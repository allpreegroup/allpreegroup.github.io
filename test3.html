<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jamaica First In-Store Deal Site & Cashback</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Font Awesome for social icons and location icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Custom CSS for header */
        .header-bg {
            background-color: #ffffff; /* White background for the header */
            border-bottom: 1px solid #e5e7eb; /* Light gray border at the bottom */
        }
        .max-w-7xl-custom {
            max-width: 1280px; /* Equivalent to max-w-7xl in Tailwind's default config */
        }

        /* Custom CSS for footer */
        .footer-section {
            background-color: #2C3E50; /* Dark blue background */
            color: white;
            padding: 2rem;
            text-align: center;
            font-size: 0.9rem;
        }
        .footer-section a {
            color: #60a5fa; /* A light blue for links */
            text-decoration: none;
            transition: color 0.2s;
        }
        .footer-section a:hover {
            color: #93c5fd; /* Lighter blue on hover */
            text-decoration: underline;
        }
        .footer-section h3 {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: #ffffff;
        }
        .footer-section ul {
            list-style: none;
            padding: 0;
        }
        .footer-section ul li {
            margin-bottom: 0.5rem;
        }
        .footer-section ul li a {
            color: #d1d5db; /* Lighter gray for footer links */
            font-weight: 400;
        }
        .footer-section ul li a:hover {
            color: #ffffff;
        }

        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4ff; /* Light background */
            color: #333;
            overflow-x: hidden;
            display: flex;
            flex-direction: column; /* Arrange header, main, footer vertically */
            justify-content: space-between; /* Push footer to bottom */
            min-height: 100vh; /* Ensure it takes full viewport height */
        }
        .btn-primary {
            background-color: #007bff; /* Primary blue for CTA */
            color: white;
            padding: 12px 28px; /* Slightly larger padding for main CTA */
            border-radius: 9999px; /* Fully rounded */
            font-weight: 600;
            transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Consistent shadow */
            display: inline-flex; /* For better alignment with icon if added */
            align-items: center;
            justify-content: center;
            gap: 8px; /* Space for potential icon */
        }
        .btn-primary:hover {
            background-color: #0056b3; /* Darker blue on hover */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .container-wrapper {
            border-radius: 1.5rem; /* Rounded corners for the main container */
            padding: 0; /* Remove padding here, it's inside sections */
            margin: 2rem auto; /* Center horizontally and add vertical margin */
            max-width: 1200px; /* Max width for content */
            width: 95%; /* Responsive width */
            overflow: hidden; /* Ensure rounded corners clip content */
            flex-grow: 1; /* Allow main content to grow and push footer down */
        }

        /* Deal Grid and Cards */
        .deal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            padding: 2rem;
        }
        .deal-card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: left;
            padding-bottom: 1rem;
        }
        .deal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        .deal-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
        }
        .discount-badge {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background-color: red;
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.75rem;
            z-index: 10;
        }
        .deal-content {
            padding: 0.75rem;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            flex-grow: 1;
        }
        .product-brand-text {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 0.25rem;
            white-space: nowrap; /* Re-added for truncation */
            overflow: hidden; /* Re-added for truncation */
            text-overflow: ellipsis; /* Re-added for truncation */
        }

        .deal-title {
            font-weight: 600;
            font-size: 1rem;
            color: #1a202c;
            margin-bottom: 0.25rem;
            height: 1.2rem; /* Fixed height to allow for truncation */
            overflow: hidden; /* Re-added for truncation */
            text-overflow: ellipsis; /* Re-added for truncation */
            display: -webkit-box; /* Re-added for truncation */
            -webkit-line-clamp: 2; /* Re-added for truncation */
            -webkit-box-orient: vertical; /* Re-added for truncation */
        }
        .price-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }
        .price-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .original-price {
            text-decoration: line-through;
            color: #6b7280;
            font-size: 0.875rem;
        }
        .discount-price {
            font-weight: 700;
            color: red;
            font-size: 1.0rem;
        }
        .add-to-cart-button {
            background-color: #2C3E50;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: .95rem;
            font-weight: 600;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        .add-to-cart-button:hover {
            background-color: #34495E;
        }

        /* Current Brand Info Card (now part of the grid) */
        .brand-info-card-grid-item {
            background-color: #2C3E50; /* Default background */
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1rem; /* Reduced padding to fit better in grid */
            border-radius: 0.75rem; /* Match other deal cards */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Match other deal cards */
            min-height: 250px; /* Maintain height for visual consistency */
            text-align: center;
            transition: background-color 0.3s ease-in-out, background-image 0.3s ease-in-out;
            /* Ensure it takes full width in its grid cell */
            width: 100%;
            height: 100%;
        }
        .brand-info-card-grid-item .brand-logo-grid {
            width: 120px; /* Slightly smaller logo for grid item */
            height: 100px;
            object-fit: contain;
            border-radius: 50%;
            background-color: rgba(255,255,255,0.2);
            padding: 5px;
            flex-shrink: 0;
            margin-bottom: 0.5rem; /* Space below logo */
        }
        .brand-info-card-grid-item .brand-name-grid {
            font-size: .8rem; /* Slightly smaller font for grid item */
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        .brand-info-card-grid-item .category-parish-text {
            font-size: 0.85rem;
            font-weight: 500;
            opacity: 0.9;
            margin-bottom: 0.25rem;
        }
        .brand-info-card-grid-item .countdown-text-grid {
            font-size: 0.75rem;
            font-weight: 500;
            color: white; /* Default color for the timer text */
            margin-top: 0.5rem;
        }
        /* New style for timer error messages */
        .brand-info-card-grid-item .countdown-text-grid.error {
            color: #ffb3b3; /* Light red for error messages */
            font-weight: 600;
        }
        /* New class for cashback text on brand card */
        .cashback-brand-text {
            font-size: 0.85rem;
            font-weight: 600;
            color: white; /* Set text color to white */
            margin-top: 0.5rem;
        }

        /* Shop More Deals Button (per brand section) */
        .shop-more-deals-container {
            display: flex;
            justify-content: center;
            padding: 1.5rem 2rem;
            background-color: #ffffff;
            border-radius: 0 0 1.5rem 1.5rem; /* Rounded bottom corners only for the last section */
            box-shadow: 0 -5px 10px rgba(0, 0, 0, 0.03);
        }
        .shop-more-button {
            background-color: #2C3E50;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.2s;
        }
        .shop-more-button:hover {
            background-color: #34495E;
        }
        .shop-more-button svg {
            width: 16px;
            height: 16px;
            fill: white;
        }

        /* Popup Styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        .popup-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.25);
            max-width: 600px;
            width: 90%;
            position: relative;
            animation: fadeInScale 0.3s ease-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .popup-close {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            font-size: 2rem;
            color: #6b7280;
            cursor: pointer;
            transition: color 0.2s;
        }
        .popup-close:hover {
            color: #ef4444;
        }
        .popup-img {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 1rem;
            margin-bottom: 1.5rem;
            background-color: #f8fafc;
            padding: 1rem;
        }
        .popup-title {
            font-size: 1rem;
            font-weight: 800;
            color: #1a202c;
            margin-bottom: 0.75rem;
        }
        .popup-brand {
            font-size: 1.125rem;
            color: #4a5568;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .popup-price-info-popup {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .popup-price {
            text-decoration: line-through;
            color: #6b7280;
            font-size: 1rem;
        }
        .popup-discount {
            font-weight: 700;
            color: red;
            font-size: 1.125rem;
        }
        .popup-desc {
            color: #4a5568;
            font-size: 0.5rem;
            line-height: .6rem;
            margin-bottom: 1.5rem;
        }
        .popup-badge {
            position: absolute;
            top: 0.75rem;
            left: 0.75rem;
            background-color: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-weight: 700;
            font-size: 1rem;
            margin-top: 1rem;
        }
        .shop-button {
            background-color: #3f51b5;
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .shop-button:hover {
            background-color: #303f9f;
        }

        /* Floating Categories Styles */
        .floating-categories-container {
            background-color: #f8fafc; /* Light gray background for the floating bar */
            padding: 0.75rem 0; /* Vertical padding only */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 70px; /* Adjust based on your header's height */
            z-index: 40; /* Below header, above main content */
            border-bottom: 1px solid #e5e7eb;
            width: 100%; /* Ensures the background spans the full width of the page */
        }
        .categories-list-wrapper { /* This new wrapper centers the content and handles scrolling */
            max-width: 1280px; /* Equivalent to max-w-7xl in Tailwind's default config */
            margin: 0 auto; /* Centers the content within the full-width container */
            padding: 0 1rem; /* Added horizontal padding for content inside */
            overflow-x: auto; /* Now this element handles horizontal scrolling */
            white-space: nowrap; /* Prevent items from wrapping here */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        /* Scrollbar hiding for the categories-list-wrapper */
        .categories-list-wrapper::-webkit-scrollbar {
            display: none; /* For Chrome, Safari, and Opera */
        }
        .categories-list-wrapper {
            -ms-overflow-style: none;  /* For Internet Explorer and Edge */
            scrollbar-width: none;  /* For Firefox */
        }

        .categories-list {
            display: flex;
            align-items: center;
            gap: 1rem; /* Space between category items */
        }
        .category-item {
            display: inline-flex; /* Keep items inline for horizontal scroll */
            flex-direction: column;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            flex-shrink: 0; /* Prevent items from shrinking */
        }
        .category-item:hover {
            background-color: #e2e8f0; /* Light hover effect */
            transform: translateY(-2px);
        }
        .category-item.active {
            background-color: #dbeafe; /* Tailwind blue-100 for active state */
            border: 1px solid #93c5fd; /* Tailwind blue-300 border */
        }
        .category-name {
            font-size: 0.75rem; /* Smaller text for category names */
            font-weight: 500;
            color: #4a5568;
            text-align: center;
            white-space: normal; /* Allow text to wrap */
            overflow: visible; /* Ensure content is visible */
            text-overflow: clip; /* Prevent ellipsis */
            max-width: none; /* Remove max-width constraint */
        }

        /* Styles for combined search/dropdown container */
        .combined-search-container {
            display: flex;
            border: 1px solid #d1d5db; /* Gray-300 */
            border-radius: 0.5rem; /* Rounded-lg */
            overflow: hidden; /* Ensures inner elements respect the container's border-radius */
            flex-grow: 1;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); /* Shadow-sm */
            height: 42px; /* Fixed height for consistent alignment */
        }
        .combined-search-container:focus-within {
            border-color: transparent; /* Hide individual border on focus */
            box-shadow: 0 0 0 2px #2C3E50; /* Focus ring */
            outline: none;
        }

        /* Styles for the search input field */
        .combined-search-container input[type="text"] {
            border: none; /* Remove individual border */
            border-radius: 0; /* Remove individual border-radius */
            padding-left: 2.5rem; /* Space for icon */
            flex-grow: 1;
            background-color: white;
            outline: none; /* Remove focus outline */
            padding-top: 0.5rem; /* py-2 */
            padding-bottom: 0.5rem; /* py-2 */
            font-size: 0.875rem; /* text-sm */
            color: #333;
        }
        .combined-search-container input[type="text"]::placeholder {
            color: #9ca3af; /* Placeholder color */
        }

        /* Styles for the parish dropdown */
        .combined-search-container select.parish-select {
            border: none; /* Remove individual border */
            border-left: 1px solid #e5e7eb; /* Add a separator line */
            border-radius: 0; /* Remove individual border-radius */
            padding-right: 0.75rem; /* Adjust padding as no custom arrow here */
            background-color: #f9fafb; /* Light background color for the dropdown */
            appearance: none; /* Hide default dropdown arrow */
            outline: none; /* Remove focus outline */
            flex-shrink: 0; /* Prevent shrinking */
            width: auto; /* Allow width to be determined by content/padding */
            min-width: 120px; /* Minimum width for the dropdown */
            cursor: pointer;
            padding-top: 0.5rem; /* py-2 */
            padding-bottom: 0.5rem; /* py-2 */
            font-size: 0.875rem; /* text-sm */
            color: #333;
            transition: background-color 0.2s ease-in-out; /* Added transition for hover */
            text-align: center; /* Center the selected text in the dropdown */
            text-align-last: center; /* For Firefox to center selected text */
        }
        .combined-search-container select.parish-select:hover {
            background-color: #f5f5f5; /* Slightly darker light hover background */
        }

        /* Styles for the town dropdown */
        .combined-search-container select.town-select {
            border: none; /* Remove individual border */
            border-left: 1px solid #e5e7eb; /* Add a separator line */
            border-radius: 0; /* Remove individual border-radius */
            padding-right: 2.5rem; /* Space for custom arrow */
            background-color: #f9fafb; /* Light background color for the dropdown */
            appearance: none; /* Hide default dropdown arrow */
            outline: none; /* Remove focus outline */
            flex-shrink: 0; /* Prevent shrinking */
            width: auto; /* Allow width to be determined by content/padding */
            min-width: 120px; /* Minimum width for the dropdown */
            cursor: pointer;
            padding-top: 0.5rem; /* py-2 */
            padding-bottom: 0.5rem; /* py-2 */
            font-size: 0.875rem; /* text-sm */
            color: #333;
            transition: background-color 0.2s ease-in-out; /* Added transition for hover */
            text-align: center; /* Center the selected text in the dropdown */
            text-align-last: center; /* For Firefox to center selected text */
        }
        .combined-search-container select.town-select:hover {
            background-color: #f5f5f5; /* Slightly darker light hover background */
        }

        .combined-search-container select option {
            color: #333; /* Ensure option text color is readable */
            text-align: center; /* Attempt to center options in the dropdown list */
        }

        /* Styles for the search icon wrapper */
        .combined-search-container .search-icon-wrapper {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            padding-left: 0.75rem; /* pl-3 */
            display: flex;
            align-items: center;
            pointer-events: none;
            z-index: 1; /* Ensure icon is above input */
        }

        /* Styles for the dropdown arrow wrapper (only for the last select) */
        .combined-search-container .dropdown-arrow-wrapper {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            padding-right: 0.5rem; /* px-2 */
            display: flex;
            align-items: center;
            pointer-events: none;
            z-index: 1; /* Ensure arrow is above select */
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header-bg py-4 sticky top-0 z-50">
        <div class="max-w-7xl-custom mx-auto px-6 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <!-- Allpree Logo -->
                <img src="https://www.allpree.com/img/allpree.com.logo.ja.png" alt="Allpree Logo" class="h-14 w-auto">
            </div>

            <!-- Combined Search and Location Bar Container -->
            <div class="flex flex-grow mx-4 max-w-2xl">
                <div class="relative flex-grow combined-search-container">
                    <div class="search-icon-wrapper">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <input type="text" id="brandSearchInput" placeholder="Search brands..." class="py-2">

                    <select id="parishSelect" class="py-2 parish-select">
                        <!-- Options populated by JS -->
                    </select>
                     
                    <select id="townSelect" class="py-2 town-select">
                        <!-- Options populated by JS -->
                    </select>
                    <div class="dropdown-arrow-wrapper">
                        <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Desktop Navigation - Hidden on mobile -->
            <nav class="hidden md:block">
                <ul class="flex space-x-6 text-gray-700 font-medium">
                   <li><a href="https://www.allpree.com/getapp" class="btn-primary py-2 px-6 text-base shadow-md">Get The App</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Floating Categories Section -->
    <div id="floating-categories-container" class="floating-categories-container">
        <div class="categories-list-wrapper"> <!-- This wrapper now handles horizontal scrolling -->
            <div id="categories-list" class="categories-list">
                <!-- "All Brands" category item -->
                <div class="category-item active" data-filter-type="category" data-filter-value="all">
                    <span class="category-name">All Categories</span>
                </div>
                <!-- Dynamic category items will be inserted here by JavaScript -->
            </div>
        </div>
    </div >

    <main class="flex-grow flex flex-col items-center">
        <div class="container-wrapper">
            <div id="all-brands-container">
                <!-- Each brand's section will be dynamically added here -->
                <p class="col-span-full text-center text-gray-500 py-4" id="loading-brands-message">Loading Brands...</p>
            </div>
        </div>
    </main>

     <!-- Footer -->
    <footer class="footer-section mt-auto">
        <div class="max-w-7xl-custom mx-auto px-6 py-8 grid grid-cols-1 md:grid-cols-4 gap-8 text-left">
            <!-- About Allpree Column -->
            <div class="col-span-1 md:col-span-1">
                <h3 class="text-white mb-4">About Allpree</h3>
                <p class="text-gray-300 text-sm leading-relaxed">
                    Allpree shows you the best local deals. From groceries to fashion and many more. We help you save every day. We search high and low to bring you unbeatable local prices on the products you love, so you can spend less and enjoy more 
                </p>
                <div class="flex space-x-4 mt-6">
                    <a href="https://www.facebook.com/allpreedotcom" target="_blank" class="text-gray-300 hover:text-white transition-colors duration-200">
                        <i class="fab fa-facebook-f fa-lg"></i>
                    </a>
                    <a href="https://www.instagram.com/allpreedotcom" target="_blank" class="text-gray-300 hover:text-white transition-colors duration-200">
                        <i class="fab fa-instagram fa-lg"></i>
                    </a>
                    <a href="https://www.youtube.com/@allpreedotcom" target="_blank" class="text-gray-300 hover:text-white transition-colors duration-200">
                        <i class="fab fa-youtube fa-lg"></i>
                    </a>
                    <a href="https://www.tiktok.com/@allpreedotcom" target="_blank" class="text-gray-300 hover:text-white transition-colors duration-200">
                        <i class="fab fa-tiktok fa-lg"></i>
                    </a>
                    <a href="https://twitter.com/allpreedotcom" target="_blank" class="text-gray-300 hover:text-white transition-colors duration-200">
                        <i class="fab fa-twitter fa-lg"></i>
                    </a>
                </div>
            </div>

            <!-- My Account Column -->
            <div class="col-span-1 md:col-span-1">
                <h3 class="text-white mb-4">CASHBACK CLUB</h3>
                <ul>
                    <li><a href="https://www.allpree.com/for-giftcard" class="text-gray-300 hover:text-white transition-colors duration-200">CashBack Club: Gift Card</a></li>
                    <li><a href="https://www.allpree.com/all-stores" class="text-gray-300 hover:text-white transition-colors duration-200">CashBack Club: All Stores</a></li>
                    <li><a href="https://www.allpree.com/install" class="text-gray-300 hover:text-white transition-colors duration-200">CashBack Club: Install App</a></li>
                    <li><a href="#" class="text-gray-300 hover:text-white transition-colors duration-200">CashBack Club: How It Works</a></li>
                    
                    
                </ul>
            </div>

            <!-- Let Us Help Column -->
            <div class="col-span-1 md:col-span-1">
                <h3 class="text-white mb-4">LET US HELP</h3>
                <ul>
                    <li><a href="#" class="text-gray-300 hover:text-white transition-colors duration-200">Help Center</a></li>
                    <li><a href="#" class="text-gray-300 hover:text-white transition-colors duration-200">Contact Customer Care</a></li>
                    <li><a href="#" class="text-gray-300 hover:text-white transition-colors duration-200">Frequently Asked Questions</a></li>
                </ul>
            </div>

            <!-- Company Information Column -->
            <div class="col-span-1 md:col-span-1">
                <h3 class="text-white mb-4">COMPANY</h3>
                <ul>
                    <li><a href="https://www.allpree.com/for-retailers" class="text-gray-300 hover:text-white transition-colors duration-200">For Giftme Retailers</a></li>
                    <li><a href="https://www.allpree.com/for-shoppers" class="text-gray-300 hover:text-white transition-colors duration-200">For Shoppers</a></li>
                    <li><a href="https://www.allpree.com/getapp" class="btn-primary py-2 px-6 text-base shadow-md">Get The App</a></li>
                </ul>
            </div>
        </div>
        <div class="max-w-7xl-custom mx-auto px-6 pt-4 border-t border-gray-700 text-center text-gray-400 text-xs">
            <p class="mb-2"><strong>Your Privacy is Guaranteed.</strong> We will never give, lease, or sell your personal information. Period!</p>
            <p class="mb-2">&copy; Copyright 2024 - <script>document.write(new Date().getFullYear());</script>&nbsp;Allpree Local Deals operates under the management of Allpree Group Holding Ltd. All Rights Reserved.</p>
            <p>By using our services, you agree to our <a href="/legal" class="text-blue-400 hover:underline">Terms & Conditions</a> and <a href="/legal" class="text-blue-400 hover:underline">Privacy Policy</a>.</p>
        </div>
    </footer>

    <!-- Popup Modal -->
    <div id="popup" class="popup-overlay hidden">
        <div class="popup-content">
            <span class="popup-close" onclick="closePopup()">&times;</span>
            <img id="popupImg" src="" alt="Deal Image" class="popup-img" onerror="this.onerror=null;this.src='https://placehold.co/300x200/e0e0e0/555555?text=Image+Not+Found';">
            <h2 id="popupTitle" class="popup-title"></h2>
            <p id="popupBrand" class="popup-brand"></p>
            <div class="popup-price-info-popup">
                <p id="popupPrice" class="popup-price"></p>
                <p id="popupDiscount" class="popup-discount"></p>
            </div>
            <p id="popupDesc" class="popup-desc"></p>
            <span id="popupBadge" class="popup-badge"></span>

        </div>
    </div>

    <script>
        const masterSheetUrl = 'https://opensheet.elk.sh/1WcTbHLTOpUl-TK7r0rTWZ_PuT0umIaBc00tzGZozgFw/Sheet1';
        const productsPerPage = 4; // Number of products to show initially per brand section

        // Store product data and current index per brand
        const brandDataMap = {}; // { brandId: { allProducts: [], currentProductIndex: 0, brandName: '', category: '', parish: '', town: '' } }
        const countdownIntervals = {}; // To store interval IDs for each brand's countdown

        // These will now be dynamically populated
        let dynamicJamaicanLocations = {
            "All Parishes": ["All Towns"]
        };
        let dynamicCategories = new Set(); // Using a Set to store unique categories

        /**
         * Shuffles an array in place using the Fisher-Yates (Knuth) algorithm.
         * @param {Array} array The array to shuffle.
         * @returns {Array} The shuffled array (same reference).
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]]; // Swap elements
            }
            return array;
        }

        /**
         * Opens the deal popup with the given product details.
         * @param {Object} deal - Object containing deal details (image, name, original, discount, description, brandName).
         */
        function openPopup({ image, name, original, discount, description, brandName }) {
            const originalPrice = parseFloat(String(original).replace(/,/g, '')) || 0;
            const discountPrice = parseFloat(String(discount).replace(/,/g, '')) || 0;
            const percentOff = originalPrice && discountPrice ? Math.round((1 - discountPrice / originalPrice) * 100) : 0;

            document.getElementById('popupImg').src = image;
            document.getElementById('popupTitle').textContent = name;
            document.getElementById('popupBrand').textContent = brandName ? `${brandName}` : '';
            document.getElementById('popupPrice').textContent = `Original Price: JMD $${original}`;
            document.getElementById('popupDiscount').textContent = `Now: JMD $${discount}`;
            document.getElementById('popupDesc').textContent = description || '';
            document.getElementById('popupBadge').textContent = `${percentOff}% OFF`;
            document.getElementById('popup').style.display = 'flex';
        }

        /**
         * Closes the deal popup.
         */
        function closePopup() {
            document.getElementById('popup').style.display = 'none';
        }

        /**
         * Loads more deals for a specific brand section.
         * @param {string} brandId - The unique ID of the brand.
         */
        function loadMoreDealsForBrand(brandId) {
            const brandData = brandDataMap[brandId];
            if (!brandData) return;

            const productsToAdd = brandData.allProducts.slice(brandData.currentProductIndex, brandData.currentProductIndex + productsPerPage);
            if (productsToAdd.length > 0) {
                const container = document.getElementById(`deals-container-${brandId}`);
                productsToAdd.forEach(row => {
                    const card = createDealCard(row);
                    if (card) {
                        container.appendChild(card);
                    }
                });
                brandData.currentProductIndex += productsToAdd.length;
                updateShopMoreButton(brandId);
            }
        }

        /**
         * Creates an HTML deal card element from product row data.
         * @param {Object} row - The product data row from the sheet.
         * @returns {HTMLElement|null} The created deal card element or null if data is incomplete.
         */
        function createDealCard(row) {
            if (!row.ProductName || !row.ImageURL) {
                return null;
            }

            const original = parseFloat(String(row.OriginalPrice).replace(/,/g, '')) || 0;
            const discount = parseFloat(String(row.DiscountPrice).replace(/,/g, '')) || 0;
            const percentOff = original && discount ? Math.round((1 - discount / original) * 100) : 0;

            const shortName = row.ProductName.length > 18 ? row.ProductName.slice(0, 17) + '...' : row.ProductName;

            const dealCard = document.createElement('div');
            dealCard.className = 'deal-card';

            // Removed conditional cashback text from here. It will now be on the brand card.

            dealCard.innerHTML = `
                <span class="discount-badge">SAVE ${percentOff}%</span>
                <img src="${row.ImageURL}" alt="${row.ProductName}" onerror="this.onerror=null;this.src='https://placehold.co/150x150/e0e0e0/555555?text=Product';">
                <div class="deal-content">
                    <div class="deal-title">${shortName}</div>
                    <div class="price-section">
                        <div class="price-info">
                            <div class="discount-price">JMD $${discount.toLocaleString()}</div>
                            <div class="original-price">JMD $${original.toLocaleString()}</div>
                        </div>
                        <button class="add-to-cart-button">+</button>
                    </div>
                </div>
            `;
            dealCard.addEventListener('click', () => {
                openPopup({
                    image: row.ImageURL,
                    name: row.ProductName,
                    original: original.toLocaleString(),
                    discount: discount.toLocaleString(),
                    description: row.Description,
                    brandName: row.BrandName // Use brand name from the product row for popup
                });
            });
            return dealCard;
        }

        /**
         * Renders the initial set of products for a specific brand's section.
         * @param {string} brandId - The unique ID of the brand.
         * @param {Array} productsToRender - Array of product objects to render.
         */
        function renderInitialProducts(brandId, productsToRender) {
            const container = document.getElementById(`deals-container-${brandId}`);
            container.innerHTML = ''; // Clear existing content

            // Create and prepend the brand info card first
            const brandData = brandDataMap[brandId];
            const brandInfoCard = createBrandInfoCard(
                brandData.brandName,
                brandData.brandId,
                brandData.brandLogo,
                brandData.brandColor,
                brandData.brandImage,
                brandData.category,
                brandData.parish,
                brandData.town, // Pass town data
                brandData.expiryDate,
                brandData.brandSecondaryColor, // Pass secondary color
                brandData.cashbackStatus // Pass cashback status
            );
            if (brandInfoCard) {
                container.appendChild(brandInfoCard); // Append first, then products
            }

            productsToRender.forEach(row => {
                const card = createDealCard(row);
                if (card) {
                    container.appendChild(card);
                }
            });
            updateShopMoreButton(brandId);
        }

        /**
         * Creates the dedicated brand information card to be placed in the grid.
         * @param {string} brandName - The name of the brand.
         * @param {string} brandId - The unique ID for the brand.
         * @param {string} brandLogo - URL to the brand's logo.
         * @param {string} brandColor - Primary background color for the brand card.
         * @param {string} brandImage - Background image URL for the brand card.
         * @param {string} category - The category of the brand.
         * @param {string} parish - The parish where the brand is located.
         * @param {string} town - The town where the brand is located.
         * @param {string} expiryDate - The expiry date of the deal for countdown.
         * @param {string} secondaryColor - The secondary background color for the brand card (optional).
         * @param {string} cashbackStatus - The cashback status ('yes' or 'no' or empty).
         * @returns {HTMLElement} The created brand info card element.
         */
        function createBrandInfoCard(brandName, brandId, brandLogo, brandColor, brandImage, category, parish, town, expiryDate, secondaryColor, cashbackStatus) {
            const brandInfoCard = document.createElement('div');
            brandInfoCard.className = 'brand-info-card-grid-item'; // New class for styling as a grid item
            brandInfoCard.id = `brand-info-card-${brandId}`;

            let backgroundStyle = '';
            if (brandImage) {
                backgroundStyle = `background-image: url('${brandImage}'); background-size: cover; background-position: center;`;
            } else if (brandColor && secondaryColor) { // If both primary and secondary colors are present
                backgroundStyle = `background: linear-gradient(to right, ${brandColor}, ${secondaryColor});`;
            } else if (brandColor) { // Fallback to solid primary color
                backgroundStyle = `background-color: ${brandColor};`;
            }
            brandInfoCard.style = backgroundStyle;

            // Conditional rendering for cashback text on the brand info card
            let cashbackTextHtml = '';
            if (cashbackStatus && String(cashbackStatus).toLowerCase() === 'yes') {
                cashbackTextHtml = `<p class="cashback-brand-text">30 - 49% CashBack ¹²¹</p>`;
            }

            brandInfoCard.innerHTML = `
                <img src="${brandLogo}" alt="${brandName} Logo" class="brand-logo-grid">
                <p class="brand-name-grid">${brandName}</p>
                <p class="category-parish-text">${category}</p>
                <p class="category-parish-text">${parish || 'N/A'}${town ? ': ' + town : ''}</p>
                ${cashbackTextHtml} <!-- Insert cashback text here -->
                <p id="countdown-${brandId}" class="countdown-text-grid"></p>
            `;

            const countdownElement = brandInfoCard.querySelector(`#countdown-${brandId}`);

            if (expiryDate) {
                const endDate = new Date(expiryDate).getTime();
                console.log(`[Timer Debug] Brand: ${brandName}, Raw ExpiryDate: "${expiryDate}", Parsed endDate (ms): ${endDate}, isNaN: ${isNaN(endDate)}`);

                if (!isNaN(endDate)) {
                    updateCountdown(brandId, endDate, countdownElement); // Pass the element directly
                } else {
                    if (countdownElement) {
                        countdownElement.textContent = "Invalid Expiry Date";
                        countdownElement.classList.add('error'); // Add error class
                    }
                }
            } else {
                if (countdownElement) {
                    countdownElement.textContent = "No Expiry Date Provided";
                    countdownElement.classList.add('error'); // Add error class
                }
            }
            return brandInfoCard;
        }


        /**
         * Updates the "Shop More Deals" button for a specific brand section.
         * @param {string} brandId - The unique ID of the brand.
         */
        function updateShopMoreButton(brandId) {
            const brandData = brandDataMap[brandId];
            if (!brandData) return;

            // Subtract 1 from allProducts.length because the first "product" is now the brand info card
            const remainingCount = (brandData.allProducts.length - brandData.currentProductIndex);
            const shopMoreButtonSpan = document.getElementById(`shop-more-count-${brandId}`);
            const shopMoreButtonContainer = document.getElementById(`shop-more-container-${brandId}`);

            if (shopMoreButtonSpan && shopMoreButtonContainer) {
                // The button should only show if there are actual products remaining
                if (remainingCount > 0) {
                    shopMoreButtonSpan.textContent = `Shop ${remainingCount} More Deals`;
                    shopMoreButtonContainer.classList.remove('hidden');
                } else {
                    shopMoreButtonContainer.classList.add('hidden');
                }
            }
        }

        /**
         * Updates the countdown timer for a specific brand.
         * @param {string} brandId - The unique ID of the brand.
         * @param {number} endDate - The timestamp (milliseconds) when the deal ends.
         * @param {HTMLElement} countdownElement - The actual element to update.
         */
        function updateCountdown(brandId, endDate, countdownElement) {
            if (!countdownElement) return;

            // Clear any existing interval for this brand to prevent duplicates
            if (countdownIntervals[brandId]) {
                clearInterval(countdownIntervals[brandId]);
            }

            const intervalId = setInterval(() => {
                const now = new Date().getTime();
                const distance = endDate - now;

                if (distance < 0) {
                    countdownElement.textContent = "Deal Ended";
                    clearInterval(intervalId);
                    delete countdownIntervals[brandId];
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                countdownElement.textContent = `Ends in: ${days}d ${hours}h ${minutes}m ${seconds}s`;
            }, 1000);

            countdownIntervals[brandId] = intervalId; // Store the interval ID
        }

        /**
         * Renders a complete section for a single brand on the page.
         * @param {string} brandName - The name of the brand.
         * @param {string} brandId - The unique ID for the brand.
         * @param {string} brandLogo - URL to the brand's logo.
         * @param {string} brandColor - Primary background color for the brand card.
         * @param {string} brandImage - Background image URL for the brand card.
         * @param {string} category - The category of the brand.
         * @param {string} parish - The parish where the brand is located.
         * @param {string} town - The town where the brand is located.
         * @param {string} expiryDate - The expiry date of the deal for countdown.
         * @param {string} secondaryColor - The secondary background color for the brand card (optional).
         * @param {string} cashbackStatus - The cashback status ('yes' or 'no' or empty).
         */
        function renderBrandSection(brandName, brandId, brandLogo, brandColor, brandImage, category, parish, town, expiryDate, secondaryColor, cashbackStatus) {
            const allBrandsContainer = document.getElementById('all-brands-container');
            const brandSection = document.createElement('section');
            brandSection.id = `brand-section-${brandId}`;
            brandSection.className = 'bg-white rounded-2xl shadow-lg mb-8 overflow-hidden';
            brandSection.setAttribute('data-brand-name', brandName);
            brandSection.setAttribute('data-category', category.toLowerCase());
            brandSection.setAttribute('data-parish', (parish || '').toLowerCase()); // Ensure parish is always a string for data attribute
            brandSection.setAttribute('data-town', (town || '').toLowerCase()); // Ensure town is always a string for data attribute

            const brandProducts = brandDataMap[brandId].allProducts;
            // Initial products will be productsPerPage, but the first slot is for the brand info card
            const initialProductsToDisplay = brandProducts.slice(0, productsPerPage);
            brandDataMap[brandId].currentProductIndex = initialProductsToDisplay.length;


            brandSection.innerHTML = `
                <div id="deals-container-${brandId}" class="deal-grid">
                    <!-- Brand Info Card and Deals will be inserted here -->
                </div>
                <div id="shop-more-container-${brandId}" class="shop-more-deals-container ${brandProducts.length <= productsPerPage ? 'hidden' : ''}">
                    <button class="shop-more-button" onclick="loadMoreDealsForBrand('${brandId}')">
                        <span id="shop-more-count-${brandId}">Shop ${brandProducts.length - initialProductsToDisplay.length} More Deals</span>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M12 21l-8-8 1.41-1.41L11 17.17V3h2v14.17l5.59-5.58L20 13z"/></svg>
                    </button>
                </div>
            `;
            allBrandsContainer.appendChild(brandSection);

            renderInitialProducts(brandId, initialProductsToDisplay); // Pass the products to display
        }

        /**
         * Fetches all brand data from the master sheet and individual brand sheets,
         * populates the brandDataMap, and then applies filters to render content.
         */
        async function fetchAndProcessData() {
            const loadingMessage = document.getElementById('loading-brands-message');
            if (loadingMessage) loadingMessage.textContent = 'Loading all brands and their deals...';
            console.log("[Data Fetch] Starting fetch and process data...");

            // Reset dynamicJamaicanLocations and dynamicCategories before fetching new data
            dynamicJamaicanLocations = { "All Parishes": ["All Towns"] };
            dynamicCategories = new Set();

            try {
                const masterRes = await fetch(masterSheetUrl);
                const masterBrands = await masterRes.json();
                console.log("[Data Fetch] Master sheet loaded:", masterBrands);

                // Clear previous brandDataMap and countdown intervals
                Object.keys(brandDataMap).forEach(key => delete brandDataMap[key]);
                Object.keys(countdownIntervals).forEach(key => clearInterval(countdownIntervals[key]));

                const allBrandsContainer = document.getElementById('all-brands-container');
                allBrandsContainer.innerHTML = ''; // Clear existing content

                if (masterBrands.length === 0) {
                    allBrandsContainer.innerHTML = '<p class="col-span-full text-center text-gray-500 py-4">No brands found in the master sheet.</p>';
                    console.log("[Data Fetch] No brands found in master sheet.");
                    return;
                }

                const brandPromises = masterBrands.map(async (brandEntry) => {
                    const brandName = brandEntry.BrandName || brandEntry.undefined;
                    const sheetUrl = brandEntry.sheeturls;

                    if (!brandName || !sheetUrl) {
                        console.warn(`[Data Fetch] Skipping brand entry due to missing name or sheet URL:`, brandEntry);
                        return null;
                    }

                    const brandId = brandName.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
                    console.log(`[Data Fetch] Processing brand: "${brandName}" (ID: ${brandId}), URL: ${sheetUrl}`);

                    try {
                        const res = await fetch(sheetUrl);
                        const rows = await res.json();
                        console.log(`[Data Fetch] Sheet data for "${brandName}" loaded:`, rows);

                        let featuredBrandData = null;
                        let tempProducts = [];
                        let brandParish = '';
                        let brandTown = '';
                        let brandCategory = 'Uncategorized';
                        let brandLogo = 'https://placehold.co/150x120/2C3E50/ffffff?text=Logo';
                        let brandColor = '#2C3E50';
                        let brandSecondaryColor = '';
                        let brandImage = '';
                        let expiryDate = null;
                        let cashbackStatus = ''; // Initialize cashback status for the brand

                        for (const row of rows) {
                            // Identify the brand's main information row (no ProductName or empty ProductName)
                            if (row.BrandName && row.BrandLogo && row.ExpiryDate && (!row.ProductName || row.ProductName.trim() === "")) {
                                featuredBrandData = row;
                                brandParish = (row.Parish || '').trim();
                                brandTown = (row.Town || '').trim();
                                brandCategory = (row.Category || 'Uncategorized').trim();
                                brandLogo = row.BrandLogo;
                                brandColor = row.PrimaryColor || '#2C3E50';
                                brandSecondaryColor = row.SecondaryColor || '';
                                brandImage = row.BrandImage || '';
                                expiryDate = row.ExpiryDate;
                                cashbackStatus = (row.Cashback || '').trim(); // Extract cashback status from brand row

                                // Dynamically populate jamaicanLocations
                                if (brandParish) {
                                    if (!dynamicJamaicanLocations[brandParish]) {
                                        dynamicJamaicanLocations[brandParish] = ["All Towns"];
                                    }
                                    if (brandTown && !dynamicJamaicanLocations[brandParish].includes(brandTown)) {
                                        dynamicJamaicanLocations[brandParish].push(brandTown);
                                    }
                                }
                                // Dynamically populate categories
                                if (brandCategory && brandCategory !== 'Uncategorized') {
                                    dynamicCategories.add(brandCategory);
                                }

                                console.log(`[Data Fetch] Found brand info row for "${brandName}": Category="${brandCategory}", Parish="${brandParish}", Town="${brandTown}", ExpiryDate="${expiryDate}", Cashback="${cashbackStatus}"`);
                            } else if (row.ProductName && row.ImageURL) {
                                // This is a product row
                                tempProducts.push(row);
                            }
                        }

                        // Ensure featuredBrandData was found. If not, this brand's sheet structure might be off.
                        if (!featuredBrandData) {
                            console.warn(`[Data Fetch] No main brand info row found for "${brandName}" (ID: ${brandId}). Skipping this brand.`);
                            return null;
                        }

                        if (tempProducts.length === 0) {
                            console.log(`[Data Fetch] Brand "${brandName}" (ID: ${brandId}) has no products. Will not be rendered.`);
                            return null;
                        }

                        shuffleArray(tempProducts);

                        brandDataMap[brandId] = {
                            allProducts: tempProducts,
                            currentProductIndex: 0,
                            brandName: brandName,
                            category: brandCategory,
                            parish: brandParish,
                            town: brandTown,
                            brandLogo: brandLogo,
                            brandColor: brandColor,
                            brandSecondaryColor: brandSecondaryColor,
                            brandImage: brandImage,
                            expiryDate: expiryDate,
                            cashbackStatus: cashbackStatus, // Store cashback status in brandDataMap
                            brandId: brandId
                        };
                        console.log(`[Data Fetch] Successfully processed brand: "${brandName}" (ID: ${brandId}), Category: "${brandCategory}", Parish: "${brandParish}", Town: "${brandTown}", Products: ${tempProducts.length}`);
                        return brandId;
                    } catch (err) {
                        console.error(`[Data Fetch] Failed to load deals for "${brandName}" from ${sheetUrl}:`, err);
                        return null;
                    }
                });

                const loadedBrandIds = await Promise.all(brandPromises);
                const successfullyLoadedBrands = loadedBrandIds.filter(id => id !== null);
                console.log("[Data Fetch] Successfully loaded brand IDs:", successfullyLoadedBrands);


                if (successfullyLoadedBrands.length === 0) {
                    allBrandsContainer.innerHTML = '<p class="col-span-full text-center text-gray-500 py-4">No brands with products found or all failed to load.</p>';
                    console.log("[Data Fetch] No brands with products found after processing all sheets.");
                    return;
                }

                // After all data is processed and dynamicJamaicanLocations and dynamicCategories are built
                populateCategories(); // Populate categories using the dynamic data
                populateParishes(); // Populate parishes and then towns using the dynamic data
                console.log("[Data Fetch] All brands processed. Applying filters and rendering...");
                applyFilters();

            } catch (err) {
                console.error('[Data Fetch] Failed to load master sheet:', err);
                document.getElementById('all-brands-container').innerHTML = '<p class="col-span-full text-center text-red-500 py-4">Failed to load brand list. Please check the master sheet URL.</p>';
            }
        }

        /**
         * Applies all active filters (search term, category, parish, town) and updates the displayed brand sections.
         */
        function applyFilters() {
            const searchTerm = brandSearchInput.value.toLowerCase().trim();
            const selectedParish = parishSelect.value.toLowerCase().trim();
            const selectedTown = townSelect.value.toLowerCase().trim();
            const selectedCategory = sessionStorage.getItem('selectedCategory') || 'all'; // Get from session storage

            console.log(`[Filter] Applying filters: Search="${searchTerm}", Category="${selectedCategory}", Parish="${selectedParish}", Town="${selectedTown}"`);

            const allBrandsContainer = document.getElementById('all-brands-container');
            allBrandsContainer.innerHTML = ''; // Clear existing content before re-rendering filtered results

            let foundContent = false;

            // Iterate through the pre-processed brandDataMap
            for (const brandId in brandDataMap) {
                const brand = brandDataMap[brandId];
                console.log(`[Filter Check] Checking brand: "${brand.brandName}" (ID: ${brandId})`);
                console.log(`  - Brand Category: "${brand.category.toLowerCase()}", Selected Category: "${selectedCategory}"`);
                console.log(`  - Brand Parish: "${brand.parish.toLowerCase()}", Selected Parish: "${selectedParish}"`);
                console.log(`  - Brand Town: "${brand.town.toLowerCase()}", Selected Town: "${selectedTown}"`);
                console.log(`  - Brand Name: "${brand.brandName.toLowerCase()}", Search Term: "${searchTerm}"`);


                let matchesSearch = true;
                if (searchTerm !== '') {
                    // Check if brand name or any product name matches the search term
                    matchesSearch = brand.brandName.toLowerCase().includes(searchTerm) ||
                                     brand.allProducts.some(p => (p.ProductName || '').toLowerCase().includes(searchTerm));
                    console.log(`  - Matches Search: ${matchesSearch}`);
                }

                let matchesCategory = true;
                if (selectedCategory !== 'all') {
                    matchesCategory = (brand.category || '').toLowerCase() === selectedCategory;
                    console.log(`  - Matches Category: ${matchesCategory}`);
                }

                let matchesParish = true;
                // Only filter by parish if a specific parish is selected (not empty string or "all parishes")
                if (selectedParish !== '' && selectedParish !== 'all parishes') {
                    matchesParish = (brand.parish || '').toLowerCase() === selectedParish;
                    console.log(`  - Matches Parish: ${matchesParish}`);
                }

                let matchesTown = true;
                // Only filter by town if a specific town is selected (not empty string or "all towns")
                if (selectedTown !== '' && selectedTown !== 'all towns') {
                    matchesTown = (brand.town || '').toLowerCase() === selectedTown;
                    console.log(`  - Matches Town: ${matchesTown}`);
                }

                const shouldShow = matchesSearch && matchesCategory && matchesParish && matchesTown;
                console.log(`  - Final Should Show: ${shouldShow}`);


                if (shouldShow) {
                    console.log(`[Filter] Brand "${brand.brandName}" (ID: ${brandId}) matches filters. Rendering.`);
                    // Re-render the brand section with its details
                    renderBrandSection(
                        brand.brandName,
                        brandId,
                        brand.brandLogo,
                        brand.brandColor,
                        brand.brandImage,
                        brand.category,
                        brand.parish, // Pass the parish data
                        brand.town, // Pass the town data
                        brand.expiryDate,
                        brand.brandSecondaryColor, // Pass secondary color
                        brand.cashbackStatus // Pass cashback status
                    );
                    foundContent = true;
                } else {
                    console.log(`[Filter] Brand "${brand.brandName}" (ID: ${brandId}) filtered out.`);
                }
            }

            let noResultsMessage = document.getElementById('no-results-message');

            if (!foundContent) {
                if (!noResultsMessage) {
                    noResultsMessage = document.createElement('p');
                    noResultsMessage.id = 'no-results-message';
                    noResultsMessage.className = 'col-span-full text-center text-gray-500 py-8 text-xl';
                    allBrandsContainer.appendChild(noResultsMessage);
                }
                noResultsMessage.textContent = `No brands or deals found matching your filters.`;
                console.log("[Filter] No content found after applying filters.");
            } else if (noResultsMessage) {
                noResultsMessage.remove();
                console.log("[Filter] Content found, removing 'no results' message.");
            }
        }

        /**
         * Creates a category item for the floating bar.
         * @param {string} categoryName - The name of the category.
         * @returns {HTMLElement} The created category item element.
         */
        function createFloatingCategoryItem(categoryName) {
            const categoryItem = document.createElement('div');
            categoryItem.className = 'category-item';
            categoryItem.setAttribute('data-filter-type', 'category');
            categoryItem.setAttribute('data-filter-value', categoryName.toLowerCase());

            categoryItem.innerHTML = `
                <span class="category-name">${categoryName}</span>
            `;
            categoryItem.addEventListener('click', () => {
                sessionStorage.setItem('selectedCategory', categoryName.toLowerCase()); // Save selected category
                highlightCategory(categoryItem);
                applyFilters(); // Apply filters
            });
            return categoryItem;
        }

        /**
         * Highlights the active category item in the floating bar.
         * @param {HTMLElement} activeItem - The category item to highlight.
         */
        function highlightCategory(activeItem) {
            document.querySelectorAll('.category-item').forEach(item => {
                item.classList.remove('active');
            });
            activeItem.classList.add('active');
        }

        /**
         * Populates the categories in the floating bar.
         */
        function populateCategories() {
            const categoriesList = document.getElementById('categories-list');
            // Clear existing categories before re-populating to prevent duplicates
            categoriesList.innerHTML = '';

            // Get the currently selected category from session storage, default to 'all'
            const currentSelectedCategory = sessionStorage.getItem('selectedCategory') || 'all';

            // Add "All Categories" as the first item
            const allCategoriesItem = document.createElement('div');
            allCategoriesItem.className = 'category-item';
            allCategoriesItem.setAttribute('data-filter-type', 'category');
            allCategoriesItem.setAttribute('data-filter-value', 'all');
            allCategoriesItem.innerHTML = `<span class="category-name">All Categories</span>`;
            categoriesList.appendChild(allCategoriesItem);

            allCategoriesItem.addEventListener('click', () => {
                sessionStorage.setItem('selectedCategory', 'all'); // Save selected category
                highlightCategory(allCategoriesItem);
                applyFilters(); // Apply filters
            });

            // Populate floating categories from the dynamically collected list
            const sortedCategories = Array.from(dynamicCategories).sort(); // Convert Set to Array and sort
            sortedCategories.forEach(category => {
                const categoryItem = createFloatingCategoryItem(category);
                categoriesList.appendChild(categoryItem);
            });

            // After all categories are added, highlight the one that was selected
            const activeItem = categoriesList.querySelector(`[data-filter-value="${currentSelectedCategory}"]`);
            if (activeItem) {
                highlightCategory(activeItem);
            } else {
                // If the previously selected category is no longer available, default to "All Categories"
                highlightCategory(allCategoriesItem);
                sessionStorage.setItem('selectedCategory', 'all');
            }
        }

        /**
         * Populates the parish dropdown with options from dynamicJamaicanLocations.
         */
        function populateParishes() {
            const parishSelect = document.getElementById('parishSelect');
            parishSelect.innerHTML = ''; // Clear existing options

            // Always add "All Parishes" first
            const allParishesOption = document.createElement('option');
            allParishesOption.value = "All Parishes";
            allParishesOption.textContent = "All Parishes";
            parishSelect.appendChild(allParishesOption);

            // Add parishes from dynamic data, ensuring unique and sorted order (optional)
            const sortedParishes = Object.keys(dynamicJamaicanLocations)
                                        .filter(p => p !== "All Parishes")
                                        .sort();
            sortedParishes.forEach(parish => {
                const option = document.createElement('option');
                option.value = parish;
                option.textContent = parish;
                parishSelect.appendChild(option);
            });

            // Restore previous selection or set default
            if (sessionStorage.getItem('selectedParish')) {
                parishSelect.value = sessionStorage.getItem('selectedParish');
            } else {
                parishSelect.value = "All Parishes";
            }
            populateTowns(parishSelect.value); // Populate towns for the initial parish
        }

        /**
         * Populates the town dropdown based on the selected parish.
         * @param {string} selectedParish - The currently selected parish.
         */
        function populateTowns(selectedParish) {
            const townSelect = document.getElementById('townSelect');
            townSelect.innerHTML = ''; // Clear existing options

            const towns = dynamicJamaicanLocations[selectedParish] || ["All Towns"];

            // Always add "All Towns" first for the selected parish
            const allTownsOption = document.createElement('option');
            allTownsOption.value = "All Towns";
            allTownsOption.textContent = "All Towns";
            townSelect.appendChild(allTownsOption);

            // Add other towns, ensuring unique and sorted order (optional)
            const sortedTowns = towns.filter(t => t !== "All Towns").sort();
            sortedTowns.forEach(town => {
                const option = document.createElement('option');
                option.value = town;
                option.textContent = town;
                townSelect.appendChild(option);
            });

            // Restore previous selection or set default
            if (sessionStorage.getItem('selectedTown') && dynamicJamaicanLocations[selectedParish]?.includes(sessionStorage.getItem('selectedTown'))) {
                townSelect.value = sessionStorage.getItem('selectedTown');
            } else {
                townSelect.value = "All Towns";
            }
        }


        // Event listener for Brand Search Input (with debounce)
        const brandSearchInput = document.getElementById('brandSearchInput');
        let searchTimeout;
        brandSearchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                applyFilters(); // Apply filters
            }, 300); // Debounce for 300ms
        });

        // Event listener for Parish Dropdown
        const parishSelect = document.getElementById('parishSelect');
        parishSelect.addEventListener('change', () => {
            sessionStorage.setItem('selectedParish', parishSelect.value); // Save selected parish
            sessionStorage.removeItem('selectedTown'); // Clear town when parish changes
            populateTowns(parishSelect.value); // Update towns based on selected parish
            applyFilters(); // Apply filters
        });

        // Event listener for Town Dropdown
        const townSelect = document.getElementById('townSelect');
        townSelect.addEventListener('change', () => {
            sessionStorage.setItem('selectedTown', townSelect.value); // Save selected town
            applyFilters(); // Apply filters
        });

        // Initial fetch and render on page load
        document.addEventListener('DOMContentLoaded', () => {
            fetchAndProcessData(); // Fetch and process all brand data, which will then populate locations and categories and apply filters
        });

        // Close popup when clicking outside the content
        document.getElementById('popup').addEventListener('click', function (e) {
            if (e.target === this) {
                closePopup();
            }
        });
    </script>
</body>
</html>
