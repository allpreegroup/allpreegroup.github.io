function openCartPopup(brandKey) {
  const cartItems = JSON.parse(localStorage.getItem('cartItems') || '{}')[brandKey] || [];

  // Create or select popup
  let popup = document.getElementById('cart-popup');
  if (!popup) {
    popup = document.createElement('div');
    popup.id = 'cart-popup';
    popup.style.position = 'fixed';
    popup.style.top = '50%';
    popup.style.left = '50%';
    popup.style.transform = 'translate(-50%, -50%)';
    popup.style.background = '#fff';
    popup.style.border = '1px solid #ccc';
    popup.style.padding = '20px';
    popup.style.zIndex = '9999';
    popup.style.maxWidth = '90%';
    popup.style.maxHeight = '80%';
    popup.style.overflowY = 'auto';
    popup.style.borderRadius = '10px';
    popup.style.boxShadow = '0 0 10px rgba(0,0,0,0.2)';

    document.body.appendChild(popup);
  }

  // Render items
  let html = `<h3>Cart Items</h3>`;
  let subtotal = 0;

  if (cartItems.length === 0) {
    html += `<p>Your cart is empty.</p>`;
  } else {
    cartItems.forEach(item => {
      const price = parseFloat(item.discount || item.original || 0);
      subtotal += price;
      html += `
        <div style="margin-bottom: 10px; display: flex; align-items: center;">
          <img src="${item.image}" alt="${item.name}" style="width: 50px; height: 50px; object-fit: cover; margin-right: 10px;">
          <div>
            <div><strong>${item.name}</strong></div>
            <div>J$${price.toFixed(2)}</div>
          </div>
        </div>
      `;
    });
  }

  const tax = subtotal * 0.15;
  const total = subtotal + tax;

  html += `
    <hr>
    <p><strong>Subtotal:</strong> J$${subtotal.toFixed(2)}</p>
    <p><strong>Tax (15%):</strong> J$${tax.toFixed(2)}</p>
    <p><strong>Total:</strong> J$${total.toFixed(2)}</p>
    <button onclick="clearCart('${brandKey}')" style="background:red;color:white;padding:8px 12px;border:none;border-radius:5px;cursor:pointer;">Clear Cart</button>
    <button onclick="document.getElementById('cart-popup').remove()" style="margin-left:10px;padding:8px 12px;border:none;border-radius:5px;cursor:pointer;">Close</button>
  `;

  popup.innerHTML = html;
}

function clearCart(brandKey) {
  const cartItems = JSON.parse(localStorage.getItem('cartItems') || '{}');
  delete cartItems[brandKey];
  localStorage.setItem('cartItems', JSON.stringify(cartItems));
  document.getElementById('cart-popup')?.remove();
  renderCartIconForBrand(brandKey);
}
