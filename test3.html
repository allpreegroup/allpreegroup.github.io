<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cashback Payout + Trading Simulation</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for graphing -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4ff;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
        }
        .container {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 2.5rem;
            max-width: 1200px;
            width: 100%;
            margin-top: 2rem;
        }
        h1 {
            font-size: 2.5rem;
            font-weight: 800;
            color: #1a202c;
            text-align: center;
            margin-bottom: 2rem;
        }
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .input-field {
            display: flex;
            flex-direction: column;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #4a5568;
        }
        input[type="number"], input[type="date"], select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #333;
            transition: border-color 0.2s, box-shadow 0.2s;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236B7280%22%20d%3D%22M287%2C197.3L159.2%2C69.5c-3.2-3.2-8.4-3.2-11.6%2C0L5.4%2C197.3c-3.2%2C3.2-3.2%2C8.4%2C0%2C11.6l11.6%2C11.6c3.2%2C3.2%2C8.4%2C3.2%2C11.6%2C0l124.6-124.6l124.6%2C124.6c3.2%2C3.2%2C8.4%2C3.2%2C11.6%2C0l11.6-11.6C290.2%2C205.7%2C290.2%2C200.5%2C287%2C197.3z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 0.8rem auto;
        }
        input[type="date"] {
            background-image: none;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input[type="number"]:focus, input[type="date"]:focus, select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 2rem;
        }
        th, td {
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            text-align: left;
        }
        th {
            background-color: #e0f2fe;
            color: #2c5282;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.875rem;
        }
        tbody tr:nth-child(odd) {
            background-color: #f8fafc;
        }
        tbody tr:hover {
            background-color: #eef7ff;
        }
        .summary {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #e0f2fe;
            border-radius: 0.75rem;
            text-align: center;
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c5282;
        }
        .summary span {
            color: #007bff;
            font-weight: 700;
        }
        .text-green-600 {
            color: #22c55e;
        }
        .text-red-600 {
            color: #ef4444;
        }
        .text-orange-600 {
            color: #f97316;
        }
        .stress-test-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .stress-test-checkbox input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        .chart-container {
            margin-top: 2rem;
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        /* Daily Log Specific Styles */
        .daily-log-section {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid #e2e8f0;
        }
        .daily-log-section h2 {
            font-size: 2rem;
            font-weight: 800;
            color: #1a202c;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .daily-log-controls {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
        }
        .daily-log-controls select {
            width: auto;
            min-width: 250px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            .container {
                padding: 1.5rem;
            }
            h1 {
                font-size: 2rem;
            }
            .input-grid {
                grid-template-columns: 1fr;
            }
            th, td {
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }
            .summary {
                font-size: 1rem;
                padding: 1rem;
            }
            .daily-log-section h2 {
                font-size: 1.5rem;
            }
            .daily-log-controls {
                flex-direction: column;
                align-items: center;
            }
            .daily-log-controls select {
                width: 100%;
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Cashback Payout + Trading Simulation</h1>
        <p class="text-center text-gray-600 mb-6">Model the growth of a trading fund and its ability to cover delayed cashback payouts.</p>

        <div class="input-grid">
            <div class="input-field">
                <label for="membershipTier">Membership Tier:</label>
                <select id="membershipTier">
                    <option value="Free">Free</option>
                    <option value="Standard">Standard</option>
                    <option value="Premium" selected>Premium</option>
                </select>
            </div>
            <div class="input-field">
                <label for="simulationStartDate">Simulation Start Date:</label>
                <input type="date" id="simulationStartDate">
            </div>
            <div class="input-field">
                <label for="voucherValue">Voucher Value (J$):</label>
                <select id="voucherValue">
                    <option value="10000">10,000</option>
                    <option value="15000">15,000</option>
                    <option value="20000" selected>20,000</option>
                </select>
            </div>
            <div class="input-field">
                <label for="vouchersPerMonth">Vouchers per Month:</label>
                <input type="number" id="vouchersPerMonth" value="2" min="1" max="10">
            </div>
            <div class="input-field">
                <label for="markupRate">Markup Rate (%):</label>
                <input type="number" id="markupRate" value="25" min="0" max="100" step="1">
            </div>
            <div class="input-field">
                <label for="markupAllocationToTradingFund">Markup Allocation to Fund (%):</label>
                <input type="number" id="markupAllocationToTradingFund" value="17" min="0" max="100" step="1">
            </div>
            <div class="input-field">
                <label for="initialTradingFund">Initial Trading Fund (J$):</label>
                <input type="number" id="initialTradingFund" value="0" min="0" step="100">
            </div>
            <div class="input-field">
                <label for="avgWeeklyWin">Avg Weekly Win (%):</label>
                <input type="number" id="avgWeeklyWin" value="23" min="0" max="100" step="1">
            </div>
            <div class="input-field">
                <label for="maxWeeklyLoss">Max Weekly Loss (%):</label>
                <input type="number" id="maxWeeklyLoss" value="5" min="0" max="100" step="1">
            </div>
            <div class="input-field">
                <label for="winRate">Win Rate (%):</label>
                <input type="number" id="winRate" value="60" min="0" max="100" step="1">
            </div>
            <div class="input-field stress-test-checkbox">
                <input type="checkbox" id="stressTestMode">
                <label for="stressTestMode" class="mb-0">Enable Stress Test Mode</label>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table id="simulationTable" class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th class="px-6 py-3">Month</th>
                        <th class="px-6 py-3">Purchase Date</th>
                        <th class="px-6 py-3">Cashback Due Date</th>
                        <th class="px-6 py-3">Payout Month-End</th>
                        <th class="px-6 py-3">Total Cashback Owed (J$)</th>
                        <th class="px-6 py-3">Starting Trading Capital (J$)</th>
                        <th class="px-6 py-3">Monthly Fund Contribution (J$)</th>
                        <th class="px-6 py-3">Ending Capital (J$)</th>
                        <th class="px-6 py-3">Surplus/Deficit vs. Payout (J$)</th>
                        <th class="px-6 py-3">Payout Met?</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Simulation rows will be generated here -->
                </tbody>
            </table>
        </div>

        <div class="summary">
            <h2 class="text-xl font-bold mb-4">12-Month Rolling View Summary</h2>
            <p>Cumulative Voucher Purchases: <span id="cumulativeVoucherPurchases" class="font-bold">J$0</span></p>
            <p>Total Cashback Owed (Accrued): <span id="totalCashbackOwedAccrued" class="font-bold">J$0</span></p>
            <p>Total Cashback Paid: <span id="totalCashbackPaid" class="font-bold">J$0</span></p>
            <p>Net Fund Performance: <span id="netFundPerformance" class="font-bold">J$0</span></p>
            <p>Overall Payout Status: <span id="overallPayoutStatus" class="font-bold"></span></p>
        </div>

        <div class="chart-container">
            <canvas id="simulationChart"></canvas>
        </div>

        <!-- Daily Trading Log Section -->
        <div class="daily-log-section">
            <h2>Daily Trading Log (121-Day Cycle)</h2>
            <div class="daily-log-controls">
                <label for="dailyLogMonthSelector" class="mr-2">Select Purchase Month:</label>
                <select id="dailyLogMonthSelector"></select>
            </div>
            <div class="overflow-x-auto">
                <table id="dailyLogTable" class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3">Day</th>
                            <th class="px-6 py-3">Date</th>
                            <th class="px-6 py-3">Day of Week</th>
                            <th class="px-6 py-3">Trading Day?</th>
                            <th class="px-6 py-3">Trade Occurred?</th>
                            <th class="px-6 py-3">Trade Outcome</th>
                            <th class="px-6 py-3">Gain/Loss (J$)</th>
                            <th class="px-6 py-3">Capital Before Trade (J$)</th>
                            <th class="px-6 py-3">Capital After Trade (J$)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Daily log rows will be generated here -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // --- Constants and Configuration ---
        const PAYOUT_DELAY_DAYS = 121; // Approximately 4 months
        const TRADING_WEEKS_PER_MONTH = 20; // This is the number of trades per month for the monthly simulation
        const TOTAL_TRADES_FOR_DAILY_LOG = 20; // Total trades over the 121-day period for the daily log

        const MEMBERSHIP_TIERS = {
            'Free': {
                fee: 0,
                cashbackRates: { 10000: 0.30, 15000: 0.30, 20000: 0.30 }
            },
            'Standard': {
                fee: 4200,
                cashbackRates: { 10000: 0.33, 15000: 0.34, 20000: 0.36 }
            },
            'Premium': {
                fee: 8400,
                cashbackRates: { 10000: 0.37, 15000: 0.41, 20000: 0.49 }
            }
        };

        // --- DOM Elements ---
        const membershipTierInput = document.getElementById('membershipTier');
        const simulationStartDateInput = document.getElementById('simulationStartDate');
        const voucherValueInput = document.getElementById('voucherValue');
        const vouchersPerMonthInput = document.getElementById('vouchersPerMonth');
        const markupRateInput = document.getElementById('markupRate');
        const markupAllocationToTradingFundInput = document.getElementById('markupAllocationToTradingFund');
        const initialTradingFundInput = document.getElementById('initialTradingFund');
        const avgWeeklyWinInput = document.getElementById('avgWeeklyWin');
        const maxWeeklyLossInput = document.getElementById('maxWeeklyLoss');
        const winRateInput = document.getElementById('winRate');
        const stressTestModeCheckbox = document.getElementById('stressTestMode');

        const simulationTableBody = document.querySelector('#simulationTable tbody');
        const cumulativeVoucherPurchasesSpan = document.getElementById('cumulativeVoucherPurchases');
        const totalCashbackOwedAccruedSpan = document.getElementById('totalCashbackOwedAccrued');
        const totalCashbackPaidSpan = document.getElementById('totalCashbackPaid');
        const netFundPerformanceSpan = document.getElementById('netFundPerformance');
        const overallPayoutStatusSpan = document.getElementById('overallPayoutStatus');
        const chartCanvas = document.getElementById('simulationChart');
        let simulationChart; // To store the Chart.js instance

        // Daily Log DOM Elements
        const dailyLogMonthSelector = document.getElementById('dailyLogMonthSelector');
        const dailyLogTableBody = document.querySelector('#dailyLogTable tbody');

        let monthlySimulationResults = []; // Store results for daily log selection

        // --- Helper Functions ---

        /**
         * Formats a number as Jamaican Dollar currency.
         * @param {number} amount - The amount to format.
         * @returns {string} The formatted currency string.
         */
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-JM', {
                style: 'currency',
                currency: 'JMD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        };

        /**
         * Adds a specified number of days to a Date object.
         * @param {Date} date - The starting Date object.
         * @param {number} days - The number of days to add.
         * @returns {Date} A new Date object with the added days.
         */
        const addDays = (date, days) => {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        };

        /**
         * Gets the last day of the month for a given date.
         * @param {Date} date - The Date object.
         * @returns {Date} A new Date object representing the last day of the month.
         */
        const getEndOfMonth = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth();
            return new Date(year, month + 1, 0); // Day 0 of next month is last day of current month
        };

        /**
         * Generates a shuffled array of win/loss outcomes for a given number of trades.
         * Ensures the exact win rate is met.
         * @param {number} totalTrades - Total number of trades.
         * @param {number} winRatePercent - Win rate as a percentage (e.g., 60).
         * @returns {boolean[]} An array where true is a win, false is a loss.
         */
        const generateTradeOutcomes = (totalTrades, winRatePercent) => {
            const numWins = Math.round(totalTrades * (winRatePercent / 100));
            const numLosses = totalTrades - numWins;

            const outcomes = [];
            for (let i = 0; i < numWins; i++) {
                outcomes.push(true); // Win
            }
            for (let i = 0; i < numLosses; i++) {
                outcomes.push(false); // Loss
            }

            // Shuffle the array (Fisher-Yates algorithm)
            for (let i = outcomes.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [outcomes[i], outcomes[j]] = [outcomes[j], outcomes[i]];
            }
            return outcomes;
        };

        // --- Main Simulation Logic (Monthly) ---

        const runSimulation = () => {
            // 1. Read Input Parameters
            const selectedTier = membershipTierInput.value;
            const simulationStartDateString = simulationStartDateInput.value;
            const voucherValue = parseInt(voucherValueInput.value);
            const vouchersPerMonth = parseInt(vouchersPerMonthInput.value);
            const markupRate = parseFloat(markupRateInput.value) / 100; // Convert to decimal
            const markupAllocationToTradingFund = parseFloat(markupAllocationToTradingFundInput.value) / 100; // Convert to decimal
            let avgWeeklyWin = parseFloat(avgWeeklyWinInput.value) / 100; // Convert to decimal
            let maxWeeklyLoss = parseFloat(maxWeeklyLossInput.value) / 100; // Convert to decimal
            let winRate = parseFloat(winRateInput.value); // Percentage

            const isStressTestMode = stressTestModeCheckbox.checked;

            if (isStressTestMode) {
                // Apply stress test adjustments
                avgWeeklyWin *= 0.8; // Reduce average win by 20%
                maxWeeklyLoss *= 1.2; // Increase max loss by 20%
                winRate = Math.max(0, winRate - 10); // Reduce win rate by 10 percentage points, not below 0
            }

            const tierConfig = MEMBERSHIP_TIERS[selectedTier];
            const membershipFee = tierConfig.fee;
            const cashbackRate = tierConfig.cashbackRates[voucherValue];

            const monthlyVoucherSpend = voucherValue * vouchersPerMonth;
            const markupPerMonth = monthlyVoucherSpend * markupRate;
            const monthlyTradingFundContribution = markupPerMonth * markupAllocationToTradingFund;

            const membershipAllocationToTradingFund = 0.50; // 50%
            const oneTimeMembershipFundAddition = membershipFee * membershipAllocationToTradingFund;

            // Calculate the base initial fund for Month 1 as per problem statement
            const calculatedMonth1BaseContribution = monthlyTradingFundContribution + oneTimeMembershipFundAddition;

            // Determine the starting trading fund for Month 1
            // User's input overrides the calculated base if it's not 0.
            let currentTradingFund = parseFloat(initialTradingFundInput.value);
            if (currentTradingFund === 0) {
                 // If user input is 0, default to the problem statement's calculated initial fund.
                currentTradingFund = calculatedMonth1BaseContribution;
                // Update the input field to reflect this default value for transparency.
                initialTradingFundInput.value = currentTradingFund.toFixed(0);
            }

            // Parse Start Date
            let initialDate;
            if (simulationStartDateString) {
                const [year, month, day] = simulationStartDateString.split('-').map(Number);
                initialDate = new Date(year, month - 1, day);
                initialDate.setHours(0, 0, 0, 0);
            } else {
                initialDate = new Date();
                initialDate.setHours(0, 0, 0, 0);
                // Set default date to today's date if not already set
                const year = initialDate.getFullYear();
                const month = (initialDate.getMonth() + 1).toString().padStart(2, '0');
                const day = initialDate.getDate().toString().padStart(2, '0');
                simulationStartDateInput.value = `${year}-${month}-${day}`;
            }

            // --- Simulation Variables ---
            monthlySimulationResults = []; // Clear and re-initialize for monthly results
            let cumulativeVoucherPurchases = 0;
            let totalCashbackOwedAccrued = 0;
            let totalCashbackPaid = 0;
            let overallPayoutSuccess = true; // Assume success until a deficit occurs

            // --- Monthly Simulation Loop ---
            for (let monthIndex = 0; monthIndex < 12; monthIndex++) {
                const monthData = {};

                // Calculate Dates
                const purchaseDate = new Date(initialDate.getFullYear(), initialDate.getMonth() + monthIndex, initialDate.getDate());
                const cashbackDueDate = addDays(purchaseDate, PAYOUT_DELAY_DAYS);
                const payoutMonthEnd = getEndOfMonth(cashbackDueDate);

                monthData.month = monthIndex + 1;
                monthData.purchaseDate = purchaseDate;
                monthData.cashbackDueDate = cashbackDueDate;
                monthData.payoutMonthEnd = payoutMonthEnd;
                monthData.totalCashbackOwed = monthlyVoucherSpend * cashbackRate;
                monthData.cashbackAccruedThisMonth = monthData.totalCashbackOwed;

                let monthlyContributionForDisplay; // This variable is for table display only

                if (monthIndex === 0) {
                    // For the first month, the contribution is the sum of markup and membership allocation.
                    // The `currentTradingFund` already holds this as its starting value.
                    monthlyContributionForDisplay = calculatedMonth1BaseContribution;
                } else {
                    // For subsequent months, only the monthly markup allocation is added to the fund.
                    currentTradingFund += monthlyTradingFundContribution;
                    monthlyContributionForDisplay = monthlyTradingFundContribution;
                }
                monthData.monthlyFundContribution = monthlyContributionForDisplay; // Store for table display

                monthData.startingTradingCapital = currentTradingFund; // This is the capital *before* this month's trading

                // Simulate Weekly Trades (20 trades per month as per problem statement)
                const tradeOutcomes = generateTradeOutcomes(TRADING_WEEKS_PER_MONTH, winRate);
                monthData.weeklyTrades = [];
                let fundAfterTrades = currentTradingFund; // Start trading with this month's capital

                for (let week = 0; week < TRADING_WEEKS_PER_MONTH; week++) {
                    const isWin = tradeOutcomes[week];
                    let gainLossAmount;
                    if (isWin) {
                        gainLossAmount = fundAfterTrades * avgWeeklyWin;
                    } else {
                        gainLossAmount = -fundAfterTrades * maxWeeklyLoss;
                    }
                    fundAfterTrades += gainLossAmount;
                    monthData.weeklyTrades.push({
                        week: week + 1,
                        type: isWin ? 'Win' : 'Loss',
                        gainLoss: gainLossAmount
                    });
                }

                // fundAfterTrades now holds the capital after all trades for this month, *before* payouts.
                monthData.endingTradingCapitalBeforePayout = fundAfterTrades;

                // --- Handle Delayed Payouts ---
                monthData.cashbackToPayThisMonth = 0;
                monthData.surplusDeficit = 0;
                monthData.payoutMet = false;

                const payoutSourceMonthIndex = monthIndex - (Math.floor(PAYOUT_DELAY_DAYS / 30.4375)); // Approx months delay
                // If the payoutSourceMonthIndex is valid (i.e., we have data from that far back)
                if (payoutSourceMonthIndex >= 0 && monthlySimulationResults[payoutSourceMonthIndex]) {
                    const owedFromPast = monthlySimulationResults[payoutSourceMonthIndex].cashbackAccruedThisMonth;
                    monthData.cashbackToPayThisMonth = owedFromPast;

                    if (fundAfterTrades >= owedFromPast) {
                        fundAfterTrades -= owedFromPast; // Deduct payout from fund
                        totalCashbackPaid += owedFromPast;
                        monthData.surplusDeficit = fundAfterTrades; // Remaining fund after payout
                        monthData.payoutMet = true;
                    } else {
                        monthData.surplusDeficit = fundAfterTrades - owedFromPast; // Negative value for deficit
                        overallPayoutSuccess = false; // Mark overall status as failed
                        // If fund isn't enough, pay what's available and note the shortfall
                        totalCashbackPaid += fundAfterTrades; // Pay what's available
                        fundAfterTrades = 0; // Fund is depleted
                        monthData.payoutMet = false;
                    }
                }

                monthData.endingTradingCapital = fundAfterTrades; // Final ending capital for the month
                // This `currentTradingFund` will be the starting point for the *next* month's calculation
                // (before adding the next month's `monthlyTradingFundContribution` if monthIndex > 0).
                currentTradingFund = monthData.endingTradingCapital;

                monthlySimulationResults.push(monthData);

                // Update Cumulative Summaries
                cumulativeVoucherPurchases += monthlyVoucherSpend;
                totalCashbackOwedAccrued += monthData.cashbackAccruedThisMonth;
            }

            // --- Update UI ---
            updateTable(monthlySimulationResults);
            updateSummary(cumulativeVoucherPurchases, totalCashbackOwedAccrued, totalCashbackPaid, currentTradingFund, overallPayoutSuccess);
            updateChart(monthlySimulationResults);
            populateDailyLogDropdown(monthlySimulationResults); // Populate dropdown after monthly sim
            // Automatically run daily simulation for the first month
            if (monthlySimulationResults.length > 0) {
                dailyLogMonthSelector.value = 0; // Select the first month by default
                runDailySimulation(0); // Run daily sim for the first month
            }
        };

        /**
         * Updates the simulation results table.
         * @param {Array<Object>} results - The array of monthly simulation data.
         */
        const updateTable = (results) => {
            simulationTableBody.innerHTML = ''; // Clear existing rows

            results.forEach(data => {
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${data.month}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${data.purchaseDate.toLocaleDateString('en-JM', { day: 'numeric', month: 'short', year: 'numeric' })}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${data.cashbackDueDate.toLocaleDateString('en-JM', { day: 'numeric', month: 'short', year: 'numeric' })}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${data.payoutMonthEnd.toLocaleDateString('en-JM', { day: 'numeric', month: 'short', year: 'numeric' })}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${formatCurrency(data.totalCashbackOwed)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${formatCurrency(data.startingTradingCapital)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${formatCurrency(data.monthlyFundContribution)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${formatCurrency(data.endingTradingCapital)}</td>
                        <td class="px-6 py-4 whitespace-nowrap ${data.surplusDeficit >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(data.surplusDeficit)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="${data.payoutMet ? 'text-green-600' : (data.cashbackToPayThisMonth > 0 ? 'text-red-600' : 'text-orange-600')}">
                                ${data.cashbackToPayThisMonth > 0 ? (data.payoutMet ? 'Met' : 'Shortfall') : 'N/A'}
                            </span>
                        </td>
                    </tr>
                `;
                simulationTableBody.insertAdjacentHTML('beforeend', row);
            });
        };

        /**
         * Updates the summary section.
         * @param {number} cumulativeVoucherPurchases - Total voucher purchases.
         * @param {number} totalCashbackOwedAccrued - Total cashback accrued.
         * @param {number} totalCashbackPaid - Total cashback actually paid out.
         * @param {number} finalTradingFund - The trading fund at the end of the simulation.
         * @param {boolean} overallPayoutSuccess - Whether all payouts were met.
         */
        const updateSummary = (cumulativeVoucherPurchases, totalCashbackOwedAccrued, totalCashbackPaid, finalTradingFund, overallPayoutSuccess) => {
            cumulativeVoucherPurchasesSpan.textContent = formatCurrency(cumulativeVoucherPurchases);
            totalCashbackOwedAccruedSpan.textContent = formatCurrency(totalCashbackOwedAccrued);
            totalCashbackPaidSpan.textContent = formatCurrency(totalCashbackPaid);
            netFundPerformanceSpan.textContent = formatCurrency(finalTradingFund);
            netFundPerformanceSpan.classList.toggle('text-green-600', finalTradingFund >= 0);
            netFundPerformanceSpan.classList.toggle('text-red-600', finalTradingFund < 0);

            if (overallPayoutSuccess) {
                overallPayoutStatusSpan.textContent = 'All Payouts Met';
                overallPayoutStatusSpan.className = 'font-bold text-green-600';
            } else {
                overallPayoutStatusSpan.textContent = 'Payout Shortfall Occurred';
                overallPayoutStatusSpan.className = 'font-bold text-red-600';
            }
        };

        /**
         * Updates or creates the Chart.js graph.
         * @param {Array<Object>} results - The array of monthly simulation data.
         */
        const updateChart = (results) => {
            const labels = results.map(data => `Month ${data.month}`);
            const tradingFundData = results.map(data => data.endingTradingCapital);
            const cashbackOwedData = results.map(data => data.cashbackAccruedThisMonth);

            if (simulationChart) {
                simulationChart.destroy(); // Destroy existing chart before creating a new one
            }

            simulationChart = new Chart(chartCanvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ending Trading Capital',
                            data: tradingFundData,
                            borderColor: '#3b82f6', // Tailwind blue-500
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: 'Cashback Owed (Accrued Monthly)',
                            data: cashbackOwedData,
                            borderColor: '#8b5cf6', // Tailwind purple-500
                            backgroundColor: 'rgba(139, 92, 246, 0.2)',
                            fill: true,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (J$)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Trading Fund vs. Cashback Owed Over 12 Months',
                            font: {
                                size: 18
                            }
                        }
                    }
                }
            });
        };

        // --- Daily Simulation Logic ---

        /**
         * Populates the dropdown for selecting a month for the daily log.
         * @param {Array<Object>} results - The array of monthly simulation data.
         */
        const populateDailyLogDropdown = (results) => {
            dailyLogMonthSelector.innerHTML = ''; // Clear existing options
            results.forEach((data, index) => {
                const option = document.createElement('option');
                option.value = index; // Store the index of the month in the results array
                option.textContent = `Month ${data.month} (Purchase: ${data.purchaseDate.toLocaleDateString('en-JM', { month: 'short', day: 'numeric', year: 'numeric' })})`;
                dailyLogMonthSelector.appendChild(option);
            });
        };

        /**
         * Runs the daily simulation for a selected 121-day period.
         * @param {number} selectedMonthIndex - The index of the month from monthlySimulationResults to simulate daily.
         */
        const runDailySimulation = (selectedMonthIndex) => {
            dailyLogTableBody.innerHTML = ''; // Clear existing rows

            if (selectedMonthIndex === undefined || monthlySimulationResults.length === 0) {
                return; // No data to simulate
            }

            const monthData = monthlySimulationResults[selectedMonthIndex];
            const startDateForDailyLog = new Date(monthData.purchaseDate);
            const endDateForDailyLog = addDays(startDateForDailyLog, PAYOUT_DELAY_DAYS - 1); // -1 because it's 121 *days* including start

            // Parameters for daily trading
            let currentDailyCapital = monthData.startingTradingCapital; // Start with the capital at the beginning of the selected purchase month
            const avgWeeklyWin = parseFloat(avgWeeklyWinInput.value) / 100;
            const maxWeeklyLoss = parseFloat(maxWeeklyLossInput.value) / 100;
            const winRate = parseFloat(winRateInput.value);

            // Generate all trade outcomes for the 121-day period
            const tradeOutcomes = generateTradeOutcomes(TOTAL_TRADES_FOR_DAILY_LOG, winRate);
            const tradingDaysWithTrades = new Set(); // Stores dates where a trade will occur

            const allTradingDaysInPeriod = [];
            let tempDate = new Date(startDateForDailyLog);
            while (tempDate <= endDateForDailyLog) {
                const dayOfWeek = tempDate.getDay(); // 0 = Sunday, 6 = Saturday
                if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Is a weekday
                    allTradingDaysInPeriod.push(new Date(tempDate)); // Store a copy
                }
                tempDate.setDate(tempDate.getDate() + 1);
            }

            // Randomly select days for trades
            const shuffledTradingDays = [...allTradingDaysInPeriod].sort(() => 0.5 - Math.random());
            for (let i = 0; i < Math.min(TOTAL_TRADES_FOR_DAILY_LOG, shuffledTradingDays.length); i++) {
                tradingDaysWithTrades.add(shuffledTradingDays[i].toDateString()); // Use date string for easy lookup
            }

            let dayCounter = 1;
            tempDate = new Date(startDateForDailyLog);
            let currentMonth = tempDate.getMonth(); // Track current month for contributions

            while (tempDate <= endDateForDailyLog) {
                const dayOfWeek = tempDate.getDay();
                const isTradingDay = (dayOfWeek !== 0 && dayOfWeek !== 6); // Exclude weekends
                let tradeOccurred = false;
                let tradeOutcome = 'N/A';
                let gainLossAmount = 0;
                let capitalBeforeTrade = currentDailyCapital;

                // Apply monthly contribution on the first day of each new month within the 121-day cycle
                if (tempDate.getDate() === 1 && tempDate.getMonth() !== currentMonth) {
                    currentDailyCapital += monthlySimulationResults[0].monthlyFundContribution; // Use the standard monthly contribution (J$1,700 or first month's full contribution)
                    capitalBeforeTrade = currentDailyCapital; // Update capital before trade for this specific day
                    currentMonth = tempDate.getMonth();
                }


                if (isTradingDay && tradingDaysWithTrades.has(tempDate.toDateString())) {
                    tradeOccurred = true;
                    const isWin = tradeOutcomes.pop(); // Get a trade outcome
                    if (isWin) {
                        gainLossAmount = currentDailyCapital * avgWeeklyWin;
                        tradeOutcome = 'Win';
                    } else {
                        gainLossAmount = -currentDailyCapital * maxWeeklyLoss;
                        tradeOutcome = 'Loss';
                    }
                    currentDailyCapital += gainLossAmount;
                }

                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${dayCounter}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${tempDate.toLocaleDateString('en-JM', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${tempDate.toLocaleDateString('en-JM', { weekday: 'short' })}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${isTradingDay ? 'Yes' : 'No'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${tradeOccurred ? 'Yes' : 'No'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="${tradeOutcome === 'Win' ? 'text-green-600' : (tradeOutcome === 'Loss' ? 'text-red-600' : 'text-gray-500')}">
                                ${tradeOutcome}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap ${gainLossAmount >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(gainLossAmount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${formatCurrency(capitalBeforeTrade)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${formatCurrency(currentDailyCapital)}</td>
                    </tr>
                `;
                dailyLogTableBody.insertAdjacentHTML('beforeend', row);

                tempDate.setDate(tempDate.getDate() + 1); // Move to the next day
                dayCounter++;
            }
        };


        // --- Event Listeners and Initial Setup ---

        // Attach event listeners to all input fields to re-run simulation
        membershipTierInput.addEventListener('change', runSimulation);
        simulationStartDateInput.addEventListener('change', runSimulation);
        voucherValueInput.addEventListener('change', runSimulation);
        vouchersPerMonthInput.addEventListener('input', runSimulation);
        markupRateInput.addEventListener('input', runSimulation);
        markupAllocationToTradingFundInput.addEventListener('input', runSimulation);
        initialTradingFundInput.addEventListener('input', runSimulation);
        avgWeeklyWinInput.addEventListener('input', runSimulation);
        maxWeeklyLossInput.addEventListener('input', runSimulation);
        winRateInput.addEventListener('input', runSimulation);
        stressTestModeCheckbox.addEventListener('change', runSimulation);

        // Event listener for daily log month selection
        dailyLogMonthSelector.addEventListener('change', (event) => {
            runDailySimulation(parseInt(event.target.value));
        });

        // Set default start date to today
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            simulationStartDateInput.value = `${year}-${month}-${day}`;

            // Initial run of simulation and also set the default initialTradingFund based on premium tier
            // This ensures the problem statement's default of J$5,900 for Premium is reflected.
            const selectedTier = membershipTierInput.value;
            const tierConfig = MEMBERSHIP_TIERS[selectedTier];
            const monthlyVoucherSpend = parseInt(voucherValueInput.value) * parseInt(vouchersPerMonthInput.value);
            const markupPerMonth = monthlyVoucherSpend * (parseFloat(markupRateInput.value) / 100);
            const monthlyTradingFundContribution = markupPerMonth * (parseFloat(markupAllocationToTradingFundInput.value) / 100);
            const oneTimeMembershipFundAddition = tierConfig.fee * 0.50; // 50% allocation

            const currentInitialFundValue = parseFloat(initialTradingFundInput.value);

            if (selectedTier === 'Premium' && (isNaN(currentInitialFundValue) || currentInitialFundValue === 0)) {
                initialTradingFundInput.value = (monthlyTradingFundContribution + oneTimeMembershipFundAddition).toFixed(0);
            } else if (selectedTier !== 'Premium' && (isNaN(currentInitialFundValue) || currentInitialFundValue === 0)) {
                initialTradingFundInput.value = 0;
            }

            runSimulation(); // Run simulation on initial page load
        });

        // Update parameters based on membership tier selection
        membershipTierInput.addEventListener('change', () => {
            const selectedTier = membershipTierInput.value;
            const tierConfig = MEMBERSHIP_TIERS[selectedTier];

            // Recalculate monthly contributions to set the default initialTradingFund value
            const monthlyVoucherSpend = parseInt(voucherValueInput.value) * parseInt(vouchersPerMonthInput.value);
            const markupPerMonth = monthlyVoucherSpend * (parseFloat(markupRateInput.value) / 100);
            const monthlyTradingFundContribution = markupPerMonth * (parseFloat(markupAllocationToTradingFundInput.value) / 100);
            const oneTimeMembershipFundAddition = tierConfig.fee * 0.50; // 50% allocation

            const currentInitialFundValue = parseFloat(initialTradingFundInput.value);

            if (selectedTier === 'Premium' && (isNaN(currentInitialFundValue) || currentInitialFundValue === 0)) {
                initialTradingFundInput.value = (monthlyTradingFundContribution + oneTimeMembershipFundAddition).toFixed(0);
            } else if (selectedTier !== 'Premium' && (isNaN(currentInitialFundValue) || currentInitialFundValue === 0)) {
                initialTradingFundInput.value = 0;
            }

            runSimulation();
        });
    </script>
</body>
</html>
