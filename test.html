<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<style>
  * {
    box-sizing: border-box;
  }

  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    background: #000;
    overflow: hidden;
    font-family: Arial, sans-serif;
    overscroll-behavior: none;
  }

  .swiper {
    width: 100vw;
    height: 100vh;
  }

  .swiper-slide {
    background-size: cover;
    background-position: center;
    position: relative;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    z-index: 40;
  }

  .slide-overlay {
    position: absolute;
    bottom: 0;
    width: 100%;
    padding: 1rem;
    background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
    color: white;
    text-align: center;
    z-index: 50;
  }

  .slide-title {
    font-size: 5rem;
    font-weight: bold;
    text-transform: capitalize;
  }

  .slide-desc {
    font-size: 3.5rem;
    margin-top: 0.5rem;
  }

  .headline-slide .slide-title {
    font-size: 5rem;
    font-weight: 800;
    text-transform: uppercase;
    font-family: 'Oswald', sans-serif;
    letter-spacing: 0.05em;
    margin-bottom: 40%;
  }

  .headline-slide {
    align-items: center !important;
    justify-content: center !important;
  }

  .cta-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 0.75rem;
  }

  .cta-button {
    padding: 0.75rem 1rem;
    border-radius: 10px;
    font-weight: bold;
    font-size: 3rem;
    text-decoration: none;
    cursor: pointer;
    color: #000;
    z-index: 30;
    position: relative;
    flex: 1 1 auto;
    max-width: 45%;
  }

  .cta-link-button {
    background: #FFD700;
  }

  .cta-jump-button {
    background: #FF0000;
    color: #fff;
  }

  .progress-bar {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    display: flex;
    gap: 4px;
    padding: 10px;
    z-index: 10;
  }

  .progress-segment {
    flex: 1;
    height: 4px;
    background: rgba(255, 255, 255, 0.25);
    border-radius: 2px;
    overflow: hidden;
    backdrop-filter: brightness(0.9);
  }

  .progress-fill {
    height: 100%;
    width: 0%;
    background: white;
    box-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
    transition: width 0.3s ease;
  }

  .tap-zone {
    position: absolute;
    width: 20%;
    height: 100%;
    top: 0;
    z-index: 20;
  }

  .tap-left { left: 0; }
  .tap-right { right: 0; }

  .sponsored-label {
    position: absolute;
    top: 20px;
    right: 10px;
    background: rgba(255, 255, 255, 0.25);
    padding: 4px 8px;
    font-size: 3.5rem;
    color: #fff;
    border-radius: 4px;
    z-index: 10;
  }

  .brand-logo {
    position: absolute;
    top: 20px;
    left: 10px;
    height: 84px;
    width: auto;
    border-radius: 6px;
    z-index: 10;
  }

  /* New styles for the story menu */
  #storyMenu {
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    width: 300px;
    background: #111;
    overflow-y: auto;
    padding: 1rem;
    box-shadow: 2px 0 10px rgba(0,0,0,0.7);
    z-index: 1000;
    display: none; /* hidden initially */
    color: white;
  }

  #storyMenu h2 {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    text-align: center;
  }

  #storyMenu .close-menu {
    display: block;
    text-align: center;
    margin-bottom: 1rem;
    font-size: 2rem;
    cursor: pointer;
    color: #ff4444;
  }

  #storyMenu ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  #storyMenu li {
    margin-bottom: 1rem;
    cursor: pointer;
    font-size: 1.8rem;
    padding: 0.5rem;
    border-radius: 6px;
    transition: background 0.2s;
  }

  #storyMenu li:hover {
    background: #444;
  }

  /* Button for opening story menu */
  #openStoryMenuBtn {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1100;
    padding: 1rem 2rem;
    font-size: 2rem;
    background: #FFD700;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    user-select: none;
  }
</style>

<button id="openStoryMenuBtn">View All Stories</button>

<div id="storyMenu">
  <div class="close-menu" id="closeStoryMenuBtn">âœ• Close</div>
  <h2>All Stories</h2>
  <ul id="storyList"></ul>
</div>

<div class="swiper">
  <div class="swiper-wrapper" id="storyWrapper"></div>
  <div class="progress-bar" id="progressBar"></div>
  <div class="tap-zone tap-left" id="tapLeft"></div>
  <div class="tap-zone tap-right" id="tapRight"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
  const sheetURL = 'https://opensheet.elk.sh/1_DyGLoYi5ndEkiwhPEzJhMc3vciIFNhN2g-H0gbVRds/sheet7';
  let allData = [];
  let sequenceRanges = [];
  let swiper;
  let storyMap = {};

  async function fetchStories() {
    const res = await fetch(sheetURL);
    const data = await res.json();
    allData = data;
  }

  function findSequences() {
    sequenceRanges = [];
    let currentSequence = '';
    let currentStartIndex = 0;
    storyMap = {};

    allData.forEach((story, index) => {
      if (parseInt(story['Slide #']) === 1 && story['Story Title']) {
        if (currentSequence) {
          sequenceRanges.push({ title: currentSequence, start: currentStartIndex, end: index - 1 });
        }
        currentSequence = story['Story Title'].trim();
        currentStartIndex = index;
        storyMap[currentSequence] = index;
      }
    });
    if (currentSequence) {
      sequenceRanges.push({ title: currentSequence, start: currentStartIndex, end: allData.length - 1 });
    }
  }

  // Render vertical story menu with clickable headlines
  function renderStoryMenu() {
    const storyList = document.getElementById('storyList');
    storyList.innerHTML = '';

    sequenceRanges.forEach((seq, i) => {
      const li = document.createElement('li');
      li.textContent = seq.title;
      li.tabIndex = 0;
      li.setAttribute('role', 'button');
      li.addEventListener('click', () => {
        closeStoryMenu();
        loadSequence(i);
      });
      li.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          closeStoryMenu();
          loadSequence(i);
        }
      });
      storyList.appendChild(li);
    });
  }

  // Show story menu overlay
  function openStoryMenu() {
    document.getElementById('storyMenu').style.display = 'block';
    document.getElementById('openStoryMenuBtn').style.display = 'none';
  }

  // Hide story menu overlay
  function closeStoryMenu() {
    document.getElementById('storyMenu').style.display = 'none';
    document.getElementById('openStoryMenuBtn').style.display = 'block';
  }

  // Initialize or update swiper with selected sequence slides
  function loadSequence(sequenceIndex) {
    const seq = sequenceRanges[sequenceIndex];
    if (!seq) return;

    const slides = allData.slice(seq.start, seq.end + 1);

    const wrapper = document.getElementById('storyWrapper');
    wrapper.innerHTML = '';

    slides.forEach((slide) => {
      const slideEl = document.createElement('div');
      slideEl.className = 'swiper-slide';

      // Add background image if present
      if (slide['Image URL']) {
        slideEl.style.backgroundImage = `url('${slide['Image URL']}')`;
      } else {
        slideEl.style.backgroundColor = '#111';
      }

      if (slide['Slide #'] === '1') {
        slideEl.classList.add('headline-slide');
        slideEl.innerHTML = `<div class="slide-overlay"><h1 class="slide-title">${slide['Headline'] || slide['Story Title']}</h1></div>`;
      } else {
        slideEl.innerHTML = `
          <div class="slide-overlay">
            <h2 class="slide-title">${slide['Headline'] || ''}</h2>
            <p class="slide-desc">${slide['Copy'] || ''}</p>
            ${slide['CTAs'] ? createCTAs(slide['CTAs']) : ''}
          </div>
        `;
      }

      wrapper.appendChild(slideEl);
    });

    if (swiper) {
      swiper.destroy(true, true);
    }
    swiper = new Swiper('.swiper', {
      direction: 'horizontal',
      loop: false,
      simulateTouch: false,
      allowTouchMove: true,
      on: {
        slideChange: updateProgressBar,
      },
    });

    updateProgressBar();
  }

  function createCTAs(ctas) {
    try {
      const ctasData = JSON.parse(ctas);
      if (!Array.isArray(ctasData)) return '';
      const ctasHtml = ctasData.map(cta => {
        return `<a href="${cta.link}" target="_blank" class="cta-button cta-link-button">${cta.label}</a>`;
      }).join('');
      return `<div class="cta-container">${ctasHtml}</div>`;
    } catch {
      return '';
    }
  }

  function updateProgressBar() {
    const bar = document.getElementById('progressBar');
    if (!swiper) return;
    const total = swiper.slides.length;
    bar.innerHTML = '';
    for (let i = 0; i < total; i++) {
      const segment = document.createElement('div');
      segment.className = 'progress-segment';
      const fill = document.createElement('div');
      fill.className = 'progress-fill';
      if (i <= swiper.activeIndex) fill.style.width = '100%';
      segment.appendChild(fill);
      bar.appendChild(segment);
    }
  }

  // Set up tap zones for navigation
  document.getElementById('tapLeft').addEventListener('click', () => {
    if (swiper) swiper.slidePrev();
  });

  document.getElementById('tapRight').addEventListener('click', () => {
    if (swiper) swiper.slideNext();
  });

  // Setup open/close story menu buttons
  document.getElementById('openStoryMenuBtn').addEventListener('click', openStoryMenu);
  document.getElementById('closeStoryMenuBtn').addEventListener('click', closeStoryMenu);

  // Initialization: fetch stories, find sequences, render first sequence and menu
  async function init() {
    await fetchStories();
    findSequences();
    renderStoryMenu();
    loadSequence(0);
  }

  init();
</script>
