<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Allpree Barcode Scanner</title>
  <style>
 body {
  font-family: system-ui, sans-serif;
  max-width: 400px;
  margin: 2rem auto;
  padding: 1rem;
}

.centered-content {
  text-align: center;
}

.centered-content img {
  max-width: 100%;
  height: auto;
  margin: 0 auto 10px; /* center horizontally */
}

.form-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
}

input, button {
  padding: 0.75rem 1rem;
  font-size: 1rem;
  width: 80%;
  margin: 0.5rem 0;
  border: 1px solid #ccc;
  border-radius: 8px;
  box-sizing: border-box;
}

input:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0,123,255,0.2);
}

#product-info img {
  max-width: 150px;
  display: block;
  margin: 0 auto 10px; /* center horizontally */
}

#manual-entry {
  display: none;
  margin-top: 1rem;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  width: 100%;  /* Make sure it spans the width */
  padding: 1rem;
}
 #loading-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      display: none;
    }

    #loading-spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #333;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

  </style>
  

</head>
<body>

<div class="form-wrapper">
 <h2> Enter Barcode Below</h2>


    <input type="text" id="barcode" placeholder="Enter Barcode" />
    <button onclick="lookupProduct()">Lookup Product</button>
  

  <!-- Product Info -->
  <div id="product-info"></div>

 <!-- Manual Entry Form -->
<div id="manual-entry">
  <h3>Add New Product</h3>
  <input type="text" id="name" placeholder="Product Name" />
  <input type="text" id="brand" placeholder="Brand" />
  <input type="text" id="size" placeholder="Size (e.g., 500ml)" />
  
  <!-- File upload input (hidden) -->
  <input type="file" id="imageInput" style="display:none;" />
  
  <!-- Save product button (triggers image upload + save action) -->
  <button id="save-button" onclick="saveProduct()" disabled>ðŸ’¾ Save Product</button>
</div>

<!-- Refresh Button -->
<button id="refresh-button" style="display: none;" onclick="refreshProduct()">ðŸ”„ Refresh Product</button>

<!-- Fullscreen loading spinner -->
<div id="loading-modal">
  <div id="loading-spinner"></div>
  <p>Loading product data...</p>
</div>

<iframe name="hidden_iframe" id="hidden_iframe" style="display:none;" onload="if(submitted) { alert('âœ… Product added!'); submitted = false; location.reload(); }"></iframe>

<script>
  let submitted = false;

  // Enable/disable Save button based on name, brand, size
  function checkSaveButtonState() {
    const name = document.getElementById('name').value.trim();
    const brand = document.getElementById('brand').value.trim();
    const size = document.getElementById('size').value.trim();
    const saveButton = document.getElementById('save-button');
    saveButton.disabled = !(name && brand && size);
  }

  document.addEventListener('DOMContentLoaded', () => {
    const nameInput = document.getElementById('name');
    const brandInput = document.getElementById('brand');
    const sizeInput = document.getElementById('size');

    nameInput.addEventListener('input', checkSaveButtonState);
    brandInput.addEventListener('input', checkSaveButtonState);
    sizeInput.addEventListener('input', checkSaveButtonState);

    checkSaveButtonState();
  });

  // Save product to Google Form with loading spinner
  async function saveProduct() {
    // Show loading spinner
    document.getElementById('loading-modal').style.display = 'flex';

    submitted = true;
    const code = document.getElementById('barcode').value.trim();
    const imageInput = document.getElementById('imageInput');
    const file = imageInput.files[0];
    
    // If there's a file, upload it first
    let imageUrl = '';
    if (file) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('fileName', file.name); // Needed for GitHub upload

      try {
        const res = await fetch('https://red-silence-79af.allpree.workers.dev/', {
          method: 'POST',
          body: formData
        });

        if (res.ok) {
          const result = await res.json();
          imageUrl = result.url;
        } else {
          throw new Error('Upload failed');
        }
      } catch (err) {
        alert('Image upload failed: ' + err.message);
        return;  // Stop if upload fails
      }
    }

    // Continue with product form submission
    const form = document.createElement('form');
    form.action = 'https://docs.google.com/forms/u/0/d/e/1FAIpQLScAPQDqtzTK3xXQAIbZV_XcO-8quOqn4pcLSuzOEGwnc5IL1Q/formResponse';
    form.method = 'POST';
    form.target = "hidden_iframe";
    
    const barcodeInput = document.createElement('input');
    barcodeInput.type = 'hidden';
    barcodeInput.name = 'entry.704671786';
    barcodeInput.value = code;
    form.appendChild(barcodeInput);

    const nameInput = document.createElement('input');
    nameInput.type = 'hidden';
    nameInput.name = 'entry.776500300';
    nameInput.value = document.getElementById('name').value.trim();
    form.appendChild(nameInput);

    const brandInput = document.createElement('input');
    brandInput.type = 'hidden';
    brandInput.name = 'entry.1276633099';
    brandInput.value = document.getElementById('brand').value.trim();
    form.appendChild(brandInput);

    const sizeInput = document.createElement('input');
    sizeInput.type = 'hidden';
    sizeInput.name = 'entry.875936883';
    sizeInput.value = document.getElementById('size').value.trim();
    form.appendChild(sizeInput);

    const imageInputHidden = document.createElement('input');
    imageInputHidden.type = 'hidden';
    imageInputHidden.name = 'entry.1939692918';
    imageInputHidden.value = imageUrl;
    form.appendChild(imageInputHidden);

    document.body.appendChild(form);
    form.submit();

    // Hide the spinner with a slight delay after form submission
    setTimeout(() => {
      document.getElementById('loading-modal').style.display = 'none';
    }, 2000); // Adjust the delay as needed to ensure spinner is visible during submission
    
    // Clear input fields after submission
    document.getElementById('barcode').value = '';
    document.getElementById('name').value = '';
    document.getElementById('brand').value = '';
    document.getElementById('size').value = '';
    document.getElementById('save-button').disabled = true;
  }

  // Refresh product function - start from scratch
  function refreshProduct() {
    // Clear barcode input field
    document.getElementById('barcode').value = '';
    
    // Clear product info display
    document.getElementById('product-info').innerHTML = '';
    
    // Hide product info and manual entry form
    document.getElementById('manual-entry').style.display = 'none';
    
    // Hide the refresh button again
    document.getElementById('refresh-button').style.display = 'none';
    
    // Reset the loading spinner and hide it
    document.getElementById('loading-modal').style.display = 'none';

    // Optionally, if you want to reset the save button as well
    document.getElementById('save-button').disabled = true;
    
    // Optionally focus on the barcode input to re-enter barcode
    document.getElementById('barcode').focus();
  }
</script>

 
</body>
</html>
