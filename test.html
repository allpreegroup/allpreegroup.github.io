<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Invitation Sign-Up</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    .hidden { display: none; }
    .form-section, .invite-section {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
    }
    button {
      padding: 10px 20px;
      background: green;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:disabled { background: grey; }
    .error { color: red; }
    .one_of_the_boxes { margin-bottom: 15px; }
    .col-md-6 {
      width: 48%;
      display: inline-block;
      vertical-align: top;
    }
    .icon_box { margin-bottom: 5px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/crs-country-js@1.0.4/crs-country.min.js"></script>
</head>
<body>

<div class="invite-section">
  <h2>Enter Invitation Code</h2>
  <input type="text" id="inviteCodeInput" placeholder="Enter your code (e.g. J388640)" required />
  <button id="validateBtn">Continue</button>
  <p class="error" id="inviteError" style="display:none;">Invalid invitation code. Please try again.</p>
</div>

<div class="form-section hidden" id="signupFormSection">
  <h2>Sign Up</h2>
  <form id="signupForm" target="hidden_iframe" onsubmit="submitted=true" action="https://docs.google.com/forms/u/0/d/e/1FAIpQLSfw0Sts9wFjaExeOLWxUGAhdrEbfMEE2n6kh430bFqb0xKO2w/formResponse" method="post">

    <!-- Auto-fill from invite -->
    <input type="hidden" name="entry.1092645840" id="field_ID">
    <input type="hidden" name="entry.2034350499" id="field_Code">

    <!-- User inputs -->
    <input type="text" name="entry.1502543154" placeholder="First Name" required>
    <input type="text" name="entry.166208811" placeholder="Last Name" required>
    <input type="email" name="emailAddress" placeholder="Email Address" required>

    <input type="tel" name="entry.1897494140" id="whatsappNumber" placeholder="WhatsApp Number (+1876...)" required>
    <small style="color: gray;">Enter your WhatsApp number. It will auto-format to start with +1876.</small>

    <select name="entry.208508536" required>
      <option value="">Select Gender</option>
      <option>Male</option>
      <option>Female</option>
    </select>

    <select name="entry.577240945" required>
      <option value="">Birth Year</option>
      <script>
        const yearSelect = new Date().getFullYear();
        for (let y = yearSelect - 50; y <= yearSelect - 10; y++) {
          document.write(`<option>${y}</option>`);
        }
      </script>
    </select>

    <!-- Country & Region -->
    <div class="col-md-6">
      <div class="one_of_the_boxes">
        <div class="icon_box country-icon"></div>
        <select name="entry.1890405601" class="crs-country" data-whitelist="JM" data-blacklist="CD,CG,SH,GS" data-region-id="seven"></select>
      </div>
    </div>
    <div class="col-md-6">
      <div class="one_of_the_boxes">
        <div class="icon_box location"></div>
        <select name="entry.341957417" id="seven" data-default-value=""></select>
      </div>
    </div>

    <br style="clear:both;">
    <button type="submit">Agree and Continue</button>
  </form>
</div>

<iframe name="hidden_iframe" id="hidden_iframe" style="display:none;" onload="if(submitted){ window.location='/thankyou/'; }"></iframe>

<script>
  let submitted = false;

  document.getElementById('validateBtn').onclick = async () => {
    const code = document.getElementById('inviteCodeInput').value.trim().toUpperCase();
    const errorText = document.getElementById('inviteError');
    if (!code) return;

    try {
      const res = await fetch("https://opensheet.elk.sh/169KgT37g1HPVkzH-NLmANR4wAByHtLy03y5bnjQA21o/appdata");
      const data = await res.json();
      const match = data.find(row => row["ID CODE"]?.toUpperCase() === code);

      if (match) {
        document.getElementById('field_ID').value = `ID ${code}`;
        document.getElementById('field_Code').value = code;
        document.getElementById('signupFormSection').classList.remove('hidden');
        document.querySelector('.invite-section').classList.add('hidden');
        errorText.style.display = "none";
      } else {
        errorText.style.display = "block";
      }
    } catch (e) {
      console.error("Error checking code:", e);
      errorText.style.display = "block";
    }
  };

  // WhatsApp phone number formatter
  const phoneInput = document.getElementById("whatsappNumber");
  phoneInput.addEventListener("input", () => {
    let raw = phoneInput.value.replace(/\D/g, "");
    if (!raw.startsWith("1876")) {
      raw = "1876" + raw.replace(/^1876/, "");
    }
    phoneInput.value = `+${raw}`;
  });
</script>

</body>
</html>
