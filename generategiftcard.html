
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f9f9f9;
        }
        form {
  margin-top: 20px;
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

input {
  padding: 8px;
  margin-top: 10px;
  width: 200px;
  font-size: 1em;
  border-radius: 5px;
  border: 1px solid #ccc;
}

button {
  padding: 10px 20px;
  margin-top: 10px;
  background-color: #28a745;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

button:hover {
  background-color: #218838;
}
.flyer {
  margin: 0px auto;
  display: inline-block;
  
	
}

.flyer-wrapper {
  position: relative;
  display: inline-block;
	
}

.flyer-img {
  width: 100%;
  height: auto;
  border-radius: 0;
}

.code-overlay {
  position: absolute;
    left: 50%;
    transform: translateX(-50%);
    bottom: 30%; /* ← Tweak this number to match your design */
    
    font-weight: bold;
    font-size: 1.1em;
    color: black;
    padding: 6px 12px;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.8);
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    max-width: 90%;
    white-space: nowrap;
    text-align: center;
}
.flyer-qr {
  position: absolute;
  top: 39%; /* Adjust this value to position the QR code where you want on the flyer */
  left: 50%;
  transform: translateX(-50%);
  width: 150px; /* Set size of QR code */
  height: auto;
}

    </style>

	
	<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J2Z2P5DQPN"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-J2Z2P5DQPN');
</script>

<link rel="manifest" href="https://www.allpree.com/manifest.json">
<script>
    if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("https://www.allpree.com/service-worker.js")
            .then(() => console.log("Service Worker Registered"))
            .catch((error) => console.log("Service Worker Registration Failed", error));
    }
</script>	
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

	
<!-- Hidden until referral code is generated -->

<div class="flyer" id="flyer1" style="display: none;">
  <div class="flyer-wrapper">
    <img src="https://www.allpree.com/img/qrcodebg.png" alt="Flyer 1" class="flyer-img" />
	  <img id="flyerQRCode" class="flyer-qr" style="display: none;" /> 
    <div class="code-overlay" id="flyerCodeOverlay">
	
    </div>
	 
 
  </div></div>
		

			
<center> <form id="redirectForm" autocomplete="off">
    <!-- Dummy fields to confuse autofill -->
    <!-- Your actual form fields -->
    <input type="text" id="code" name="code" placeholder="eGift Card Number" autocomplete="on" />
    <input type="password" id="pin" name="pin" placeholder="eGift Card PIN" autocomplete="new-password" />

    <button class="btn btn-outline btn-xla" id="mc-embedded-subscribe" type="submit">Generate Your Gift Card</button>
</form> </center>

<hr> <center> 
	<p id="countdownMsg" style="display: none;"></p>
<button style="display: none;" class="btn btn-outline btn-xla" id="downloadBtn"><i class="fa-solid fa-computer-mouse"></i> Download Your Gift Card</button><br>
<p id="downloadNote" style="display: none;">
  We recommend that you download your digital card and keep it safe to use when there is no internet connection
</p>
</center>
<hr>
	<center> 		
<button type="button" id="clearBtn" style="display: none;"> Clear And Start Over If Mistake Was Made </button>
	</center><br>	
<script>
const form = document.getElementById("redirectForm");
const flyer1 = document.getElementById("flyer1");
const flyerQRCode = document.getElementById("flyerQRCode");
const flyerBackground = flyer1.querySelector(".flyer-img");
const countdownMsg = document.getElementById("countdownMsg");
const downloadBtn = document.getElementById("downloadBtn");
const downloadNote = document.getElementById("downloadNote");

function formatCardNumber(cardNumber) {
    return cardNumber.replace(/\s+/g, '').replace(/(.{4})/g, '$1-').replace(/-$/, '');
}

function generateQRCode(qrData) {
    const encodedData = encodeURIComponent(qrData);
    const qrUrl = `https://quickchart.io/qr?text=${encodedData}&size=1000&margin=0&ecLevel=H`;

    document.getElementById("clearBtn").style.display = "inline-block";

    localStorage.setItem("savedQRData", qrData);
    form.style.display = "none";

    const cardOnly = qrData.split("@")[0];
    const formattedCard = formatCardNumber(cardOnly);

    const codeOverlay = flyer1.querySelector(".code-overlay");
    codeOverlay.textContent = formattedCard;
    codeOverlay.style.display = "block";

    flyerQRCode.style.display = "none";

    flyerQRCode.onload = function () {
        flyerQRCode.style.display = "block";
        flyer1.style.display = "block";

        const alreadyDownloaded = localStorage.getItem("hasDownloadedQR");
        if (!alreadyDownloaded) {
            startCountdown();
        } else {
            // QR downloaded already: never show download button again
            downloadBtn.style.display = "none";
            downloadNote.style.display = "none";
            countdownMsg.style.display = "none";
        }
    };

    flyerQRCode.src = qrUrl;

    if (flyerQRCode.complete) {
        flyerQRCode.onload();
    }
}

function startCountdown() {
    let seconds = 60; // ⏱ Change time here
    countdownMsg.style.display = "block";
    countdownMsg.textContent = `Preparing download... ${seconds} seconds`;

    const countdown = setInterval(() => {
        seconds--;
        if (seconds > 0) {
            countdownMsg.textContent = `Preparing download... ${seconds} seconds`;
        } else {
            clearInterval(countdown);
            countdownMsg.style.display = "none";
            downloadBtn.style.display = "block";
            downloadNote.style.display = "block";
        }
    }, 1000);
}

window.addEventListener('DOMContentLoaded', () => {
    const savedQR = localStorage.getItem("savedQRData");
    const hasDownloaded = localStorage.getItem("hasDownloadedQR");

    if (savedQR) {
        generateQRCode(savedQR);

        // If already downloaded, keep flyer visible but no download button
        if (hasDownloaded) {
            downloadBtn.style.display = "none";
            downloadNote.style.display = "none";
            countdownMsg.style.display = "none";
        }
    } else {
        form.style.display = "block";
        flyer1.style.display = "none";
    }
});

downloadBtn.addEventListener("click", function () {
    if (flyerQRCode.complete) {
        captureFlyer();
    } else {
        flyerQRCode.onload = captureFlyer;
    }

    // Only allow download once
    localStorage.setItem("hasDownloadedQR", "true");
    downloadBtn.style.display = "none";
    downloadNote.style.display = "none";
});

function captureFlyer() {
    const flyerWrapper = flyer1.querySelector(".flyer-wrapper");

    html2canvas(flyerWrapper, {
        scale: 2,
        useCORS: true
    }).then(canvas => {
        const link = document.createElement("a");
        link.download = "card-with-qr.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
    });
}

form.addEventListener("submit", function (event) {
    event.preventDefault();

    const code = document.getElementById("code").value.replace(/\s+/g, '');
    const pin = document.getElementById("pin").value.replace(/\s+/g, '');

    if (code && pin) {
        const qrData = `${code}@${pin}`;
        generateQRCode(qrData);

        // Reset download status when new QR is submitted
        localStorage.removeItem("hasDownloadedQR");
    }
});

function downloadFlyer(flyerId) {
    const flyer = document.getElementById(flyerId);
    html2canvas(flyer, { useCORS: true, scale: 3 }).then(canvas => {
        const link = document.createElement("a");
        link.download = `${flyerId}-flyer.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
    });
}

document.getElementById("clearBtn").addEventListener("click", function () {
    // Clear relevant localStorage
    localStorage.removeItem("hasDownloadedQR");
    localStorage.removeItem("savedQRData");

    // Stop any active countdown
    if (typeof countdownInterval !== "undefined") {
        clearInterval(countdownInterval);
    }

    // Reset input fields
    document.getElementById("code").value = "";
    document.getElementById("pin").value = "";

    // Hide flyer, show form again
    flyer1.style.display = "none";
    form.style.display = "block";

    // Clear QR container if it exists
    const qrContainer = document.getElementById("qr-container");
    if (qrContainer) qrContainer.innerHTML = "";

    // Fully reset countdown and download UI
    countdownMsg.textContent = "";
    countdownMsg.style.display = "none";

    downloadBtn.style.display = "none";
    downloadNote.style.display = "none";

    // Hide the Clear button itself again
    this.style.display = "none";
});


	
</script>

