<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cashback Fund Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .collapsible-header {
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .collapsible-header:hover {
            background-color: #e5e7eb;
        }
        .collapsible-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }
        .collapsible-body.open {
            max-height: 1000vh; /* Arbitrarily large value to allow for any height */
            padding-bottom: 1rem;
        }
        .rotate-90 {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

    <div class="max-w-7xl mx-auto bg-white shadow-xl rounded-2xl overflow-hidden p-6 sm:p-10">
        <!-- Header Section -->
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">Cashback Fund Simulation</h1>
            <p class="text-gray-600 text-lg">Model and visualize fund growth and payouts over time.</p>
        </header>

        <!-- Simulation Inputs Section -->
        <section class="bg-gray-50 p-6 rounded-xl shadow-inner mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Key Simulation Inputs</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">

                <!-- Trading Rate Inputs -->
                <div class="flex flex-col">
                    <label for="avgWeeklyWin" class="text-sm font-medium text-gray-600 mb-1">Max Win (%)</label>
                    <input type="number" id="avgWeeklyWin" value="10" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex flex-col">
                    <label for="maxWeeklyLoss" class="text-sm font-medium text-gray-600 mb-1">Max Loss (%)</label>
                    <input type="number" id="maxWeeklyLoss" value="5" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex flex-col">
                    <label for="winRate" class="text-sm font-medium text-gray-600 mb-1">Win Rate (%)</label>
                    <input type="number" id="winRate" value="65" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- Fund & Payout Inputs -->
                <div class="flex flex-col">
                    <label for="initialTradingFund" class="text-sm font-medium text-gray-600 mb-1">Initial Trading Fund (J$)</label>
                    <input type="number" id="initialTradingFund" value="0" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex flex-col">
                    <label for="markupRate" class="text-sm font-medium text-gray-600 mb-1">Markup Rate (%)</label>
                    <input type="number" id="markupRate" value="25" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex flex-col">
                    <label for="payoutDelayDays" class="text-sm font-medium text-gray-600 mb-1">Payout Delay (Days)</label>
                    <input type="number" id="payoutDelayDays" value="121" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <!-- Simulation Control Inputs -->
                <div class="flex flex-col">
                    <label for="simulationSeed" class="text-sm font-medium text-gray-600 mb-1">Simulation Seed</label>
                    <input type="number" id="simulationSeed" value="12345" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="stressTestMode" class="form-checkbox h-4 w-4 text-blue-600">
                    <label for="stressTestMode" class="text-sm font-medium text-gray-600">Stress Test Mode</label>
                </div>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                <button id="runSimulationButton" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out">
                    Run Simulation
                </button>
                <button id="loadSheetButton" class="bg-gray-800 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-gray-900 transition duration-300 ease-in-out">
                    Load Sheet Data
                </button>
            </div>
        </section>

        <!-- Simulation Parameters from Sheet Section -->
        <section class="bg-gray-50 p-6 rounded-xl shadow-inner mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Simulation Parameters from Sheet</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-gray-600">
                <div>
                    <span class="font-medium">Simulation Start Date:</span>
                    <span id="displaySimulationStartDate" class="ml-2 font-semibold text-gray-800">N/A</span>
                    <input type="hidden" id="simulationStartDateInput">
                </div>
                <div>
                    <span class="font-medium">Number of Purchase Months:</span>
                    <span id="displayNumberOfPurchaseMonths" class="ml-2 font-semibold text-gray-800">N/A</span>
                    <input type="hidden" id="numberOfPurchaseMonthsInput">
                </div>
                <div>
                    <span class="font-medium">Calculated Trading Fund Start:</span>
                    <span id="currentTradingFundStart" class="ml-2 font-semibold text-gray-800">N/A</span>
                </div>
                <div>
                    <span class="font-medium">Calculated Reserve Fund Start:</span>
                    <span id="currentReserveFundStart" class="ml-2 font-semibold text-gray-800">N/A</span>
                </div>
            </div>
        </section>

        <!-- Simulation Results Section -->
        <section class="bg-blue-50 p-6 rounded-xl shadow mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Simulation Results</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Current Trading Fund -->
                <div class="bg-white p-5 rounded-lg shadow-md border-l-4 border-blue-500">
                    <p class="text-lg text-gray-500">Final Trading Fund</p>
                    <p id="currentTradingFundDisplay" class="text-3xl font-bold text-gray-800 mt-1">J$0.00</p>
                </div>
                <!-- Current Reserve Fund -->
                <div class="bg-white p-5 rounded-lg shadow-md border-l-4 border-green-500">
                    <p class="text-lg text-gray-500">Final Reserve Fund</p>
                    <p id="currentReserveFundDisplay" class="text-3xl font-bold text-gray-800 mt-1">J$0.00</p>
                </div>
                <!-- Total Cashback Owed (Simulated) -->
                <div class="bg-white p-5 rounded-lg shadow-md border-l-4 border-purple-500">
                    <p class="text-lg text-gray-500">Total Cashback Owed</p>
                    <p id="totalCashbackOwedDisplay" class="text-3xl font-bold text-gray-800 mt-1">J$0.00</p>
                </div>
                <!-- Total Cashback Paid Out (Simulated) -->
                <div class="bg-white p-5 rounded-lg shadow-md border-l-4 border-orange-500">
                    <p class="text-lg text-gray-500">Simulated Paid Out</p>
                    <p id="totalCashbackPaidOutDisplay" class="text-3xl font-bold text-gray-800 mt-1">J$0.00</p>
                </div>
                <!-- Total Cashback Paid Out (From Sheet) -->
                <div class="bg-white p-5 rounded-lg shadow-md border-l-4 border-yellow-500">
                    <p class="text-lg text-gray-500">Sheet Paid Out</p>
                    <p id="totalCashbackPaidFromSheetDisplay" class="text-3xl font-bold text-gray-800 mt-1">J$0.00</p>
                </div>
            </div>
        </section>

        <!-- Collapsible Tables Section -->
        <section class="space-y-6">

            <!-- Payout & Fund Daily Log -->
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div id="dailyLog-header" class="collapsible-header bg-gray-200 hover:bg-gray-300">
                    <h3 class="text-lg font-semibold text-gray-700">Payout & Fund Daily Log</h3>
                    <svg id="dailyLog-arrow" class="w-5 h-5 text-gray-600 transform transition-transform duration-200" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div id="dailyLog-body" class="collapsible-body">
                    <!-- Added a wrapper div with a max height and vertical scroll for better user experience on smaller screens -->
                    <div class="p-4 max-h-[60vh] overflow-y-auto">
                        <div id="dailyLogTableBodyWrapper" class="min-w-full divide-y divide-gray-200">
                            <!-- Table will be populated dynamically by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reserve Flow Calculator -->
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div id="rf-header" class="collapsible-header bg-gray-200 hover:bg-gray-300">
                    <h3 class="text-lg font-semibold text-gray-700">Reserve Flow Calculator</h3>
                    <svg id="rf-arrow" class="w-5 h-5 text-gray-600 transform transition-transform duration-200" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div id="rf-body" class="collapsible-body">
                    <!-- Added a wrapper div with a max height and vertical scroll -->
                    <div class="p-4 max-h-[60vh] overflow-y-auto">
                        <div id="rfReserveFlowTableBodyWrapper" class="min-w-full divide-y divide-gray-200">
                            <!-- Table will be populated dynamically by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Google Sheet Data Viewer -->
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div id="gs-header" class="collapsible-header bg-gray-200 hover:bg-gray-300">
                    <h3 class="text-lg font-semibold text-gray-700">Google Sheet Data Viewer</h3>
                    <svg id="gs-arrow" class="w-5 h-5 text-gray-600 transform transition-transform duration-200" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div id="gs-body" class="collapsible-body">
                    <div id="gs-loading" class="p-4 text-center text-blue-600 font-semibold">Loading data...</div>
                    <div id="gs-error" class="p-4 text-center text-red-600 font-semibold hidden"></div>
                    <!-- Added a wrapper div with a max height and vertical scroll -->
                    <div class="p-4 max-h-[60vh] overflow-y-auto">
                        <div id="gs-yearlyDataWrapper" class="min-w-full divide-y divide-gray-200 hidden">
                            <!-- Table will be populated dynamically by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

        </section>
    </div>

    <script>
        // =================================================================================================================
        //                                         GLOBAL VARIABLES & DOM ELEMENTS
        // =================================================================================================================

        // Get DOM elements for simulation inputs
        const initialTradingFundInput = document.getElementById('initialTradingFund');
        const avgWeeklyWinInput = document.getElementById('avgWeeklyWin');
        const maxWeeklyLossInput = document.getElementById('maxWeeklyLoss');
        const winRateInput = document.getElementById('winRate');
        const markupRateInput = document.getElementById('markupRate');
        const payoutDelayDaysInput = document.getElementById('payoutDelayDays');
        const simulationSeedInput = document.getElementById('simulationSeed');
        const stressTestModeCheckbox = document.getElementById('stressTestMode');
        const runSimulationButton = document.getElementById('runSimulationButton');
        const loadSheetButton = document.getElementById('loadSheetButton');

        // Get DOM elements for simulation parameters from sheet
        const displaySimulationStartDate = document.getElementById('displaySimulationStartDate');
        const simulationStartDateInput = document.getElementById('simulationStartDateInput');
        const displayNumberOfPurchaseMonths = document.getElementById('displayNumberOfPurchaseMonths');
        const numberOfPurchaseMonthsInput = document.getElementById('numberOfPurchaseMonthsInput');
        const currentTradingFundStartDisplay = document.getElementById('currentTradingFundStart');
        const currentReserveFundStartDisplay = document.getElementById('currentReserveFundStart');

        // Get DOM elements for simulation results
        const currentTradingFundDisplay = document.getElementById('currentTradingFundDisplay');
        const currentReserveFundDisplay = document.getElementById('currentReserveFundDisplay');
        const totalCashbackOwedDisplay = document.getElementById('totalCashbackOwedDisplay');
        const totalCashbackPaidOutDisplay = document.getElementById('totalCashbackPaidOutDisplay');
        const totalCashbackPaidFromSheetDisplay = document.getElementById('totalCashbackPaidFromSheetDisplay'); // New element for sheet data

        // Get DOM elements for tables
        const dailyLogTableBodyWrapper = document.getElementById('dailyLogTableBodyWrapper');
        const rfReserveFlowTableBodyWrapper = document.getElementById('rfReserveFlowTableBodyWrapper');
        const gsDataTableContainer = document.getElementById('gs-yearlyDataWrapper'); // Changed ID

        // Get DOM elements for collapsibles
        const dailyLogHeader = document.getElementById('dailyLog-header');
        const dailyLogBody = document.getElementById('dailyLog-body');
        const dailyLogArrow = document.getElementById('dailyLog-arrow');

        const rfHeader = document.getElementById('rf-header');
        const rfBody = document.getElementById('rf-body');
        const rfArrow = document.getElementById('rf-arrow');

        const gsHeader = document.getElementById('gs-header');
        const gsBody = document.getElementById('gs-body');
        const gsArrow = document.getElementById('gs-arrow');
        const gsLoadingIndicator = document.getElementById('gs-loading');
        const gsErrorMessage = document.getElementById('gs-error');

        // Global simulation data logs
        let dailySimulationLog = [];
        let dailyReserveFlowLog = [];
        let processedGoogleSheetData = [];

        // Global Maps for data aggregation from Google Sheet
        const dailyTopUpAmountsMap = new Map();
        const dailyCashbackFundAdditionsMap = new Map();
        const dailyReserveFundAdditionsMap = new Map();
        const dailyLiabilityAdditionsMap = new Map();
        const monthlyPaidCashbackMap = new Map(); // NEW: Map to hold aggregated monthly payouts
        
        // Headers for the tables
        const GS_HEADERS = `
            <thead>
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Top-Up Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Top-Up</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Markup (J$)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Release Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paid Cashback (J$)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cashback Value (J$)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cashback Fund (J$)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reserve Fund (J$)</th>
                </tr>
            </thead>
        `;
        const PAYOUT_HEADERS = `
            <thead>
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Day</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trading Fund (Start)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Additions (J$)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trade Result (J$)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paid Cashback (J$)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trading Fund (End)</th>
                </tr>
            </thead>
        `;
        const RF_HEADERS = `
            <thead>
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Day</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reserve Fund (Start)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Markup Added (J$)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paid Cashback (J$)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reserve Fund (End)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reserve Status</th>
                </tr>
            </thead>
        `;

        // Constants for the simulation
        const EXTRA_MONTHS_FOR_PAYOUTS = 4;
        const RF_MARKUP_ALLOCATION_TO_RESERVE = 0.83; // 1 - 0.17 from Google Script
        const PAYOUT_DELAY_DAYS = 121;

        // =================================================================================================================
        //                                              UTILITY FUNCTIONS
        // =================================================================================================================

        /**
         * Formats a number as a Jamaican Dollar currency string.
         * @param {number} amount The number to format.
         * @param {boolean} showSign Whether to show a + or - sign for the number.
         * @returns {string} The formatted currency string.
         */
        const formatCurrency = (amount, showSign = false) => {
            if (typeof amount !== 'number' || isNaN(amount)) {
                return 'J$0.00';
            }
            let sign = '';
            if (showSign) {
                sign = amount > 0 ? '+' : (amount < 0 ? '-' : '');
            }
            const absAmount = Math.abs(amount);
            return `J$${absAmount.toLocaleString('en-JM', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        };

        /**
         * Formats a number as a percentage string.
         * @param {number} value The number to format.
         * @returns {string} The formatted percentage string.
         */
        const formatPercentage = (value) => {
            const num = parseFloat(value);
            if (isNaN(num)) return 'N/A';
            return `${num.toFixed(2)}%`;
        };

        /**
         * Parses a string or number into a float, handling commas and currency symbols.
         * @param {string|number} value The value to clean and parse.
         * @returns {number} The parsed float or 0 if invalid.
         */
        const cleanAndParseFloat = (value) => {
            if (typeof value === 'number') {
                return value;
            }
            if (typeof value === 'string') {
                const cleaned = value.replace(/[^0-9.-]+/g, '');
                const parsed = parseFloat(cleaned);
                return isNaN(parsed) ? 0 : parsed;
            }
            return 0;
        };

        /**
         * Finds the value of a column in a row of data, checking for multiple possible header names.
         * @param {Object} row The data row object.
         * @param {string[]} possibleHeaders An array of possible header names.
         * @returns {any} The value of the column or null if not found.
         */
        const getColumnValue = (row, possibleHeaders) => {
            for (const header of possibleHeaders) {
                const lowerCaseHeader = header.toLowerCase();
                // Find the key in the row object that matches (case-insensitive)
                const key = Object.keys(row).find(k => k.toLowerCase() === lowerCaseHeader);
                if (key && (row[key] !== null && row[key] !== undefined)) {
                    return row[key];
                }
            }
            return null;
        };
        
        /**
         * Parses a date string from the sheet into a Date object.
         * Handles various date formats.
         * @param {string} dateString The date string from the sheet.
         * @returns {Date|null} A Date object or null if parsing fails.
         */
        const parseSheetDate = (dateString) => {
            if (!dateString) return null;
            // Attempt to parse with a format-aware library or logic
            let date;
            // Try ISO format (yyyy-mm-dd)
            if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                date = new Date(dateString + 'T00:00:00');
            }
            // Try common slash format (m/d/yyyy)
            else if (dateString.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                const [month, day, year] = dateString.split('/').map(Number);
                date = new Date(year, month - 1, day);
            }
            // Try other common formats
            else {
                date = new Date(dateString);
            }

            // Check if the date is valid and normalize to local midnight
            if (isNaN(date.getTime())) {
                console.warn(`parseSheetDate: Failed to parse date string: '${dateString}'`);
                return null;
            }
            date.setHours(0, 0, 0, 0); // Normalize to local midnight
            return date;
        };

        /**
         * Adds a number of days to a given Date object.
         * @param {Date} date The starting date.
         * @param {number} days The number of days to add.
         * @returns {Date} The new Date object.
         */
        const addDays = (date, days) => {
            const newDate = new Date(date);
            newDate.setDate(newDate.getDate() + days);
            return newDate;
        };
        
        /**
         * Calculates the last day of the month for a given date.
         * @param {Date} date The date object.
         * @returns {Date} A new Date object for the last day of that month.
         */
        const getEndOfMonthLocal = (date) => {
            const endOfMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0);
            return new Date(endOfMonth.getFullYear(), endOfMonth.getMonth(), endOfMonth.getDate(), 0, 0, 0, 0);
        };
        
        /**
         * Checks if a date is the last day of its month.
         * @param {Date} date The date object to check.
         * @returns {boolean} True if it's the last day of the month, false otherwise.
         */
        const isLastDayOfMonth = (date) => {
            const nextDay = new Date(date);
            nextDay.setDate(date.getDate() + 1);
            return nextDay.getMonth() !== date.getMonth();
        };

        /**
         * A simple seedable pseudo-random number generator function.
         * @param {number} seed The seed for the generator.
         * @returns {function} A function that returns a new random number each time it's called.
         */
        function* seededRandom(seed) {
            let state = seed;
            while (true) {
                state = (state * 9301 + 49297) % 233280;
                yield state / 233280;
            }
        }
        let rng;

        /**
         * Function to generate a seeded random number from the generator.
         * @returns {number} A random number between 0 and 1.
         */
        const generateSeededRandomNumber = () => {
            if (!rng) {
                const seed = parseInt(simulationSeedInput.value) || 12345;
                rng = seededRandom(seed);
            }
            return rng.next().value;
        };

        // =================================================================================================================
        //                                         COLLAPSIBLE TABLE & UI FUNCTIONS
        // =================================================================================================================
        
        /**
         * Toggles the open/close state of a collapsible section.
         * @param {HTMLElement} body The collapsible body element.
         * @param {HTMLElement} arrow The arrow icon element.
         */
        const toggleCollapsible = (body, arrow) => {
            const isOpen = body.classList.contains('open');
            if (isOpen) {
                body.classList.remove('open');
                arrow.classList.remove('rotate-90');
            } else {
                body.classList.add('open');
                arrow.classList.add('rotate-90');
            }
        };

        // Add event listeners for collapsible headers
        dailyLogHeader.addEventListener('click', () => toggleCollapsible(dailyLogBody, dailyLogArrow));
        rfHeader.addEventListener('click', () => toggleCollapsible(rfBody, rfArrow));
        gsHeader.addEventListener('click', () => toggleCollapsible(gsBody, gsArrow));

        /**
         * Updates the display of the current fund balances.
         */
        const updateCurrentFundBalancesDisplay = () => {
            currentTradingFundStartDisplay.textContent = formatCurrency(cleanAndParseFloat(initialTradingFundInput.value));
            currentReserveFundStartDisplay.textContent = formatCurrency(0);
        };

        /**
         * Dynamically creates and populates a collapsible table with yearly groupings.
         * @param {HTMLElement} container The DOM element to append the table to.
         * @param {Array<Object>} data The array of data objects to display.
         * @param {Function} rowRenderer A function that returns the HTML string for a table row.
         * @param {string} dateKey The key in the data object that holds the date.
         * @param {string} prefix A unique prefix for element IDs.
         * @param {string} headersHtml The HTML string for the table headers.
         */
        const createCollapsibleYearlyTable = (container, data, rowRenderer, dateKey, prefix, headersHtml) => {
            container.innerHTML = ''; // Clear previous content
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">No data to display.</p>';
                return;
            }

            // Group data by year
            const dataByYear = data.reduce((acc, current) => {
                const date = current[dateKey] instanceof Date ? current[dateKey] : parseSheetDate(current[dateKey]);
                if (date) {
                    const year = date.getFullYear();
                    if (!acc[year]) {
                        acc[year] = [];
                    }
                    acc[year].push(current);
                }
                return acc;
            }, {});

            const sortedYears = Object.keys(dataByYear).sort((a, b) => b - a);

            sortedYears.forEach(year => {
                const yearDiv = document.createElement('div');
                yearDiv.className = 'border border-gray-200 rounded-lg shadow-sm mb-4 overflow-hidden';
                yearDiv.innerHTML = `
                    <div id="${prefix}-year-${year}-header" class="collapsible-header bg-gray-100 p-4">
                        <h4 class="text-md font-medium text-gray-700">${year}</h4>
                        <svg id="${prefix}-year-${year}-arrow" class="w-4 h-4 text-gray-500 transform transition-transform duration-200" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div id="${prefix}-year-${year}-body" class="collapsible-body">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                ${headersHtml}
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${dataByYear[year].map(rowRenderer).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                container.appendChild(yearDiv);

                const header = document.getElementById(`${prefix}-year-${year}-header`);
                const body = document.getElementById(`${prefix}-year-${year}-body`);
                const arrow = document.getElementById(`${prefix}-year-${year}-arrow`);
                header.addEventListener('click', () => toggleCollapsible(body, arrow));

                // Open the latest year by default
                if (year === sortedYears[0]) {
                    toggleCollapsible(body, arrow);
                }
            });
        };

        // =================================================================================================================
        //                                               SIMULATION LOGIC
        // =================================================================================================================

        /**
         * The main simulation function that runs the cumulative daily simulation.
         */
        const runSimulation = () => {
            console.log("runSimulation: Starting simulation with payouts at month end.");

            // Reset logs
            dailySimulationLog = [];
            dailyReserveFlowLog = [];

            // Reset the RNG to ensure deterministic results with the same seed
            const seed = parseInt(simulationSeedInput.value) || 12345;
            rng = seededRandom(seed);

            // Get inputs
            const initialTradingFund = cleanAndParseFloat(initialTradingFundInput.value);
            const avgWeeklyWin = parseFloat(avgWeeklyWinInput.value) / 100;
            const maxWeeklyLoss = parseFloat(maxWeeklyLossInput.value) / 100;
            const winRate = parseFloat(winRateInput.value) / 100;
            const stressTestMode = stressTestModeCheckbox.checked;

            let tradingFund = initialTradingFund;
            let reserveFund = 0;
            let totalCashbackOwed = 0;
            let totalCashbackPaidOut = 0;
            let dailyLiability = 0;

            const numMonths = parseInt(numberOfPurchaseMonthsInput.value) || 1;
            const simStartDate = parseSheetDate(simulationStartDateInput.value);

            if (!simStartDate) {
                console.error("runSimulation: Simulation start date could not be parsed. Aborting.");
                return;
            }

            const simEndDate = new Date(simStartDate);
            simEndDate.setMonth(simEndDate.getMonth() + numMonths + EXTRA_MONTHS_FOR_PAYOUTS);

            let dayCounter = 0;

            // Start the simulation loop
            for (let date = new Date(simStartDate); date <= simEndDate; date.setDate(date.getDate() + 1)) {
                dayCounter++;
                const dateKey = date.toLocaleDateString('en-CA', { year: 'numeric', month: '2-digit', day: '2-digit' });
                const monthKey = `${date.getFullYear()}-${date.getMonth()}`;

                // --- Simulation Fund Update Part ---
                const tradingFundStartOfDay = tradingFund;
                const reserveFundStartOfDay = reserveFund;
                let fundAdditions = 0;
                let dailyTradingResult = 0;
                let payouts = 0;
                let markupAddedToReserve = 0;

                // Apply daily top-up additions from Google Sheet
                if (dailyCashbackFundAdditionsMap.has(dateKey)) {
                    fundAdditions = dailyCashbackFundAdditionsMap.get(dateKey);
                    tradingFund += fundAdditions;
                }
                if (dailyReserveFundAdditionsMap.has(dateKey)) {
                    markupAddedToReserve = dailyReserveFundAdditionsMap.get(dateKey);
                    reserveFund += markupAddedToReserve;
                }
                
                // Update total cashback owed from daily liabilities
                if (dailyLiabilityAdditionsMap.has(dateKey)) {
                    dailyLiability = dailyLiabilityAdditionsMap.get(dateKey);
                    totalCashbackOwed += dailyLiability;
                }

                // Simulate weekly trading based on day of the week (e.g., Tuesday)
                if (date.getDay() === 2) { // 2 = Tuesday
                    const rand = generateSeededRandomNumber();
                    const isWin = rand < winRate;
                    let tradeChange;
                    if (isWin) {
                        tradeChange = tradingFund * (avgWeeklyWin * (generateSeededRandomNumber() + 0.5)); // Randomize win
                    } else {
                        tradeChange = -tradingFund * (maxWeeklyLoss * (generateSeededRandomNumber() + 0.5)); // Randomize loss
                    }
                    dailyTradingResult = tradeChange;
                    tradingFund += tradeChange;
                }
                
                // --- MODIFIED PAYOUT LOGIC: Payout all due cashback at the end of the month ---
                if (isLastDayOfMonth(date) && monthlyPaidCashbackMap.has(monthKey)) {
                    const payoutAmount = monthlyPaidCashbackMap.get(monthKey);
                    
                    if (payoutAmount > 0) {
                         // Pay from reserve first
                        const paidFromReserve = Math.min(reserveFund, payoutAmount);
                        reserveFund -= paidFromReserve;
                        
                        // Pay the rest from trading fund
                        const remainingPayout = payoutAmount - paidFromReserve;
                        tradingFund -= remainingPayout;
                        
                        payouts = payoutAmount;
                    }
                }
                
                totalCashbackPaidOut += payouts;
                
                // Log daily results
                dailySimulationLog.push({
                    day: dayCounter,
                    date: new Date(date),
                    tradingFundStart: tradingFundStartOfDay,
                    fundAdditions: fundAdditions,
                    tradeResult: dailyTradingResult,
                    payouts: payouts,
                    tradingFundEnd: tradingFund
                });

                dailyReserveFlowLog.push({
                    day: dayCounter,
                    date: new Date(date),
                    reserveStart: reserveFundStartOfDay,
                    markupAddedToReserve: markupAddedToReserve,
                    paidCashback: payouts,
                    reserveEnd: reserveFund
                });
            }

            // Update final displays
            currentTradingFundDisplay.textContent = formatCurrency(tradingFund);
            currentReserveFundDisplay.textContent = formatCurrency(reserveFund);
            totalCashbackOwedDisplay.textContent = formatCurrency(totalCashbackOwed);
            totalCashbackPaidOutDisplay.textContent = formatCurrency(totalCashbackPaidOut);

            // Populate the tables with the new data
            createCollapsibleYearlyTable(dailyLogTableBodyWrapper, dailySimulationLog, (data) => {
                let tradeResultClass = 'text-gray-500';
                if (data.tradeResult > 0) tradeResultClass = 'text-green-600';
                if (data.tradeResult < 0) tradeResultClass = 'text-red-600';
                
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${data.day}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${data.date.toLocaleDateString('en-JM', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${formatCurrency(data.tradingFundStart, false)}</td>
                        <td class="px-6 py-4 whitespace-nowrap ${data.fundAdditions > 0 ? 'text-green-600' : 'text-gray-500'}">${data.fundAdditions > 0 ? formatCurrency(data.fundAdditions, true) : 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap ${tradeResultClass}">${data.tradeResult !== 0 ? formatCurrency(data.tradeResult, true) : 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap ${data.payouts > 0 ? 'text-red-600' : 'text-gray-500'}">${data.payouts > 0 ? formatCurrency(data.payouts, true) : 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${formatCurrency(data.tradingFundEnd, false)}</td>
                    </tr>
                `;
            }, 'date', 'payout', PAYOUT_HEADERS); // Pass headers HTML

            console.log("runSimulation: Simulation finished.");
            runReserveFlowSimulation();
        };


        /**
         * Runs the Reserve Flow simulation.
         */
        const runReserveFlowSimulation = () => {
            console.log("runReserveFlowSimulation: Starting Reserve Flow simulation.");
            // Clear previous results by clearing the wrapper
            rfReserveFlowTableBodyWrapper.innerHTML = ''; 

            console.log("Populating RF Reserve Flow Table with:", dailyReserveFlowLog); // Debug log
            // Populate Reserve Flow Table (Daily) using collapsible years
            createCollapsibleYearlyTable(rfReserveFlowTableBodyWrapper, dailyReserveFlowLog, (data) => {
                let displayedStatus;
                let statusClass;
                
                if (data.reserveEnd !== null) {
                    if (data.reserveEnd >= 0) {
                        displayedStatus = 'POSITIVE';
                        statusClass = 'text-green-600';
                    } else {
                        displayedStatus = 'NEGATIVE';
                        statusClass = 'text-red-600';
                    }
                } else {
                    displayedStatus = 'N/A';
                    statusClass = 'text-gray-500';
                }

                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${data.day}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${data.date.toLocaleDateString('en-JM', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${formatCurrency(data.reserveStart, true)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${data.markupAddedToReserve > 0 ? formatCurrency(data.markupAddedToReserve, true) : 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${data.paidCashback > 0 ? formatCurrency(data.paidCashback, true) : 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${formatCurrency(data.reserveEnd, true)}</td>
                        <td class="px-6 py-4 whitespace-nowrap ${statusClass}">${displayedStatus}</td>
                    </tr>
                `;
            }, 'date', 'rf', RF_HEADERS); // Pass headers HTML

            console.log("runReserveFlowSimulation: Reserve Flow simulation finished.");
        };


        // --- Google Sheet Data Viewer Logic ---
        /**
         * Fetches and processes data from the specified Google Sheet URL.
         * Populates simulation inputs and triggers simulations.
         */
        const loadGoogleSheetData = async () => {
            console.log("loadGoogleSheetData: Starting data load from Google Sheet.");
            const dataUrl = 'https://opensheet.elk.sh/1_DyGLoYi5ndEkiwhPEzJhMc3vciIFNhN2g-H0gbVRds/sheet8';

            // Clear previous data and reset visibility
            if (gsDataTableContainer) gsDataTableContainer.innerHTML = ''; // Clear the wrapper div
            if (gsErrorMessage) gsErrorMessage.classList.add('hidden');
            if (gsDataTableContainer) gsDataTableContainer.classList.add('hidden');
            if (gsLoadingIndicator) gsLoadingIndicator.classList.remove('hidden');

            try {
                console.log("loadGoogleSheetData: Fetching data from:", dataUrl);
                const response = await fetch(dataUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log("loadGoogleSheetData: Data fetched successfully:", data);

                if (gsLoadingIndicator) gsLoadingIndicator.classList.add('hidden'); // Hide loading
                if (gsDataTableContainer) gsDataTableContainer.classList.remove('hidden'); // Show table container

                // Clear global maps before populating
                dailyCashbackFundAdditionsMap.clear();
                dailyReserveFundAdditionsMap.clear();
                dailyLiabilityAdditionsMap.clear();
                dailyTopUpAmountsMap.clear();
                monthlyPaidCashbackMap.clear(); // Clear the new map
                
                let totalCashbackPaidFromSheet = 0; // New variable to hold the total

                if (data && Array.isArray(data) && data.length > 0) {
                    console.log("loadGoogleSheetData: Processing valid data rows.");
                    processedGoogleSheetData = []; // Reset the global variable

                    const validDataRowsUnsorted = data.filter(row => {
                        const topUp = getColumnValue(row, ['Top-Up', 'Top Up', 'Topup']);
                        return topUp !== null && topUp !== '';
                    });

                    // Add parsedDate and parsedReleaseDate to each row for sorting and processing
                    validDataRowsUnsorted.forEach(row => {
                        const dateRaw = getColumnValue(row, ['Top-Up Date', 'Top Up Date', 'Top-up Date', 'Top up Date', 'TopUp Date', 'Activation Date', 'activation date']);
                        const parsedActivationDate = parseSheetDate(dateRaw);
                        const releaseDateRaw = getColumnValue(row, ['Release Date', 'ReleaseDate']);
                        const paidCashback = cleanAndParseFloat(getColumnValue(row, ['Paid Cashback (J$)', 'Paid Cashback', 'PaidCashback']));
                        
                        const parsedReleaseDate = parseSheetDate(releaseDateRaw);
                        
                        totalCashbackPaidFromSheet += paidCashback; // Aggregate the value

                        processedGoogleSheetData.push({ ...row, parsedDate: parsedActivationDate, parsedReleaseDate: parsedReleaseDate, paidCashback: paidCashback });
                    });

                    // Sort processedGoogleSheetData by Activation Date (parsedDate)
                    processedGoogleSheetData.sort((a, b) => {
                        if (!a.parsedDate && !b.parsedDate) return 0;
                        if (!a.parsedDate) return 1; // Null dates go to the end
                        if (!b.parsedDate) return -1; // Null dates go to the end
                        return a.parsedDate.getTime() - b.parsedDate.getTime();
                    });

                    // Update the new display card with the total from the sheet
                    totalCashbackPaidFromSheetDisplay.textContent = formatCurrency(totalCashbackPaidFromSheet);

                    if (processedGoogleSheetData.length > 0) {
                        // Determine Simulation Start Date from the first sorted entry
                        const firstTopUpDateRaw = getColumnValue(processedGoogleSheetData[0], ['Top-Up Date', 'Top Up Date', 'Top-up Date', 'Top up Date', 'TopUp Date', 'Activation Date', 'activation date']);
                        let parsedStartDate = parseSheetDate(firstTopUpDateRaw);

                        if (!parsedStartDate) {
                            parsedStartDate = new Date();
                            parsedStartDate.setHours(0,0,0,0);
                            console.warn("loadGoogleSheetData: Could not parse simulation start date from sheet. Defaulting to today's date.");
                        }

                        if (displaySimulationStartDate) displaySimulationStartDate.textContent = parsedStartDate.toLocaleDateString('en-JM', { year: 'numeric', month: 'short', day: 'numeric' });
                        simulationStartDateInput.value = parsedStartDate.toISOString().split('T')[0];
                        console.log("loadGoogleSheetData: Simulation Start Date set to:", simulationStartDateInput.value);

                        // Determine # Of Months
                        const uniqueMonths = new Set();
                        processedGoogleSheetData.forEach(row => {
                            const dateObj = row.parsedDate;
                            if (dateObj) {
                                uniqueMonths.add(`${dateObj.getFullYear()}-${dateObj.getMonth()}`);
                            }
                        });
                        const numMonths = uniqueMonths.size;
                        if (displayNumberOfPurchaseMonths) displayNumberOfPurchaseMonths.textContent = numMonths;
                        numberOfPurchaseMonthsInput.value = numMonths;
                        console.log("loadGoogleSheetData: Number of Purchase Months set to:", numMonths);

                        // Update Max Win (%), Max Loss (%), Win Rate (%) inputs from the first row
                        const firstRow = processedGoogleSheetData[0];
                        const maxWin = cleanAndParseFloat(getColumnValue(firstRow, ['Max Win (%)', 'Max Win %', 'MaxWin']));
                        if (!isNaN(maxWin)) {
                            avgWeeklyWinInput.value = maxWin;
                            console.log("loadGoogleSheetData: Max Win set to:", avgWeeklyWinInput.value);
                        }
                        const maxLoss = cleanAndParseFloat(getColumnValue(firstRow, ['Max Loss (%)', 'Max Loss %', 'MaxLoss']));
                        if (!isNaN(maxLoss)) {
                            maxWeeklyLossInput.value = maxLoss;
                            console.log("loadGoogleSheetData: Max Loss set to:", maxLoss);
                        }
                        const winRate = cleanAndParseFloat(getColumnValue(firstRow, ['Win Rate (%)', 'Win Rate %', 'WinRate']));
                        if (!isNaN(winRate)) {
                            winRateInput.value = winRate;
                            console.log("loadGoogleSheetData: Win Rate set to:", winRate);
                        }
                        
                        // Populate the daily maps for fund additions and the new monthly payout map
                        processedGoogleSheetData.forEach(row => {
                            const parsedActivationDate = row.parsedDate;
                            const parsedReleaseDate = row.parsedReleaseDate;

                            if (parsedActivationDate) {
                                const activationDateKey = parsedActivationDate.toLocaleDateString('en-CA', { year: 'numeric', month: '2-digit', day: '2-digit' });

                                // Attempt to get Markup value first
                                let markupAmount = cleanAndParseFloat(getColumnValue(row, ['Markup', 'markup']));
                                let cashbackFundToAdd = 0;
                                let reserveFundToAdd = 0;

                                if (!isNaN(markupAmount) && markupAmount > 0) {
                                    cashbackFundToAdd = markupAmount * (1 - RF_MARKUP_ALLOCATION_TO_RESERVE);
                                    reserveFundToAdd = markupAmount * RF_MARKUP_ALLOCATION_TO_RESERVE;
                                } else {
                                    cashbackFundToAdd = cleanAndParseFloat(getColumnValue(row, ['Cashback Fund', 'CashbackFund']));
                                    reserveFundToAdd = cleanAndParseFloat(getColumnValue(row, ['Reserve Fund', 'ReserveFund']));
                                }
                                
                                const cashbackOwed = cleanAndParseFloat(getColumnValue(row, ['Cashback', 'Cashback Value']));
                                const paidCashback = row.paidCashback;
                                const topUp = cleanAndParseFloat(getColumnValue(row, ['Top-Up', 'Top Up', 'Topup']));

                                dailyCashbackFundAdditionsMap.set(activationDateKey, (dailyCashbackFundAdditionsMap.get(activationDateKey) || 0) + cashbackFundToAdd);
                                dailyReserveFundAdditionsMap.set(activationDateKey, (dailyReserveFundAdditionsMap.get(activationDateKey) || 0) + reserveFundToAdd);
                                dailyLiabilityAdditionsMap.set(activationDateKey, (dailyLiabilityAdditionsMap.get(activationDateKey) || 0) + cashbackOwed);
                                dailyTopUpAmountsMap.set(activationDateKey, (dailyTopUpAmountsMap.get(activationDateKey) || 0) + topUp); // Fixed: changed topUpAmount to topUp
                            }

                            // Populate the new monthly payouts map
                            if (parsedReleaseDate) {
                                const monthKey = `${parsedReleaseDate.getFullYear()}-${parsedReleaseDate.getMonth()}`;
                                const paidCashback = row.paidCashback;
                                monthlyPaidCashbackMap.set(monthKey, (monthlyPaidCashbackMap.get(monthKey) || 0) + paidCashback);
                            }

                        });
                        console.log("loadGoogleSheetData: Google Sheet data table populated.");

                        // Render Google Sheet data with collapsible years
                        createCollapsibleYearlyTable(gsDataTableContainer, processedGoogleSheetData, (row) => {
                            const dateObj = row.parsedDate;
                            const topUpDateDisplay = dateObj ? dateObj.toLocaleDateString('en-JM', { year: 'numeric', month: 'short', day: 'numeric' }) : (getColumnValue(row, ['Top-Up Date', 'Top Up Date', 'Top-up Date', 'Top up Date', 'TopUp Date', 'Activation Date', 'activation date']) || 'N/A');
                            const topUp = cleanAndParseFloat(getColumnValue(row, ['Top-Up', 'Top Up', 'Topup']));
                            const markup = cleanAndParseFloat(getColumnValue(row, ['Markup', 'markup']));
                            const releaseDateObj = row.parsedReleaseDate;
                            const releaseDateDisplay = releaseDateObj ? releaseDateObj.toLocaleDateString('en-JM', { year: 'numeric', month: 'short', day: 'numeric' }) : 'N/A';
                            const cashbackValue = cleanAndParseFloat(getColumnValue(row, ['Cashback', 'Cashback Value']));
                            const cashbackFund = cleanAndParseFloat(getColumnValue(row, ['Cashback Fund', 'CashbackFund']));
                            const reserveFund = cleanAndParseFloat(getColumnValue(row, ['Reserve Fund', 'ReserveFund']));
                            const paidCashback = row.paidCashback;

                            return `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap">${topUpDateDisplay}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${formatCurrency(topUp)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${markup !== null ? formatCurrency(markup) : 'N/A'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${releaseDateDisplay}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${formatCurrency(paidCashback)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${formatCurrency(cashbackValue)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${formatCurrency(cashbackFund)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${formatCurrency(reserveFund)}</td>
                                </tr>
                            `;
                        }, 'parsedDate', 'gs', GS_HEADERS);

                        runSimulation();
                        runReserveFlowSimulation();
                        updateCurrentFundBalancesDisplay();
                        console.log("loadGoogleSheetData: Simulations triggered after data load.");

                    } else {
                        console.warn("loadGoogleSheetData: No valid data rows found in the sheet. Running with defaults.");
                        if (gsErrorMessage) gsErrorMessage.textContent = 'No valid data rows found in the sheet. Running with default parameters.';
                        if (gsErrorMessage) gsErrorMessage.classList.remove('hidden');
                        const today = new Date();
                        today.setHours(0,0,0,0);
                        if (displaySimulationStartDate) displaySimulationStartDate.textContent = today.toLocaleDateString('en-JM', { year: 'numeric', month: 'short', day: 'numeric' });
                        simulationStartDateInput.value = today.toISOString().split('T')[0];
                        if (numberOfPurchaseMonthsInput) numberOfPurchaseMonthsInput.value = '1'; 
                        if (displayNumberOfPurchaseMonths) displayNumberOfPurchaseMonths.textContent = '1'; 
                        if (dailyLogTableBodyWrapper) dailyLogTableBodyWrapper.innerHTML = '';
                        if (gsDataTableContainer) gsDataTableContainer.innerHTML = '';
                        if (rfReserveFlowTableBodyWrapper) rfReserveFlowTableBodyWrapper.innerHTML = '';
                        runSimulation();
                        runReserveFlowSimulation();
                        updateCurrentFundBalancesDisplay();
                    }

                } else {
                    console.warn("loadGoogleSheetData: No data found in the sheet or sheet is empty. Running with defaults.");
                    if (gsErrorMessage) gsErrorMessage.textContent = 'No data found in the sheet or sheet is empty. Running with default parameters.';
                    if (gsErrorMessage) gsErrorMessage.classList.remove('hidden');
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    if (displaySimulationStartDate) displaySimulationStartDate.textContent = today.toLocaleDateString('en-JM', { year: 'numeric', month: 'short', day: 'numeric' });
                    simulationStartDateInput.value = today.toISOString().split('T')[0];
                    if (numberOfPurchaseMonthsInput) numberOfPurchaseMonthsInput.value = '1'; 
                    if (displayNumberOfPurchaseMonths) displayNumberOfPurchaseMonths.textContent = '1'; 
                    if (dailyLogTableBodyWrapper) dailyLogTableBodyWrapper.innerHTML = '';
                    if (gsDataTableContainer) gsDataTableContainer.innerHTML = '';
                    if (rfReserveFlowTableBodyWrapper) rfReserveFlowTableBodyWrapper.innerHTML = '';
                    runSimulation();
                    runReserveFlowSimulation();
                    updateCurrentFundBalancesDisplay();
                }

            } catch (error) {
                console.error('loadGoogleSheetData: Error fetching data:', error);
                if (gsLoadingIndicator) gsLoadingIndicator.classList.add('hidden');
                if (gsErrorMessage) gsErrorMessage.textContent = `Failed to load data: ${error.message}. Please ensure the Google Sheet is publicly viewable and the URL is correct. Running with default parameters.`;
                if (gsErrorMessage) gsErrorMessage.classList.remove('hidden');
                const today = new Date();
                today.setHours(0,0,0,0);
                if (displaySimulationStartDate) displaySimulationStartDate.textContent = today.toLocaleDateString('en-JM', { year: 'numeric', month: 'short', day: 'numeric' });
                simulationStartDateInput.value = today.toISOString().split('T')[0];
                if (numberOfPurchaseMonthsInput) numberOfPurchaseMonthsInput.value = '1'; 
                if (displayNumberOfPurchaseMonths) displayNumberOfPurchaseMonths.textContent = '1'; 
                if (dailyLogTableBodyWrapper) dailyLogTableBodyWrapper.innerHTML = '';
                if (gsDataTableContainer) gsDataTableContainer.innerHTML = '';
                if (rfReserveFlowTableBodyWrapper) rfReserveFlowTableBodyWrapper.innerHTML = '';
                runSimulation();
                runReserveFlowSimulation();
                updateCurrentFundBalancesDisplay();
            }
        };

        // --- Event listeners & initial setup ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded: Event fired.");
            const today = new Date();
            today.setHours(0,0,0,0);
            simulationStartDateInput.value = today.toISOString().split('T')[0];
            updateCurrentFundBalancesDisplay();
            loadGoogleSheetData();
        });

        // Event listeners for manual inputs
        runSimulationButton.addEventListener('click', () => {
            console.log("Run Simulation button clicked. Re-running simulations.");
            runSimulation();
        });
        loadSheetButton.addEventListener('click', loadGoogleSheetData);
        markupRateInput.addEventListener('input', () => {
            console.log("markupRateInput: Value changed. Re-running simulations.");
            runSimulation();
        });
        initialTradingFundInput.addEventListener('input', () => {
            console.log("initialTradingFundInput: Value changed. Re-running simulation.");
            runSimulation();
        });
        simulationSeedInput.addEventListener('input', () => {
            console.log("simulationSeedInput: Value changed. Re-running simulation.");
            runSimulation();
        });
        stressTestModeCheckbox.addEventListener('change', () => {
            console.log("stressTestModeCheckbox: Value changed. Re-running simulation.");
            runSimulation();
        });
    </script>
</body>
</html>
