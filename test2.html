<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

 <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> 
 <link href="//site-assets.fontawesome.com/releases/v6.1.1/css/all.css" rel="stylesheet"> 
<link href="//fonts.googleapis.com/css?family=Space+Mono|Work+Sans:700" rel="stylesheet">
	
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="https://www.allpree.com/img/AllPreepwaapp.png"/>
<link rel="apple-touch-icon" type="image/png" sizes="192x192" href="https://www.allpree.com/img/AllPreepwaapp.png"/>
<link rel="apple-touch-icon" type="image/png" sizes="32x32" href="https://www.allpree.com/img/AllPreepwaapp.png"/>
<link rel="apple-touch-icon" type="image/png" sizes="96x96" href="https://www.allpree.com/img/AllPreepwaapp.png"/>
<link rel="apple-touch-icon" type="image/png" sizes="16x16" href="https://www.allpree.com/img/AllPreepwaapp.png"/>
	<link rel="web-app-origin-association" href="/web-app-origin-association">
   <link rel="manifest" href="https://www.allpree.com/manifest.json">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
     <title>See Today's Deals</title>
	 <meta name="robots" content="noindex, nofollow" />
         <style>
		  * {
  box-sizing: border-box;
}
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      margin-top: 0px;
      padding: 20px 20px 100px 20px; /* top, right, bottom, left */
      overscroll-behavior-y: none;
      overscroll-behavior: none;    
    }

 #bottomMenu {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #ffffff;
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding: 10px;
      border-top: 1px solid #ccc;
      z-index: 1000;
    }

#bottomMenu::-webkit-scrollbar {
  display: none; /* Chrome & Safari */
}
 
    .menu-button {
      background: #007bff;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      flex: 0 0 auto;
      cursor: pointer;
      white-space: nowrap;
    }

    #panel {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 100vh;
      background: white;
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
      transform: translateY(80%);
      transition: transform 0.3s ease;
      z-index: 999;
       pointer-events: auto;
      touch-action: none;
      display: flex;
      flex-direction: column;
    }

    #handle {
      width: 30%;
      height: 5px;
      background: #bbb;
      border-radius: 10px;
      margin: 8px auto;
    }
    
    #panelContent {
      flex: 1;
      pointer-events: auto;
      overflow-y: auto;
      padding: 16px;
    }
		 
    h1 {
      text-align: center;
      margin-bottom: 20px;
    
    }

	.hidden {
  display: none;
}	 

.noscroll {
  overflow: hidden;
  height: 100vh;
}

#overrideButton {
  display: block;
  margin: 2rem auto;
  padding: 0.75rem 1.5rem;
  background-color: #1d4ed8;
  color: white;
  border: none;
  border-radius: 0.5rem;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  transition: background-color 0.3s;
}

#overrideButton:hover {
  background-color: #2563eb;
}
.hidden-offline {
  display: none !important;
}


		 
.favorite-brand-badge {
    
    color: #fff;
     font-weight: bold;
  padding: 2px 10px;
  border-radius: 20px;
  position: absolute;
  top: -10px;
  right: -225px;
  font-size: 12px;
  box-shadow: 0 0 8px rgba(0,0,0,0.2);
}	
 .brand-logo-container {
  position: absolute; /* Needed for badge positioning */
 
}
		 
.favorite-brand-highlight {
  --highlight-border-color: gold; /* Default fallback */
  border: 3px solid var(--highlight-border-color);
  border-radius: 12px;
  padding-left: 50px;
  padding-right: 50px;
}

.top-ranked-badge {
  background-color:  #f5f5f5;
  color: #000;
  font-weight: bold;
  padding: 2px 10px;
  border-radius: 20px;
  position: absolute;
  top: -10px;
  right: -225px;
  font-size: 12px;
  box-shadow: 0 0 8px rgba(0,0,0,0.2);
}
.brand-logo-container {
  position: absolute; /* Needed for badge positioning */
 
}

.location-badge {
  background-color: #f5f5f5;
  color: #000;
  font-weight: bold;
  padding: 2px 10px;
  border-radius: 20px;
  position: absolute;
  top: -10px;
  right: -70px;
  font-size: 12px;
  box-shadow: 0 0 8px rgba(0,0,0,0.2);
}
.brand-logo-container {
  position: absolute; /* Needed for badge positioning */
 
}
		 
.top-deal-badge {
  background-color: gold;
  color: #000;
  font-weight: bold;
  padding: 2px 10px;
  border-radius: 20px;
  position: absolute;
  top: -10px;
  right: -225px;
  font-size: 12px;
  box-shadow: 0 0 8px rgba(0,0,0,0.2);
}
.brand-logo-container {
  position: absolute; /* Needed for badge positioning */
 
}
	     
	     
.top-brand-highlight {
	
  border: 3px solid gold;	
  border-radius: 12px;
  animation: glowPulse 2s ease-in-out infinite;
  box-shadow: 0 0 10px gold;
  
  padding-left: 50px;
  padding-right: 50px;
}

@keyframes glowPulse {
  0% {
    box-shadow: 0 0 10px gold;
  }
  50% {
    box-shadow: 0 0 20px orange;
  }
  100% {
    box-shadow: 0 0 10px gold;
  }
}

     .countdown-timer {
  font-weight: bold;
  color: #007bff;
}

.countdown-urgent .countdown-timer {
  color: #ff4136;
  animation: blink 1s step-start 0s infinite;
}

.countdown-ended {
  color: gray;
}

@keyframes blink {
  50% {
    opacity: 0;
  }
}

	
    .countdown {
      text-align: center;
      font-size: 18px;
      margin-bottom: 20px;
    }
		 
    .brand-section {
      margin-bottom: 30px;
		    
    }

.countdown-upcoming {
  color: orange;
  font-style: italic;
}
		 
    .brand {
  display: flex;
  align-items: center;
  gap: 12px;
	    
  margin-left: -15px;
  margin-right: -15px;
  width: calc(100% + 30px); /* wider than container */    
  
  background-color: #fff;
  padding: 1px 1px;
  border-radius: 10px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  margin-bottom: 1px;
  min-height: 7px;
}

.brand-logo-container {
 
height: 60px;
  width: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.brand-logo-container img {
  max-height: 100%;
  max-width: 100%;
  object-fit: contain;
  border-radius: 8px;
}
    .brand img {
      width: 100px;
      height: 100px;
      margin-left: 8px;
      border-radius: 1px;
      object-fit: contain;
    }
    .brand-name {
      font-size: 18px;
      font-weight: bold;
      margin-left: 67px;
    }
    .brand-timer {
  font-size: 14px;
  margin-left: 67px;
    }

    .deal {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      flex: 0 0 auto;
      margin-left: -20px;
      margin-right: -20px;
      width: 100%;
      scroll-snap-align: start;
      position: relative;
      cursor: pointer;
    }

	.deal-item {
  opacity: 0;
  transform: translateY(10px);
  animation: fadeInUp 0.3s ease forwards;
}

@keyframes fadeInUp {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
	 
		 
    .deal-grid {
      display: grid;
      grid-auto-flow: column;
      grid-template-rows: repeat(1, 1fr); /* 2 rows */
      grid-auto-columns: 54.2%;  
       
       margin-left: -5px;
       margin-right: -5px;
	    
      gap: 15px;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      padding: 10px 20px;  /*Slightly more padding for breathing room */
      scrollbar-width: none; /* Firefox */
    }
		 
    .deal-grid.takeover-active {
      grid-template-rows: repeat(2, 1fr); /* 2 rows for takeover */
    }
    .deal-grid::-webkit-scrollbar {
      display: none; /* Chrome, Safari */
	    
    }
    .deal img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
    }
    .deal-content {
      padding: 10px;
      
    }
    .deal-title {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .price {
      color: #999;
      text-decoration: line-through;
      font-size: 14px;
    }
    .discount {
      color: #e60000;
      font-weight: bold;
      font-size: 16px;
    }
    .discount-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: red;
      color: white;
      font-weight: bold;
      font-size: 12px;
      padding: 4px 6px;
      border-radius: 4px;
    }

     /* Popup Styles */
.popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
 width: 100%;
    height: 100%;
  background: linear-gradient(
    to bottom,
    rgba(0, 0, 0, 1) 0%,
    rgba(0, 0, 0, 1) 10%,
    rgba(0, 0, 0, 1) 20%,
    rgba(0, 0, 0, 1) 30%,
    rgba(0, 0, 0, 1) 40%,
    rgba(0, 0, 0, 1) 50%,
    rgba(0, 0, 0, 1) 60%,
    rgba(0, 0, 0, 1) 70%,
    rgba(0, 0, 0, 1) 80%,
    rgba(0, 0, 0, 1) 90%,
    rgba(0, 0, 0, 1) 100%
  );
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  flex-direction: column;
  gap: 20px;
}

.popup-content {
  background: white;
  justify-content: center;
  border-radius: 10px;
  max-width: 500px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;	
}


.tab-switcher {
  display: flex;
  width: 50%;
  justify-content: center;
  background: black;
  margin-top: -0px; /* or try -10px if you want to pull it up */	
  padding: 5px 0;
}

.tab-btn {
  flex: 1;
  background: transparent;
  border: none;
  font-size: 16px;
  font-weight: bold;
  color: rgba(255, 255, 255, 0.5);
  padding: 5px;
  position: relative;
  cursor: pointer;
}

.tab-btn.active {
  color: #fff;
}

.tab-btn.active::after {
  content: "";
  position: absolute;
  bottom: -2px;
  left: 50%;
  transform: translateX(-50%);
  width: 30px;
  height: 3px;
  background: #fff;
  border-radius: 2px;
}

		 
.image-wrapper {
  width: 100%;
  height: 200px; /* Fixed container height */
  background: #f9f9f9;
  border-top-left-radius: 10px;
  border-top-right-radius: 10px;
  overflow: hidden; /* Important: clip the image if needed */
  display: flex;
  align-items: center;
  justify-content: center;
}

.image-wrapper img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain; /* Show full image inside without cutting */
  display: block;
}

.popup-body {
  padding: 20px;
}

.popup-title {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 10px;
}

.popup-price {
  font-size: 14px;
  text-decoration: line-through;
  color: #888;
}

.popup-discount {
  font-size: 18px;
  color: #e60000;
  font-weight: bold;
}
		
.popup-cashback {
  font-weight: bold;
  color: #28a745;
  font-size: 13px;
}	
		
.final-price {
  margin-top: -10px;  
  margin-bottom: 10px;
  color: #e60000; /* Green shade for positive pricing */
  font-weight: bold;
  font-size: 12px;
}
		
.popup-discount-badge {
  position: absolute;
  top: 15px;
  right: 15px;
  background: red;
  color: white;
  font-weight: bold;
  font-size: 9px;
  padding: 5px 8px;
  border-radius: 4px;
  z-index: 10;
}
		 /* Style for the Like Button */
.like-btn {
  font-size: 1rem;
  background: none;
  border: none;
  cursor: pointer;
  transition: transform 0.2s ease;
  position: absolute; /* Position it inside the container */
  bottom: -120px; /* Pushes the button down */
  right: 15px; /* Adjust to your desired position (can be changed to center, right, etc.) */
  color: black; /* Initial color */
  z-index: 10; /* Ensures it's above other content */
}

.like-btn.liked {
  color: red;
  transform: scale(1.2); /* Enlarges the button when liked */
}

.popup-savings {
  position: absolute; /* Position it absolutely */
  top: 15px; /* Adjust position as needed */
  left: 15px; /* Align to the right side */
  background: #28a745; /* Green color for savings */
  color: white;
  font-weight: bold;
  font-size: 12px;
  padding: 5px 8px;
  border-radius: 4px;
  z-index: 10; /* Ensure it stays above other elements */
}


.popup-description {
  font-size: 9px;
  padding-top: 10px;
}

.popup-close {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 28px;
  color: #333;
  cursor: pointer;
  font-weight: bold;
}

.popup-brand-box {
 margin: 10px 20px 20px 20px; /* Top, horizontal, bottom */
  padding: 10px;
  border-top: 1px solid #eee;
  background-color: #fdfdfd;
  border-radius: 8px;
  display: flex;
  flex-direction: column; /* Stack brand name and timer vertically */
  align-items: flex-start; /* Align to the left */
  gap: 8px; /* Space between brand name and timer */
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.popup-brand-box .brand-logo-container {
  height: 50px;
  width: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.popup-brand-box .brand-logo-container img {
  max-height: 100%;
  max-width: 100%;
  object-fit: contain;
  border-radius: 6px;
}

.popup-brand-box .brand-name {
  font-size: 16px;
  font-weight: bold;
}

.popup-brand-box .brand-timer {
  font-size: 14px;
  color: #555;
}
		 
#brandContainer .badge-premium,
#brandContainer	.badge-starter, 
#brandContainer .badge-exclusive,	 
#brandContainer .badge-pro {
  position: absolute;
  top: -30px;
  right: 4px;
  font-size: 24px;
  padding: 3px 8px;
  z-index: 2;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}	


.popup-back-arrow {
  position: absolute;
  left: 15px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  font-size: 22px;
  color: #888;
  cursor: pointer;
  display: none;
  z-index: 11;
  padding: 6px 10px;
  border-radius: 4px;
}

.popup-back-arrow:hover {
  color: black;
}
		 

/* Liked Deals Gallery (Horizontal Scroll) */
#likedDealsSection {
  border: 0px ;
  padding-top: 0;
  padding-right: 1rem;
  padding-bottom: 1rem;
  padding-left: 1rem;
  
  box-shadow: 0 0 0px;
  margin-bottom: 40px;
  animation: fadeInUp 0.4s ease-in-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(15px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}


/* Deal Grid Style for Liked Deals */
#likedDealsGallery {
display: grid;
  grid-auto-flow: column;
  grid-template-rows: repeat(1, 1fr); /* Two rows if needed */
  grid-auto-columns: 54.2%;
  gap: 15px;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  padding: 10px 20px;
  margin-left: -5px;
  margin-right: -5px;
  margin-top: -25px; /* Pulls the gallery up */
  scrollbar-width: none; /* Firefox */
}

#likedDealsGallery::-webkit-scrollbar {
  display: none; /* Chrome & Safari */
}

/* Style for the container around the brand logo (liked-deal-brand) */
.liked-deal-brand {
height: 40px;
  width: 40px;
  display: flex;
	border: 3px solid #163a5c; /* Glowing border */
  align-items: center;
  justify-content: center;
	border-radius: 50%;
	overflow: hidden;
	object-position: top;
	position: relative;
	margin-top: 10px;
        margin-left: 10px;
}

/* Styling for the image inside the brand logo container */
.liked-deal-brand-img {
  max-height: 100%;
  max-width: 100%;
  object-fit: contain;
	
  border-radius: 8px;
  align-items: center;
  padding: 3px;
  justify-content: center;
}

		 
/* Card style for each liked deal */
.liked-deal-card {
  background: white;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  flex: 0 0 auto;
  width: 100%;
  scroll-snap-align: start;
  position: relative;
  cursor: pointer;
  transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.liked-deal-card:hover {
  transform: scale(1.05);
  box-shadow: 0 0 15px rgba(255, 111, 97, 0.7);
}
		 
/* Optional glow if liked */
.liked-deal-card.liked {
   border: 2px solid #ff6f61;
  box-shadow: 0 0 15px rgba(255, 111, 97, 0.7);
}

/* Image Styling */
.liked-deal-card-img {
  width: 65%;
  height: 65%;
  margin-top: -20px;
  object-fit: contain; /* shows entire image without cropping */
  border-top-left-radius: 10px;
  border-top-right-radius: 10px;
  background-color: white; /* background: #f9f9f9; *//* optional: adds background behind image if needed */
  padding: 30px; /* optional: gives image breathing room */
}

/* Card Content */
.liked-deal-content {
 padding-left: 12px;
height: 20%;
}
		 
.liked-deal-title {
  font-size: 9px;
  font-weight: bold;
  margin-top: -25px;
  margin-bottom: 5px;
}

.liked-deal-price {
  color: #999;
  text-decoration: line-through;
  font-size: 14px;
}


.liked-deal-discount {
 color: #e60000;
  font-weight: bold;
  font-size: 16px;
}

/* Discount badge */
.liked-discount-badge {
  position: absolute;
  top: 16.6px;
  right: 10px;
  background: red;
  color: white;
  font-weight: bold;
  font-size: 10px;
  padding: 4px 6px;
  border-radius: 4px;
}

#cartBtnContainer.hidden {
  display: none !important;
}

#popupAddToCartBtn {
  font-size: 1rem;
  background: none;
  border: none;
  cursor: pointer;
  transition: transform 0.2s ease;
  position: absolute;
  bottom: -130px;
  right: 15px;
  color: black;
  z-index: 10;
}

#popupAddToCartBtn.in-cart {
  color: green;
  transform: scale(1.2);
}
	 
.cart-icon {
  position: absolute;
  top: 10px;
  right: 20px;
  font-size: 24px;
  cursor: pointer;
}

.cart-count {
  position: absolute;
  top: -8px;
  right: -8px;
  background-color: red;
  color: white;
  border-radius: 50%;
  font-size: 12px;
  padding: 2px 6px;
}
#cart-icon-container {
  position: fixed;
  top: 10px;
  right: 10px;
  z-index: 1000;
}

#cart-icon {
  font-size: 24px;
  background: white;
  border-radius: 50%;
  padding: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  cursor: pointer;
}
#cartBtn {
  display: flex;
  align-items: center;
  gap: 4px; /* space between icon and count */
  font-size: 12px;
}
		 
.cart-icon2 {
  font-size: 20px;
  padding: 0px;
  cursor: pointer;
}
.cart-count2 {
  font-weight: bold;
  background-color: red;
  color: white;
  padding: 2px 6px;
  border-radius: 50%;
  font-size: 12px;
}
		 
/* Badge styles for premium and pro tiers */
.badge-premium, .badge-pro, .badge-starter, .badge-exclusive {
  background-color: transparent;
  border: 0.0px solid  #000;
  color: #fff;
  font-weight: bold;
  padding: 0px 0px;
  border-radius: 20px;
  position: absolute;
  top: -15px;
  right: 10px;
  font-size: 24px;
  z-index: 2;
  box-shadow: 0 0 0px #f5f5f5;
}
		 
.premium-brand-highlight {
  border: 3px solid  #f5f5f5;
  border-radius: 12px;
  box-shadow: 0 0 10px  #f5f5f5;
 
}

.pro-brand-highlight {
  border: 3px solid  #f5f5f5;
  border-radius: 12px;
  box-shadow: 0 0 15px  #f5f5f5;
  
}
.starter-brand-highlight {
  border: 3px solid #f5f5f5;
  border-radius: 12px;
  box-shadow: 0 0 8px #f5f5f5;
}

.exclusive-brand-highlight {
  border: 3px solid #f5f5f5;
  border-radius: 12px;
  box-shadow: 0 0 12px #f5f5f5;
}
.brand-logo-container {
  position: absolute; /* Needed for badge positioning */
 
}
		 
  /* SPLASH SCREEN SCOPED STYLES */
  #splash-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #e7ebf2;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    z-index: 9999;
  }

  #splash-screen video {
    max-width: 90vw;
    max-height: 90vh;
    width: 320px;
    height: auto;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  }

  #splash-screen .loading-text {
    margin-top: 24px;
    font-family: Arial, sans-serif;
    color: #333;
    font-size: 18px;
    text-align: center;
    display: flex;
    gap: 2px;
    flex-wrap: wrap;
    justify-content: center;
  }

  #splash-screen .loading-text span {
    opacity: 0;
    animation: fadeInLetter 0.5s forwards;
  }

  @keyframes fadeInLetter {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }	


/* Main Admin Panel */
#adminPanel {
  display: none;
  position: fixed;
  bottom: 60px;
  left: 10px;
  background: #ffffff;
  border-radius: 12px;
  padding: 16px;
  width: 280px;
  max-height: 80vh;         /* Limit height */
  overflow-y: auto;         /* Enable vertical scrolling */
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  font-size: 14px;
  z-index: 9999;
}
		 
#rankSlotButtonsContainer {
  display: flex;
  gap: 5px;  /* Space between buttons */
  justify-content: start;  /* Align buttons to the left */
  margin-bottom: 10px;  /* Adjust margin as needed */
}		 

/* Style for rank slot buttons */
.rankSlotBtn {
  padding: 5px 5px; /* Smaller padding */
  font-size: 12px;   /* Smaller text size */
  margin: 0 5px;     /* Space between buttons */
  cursor: pointer;
  background-color: #f0f0f0;
  border: 1px solid #ccc;
  border-radius: 5px;
  transition: background-color 0.3s ease;
}

/* Hover effect for buttons */
.rankSlotBtn:hover {
  background-color: #e0e0e0;
}
		 
		 
/* Buttons Inside Panel */
#adminPanel button {
  margin-top: 8px;
  margin-bottom: 8px;
  background-color: #3498db;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 10px 14px;
  cursor: pointer;
  font-size: 14px;
  width: 100%;
  transition: background-color 0.25s ease;
}

#adminPanel button:hover {
  background-color: #2980b9;
}

/* Close Button Styling */
#closeAdminPanelBtn {
  background-color: #e74c3c;
  font-weight: 600;
}

#closeAdminPanelBtn:hover {
  background-color: #c0392b;
}

/* Labels & Inputs */
#adminPanel label {
  display: block;
  margin-top: 12px;
  margin-bottom: 4px;
  font-weight: 600;
  color: #333;
}

#adminPanel input[type="datetime-local"] {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 14px;
  box-sizing: border-box;
  transition: border-color 0.3s;
}

#adminPanel input[type="datetime-local"]:focus {
  border-color: #3498db;
  outline: none;
}

/* Takeover Backdrop */
#admin-takeover-brand-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  bottom: 68px;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

#admin-takeover-brand-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 12px;
  padding: 16px;
  width: 90%;
  max-width: 500px;
  height: 60%;
  max-height: 70vh;
  overflow-y: auto;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  z-index: 9999;
}

#admin-takeover-brand-popup::-webkit-scrollbar {
  display: none;
}


		 
/* Backdrop */
#admin-favorite-brand-backdrop,
#admin-single-rank-backdrop{
  position: fixed;
  top: 0;
  left: 0;
  bottom: 68px;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

/* Brand Popup */
#admin-favorite-brand-popup,
#admin-single-rank-backdrop {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 12px;
  padding: 16px;
  width: 90%;
  max-width: 500px;
  height: 60%;
  max-height: 70vh;
  overflow-y: auto;
  scrollbar-width: none;
  -ms-overflow-style: none;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  z-index: 9999;
}

#admin-favorite-brand-popup::-webkit-scrollbar {
  display: none;
}

/* Brand Carousel */
.admin-brand-carousel {
  display: flex;
  flex-direction: column;
  gap: 10px;
  overflow-y: scroll;
  max-height: 60vh;
  padding: 10px;
}

/* Brand Card Styling */
.admin-brand-card {
  width: 100%;
  display: flex;
  align-items: center;
  padding: 10px 14px;
  border: 1px solid #ddd;
  border-radius: 8px;
  cursor: pointer;
  background-color: #f9f9f9;
  transition: all 0.25s ease;
}

.admin-brand-card:hover {
  transform: scale(1.03);
  background-color: #f0f0f0;
}

.admin-brand-card.selected {
  border: 2px solid #e74c3c;
  background-color: #ffe6e6;
}

.admin-brand-card img {
  width: 42px;
  height: 42px;
  margin-right: 16px;
  border-radius: 50%;
}

body.no-scroll {
  overflow: hidden;
}	
		 
#loading-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: rgba(255, 255, 255, 0.8);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 10005;
  display: none;
}

#loading-spinner {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #333;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin-bottom: 10px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
#a2hs-popup {
      display: none;
      position: fixed;
      bottom: 80px;
      left: 0;
      right: 0;
      background: #fff;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
      padding: 16px;
      z-index: 99999;
      font-family: sans-serif;
    }
    #a2hs-popup .content {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    #a2hs-install-btn {
      background: #0071ce;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 4px;
      cursor: pointer;
    }
    #a2hs-close {
      margin-left: 10px;
      font-size: 20px;
      background: none;
      border: none;
      cursor: pointer;
    }
    .section {
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      max-width: 700px;
      margin: 20px auto;
    }
    .columns2 {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    .column2 {
      flex: 1 1 45%;
      display: flex;
      gap: 15px;
      align-items: flex-start;
      background: #ffff;
      padding: 15px;
      border-radius: 10px;
    }

    .emoji2 {
      font-size: 1.5rem;
      flex-shrink: 0;
      line-height: 1;
    }
   
    .content2 h1 {
      margin: 0 0 10px;
      font-size: 1.2rem;
      font-weight: bold;
    }

    .content2 p {
      margin: 0;
      font-size: 1.0rem;
      line-height: 1.5;
    }

   .menu-button[data-view="signup"] {
     visibility: hidden;
     position: absolute;
     left: -9999px;
}
.menu-button[data-view="topup"] {
     visibility: hidden;
     position: absolute;
     left: -9999px;
}
.menu-button[data-view="generategiftcard"] {
     visibility: hidden;
     position: absolute;
     left: -9999px;
}		 
#leaderboardPopup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 90%;
  background-color: #fff;
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  padding: 10px;
  z-index: 9999;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  display: none; /* Hidden by default */
}


  #leaderboardPopup.show {
    display: block;
  }

  #leaderboardPopup h2 {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 16px;
    text-align: center;
    color: #333;
  }

  #leaderboardContent {
    max-height: 400px;
    overflow-y: auto;
  }

  .leaderboard-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #f5f5f5;
    border-radius: 8px;
    padding: 8px 12px;
    margin-bottom: 8px;
    transition: background-color 0.2s ease;
  }

  .leaderboard-row:hover {
    background-color: #e0e0e0;
  }

  .leaderboard-left {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .leaderboard-idcode {
    background-color: #ccc;
    color: #333;
    font-size: 12px;
    font-weight: bold;
    padding: 4px 8px;
    border-radius: 8px;
    min-width: 50px;
    text-align: center;
  }

  .leaderboard-name {
    font-size: 14px;
    color: #222;
    font-weight: 600;
  }

  .leaderboard-points {
    font-size: 14px;
    font-weight: 700;
    color: #1e40af; /* blue-800 */
  }

  .leaderboard-tabs {
  display: flex;
  justify-content: center;
  border-bottom: 2px solid #ddd;
  margin-bottom: 12px;
}

.leaderboard-tab {
  padding: 10px 16px;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  text-align: center;	
  color: #666;
  position: relative;
}

.leaderboard-tab.active {
  color: #1e40af; /* Blue for active */
}

.leaderboard-tab.active::after {
  content: "";
  position: absolute;
  bottom: -2px;
  left: 0;
  right: 0;
  height: 3px;
  background-color: #1e40af;
  border-radius: 2px 2px 0 0;
}
#sponsorTakeover {
  padding: 10px;
  text-align: center;
  margin-bottom: 20px;
}

.takeover-banner img {
  max-width: 50px;
  border-radius: 50%;
  margin-bottom: 8px;
}

.takeover-heading {
  font-size: 16px;
  text-align: center;
  font-weight: bold;
  color: #1e40af;
}

.takeover-description {
  font-size: 14px;
  text-align: center;
  color: #333;
}

		 
  /* Close button */
  .close-button {
    position: absolute;
    top: 12px;
    right: 16px;
    font-size: 24px;
    color: #666;
    background: none;
    border: none;
    cursor: pointer;
  }
  .close-button:hover {
    color: #111;
  }

.help-section {
    max-width: 600px;
    margin: 0 auto;
    padding-bottom: 80px;
    font-family: Arial, sans-serif;
    font-size: 14px;
  }
  .accordion {
    border: 1px solid #ccc;
    border-radius: 4px;
    margin-bottom: 8px;
  }
  .accordion-header {
    background: #0078d7;
    color: white;
    cursor: pointer;
    padding: 12px 16px;
    font-weight: bold;
    user-select: none;
    font-size: 14px;
  }
  .accordion-content {
    padding: 12px 16px;
    background: #f9f9f9;
    display: none;
    border-top: 1px solid #ccc;
    line-height: 1.6;
  }
  .accordion-header.active {
    background: #005ea2;
  }
  .accordion-content ul {
    padding-left: 18px;
    margin: 0;
  }
  .accordion-content li {
    margin-bottom: 6px;
  }
  .icon {
    margin-right: 6px;
    vertical-align: middle;
  }
.drag-hint {
  text-align: right;
  margin-right: -100px;
  font-size: 0.475rem;
  color: #888;
  z-index: 9999;
  margin-top: -4px;
}	

#storyListPopup {
  position: fixed;
  inset: 0;
  background: white;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 998;
}

#storyListContainer {
  background: white;
  padding: 20px;
  max-height: 80vh;
  overflow-y: auto;
  width: 90%;
  max-width: 600px;

  display: grid;
  grid-template-columns: 1fr; /* single column */
  gap: 16px;
  border-radius: 16px;
}
  
#closeStoryListPopupBtn {
  position: fixed;      /* fixed relative to viewport */
  top: 16px;            /* distance from top */
  right: 16px;          /* distance from right */
  z-index: 110;         /* above popup backdrop */
  background: #ff4444;  /* red button */
  border: none;
  color: white;
  font-weight: bold;
  font-size: 20px;
  width: 36px;
  height: 36px;
  border-radius: 18px;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
.story-tile {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 16px;
  background: white;
  border-radius: 12px;
  margin-bottom: 16px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  transition: box-shadow 0.3s ease, transform 0.2s ease;
}

.story-tile:hover {
  transform: translateY(-2px);
}

.story-tile img {
   width: 64px;
  height: 64px;
  object-fit: cover;
  border-radius: 10px;
  flex-shrink: 0;
}

.story-tile h3 {
   font-size: 1.3rem;
  font-weight: 700;
  text-transform: capitalize;
  margin: 0;
  line-height: 1.2;
  color: #222;
}

  .swiper {
  position: fixed;
  inset: 0; /* top: 0, right: 0, bottom: 0, left: 0 */
  width: 100vw;
  height: 100vh;
  background: black;
  z-index: 9999;
  display: none;

  overflow: hidden;
  pointer-events: auto;
  isolation: isolate;

  /* Prevents subtle layout bleed-through from outer elements */
  box-shadow: 0 0 0 9999px black;
}

.swiper-slide {
  background-size: cover;
  background-position: center;
  position: relative;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  z-index: 40;
}

.slide-overlay {
  position: absolute;
  bottom: 0;
  width: 100%;
  padding: 1rem;
  background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
  color: white;
  text-align: center;
  z-index: 50;
}

.slide-title {
  font-size: 2rem;
  font-weight: bold;
  text-transform: capitalize;
}

.slide-desc {
  font-size: 1.2rem;
  margin-top: 0.5rem;
}

.headline-slide .slide-title {
  font-size: 2.5rem;
  font-weight: 800;
  text-transform: uppercase;
  font-family: 'Oswald', sans-serif;
  letter-spacing: 0.05em;
  margin-bottom: 30%;
}

.headline-slide {
  align-items: center !important;
  justify-content: center !important;
}

.cta-container {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 0.5rem;
  margin-top: 0.75rem;
}

.cta-button {
  padding: 0.75rem 1rem;
  border-radius: 10px;
  font-weight: bold;
  font-size: 1rem;
  text-decoration: none;
  cursor: pointer;
  color: #000;
  z-index: 30;
  position: relative;
  flex: 1 1 auto;
  max-width: 25%;
}

.cta-link-button {
  background: #FFD700;
}

.cta-jump-button {
  background: #FF0000;
  color: #fff;
}

.cta-button.close-story-button {
  background-color: transparent;
  border: 2px solid #fff;
  color: #fff;
  font-size: 14px;
  padding: 6px 10px;
  border-radius: 50%;
  margin-left: 10px;
  cursor: pointer;
}

.progress-bar {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  display: flex;
  gap: 4px;
  padding: 10px;
  z-index: 10000 !important;
}

.progress-segment {
  flex: 1;
  height: 4px;
  background: rgba(255, 255, 255, 0.25);
  border-radius: 2px;
  overflow: hidden;
  backdrop-filter: brightness(0.9);
}

.progress-fill {
  height: 100%;
  width: 0%;
  background: white;
  box-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
  transition: width 0.3s ease;
}

.tap-zone {
  position: absolute;
  width: 20%;
  height: 100%;
  top: 0;
  z-index: 20;
}

.tap-left { left: 0; }
.tap-right { right: 0; }

.sponsored-label {
  position: absolute;
  top: 20px;
  right: 10px;
  background: rgba(255, 255, 255, 0.25);
  padding: 4px 8px;
  font-size: 1rem;
  color: #fff;
  border-radius: 4px;
  z-index: 10;
}

.brand-logo {
  position: absolute;
  top: 20px;
  left: 10px;
  height: 32px;
  width: auto;
  border-radius: 6px;
  z-index: 10;
}
		 
  </style>
  
<link rel="manifest" href="https://www.allpree.com/manifest.json">
<script>
    if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("https://www.allpree.com/service-worker.js")
            .then(() => console.log("Service Worker Registered"))
            .catch((error) => console.log("Service Worker Registration Failed", error));
    }
</script>	

	<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J2Z2P5DQPN"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-J2Z2P5DQPN');
</script>

</head>
<body>
<!-- start webpushr tracking code  
<script>(function(w,d, s, id) {if(typeof(w.webpushr)!=='undefined') return;w.webpushr=w.webpushr||function(){(w.webpushr.q=w.webpushr.q||[]).push(arguments)};var js, fjs = d.getElementsByTagName(s)[0];js = d.createElement(s); js.id = id;js.async=1;js.src = "https://cdn.webpushr.com/app.min.js";
fjs.parentNode.appendChild(js);}(window,document, 'script', 'webpushr-jssdk'));
webpushr('setup',{'key':'BE2GVRF5mLk7Fp1kzgXE_A5QDGK54HwqN1wEgxczP_fzfugkPREKHebr_Bfzd13eEyrn2rpv_IxZ-H9A4rygXPA' });</script>
 end webpushr tracking code -->

	<div class="container">
             <div class="row land">
                 <div class="home">     
 			<div class="center">
                 <div class="col-md-6 home-txt1">
			 
<div id="a2hs-popup" style="display: none;
      position: fixed;
      bottom: 80px;
      left: 20px;
      right: 20px;
      background: #fff;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
      padding: 16px;
      z-index: 99999;
      font-family: sans-serif;
">
  <div class="section" style="display: flex; align-items: center; margin-bottom: 16px;">
    <div class="emoji2" style="font-size: 2rem; margin-right: 12px;">
  <img src="https://www.allpree.com/img/AllPreepwaapp.png" alt="AllPree App Icon" style="height: 88px; width: 88px; border-radius: 10px;" />
</div>
    <div class="content2">
      
	 <img src="https://www.allpree.com/img/AllPreeLocalDeals.png" alt="AllPree App Icon" style="height: 45px; width: 188px; border-radius: 0px;" />    
	    
    </div>
  </div>
   Get full access to all local deals, exclusive offers, and shopping tools, no account needed. To log in, you'll need to create an account. <br><br>
  <div id="a2hs-message" style="margin-bottom: 16px;">
    <!-- This will be filled dynamically for Android or iOS -->
  </div>
  <div style="display: flex; justify-content: flex-end;">
    <button id="a2hs-install-btn" style="margin-right: 10px;">Install</button>
    <button id="a2hs-close">×</button>
  </div>
</div>
			 
 <div id="splash-screen">
    <video autoplay muted playsinline preload="auto">
      <source src="https://www.allpree.com/img/allpree%20Video.mp4" type="video/mp4">
      Your browser does not support the video tag.
    </video>
    <div class="loading-text" id="loadingText"></div>
  </div>
			  <div id="main-app" style="display: none;">
			 
	
				  <br>
  <div id="deals-container">Loading deals...</div>

	<div id="bottomMenu">
        <div id="refresh-button" style="position: fixed;" class="menu-button" onclick="location.reload()"><i class="fa-solid fa-arrows-rotate fa-lg"></i></div>
        <div class="menu-button" style="margin-left: 60px;" id="viewAllButton"><i class="fa-solid fa-book-open-reader fa-lg"></i></div>	
	<div id="lockButton" onclick="openLeaderboard()" class="menu-button"><i class="fa-solid fa-arrow-up-wide-short fa-lg"></i></div>
        <div id="profile" class="menu-button" data-view="profile"><i class="fa-solid fa-user fa-lg"></i></div>
	<div id="CartButton" class="menu-button" onclick="openCartPopup()"><i class="fa-solid fa-cart-shopping fa-lg"></i> <span id="cart-count" style="background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px; margin-left: 4px; display: none;">0</span></div>
        <div id="savedListsButton" class="menu-button" onclick="openSavedListsPopup()"><i class="fa-solid fa-receipt fa-lg"></i></div>
	<div id="marketing" class="menu-button" data-view="marketing"><i class="fa-solid fa-share-from-square fa-lg"></i></div>	
       <div id="salesletter" class="menu-button" data-view="salesletter">Get <i class="fa-solid fa-magnifying-glass-plus fa-lg"></i></div>

<div id="offlineMessage" class="menu-button" style="
  display: none;
  max-width: 185px;
  background: #f44336;
  color: white;
  text-align: center;
  font-weight: bold;
  font-size: 0.75rem;
  word-wrap: break-word;

">
  You are offline. To get the latest deals,<br> 
  please go back online. wifi or data
</div>

		
  <div class="menu-button" data-view="signup"><i class="fa-solid fa-file-contract fa-lg"></i> Sign Up</div> 
  <div class="menu-button" data-view="generategiftcard"><i class="fa-solid fa-credit-card fa-lg"></i> Digital Card</div>
  <div class="menu-button" data-view="topup"><i class="fa-solid fa-building-columns fa-lg"></i> Topup Card</div>
<!--  <div class="menu-button" data-view="balance"><i class="fa-solid fa-piggy-bank fa-lg"></i> Check Balance</div>	-->
 
  		
 
<!--  <div id="favorite-brand-button" class="menu-button" onclick="openFavoriteBrandPopup()"><i class="fa-solid fa-heart fa-lg"></i> Brand</div> -->
</div>

<div id="storyListPopup" style="display: none;">
   <button id="closeStoryListPopupBtn">X</button>
  <div id="storyListContainer" class="story-grid"></div>
</div>

<div class="swiper" style="display:none;">
  <div class="swiper-wrapper" id="storyWrapper"></div>
  <div class="progress-bar" id="progressBar"></div>
  <div class="tap-zone tap-left" id="tapLeft"></div>
  <div class="tap-zone tap-right" id="tapRight"></div>
</div>


				  
<!-- Slide-up panel content area -->
<div id="panel" class="slide-up-panel">
  <div id="handle">
	<div class="drag-hint">⬆️⬇️ Drag up or down</div>  
  </div>
  <div id="panelContent">
	  
<div class="help-section">
 

   <div class="accordion">
    <div class="accordion-header">1. 🏬 Browse Deals by Brand</div>
    <div class="accordion-content">
      <ul>
        <li><span class="icon">🏬</span>Brands are sorted by discount and ⏳ expiration time.</li>
        <li><span class="icon">⭐</span> <strong>Featured Brand:</strong> Automatically open when you launch the app.</li>
         <li><span class="icon">🌟</span> <strong>Top 5 Brands:</strong>  Brands pick to be on top.</li>
        <li><span class="icon">🔥</span> <strong>Hottest Discount:</strong> Top discounts across all brands.</li>
        <li><span class="icon">🚫</span>No deals available right now. Means check back later.</li>
      </ul>
    </div>
  </div>

  <div class="accordion">
    <div class="accordion-header">2. 🏷️ Brand Recognition Guide</div>
    <div class="accordion-content">
      <ul>
        <li><span class="icon">🏆</span> <strong>Elite Brand</strong> </li>
        <li><span class="icon">👑</span> <strong>Pro Brand</strong> </li>
        <li><span class="icon">💎</span> <strong>Premium Brand</strong> </li>
        <li><span class="icon">🎁</span> <strong>Starter Brand</strong></li>
        
        
        
      </ul>
    </div>
  </div>

  <div class="accordion">
    <div class="accordion-header">3. 🏆 Elite Brand</div>
    <div class="accordion-content">
      <ul>
        <li><span class="icon">💥</span> <strong>Exclusive Brand:</strong> They are the only deals in the system.</li>
        <li><span class="icon">👆</span> <strong>During Exclusive:</strong> Click Show All Other Brands to reveal the others.</li>
        </ul>
    </div>
  </div>

  <div class="accordion">
    <div class="accordion-header">4. 🔍 View Deal Details</div>
    <div class="accordion-content">
      <ul>
        <li><span class="icon">👆</span>Click on any deal to see price, cashback, and expiration.</li>
        <li><span class="icon">⬆️⬇️</span>Swipe up or down to move between deals.</li>
        <li><span class="icon">➖</span>Tap on the tabs to switch between mode.</li>
        <li><span class="icon">📝</span> Add deals to your cart.</li>
        <li><span class="icon">❌</span> Delete deals from your cart.</li>
         <li><span class="icon">❤️</span>Tap the heart icon to likes deals you like.</li>
      </ul>
    </div>
  </div>

  <div class="accordion">
    <div class="accordion-header">5. ❤️ Likes Deals</div>
    <div class="accordion-content">
      <ul>
       <li><span class="icon">❤️</span>Likes deals auto-load at the top for quick access.</li>
        <li><span class="icon">👆</span>Click on any liked deals to view all liked deals.</li>
        
      </ul>
    </div>
  </div>

  <div class="accordion">
    <div class="accordion-header">6. 🛒 Shopping Cart</div>
    <div class="accordion-content">
      <ul>
        <li><span class="icon">💵</span>See subtotals, tax, and grand totals by brand.</li>
        <li><span class="icon">📃</span>Clear brand-specific all items from your cart.</li>
      </ul>
    </div>
  </div>

  <div class="accordion">
    <div class="accordion-header">7. 💾 Save Shopping List</div>
    <div class="accordion-content">
      <ul>
        <li><span class="icon">📃</span> Save your current shopping list for later reference.</li>
        <li><span class="icon">📅</span> Lists are saved by brand with date and items included.</li>
        <li><span class="icon">📂</span> You can open saved lists anytime to review them quickly.</li>
      </ul>
    </div>
  </div>
	
  <div class="accordion">
    <div class="accordion-header">8. 📍 Store Locations</div>
    <div class="accordion-content">
      <ul>
        <li><span class="icon">📍</span>Click <strong>Location</strong> to get stores directions.</li>
        <li><span class="icon">📉</span>Enable location access to get directions in Google Maps.</li>
      </ul>
    </div>
  </div>

  <div class="accordion">
    <div class="accordion-header">9. 🧪 Tips & Tricks</div>
    <div class="accordion-content">
      <ul>
        
        <li><span class="icon">👆</span>Click to open and close brands grid to reshuffle deals.</li>
        <li><span class="icon">⏳</span>Keep an eye on timers, some expire quickly.</li>
       
      </ul>
    </div>
  </div>

  <div class="accordion">
    <div class="accordion-header">10. ❓ Troubleshooting</div>
    <div class="accordion-content">
      <ul>
        <li><span class="icon">🔄</span>Refresh the page if deals don’t load.</li>
        <li><span class="icon">🚫</span>Check your internet connection.</li>
        <li><span class="icon">📍</span>Enable location access for maps and directions.</li>
        <li><span class="icon">🔧</span>Clearing browser data removes saved favorites and cart.</li>
        <li><span class="icon">📧</span>Need help? <strong>just message us on WhatsApp</strong></li>
      </ul>
    </div>
  </div>
</div>

<script>
  document.querySelectorAll('.accordion-header').forEach(header => {
    header.addEventListener('click', () => {
      const currentlyActive = document.querySelector('.accordion-header.active');
      if (currentlyActive && currentlyActive !== header) {
        currentlyActive.classList.remove('active');
        currentlyActive.nextElementSibling.style.display = 'none';
      }

      header.classList.toggle('active');
      const content = header.nextElementSibling;
      content.style.display = header.classList.contains('active') ? 'block' : 'none';
    });
  });
</script>	  
  </div>
</div>

<!-- Leaderboard Popup -->
<div id="leaderboardPopup" class="popup">
  <button onclick="closeLeaderboard()" class="close-button" aria-label="Close leaderboard popup">&times;</button>
  <h2>🎯 Referral Challenge</h2>
	
  <div class="leaderboard-tabs">
    <div class="leaderboard-tab" onclick="showTab('sponsorTab', this)">⭐ Sponsor</div>
    <div class="leaderboard-tab" onclick="showTab('leaderboardTab', this)">🏆 Leaderboard</div>
    <div class="leaderboard-tab" onclick="showTab('winnersTab', this)">🎉 Winners</div>
  </div>

<div class="tab-content" id="sponsorTab" style="display: none;"> 
  <div id="sponsorContent"> <center> <h3 style="margin-bottom: 10px;">No Sponsor Right Now</h3>
    <p>Check back soon for your chance to win exclusive vouchers from top brands.</p>
    <p>🔥 Exciting giveaways and offers are always around the corner!</p> </center></div> 
</div>
	
  <div class="tab-content" id="leaderboardTab" style="display: none;">
    <div id="leaderboardContent">Loading leaderboard...</div>
  </div>

  <div class="tab-content" id="winnersTab" style="display: none;">
    <div id="winnersContent">Loading past winners...</div>
  </div>
</div>



				  
		  
 <!-- Popup Overlay -->
<div class="popup-overlay" id="popup">

<div class="tab-switcher">
  <button id="showLikedBtn" class="tab-btn">Likes</button>
  <button id="showRandomBtn" class="tab-btn active">Deals</button>
  <button id="showBrandTabBtn" class="tab-btn">Shop</button>
 <button id="cartBtn" class="tab-btn">
  <span class="cart-icon2">🛒</span>
  <span id="cartCount" class="cart-count2">0</span>
</button>
</div>

	
  <div class="popup-content" id="popupContent">
    <span class="popup-close" onclick="closePopup()">×</span>
    <div style="position: relative;">
      <span class="popup-discount-badge" id="popupBadge"></span>
	    
      <button id="popupBack" class="popup-back-arrow"></button> 
     <div class="image-wrapper">
      <img id="popupImg" src="" alt="Product">
    </div>
	   <div id="cartBtnContainer" class="hidden">
	    <button id="popupAddToCartBtn" class="cart-btn">🛒 Add</button>
	    </div>
	   <div id="likeButtonContainer">
  <button class="like-btn" id="popupLikeBtn">🤍 Like</button>
</div>

    </div>
    <div class="popup-body">
      <div class="popup-title" id="popupTitle"></div>
      <div class="popup-price" id="popupPrice"></div>
      <div class="popup-discount" id="popupDiscount"></div>
      <div class="popup-savings" id="popupSavings"></div> <!-- Savings element below the discount -->
      <div id="popupCashback" class="popup-cashback"></div>
      <div class="popup-description" id="popupDesc"></div>
     
    </div>	  
  </div> 

 <!-- Brand Box Wrapper -->
<div class="popup-brand-box" id="brandContainer">
  <div class="brand-logo-container">
    <img id="brandLogo" src="" alt="Brand Logo" class="brand-logo">
  </div>

	<div class="brand-text-container">
    <div id="brandName" class="brand-name"></div>
    <span id="popupTimer" class="brand-timer"></span>
  </div>
  
</div>
	
</div> 


<div id="cartPopup" style="display: none; position: fixed; top: 60px; right: 10px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; background: white; border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.3); z-index: 10000; padding: 16px;"></div>
			 
<script>
let sheetUrls = [];		
const allBrandsData = [];       // Holds all data from each brand's sheet
const allDealsFlat = [];        // Flattened list of all deals across brands
let currentPopupDeal = null;    // Currently open deal in the popup
let likedDealIndex = 0;         // Index of current liked deal being viewed
let likedDealKeys = [];         // Array of liked deal keys
let isLikedMode = false;        // Tracks whether we’re in liked mode or random mode
let allDealsFromSheets = [];
let isBrandMode = false;
let brandDealIndex = 0;
let brandDealKeys =[];	
let isSwiping = false;
let isNavigating = false; // Flag to prevent multiple redirects happening at the same time
let lastKnownLocation = null;
let userLocation = null;
let brandLocations = {}; // Declare at the top of your script
let popupCountdownInterval = null;

// Initialize the app, calling loadBrandLocations and loadDeals
async function init() {
  await loadBrandLocations();  // Load brand locations first
  await loadDeals();           // Then load the deals
}	

async function loadSheetUrls() { 
  try {
    const response = await fetch('https://opensheet.elk.sh/1WcTbHLTOpUl-TK7r0rTWZ_PuT0umIaBc00tzGZozgFw/Sheet1');
    const data = await response.json();

    // Convert data into just a flat array of URLs
    sheetUrls = data.map(row => row.sheeturls);  // assumes column name is exactly 'sheeturls'

    console.log(sheetUrls);
    init(); // ✅ Start the app after URLs are ready

  } catch (err) {
    console.error('Failed to load sheet URLs:', err);
  }
}

loadSheetUrls();
	
// Inject loading modal into the DOM (this will add the spinner)
function injectLoadingModal() {
  if (document.getElementById('loading-modal')) return; // Prevent duplicates

  const modal = document.createElement('div');
  modal.id = 'loading-modal';
  modal.style.display = 'none'; // Initial hidden state
  modal.innerHTML = `
    <div id="loading-spinner"></div>
    <div id="loading-text">Loading...</div>
  `;
  
  document.body.appendChild(modal);
}


////// START
document.addEventListener('DOMContentLoaded', () => {
  // Panel Variables and Setup
  const panel = document.getElementById("panel");
  const content = document.getElementById("panelContent");
  let startY = 0, currentY = 0, panelY = 0, isDragging = false;
  const screenHeight = window.innerHeight;

  const positions = {
    full: screenHeight * 0,
     mid: screenHeight * 0.7,
    collapsed: screenHeight * 0.89
  };

  const allowedViews = ["add", "generategiftcard", "topup", "signup", "balance", "marketing", "salesletter",  "profile"]; // restrict valid views

  // Set panel position with optional animation
 function setPanelY(y, animate = true) {
  panel.style.transition = animate ? "transform 0.3s ease" : "none";
  panel.style.transform = `translateY(${y}px)`;
  panelY = y;

  // Toggle body scroll depending on panel state
  if (y === positions.mid) {
    document.body.classList.add('noscroll');
  } else if (y === positions.collapsed) {
    document.body.classList.remove('noscroll');
  }
}


  // Snap to the nearest defined position
  function closestSnap(y) {
    const diffs = Object.values(positions).map(p => Math.abs(p - y));
    const min = Math.min(...diffs);
    return Object.values(positions)[diffs.indexOf(min)];
  }

  // Load content dynamically and safely
  async function loadPanelContent(view) {
  if (!allowedViews.includes(view)) {
    console.warn(`[Panel] Blocked attempt to load unknown view: "${view}"`);
    return;
  }

  const url = `${view}.html`; // Path to load HTML content based on the view

  try {
    // Fetch the HTML content
    const res = await fetch(url);
    const html = await res.text();

    const contentDiv = document.getElementById('panelContent');
    contentDiv.innerHTML = html;

    // Set dynamic padding to avoid content hiding behind menu
    const bottomPadding = screenHeight - positions.collapsed;
    contentDiv.style.paddingBottom = `${bottomPadding + 50}px`;

    // Execute inline scripts within the loaded HTML
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    tempDiv.querySelectorAll('script').forEach((script) => {
      const newScript = document.createElement('script');
      if (script.src) {
        newScript.src = script.src;
      } else {
        newScript.textContent = script.textContent;
      }
      document.body.appendChild(newScript);
    });

   
    // Check if script is already added before appending
// Check if script is already added before appending
if (!document.querySelector(`script[src="https://allpree.com/js/${view}.js"]`)) {
  const script = document.createElement('script');
  script.src = `https://allpree.com/js/${view}.js`;
  script.onload = () => {
    const initFn = `init_${view}`;
    if (typeof window[initFn] === 'function') {
      window[initFn]();
    }
  };
  document.body.appendChild(script);
} else {
  // If already loaded, call the function immediately
  const initFn = `init_${view}`;
  if (typeof window[initFn] === 'function') {
    window[initFn]();
  }
}
	  

    // Show the panel
    setPanelY(positions.mid);

  } catch (err) {
    contentDiv.innerHTML = "<p>Error loading content.</p>";
    console.error('Error loading content:', err);
  }
}


  // Handle drag start
  function startDrag(e) {
    if (content.scrollTop > 0) return; // only drag if scroll is at top
    startY = e.touches ? e.touches[0].clientY : e.clientY;
    isDragging = true;
    panel.style.transition = "none";
  }

  // Handle dragging movement
  function duringDrag(e) {
    if (!isDragging) return;

    currentY = e.touches ? e.touches[0].clientY : e.clientY;
    const delta = currentY - startY;
    const newY = Math.min(positions.collapsed, Math.max(0, panelY + delta)); // Clamp to collapsed
    panel.style.transform = `translateY(${newY}px)`;
  }

  // Handle drag end
  function endDrag() {
    if (!isDragging) return;
    isDragging = false;

    const delta = currentY - startY;
    const newY = Math.max(0, panelY + delta);
    const snapTo = closestSnap(newY);
    setPanelY(snapTo);
  }

  // Attach unified drag listeners
  ["touchstart", "mousedown"].forEach(evt =>
    panel.addEventListener(evt, startDrag, { passive: false })
  );
  ["touchmove", "mousemove"].forEach(evt =>
    panel.addEventListener(evt, duringDrag, { passive: false })
  );
  ["touchend", "mouseup"].forEach(evt =>
    panel.addEventListener(evt, endDrag)
  );

  // Dynamically handle button clicks
  const buttons = document.querySelectorAll('.menu-button[data-view]');
  buttons.forEach(button => {
    button.addEventListener('click', () => {
      const view = button.getAttribute('data-view');
      loadPanelContent(view);
    });
  });


  // ✅ GOOD: Set initial panel position immediately
  panelY = positions.collapsed;
  setPanelY(panelY, false);

// Panel logic
document.addEventListener('DOMContentLoaded', () => {
  const panel = document.getElementById("panel");
  // ... rest of panel script using `positions`
});

// Padding logic
document.addEventListener('DOMContentLoaded', () => {
    const mainContent = document.querySelector('.deal-grid'); // you're using this class

    if (mainContent) {
      const collapsedOffset = window.innerHeight - positions.collapsed;
      mainContent.style.paddingBottom = `${collapsedOffset + 50}px`;
    }
  });
	
});

/////// END	

	
/////////// ADMIN
	
// --- Create the Admin Panel ---

let selectedRankSlot = null;
let selectedRankBrand = null;
let adminSelectedTakeoverBrand = localStorage.getItem('adminSelectedTakeoverBrand') || null;


// Admin Panel
const adminPanel = document.createElement('div');
adminPanel.id = 'adminPanel';
adminPanel.style.display = 'none';
adminPanel.innerHTML = `

<a href="https://www.allpree.com/add"><button>Add Products</button> </a>
 <hr />
<button id="selectTakeoverBrandBtn">Select Takeover Brand</button>
<label for="takeoverExpiryInput">Takeover Expiry:</label>
<input type="datetime-local" id="takeoverExpiryInput" />
<button id="sendTakeoverBtn">Update Takeover Brand</button>
 <hr />
  <div> <strong>Select Top Rank Slot:</strong><br/>  
  <div id="rankSlotButtonsContainer">
  ${[1, 2, 3, 4, 5].map(i => `<button class="rankSlotBtn" data-slot="${i - 1}"> ${i}</button>`).join(' ')}
</div> </div>
  <button id="selectTopRankBrandBtn" disabled>Select Top Rank Brand</button>
  <label for="rankExpiryInput">Expiration Date:</label>
  <input type="datetime-local" id="rankExpiryInput" />
  <button id="sendSelectedRankBtn" disabled>Update Top Rank Brand</button>
  <hr />

  <button id="selectFavoriteBrandBtn">Select Featured Brand</button>
  <label for="expiryInput">Favorite Expiry:</label>
  <input type="datetime-local" id="expiryInput" />
  <button id="sendFeaturedBtn">Update Featured Brand</button>
`;

document.body.appendChild(adminPanel);

// Show/hide with 5 clicks
let tapCount = 0;
let lastTapTime = 0;
const lockButton = document.getElementById('lockButton');
	
document.body.addEventListener('click', () => {
  const now = Date.now();
  if (now - lastTapTime < 600) {
    tapCount++;
    if (tapCount >= 13) {
      tapCount = 0;
      showAdminPanel();
    }
  } else {
    tapCount = 1;
  }
  lastTapTime = now;
});

function showAdminPanel() {
  adminPanel.style.display = adminPanel.style.display === 'none' ? 'block' : 'none';
}

// Rank Slot Buttons
document.querySelectorAll('.rankSlotBtn').forEach(btn => {
  btn.addEventListener('click', () => {
    selectedRankSlot = parseInt(btn.getAttribute('data-slot'));
    selectedRankBrand = null;
    document.getElementById('selectTopRankBrandBtn').disabled = false;
    document.getElementById('sendSelectedRankBtn').disabled = true;
    alert(`Selected Slot ${selectedRankSlot + 1}`);
  });
});

// Select Brand for Slot
document.getElementById('selectTopRankBrandBtn').addEventListener('click', () => {
  if (selectedRankSlot === null) {
    alert('Please select a slot first!');
    return;
  }
  openRankBrandPopup();
});

// Format to YYYY-MM-DDTHH:mm
const expiryDate = new Date(expiryInput);
const year = expiryDate.getFullYear();
const month = String(expiryDate.getMonth() + 1).padStart(2, '0');
const day = String(expiryDate.getDate()).padStart(2, '0');
const hours = String(expiryDate.getHours()).padStart(2, '0');
const minutes = String(expiryDate.getMinutes()).padStart(2, '0'); 
const formattedExpiry = `${year}-${month}-${day}T${hours}:${minutes}`;

	
// Update Slot Button
document.getElementById('sendSelectedRankBtn').addEventListener('click', () => {
  const expiry = document.getElementById('rankExpiryInput').value;
  if (!expiry || !selectedRankBrand || selectedRankSlot === null) {
    alert('Make sure you selected a slot, brand, and expiration!');
    return;
  }

  const formattedExpiry = new Date(expiry).toISOString().slice(0, 16);

  fetch('https://script.google.com/macros/s/AKfycbxl-2XeXXvcOE4VTHVp-7fFnzvpoj8qqI_O2ZfjgVAm0e1sC9NQxRYJTlCFM2LrXLH3/exec', {
    method: 'POST',
    body: new URLSearchParams({
      brand: selectedRankBrand,
      expiresAt: formattedExpiry,
      index: selectedRankSlot.toString(),
      action: 'toprank'
    })
  }).then(() => {
    alert(`Slot ${selectedRankSlot + 1} updated with "${selectedRankBrand}"`);
    selectedRankSlot = null;
    selectedRankBrand = null;
    document.getElementById('selectTopRankBrandBtn').disabled = true;
    document.getElementById('sendSelectedRankBtn').disabled = true;
  }).catch(err => {
    console.error('Error:', err);
    alert('There was an error updating the slot.');
  });
});

// Favorite Brand Flow (unchanged)
document.getElementById('selectFavoriteBrandBtn').addEventListener('click', () => {
  openAdminFavoriteBrandPopup();
});

document.getElementById('sendFeaturedBtn').addEventListener('click', () => {
  const selectedBrand = localStorage.getItem('selectedFavoriteBrand');
  const expiryInput = document.getElementById('expiryInput').value;
  if (!expiryInput) return alert('Please select expiration!');
  if (!selectedBrand) return alert('Select a favorite brand first!');

  const formattedExpiry = new Date(expiryInput).toISOString().slice(0, 16);

  fetch('https://script.google.com/macros/s/AKfycbxl-2XeXXvcOE4VTHVp-7fFnzvpoj8qqI_O2ZfjgVAm0e1sC9NQxRYJTlCFM2LrXLH3/exec', {
    method: 'POST',
    body: new URLSearchParams({
      brand: selectedBrand,
      expiresAt: formattedExpiry,
      action: 'favorite'
    })
  }).then(() => {
    alert('Featured brand successfully updated!');
  }).catch(err => {
    console.error('Error updating brand:', err);
    alert('Error updating featured brand.');
  });
});

// Favorite Brand Popup
function openAdminFavoriteBrandPopup() {
  if (document.getElementById('admin-favorite-brand-backdrop')) return;

  document.body.classList.add('no-scroll');
  const backdrop = document.createElement('div');
  backdrop.id = 'admin-favorite-brand-backdrop';
  backdrop.addEventListener('click', e => {
    if (e.target === backdrop) closeAdminFavoriteBrandPopup();
  });

  const popup = document.createElement('div');
  popup.id = 'admin-favorite-brand-popup';

  const brands = allBrandsData.map(brand => ({ name: brand.brand, logo: brand.logo }));
  const selectedBrand = localStorage.getItem('selectedFavoriteBrand');
  const carousel = document.createElement('div');
  carousel.className = 'admin-brand-carousel';

  brands.forEach(brand => {
    const card = document.createElement('div');
    card.className = 'admin-brand-card';
    if (brand.name === selectedBrand) card.classList.add('selected');

    card.innerHTML = `<img src="${brand.logo}" /><strong>${brand.name}</strong>`;
    card.onclick = () => {
      document.querySelectorAll('.admin-brand-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      localStorage.setItem('selectedFavoriteBrand', brand.name);
      closeAdminFavoriteBrandPopup();
    };

    carousel.appendChild(card);
  });

  popup.appendChild(carousel);
  backdrop.appendChild(popup);
  document.body.appendChild(backdrop);
}

function closeAdminFavoriteBrandPopup() {
  document.getElementById('admin-favorite-brand-backdrop')?.remove();
  document.body.classList.remove('no-scroll');
}
	
// Brand Selection Popup for Top Rank
function openRankBrandPopup() {
  if (document.getElementById('admin-single-rank-backdrop')) return;

  const backdrop = document.createElement('div');
  backdrop.id = 'admin-single-rank-backdrop';

  backdrop.addEventListener('click', e => {
    if (e.target === backdrop) closeRankBrandPopup();
  });

  const popup = document.createElement('div');
  popup.id = 'admin-single-rank-popup';
  popup.innerHTML = '<h3>Select a Brand for Slot</h3>';

  const brandList = document.createElement('div');
  brandList.className = 'admin-brand-carousel'; // <-- use correct class

  allBrandsData.forEach(brand => {
    const card = document.createElement('div');
    card.className = 'admin-brand-card'; // <-- use correct class

    const img = document.createElement('img');
    img.src = brand.logo;

    const label = document.createElement('div');
    label.textContent = brand.brand;

    card.appendChild(img);
    card.appendChild(label);

    card.onclick = () => {
      selectedRankBrand = brand.brand;
      document.getElementById('sendSelectedRankBtn').disabled = false;
      closeRankBrandPopup();
    };

    brandList.appendChild(card);
  });

  popup.appendChild(brandList);
  backdrop.appendChild(popup);
  document.body.appendChild(backdrop);
}

function closeRankBrandPopup() {
  const el = document.getElementById('admin-single-rank-backdrop');
  if (el) el.remove();
}



document.getElementById('selectTakeoverBrandBtn').addEventListener('click', () => {
  openAdminTakeoverBrandPopup();
});

document.getElementById('sendTakeoverBtn').addEventListener('click', () => {
  const expiryInput = document.getElementById('takeoverExpiryInput').value;
  if (!expiryInput) return alert('Please select expiration!');
  if (!adminSelectedTakeoverBrand) return alert('Select a takeover brand first!');

  const formattedExpiry = new Date(expiryInput).toISOString().slice(0, 16);
  console.log("Submitting takeover brand:", adminSelectedTakeoverBrand);
  fetch('https://script.google.com/macros/s/AKfycbxl-2XeXXvcOE4VTHVp-7fFnzvpoj8qqI_O2ZfjgVAm0e1sC9NQxRYJTlCFM2LrXLH3/exec', {
    method: 'POST',
    body: new URLSearchParams({
      brand: adminSelectedTakeoverBrand,
      expiresAt: formattedExpiry,
      action: 'takeover'
    })
  }).then(() => {
    alert('Takeover brand successfully updated!');
  }).catch(err => {
    console.error('Error updating takeover brand:', err);
    alert('Error updating takeover brand.');
  });
});

function openAdminTakeoverBrandPopup() {
  if (document.getElementById('admin-takeover-brand-backdrop')) return;
const selectedBrand = localStorage.getItem('adminSelectedTakeoverBrand');

  document.body.classList.add('no-scroll');

  const backdrop = document.createElement('div');
  backdrop.id = 'admin-takeover-brand-backdrop';
  backdrop.className = 'admin-favorite-brand-backdrop';
  backdrop.addEventListener('click', e => {
    if (e.target === backdrop) closeAdminTakeoverBrandPopup();
  });

  const popup = document.createElement('div');
  popup.id = 'admin-takeover-brand-popup';
  popup.className = 'admin-favorite-brand-popup';

  const carousel = document.createElement('div');
  carousel.className = 'admin-brand-carousel';

  const brands = allBrandsData.map(brand => ({ name: brand.brand, logo: brand.logo }));

  brands.forEach(brand => {
    const card = document.createElement('div');
    card.className = 'admin-brand-card';
    if (brand.name === adminSelectedTakeoverBrand) card.classList.add('selected');

    card.innerHTML = `<img src="${brand.logo}" alt="${brand.name}" /><strong>${brand.name}</strong>`;
    card.onclick = () => {
  document.querySelectorAll('.admin-brand-card').forEach(c => c.classList.remove('selected'));
  card.classList.add('selected');
  adminSelectedTakeoverBrand = brand.name;
  localStorage.setItem('adminSelectedTakeoverBrand', brand.name); // ✅ no conflict with user view
  closeAdminTakeoverBrandPopup();
  alert(`Takeover brand selected: ${adminSelectedTakeoverBrand}`);
};

    carousel.appendChild(card);
  });

  popup.appendChild(carousel);
  backdrop.appendChild(popup);
  document.body.appendChild(backdrop);
}

function closeAdminTakeoverBrandPopup() {
  document.getElementById('admin-takeover-brand-backdrop')?.remove();
  document.body.classList.remove('no-scroll');
}


	
//////////END
	
fetch('https://opensheet.elk.sh/1_DyGLoYi5ndEkiwhPEzJhMc3vciIFNhN2g-H0gbVRds/sheet1')
  .then(res => res.json())
  .then(data => {
    const last = data[data.length - 1];
    const now = new Date();
    const expiry = new Date(last['Expires At']);
    const featuredBrand = last['Featured Brand'];

    console.log('Now:', now.toISOString());
    console.log('Expiry from sheet:', last['Expires At']);
    console.log('Parsed Expiry:', expiry.toISOString());
    console.log('Featured Brand:', featuredBrand);

    const storedBrand = localStorage.getItem('selectedFavoriteBrand');
    const originalBrand = localStorage.getItem('originalBrand');

    if (now < expiry && featuredBrand) {
      if (!originalBrand && storedBrand && storedBrand !== featuredBrand) {
        localStorage.setItem('originalBrand', storedBrand);
      }

      localStorage.setItem('selectedFavoriteBrand', featuredBrand);
      localStorage.setItem('tempExpiryTime', expiry.getTime()); // 👈 THIS should run
      console.log('tempExpiryTime set to:', expiry.getTime());
    } else {
      if (originalBrand) {
        localStorage.setItem('selectedFavoriteBrand', originalBrand);
        localStorage.removeItem('originalBrand');
      }
      localStorage.removeItem('tempExpiryTime');
      console.log('Expired or missing brand — reset to original.');
    }
  });
	
/////////// 

fetch('https://opensheet.elk.sh/1_DyGLoYi5ndEkiwhPEzJhMc3vciIFNhN2g-H0gbVRds/Sheet5')
  .then(res => res.json())
  .then(data => {
    const last = data[data.length - 1];
    const now = new Date();
    const expiry = new Date(last['Expires At']);
    const takeoverBrand = last['Take Over Brand'];

    console.log('Now:', now.toISOString());
    console.log('Expiry from sheet:', last['Expires At']);
    console.log('Parsed Expiry:', expiry.toISOString());
    console.log('Take Over Brand:', takeoverBrand);

    const overrideUntil = parseInt(sessionStorage.getItem('overrideTakeoverUntil') || '0', 10);
    const overrideBrand = sessionStorage.getItem('originalTakeoverBrand');
    const storedBrand = localStorage.getItem('selectedTakeoverBrand');
    const originalBrand = localStorage.getItem('originalTakeoverBrand');

    if (Date.now() < overrideUntil) {
      // Override still active
      console.log('🟡 Override in effect until', new Date(overrideUntil).toISOString());
      return;
    } else {
      // Override expired, cleanup override session keys
      sessionStorage.removeItem('overrideTakeoverUntil');
      sessionStorage.removeItem('originalTakeoverBrand');
    }

    if (now < expiry && takeoverBrand) {
      // Only store original if it hasn't already been saved
      if (!originalBrand && storedBrand && storedBrand !== takeoverBrand) {
        localStorage.setItem('originalTakeoverBrand', storedBrand);
      }

      localStorage.setItem('selectedTakeoverBrand', takeoverBrand);
      localStorage.setItem('takeoverExpiryTime', expiry.getTime());
      console.log('✅ Takeover brand set:', takeoverBrand, 'Expires at:', expiry.toISOString());
    } else {
      // Expired or missing — restore original if it exists
      if (originalBrand) {
        localStorage.setItem('selectedTakeoverBrand', originalBrand);
        localStorage.removeItem('originalTakeoverBrand');
        console.log('🔁 Restored original brand:', originalBrand);
      } else {
        localStorage.removeItem('selectedTakeoverBrand');
        console.log('❌ No brand to restore — cleaned up');
      }

      localStorage.removeItem('takeoverExpiryTime');
    }
  });
	
///////////	

// Load ranked slots (Sheet2)
fetch('https://opensheet.elk.sh/1_DyGLoYi5ndEkiwhPEzJhMc3vciIFNhN2g-H0gbVRds/sheet2')
  .then(res => res.json())
  .then(data => {
    const now = new Date();

    data.forEach((row, i) => {
      const brand = row['Brand'];          // Adjust keys if necessary
      const expiry = new Date(row['Expires At']); // Adjust keys if necessary

      const slotKey = `rankedSlot${i + 1}`;
      const expiryKey = `${slotKey}Expiry`;

      if (brand && expiry && now < expiry) {
        localStorage.setItem(slotKey, brand);
        localStorage.setItem(expiryKey, expiry.getTime());
        console.log(`Set ${slotKey} to ${brand} (expires at ${expiry})`);
      } else {
        localStorage.removeItem(slotKey);
        localStorage.removeItem(expiryKey);
        console.log(`${slotKey} expired or missing — cleared.`);
      }
    });
  });
	
//////////END
	
function getDealKey(deal) {
  return `${(deal.brandName || '').trim().toLowerCase()}-${(deal.name || '').trim().toLowerCase()}`
    .replace(/\s+/g, '')      // remove spaces
    .replace(/[^a-z0-9\-]/g, ''); // strip weird characters
}

///////  ///////// START


function updateFavoriteBrandCount(count) {
  const countEl = document.getElementById('favorite-brand-count');
  if (countEl) {
    countEl.textContent = count;
    countEl.style.display = count > 0 ? 'inline-block' : 'none';
  }
}

function getTotalFavoriteBrands() {
  const favoriteBrands = JSON.parse(localStorage.getItem('favoriteBrands') || '[]');
  return favoriteBrands.length;
}

function addToFavorites(brand) {
  const favoriteBrands = JSON.parse(localStorage.getItem('favoriteBrands') || '[]');
  const alreadyInFavorites = favoriteBrands.includes(brand);

  if (alreadyInFavorites) {
    const index = favoriteBrands.indexOf(brand);
    favoriteBrands.splice(index, 1);
    console.log('Removed from favorites:', brand);
  } else {
    favoriteBrands.push(brand);
    console.log('Added to favorites:', brand);
  }

  localStorage.setItem('favoriteBrands', JSON.stringify(favoriteBrands));
  updateFavoriteBrandCount(getTotalFavoriteBrands());
  showFavoriteBrandIcon();

  return !alreadyInFavorites; // return new state: true if added, false if removed
}

function showFavoriteBrandIcon() {
  const favoriteBrands = JSON.parse(localStorage.getItem('favoriteBrands') || '[]');
  if (favoriteBrands.length > 0) {
    document.getElementById('favorite-brand-icon').style.display = 'block';
  } else {
    document.getElementById('favorite-brand-icon').style.display = 'none';
  }
}

function openFavoriteBrandPopup() {
  // Prevent duplicate backdrop
  if (document.getElementById('favorite-brand-backdrop')) return;

  // Create backdrop
  const backdrop = document.createElement('div');
  backdrop.id = 'favorite-brand-backdrop';
  backdrop.style = `
    position: fixed;
    top: 0;
    left: 0;
    bottom: 68px;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  `;
  backdrop.addEventListener('click', (e) => {
    if (e.target === backdrop) closeFavoriteBrandPopup();
  });

  // Create popup
  let popup = document.getElementById('favorite-brand-popup');
  if (!popup) {
    popup = document.createElement('div');
    popup.id = 'favorite-brand-popup';
    popup.style = `
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  padding: 10px;
  width: 90%;
  max-width: 500px;
  height: 70%;
  max-height: 100vh;
   overflow-y: scroll; /* Allow scroll */
  scrollbar-width: none; /* Firefox hide */
  -ms-overflow-style: none; /* IE/Edge hide */
  box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
  z-index: 9999;
`;
  }

  // Add swipeable brand content dynamically from allBrandsData
  const brands = allBrandsData.map(brand => ({ name: brand.brand, logo: brand.logo }));  // Extract brand names and logos
  popup.innerHTML = '';

  if (brands.length === 0) {
    popup.innerHTML = `<div style="text-align:center;">No favorite brands available.</div>`;
  } else {
    const brandCarousel = document.createElement('div');
    brandCarousel.style = 'display: flex; flex-direction: column; gap: 10px; overflow-y: scroll; max-height: 70vh; padding: 10px;';

    // Retrieve selected brand from localStorage
    const selectedBrand = localStorage.getItem('selectedFavoriteBrand');

    // Add each brand as a card
    brands.forEach(brand => {
      const brandCard = document.createElement('div');
      brandCard.style = `
        width: 100%;
        display: flex;
        align-items: center;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
        background-color: #f8f8f8;
        transition: all 0.3s;
      `;

      const brandLogo = document.createElement('img');
      brandLogo.src = brand.logo;  // Set the logo image source
      brandLogo.style = 'width: 40px; height: 40px; margin-right: 15px; border-radius: 50%;';
      
      const brandName = document.createElement('strong');
      brandName.innerText = brand.name;

      brandCard.appendChild(brandLogo);
      brandCard.appendChild(brandName);

      // Check if this brand was previously selected
      if (brand.name === selectedBrand) {
        brandCard.style.border = '2px solid #ff4d4d';
        brandCard.style.backgroundColor = '#ffe6e6';
      }

      // Click event to select brand
      brandCard.onclick = () => {
        selectFavoriteBrand(brand.name, brandCard);
      };

      // Hover effect
      brandCard.onmouseover = () => {
        brandCard.style.transform = 'scale(1.05)';
        brandCard.style.backgroundColor = '#f0f0f0';
      };

      brandCard.onmouseout = () => {
        brandCard.style.transform = 'scale(1)';
        brandCard.style.backgroundColor = '#f8f8f8';
      };

      // Add brand card to carousel
      brandCarousel.appendChild(brandCard);
    });

    popup.appendChild(brandCarousel);
  }

  backdrop.appendChild(popup);
  document.body.appendChild(backdrop);
}

// Select a brand and highlight it visually
function selectFavoriteBrand(brand, brandCard) {
  console.log(`Selected favorite brand: ${brand}`);

  // Reset previous selections
  const allBrandCards = document.querySelectorAll('#favorite-brand-popup div');
  allBrandCards.forEach(card => {
    card.style.border = '1px solid #ddd';
    card.style.backgroundColor = '#f8f8f8';
  });

  // Highlight selected brand
  brandCard.style.border = '2px solid #ff4d4d';
  brandCard.style.backgroundColor = '#ffe6e6';

  // Save selected brand to localStorage
  localStorage.setItem('selectedFavoriteBrand', brand);
  closeFavoriteBrandPopup();
}

function closeFavoriteBrandPopup() {
  const backdrop = document.getElementById('favorite-brand-backdrop');
  if (backdrop) backdrop.remove();
  document.body.style.overflow = ''; // Re-enable page scroll
}

///////  ///////// END	

/////// ////////// START

document.addEventListener('DOMContentLoaded', () => {
  updateCartCount(getTotalCartItems());
});

document.getElementById('cartBtn').addEventListener('click', (e) => {
  e.stopPropagation(); // Prevents closing the current popup
  openCartPopup();
});
	
function updateCartCount(count) {
  const countEl = document.getElementById('cart-count');
  const tabCountEl = document.getElementById('cartCount');
  if (countEl) {
    countEl.textContent = count;
    countEl.style.display = count > 0 ? 'inline-block' : 'none';
  }
  if (tabCountEl) {
    tabCountEl.textContent = count;
  }
}

function getTotalCartItems() {
  const cart = JSON.parse(localStorage.getItem('cartItems') || '{}');
  return Object.values(cart).reduce((sum, items) => sum + items.length, 0);
}

function addToCart(deal) {
  const dealKey = getDealKey(deal);
  const brand = deal.brandName?.trim() || 'Unknown';
  const cart = JSON.parse(localStorage.getItem('cartItems') || '{}');
  let brandItems = cart[brand] || [];

  const itemIndex = brandItems.findIndex(item => item._id === dealKey);
  const inCart = itemIndex !== -1;

  if (inCart) {
    // Remove item
    brandItems.splice(itemIndex, 1);
    console.log('Removed from cart:', deal.name);
  } else {
    // Add item
    const price = parseFloat(deal.discount?.toString().replace(/,/g, '') || '0');
    brandItems.push({
      _id: dealKey,
      brand: deal.brandName,
      brandimg: deal.brandLogo,
      name: deal.name,
      img: deal.img || deal.image || '',
      price
    });
    console.log('Added to cart:', deal.name);
  }

  cart[brand] = brandItems;
  localStorage.setItem('cartItems', JSON.stringify(cart));
  updateCartCount(getTotalCartItems());
  showCartIcon();

  return !inCart; // return new state: true if added, false if removed
}

function clearBrandCart(brand) {
  const cart = JSON.parse(localStorage.getItem('cartItems') || '{}');
  delete cart[brand];
  localStorage.setItem('cartItems', JSON.stringify(cart));
  updateCartCount(getTotalCartItems());

  const popup = document.getElementById('cart-popup');
  if (!popup) return;

  // Remove the brand section directly
  const brandSections = popup.querySelectorAll('strong');
  brandSections.forEach(strong => {
    if (strong.textContent.trim() === brand) {
      const section = strong.closest('div[style*="border-bottom"]');
      if (section) section.remove();
    }
  });

  // If nothing left in cart, show empty message
  const remainingCart = JSON.parse(localStorage.getItem('cartItems') || '{}');
  const hasItems = Object.values(remainingCart).some(arr => arr.length > 0);
  if (!hasItems) {
    popup.innerHTML = `<div style="text-align:center;">📝 Your shopping list is empty.</div>`;
  }
}

// Location utilities
	

function saveLocation(coords) {
  localStorage.setItem('userLocation', coords);
}

function getSavedLocation() {
  return localStorage.getItem('userLocation');
}

async function loadBrandLocations() {
  try {
    const res = await fetch('https://opensheet.elk.sh/19K8yc9jeDGb4BRjKq_lE_Xh0d-K7p-f24QtnP7vv0sQ/Sheet1');
    if (!res.ok) throw new Error('Failed to fetch locations from Google Sheet');

    const data = await res.json();
    brandLocations = {};

    data.forEach(row => {
      const brand = row.parentBrand?.trim();
      const store = row.storeLocation?.trim();
      const coords = row.coordinates?.trim();

      if (!brand || !store) return;

      if (!brandLocations[brand]) {
        brandLocations[brand] = {};
      }

      brandLocations[brand][store] = coords || " ";
    });

    console.log("Loaded brand locations:", brandLocations);
  } catch (err) {
    console.error('Failed to load brand locations:', err);
  }
}

async function showCartWithLocations() {
  await loadBrandLocations();
  openCartPopup();
}

async function ensureUserLocation() {
  const saved = getSavedLocation();

  return new Promise((resolve) => {
    if (!navigator.geolocation) {
      showSpinner("Geolocation is not supported by your browser.");
      return resolve(false);
    }

    showSpinner("Loading brand locations. Please wait...");
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        hideSpinner();
        const currentCoords = `${pos.coords.latitude},${pos.coords.longitude}`;

        // Only save if user has moved significantly or no saved location
        if (!saved || hasMovedSignificantly(saved, currentCoords)) {
          saveLocation(currentCoords);
        }

        resolve(true);
      },
      (err) => {
        hideSpinner();
        console.warn("User denied location or error occurred", err);
        showSpinner("Location denied. Please allow location access to continue.");
        setTimeout(hideSpinner, 3000);
        resolve(false);
      }
    );
  });
}


function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const φ1 = lat1 * Math.PI / 180;
  const φ2 = lat2 * Math.PI / 180;
  const Δφ = (lat2 - lat1) * Math.PI / 180;
  const Δλ = (lon2 - lon1) * Math.PI / 180;

  const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
            Math.cos(φ1) * Math.cos(φ2) *
            Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

  return R * c;
}

function hasMovedSignificantly(savedLocation, currentLocation) {
  if (!savedLocation) return true;
  const [savedLat, savedLon] = savedLocation.split(',').map(Number);
  const [currentLat, currentLon] = currentLocation.split(',').map(Number);
  const distance = getDistance(savedLat, savedLon, currentLat, currentLon);
  return distance > 500;
}

function handleLocationClick(coordinates) {
  if (!coordinates) {
    showSpinner("Sorry, this location is not available yet.");
    setTimeout(hideSpinner, 3000);
    return;
  }
  closeLocationPopup();
  navigateToLocation(coordinates, getSavedLocation());
}

function getUserLocationAndNavigate(destination) {
  const savedLocation = getSavedLocation();
  showSpinner("Finding your location...");

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        hideSpinner();
        const currentCoords = `${pos.coords.latitude},${pos.coords.longitude}`;
        if (!savedLocation || hasMovedSignificantly(savedLocation, currentCoords)) {
          saveLocation(currentCoords);
        }
        navigateToLocation(destination, currentCoords);
      },
      () => {
        hideSpinner();
        showSpinner("Could not retrieve your location.");
        setTimeout(hideSpinner, 3000);
      }
    );
  } else {
   hideSpinner();
    showSpinner("Geolocation is not supported by your browser.");
    setTimeout(hideSpinner, 3000);
  }
}

async function openBrandLocation(brand) {
  if (isNavigating) return;
  isNavigating = true;

const dest = brandLocations[brand];

  if (!dest || (typeof dest === 'string' && dest.trim() === '') || (typeof dest === 'object' && Object.keys(dest).length === 0)) {
    showSpinner("No location set for this brand yet.");
    setTimeout(hideSpinner, 3000);
    isNavigating = false;
    return;
  }

	
  const allowed = await ensureUserLocation();
  if (!allowed) {
    isNavigating = false;
    return;
  }

  
  if (typeof dest === 'object') {
    showLocationPopup(dest);
    isNavigating = false;
  } else {
    getUserLocationAndNavigate(dest);
    isNavigating = false;
  }
}

function showLocationPopup(brandLocations) {
  if (document.getElementById('location-popup')) return;

  const backdrop = document.createElement('div');
  backdrop.id = 'location-popup-backdrop';
  backdrop.style = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 10000;
  `;

  const popup = document.createElement('div');
  popup.id = 'location-popup';
  popup.style = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 10px;
    z-index: 10001;
    max-width: 400px;
    width: 90%;
    text-align: center;
    overflow-y: auto;
    height: 80%;
  `;
  popup.innerHTML = '<p>Loading locations...</p>';

  document.body.appendChild(backdrop);
  document.body.appendChild(popup);
  backdrop.addEventListener('click', closeLocationPopup);
  popup.addEventListener('click', (event) => event.stopPropagation());

  const saved = getSavedLocation();
  showLocationButtons(saved);

  function showLocationButtons(origin) {
    let optionsHtml = '<h3>Select a Location</h3>';
    for (const [name, coords] of Object.entries(brandLocations)) {
      optionsHtml += `
        <button onclick="handleNavigate('${coords}', '${origin}')" style="margin: 8px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px;">${name}</button><br>
      `;
    }
    popup.innerHTML = optionsHtml;
  }
}

function handleNavigate(coords, origin) {
  if (!coords || coords.trim() === '') {
    showSpinner("No location set for this location yet.");
    setTimeout(hideSpinner, 3000);
    return;
  }
  closeLocationPopup();
  navigateToLocation(coords, origin);
}

function closeLocationPopup() {
  const popup = document.getElementById('location-popup');
  const backdrop = document.getElementById('location-popup-backdrop');
  if (popup) popup.remove();
  if (backdrop) backdrop.remove();
}

function closeLocationSection() {
  const popup = document.getElementById('cart-popup');
  const locationSection = popup.querySelector('.location-section');
  if (locationSection) {
    locationSection.remove();
  }
}

function navigateToLocation(dest, originCoords = null) {
  const url = originCoords
    ? `https://www.google.com/maps/dir/?api=1&origin=${originCoords}&destination=${dest}`
    : `https://www.google.com/maps/dir/?api=1&destination=${dest}`;

  window.location.href = url;
}

	

	 // ✅ Add these here:
  function showSpinner(message = "Loading...") {
    const modal = document.getElementById('loading-modal');
    const text = document.getElementById('loading-text');
    if (modal && text) {
      text.textContent = message;
      modal.style.display = 'flex';
    }
  }

  function hideSpinner() {
    const modal = document.getElementById('loading-modal');
    if (modal) {
      modal.style.display = 'none';
    }
  }

//////////////
	
	
function openCartPopup() {
  // Prevent duplicate backdrop
  if (document.getElementById('cart-backdrop')) return;

	// Load brand locations first
  showCartWithLocations();
	
 // Create backdrop
const backdrop = document.createElement('div');
backdrop.id = 'cart-backdrop';
backdrop.style = `
  position: fixed;
  top: 0;
  left: 0;
  bottom: 0;
  width: 100%;
  height: 100%;
 background: linear-gradient(
    to bottom,
    rgba(0, 0, 0, 1) 0%,
    rgba(0, 0, 0, 1) 10%,
    rgba(0, 0, 0, 1) 20%,
    rgba(0, 0, 0, 1) 30%,
    rgba(0, 0, 0, 1) 40%,
    rgba(0, 0, 0, 1) 50%,
    rgba(0, 0, 0, 1) 60%,
    rgba(0, 0, 0, 1) 70%,
    rgba(0, 0, 0, 1) 80%,
    rgba(0, 0, 0, 1) 90%,
    rgba(0, 0, 0, 1) 100%
  );
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
`;
backdrop.addEventListener('click', (e) => {
  if (e.target === backdrop) closeCartPopup();
});

// Create or get popup
let popup = document.getElementById('cart-popup');
if (!popup) {
  popup = document.createElement('div');
  popup.id = 'cart-popup';
  popup.style = `
   background: #fff;
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 10px;
    width: 90%;
    max-width: 500px;
    margin-top: -90px;
    height: 80%;
    max-height: 100vh;
   overflow-y: scroll; /* Allow scroll */
  scrollbar-width: none; /* Firefox hide */
  -ms-overflow-style: none; /* IE/Edge hide */
  box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
  z-index: 9999;
`;
}

// Add popup to backdrop and backdrop to body
backdrop.appendChild(popup);
document.body.appendChild(backdrop);

  // Clear and rebuild cart content
  const cart = JSON.parse(localStorage.getItem('cartItems') || '{}');
  const brandKeys = Object.keys(cart);
  popup.innerHTML = '';

  if (brandKeys.length === 0) {
    popup.innerHTML = `<div style="text-align:center;">🛒 Your shopping cart is empty.</div>`;
  } else {
    brandKeys.forEach(brand => {
      const items = cart[brand];
      if (!items || items.length === 0) return;

      const brandLogo = items[0].brandimg || '';
      const brandSection = document.createElement('div');
      brandSection.style = 'border-bottom: 1px solid #eee; margin-bottom: 12px; padding-bottom: 10px;';
      brandSection.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <img src="${brandLogo}" alt="${brand}" style="width: 30px; height: 30px; object-fit: contain;">
            <strong>${brand}</strong>
          </div>
        </div>
      `;

      items.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.style = 'display: flex; gap: 10px; align-items: center; margin-bottom: 6px;';
        itemDiv.innerHTML = `
          <img src="${item.img}" alt="${item.name}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px;">
          <div style="flex: 1;">
            <div style="font-size: 14px;">${item.name}</div>
            <div style="font-weight: bold; color: green;">JMD ${item.price}</div>
          </div>
        `;
        brandSection.appendChild(itemDiv);
      });

    // Calculate totals
const subtotal = items.reduce((sum, item) => sum + (item.price || 0), 0);
const tax = subtotal * 0.15;
const grandTotal = subtotal + tax;

// Format numbers as currency
const formatCurrency = (amount) => `JMD ${amount.toLocaleString('en-JM', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

// Totals section
const totalsDiv = document.createElement('div');
totalsDiv.style = 'margin-top: 10px; margin-bottom: 10px; font-size: 14px;';
totalsDiv.innerHTML = `
  <div style="display: flex; justify-content: space-between;"><span>Subtotal:</span><strong>${formatCurrency(subtotal)}</strong></div>
  <div style="display: flex; justify-content: space-between;"><span>15% Tax:</span><strong>${formatCurrency(tax)}</strong></div>
  <div style="display: flex; justify-content: space-between; font-weight: bold;"><span>Total:</span><strong style="color: green;">${formatCurrency(grandTotal)}</strong></div>
`;
brandSection.appendChild(totalsDiv);

// Buttons row
const actionRow = document.createElement('div');
actionRow.style = 'display: flex; justify-content: space-between; margin-top: 8px;';
actionRow.innerHTML = `
  <button onclick="clearBrandCart('${brand}')" style="background: red; color: white; border: none; padding: 5px 10px; border-radius: 4px;">Clear</button>
  <button onclick="saveShoppingList('${brand}')" style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 4px;">Save Shopping List</button>
  <button onclick="openBrandLocation('${brand}')" style="background: #555; color: white; border: none; padding: 5px 10px; border-radius: 4px;">Location</button>
`;

brandSection.appendChild(actionRow);

      popup.appendChild(brandSection);
    });
  }

  // Add popup to backdrop and show
  backdrop.appendChild(popup);
  document.body.appendChild(backdrop);
  document.body.style.overflow = 'hidden'; // disable page scroll
}

function closeCartPopup() {
  const backdrop = document.getElementById('cart-backdrop');
  if (backdrop) backdrop.remove();
  document.body.style.overflow = ''; // re-enable scroll
}

	
 ////////// END


	
function deleteSavedList(brand, index) {
  const savedLists = JSON.parse(localStorage.getItem('savedLists') || '{}');
  if (savedLists[brand]) {
    savedLists[brand].splice(index, 1);
    if (savedLists[brand].length === 0) delete savedLists[brand];
    localStorage.setItem('savedLists', JSON.stringify(savedLists));
    openSavedListsPopup(); // Refresh the popup
  }
}

function formatCurrency(value) {
  return value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
	
function saveShoppingList(brand) {
  const cart = JSON.parse(localStorage.getItem('cartItems') || '{}');
  const savedLists = JSON.parse(localStorage.getItem('savedLists') || '{}');
  const timestamp = new Date().toISOString();

  if (cart[brand]) {
    if (!savedLists[brand]) savedLists[brand] = [];
    savedLists[brand].push({
      date: timestamp,
      items: cart[brand]
    });
    localStorage.setItem('savedLists', JSON.stringify(savedLists));
    alert(`Shopping list for ${brand} saved!`);
  }
}
	
function openSavedListsPopup() {
  // Backdrop
  const backdrop = document.createElement('div');
  backdrop.id = 'saved-lists-backdrop';
  backdrop.style = `
    position: fixed;
    top: 0;
    left: 0;
    display: flex;
    align-items: center;
    justify-content: center;
   width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.4);
    z-index: 10000;
  `;
  backdrop.onclick = (e) => {
    if (e.target === backdrop) closeSavedListsPopup();
  };

  // Popup
  const popup = document.createElement('div');
  popup.id = 'saved-lists-popup';
  popup.style = `
    background: #fff;
    padding: 16px;
    border-radius: 10px;
    max-width: 500px;
    width: 90%;
    max-height: 70vh;
    overflow-y: auto;
    box-shadow: 0 0 20px rgba(0,0,0,0.2);
  `;

  const savedLists = JSON.parse(localStorage.getItem('savedLists') || '{}');
  const brandKeys = Object.keys(savedLists);
  popup.innerHTML = `<h3 style="margin-bottom: 16px;">📝 Saved Shopping Lists</h3>`;

  if (brandKeys.length === 0) {
    popup.innerHTML += `<div style="text-align: center;">📝 No saved shopping lists yet.</div>`;
  } else {
    brandKeys.forEach(brand => {
      savedLists[brand].forEach((list, index) => {
        const date = new Date(list.date).toLocaleString();
        const section = document.createElement('div');
        section.style = 'border: 1px solid #ccc; border-radius: 8px; padding: 10px; margin-bottom: 12px;';
        section.innerHTML = `
          <strong>${brand}</strong><br>
          <small>Saved: ${date}</small>
          <ul style="margin-top: 8px; padding-left: 16px;">
            ${list.items.map(item => `<li>${item.name} – JMD ${formatCurrency(item.price)}</li>`).join('')}
          </ul>
          <button onclick="deleteSavedList('${brand}', ${index})" style="margin-top: 6px; background: red; color: white; border: none; padding: 4px 8px; border-radius: 4px;">Delete</button>
        `;
        popup.appendChild(section);
      });
    });
  }

  backdrop.appendChild(popup);
  document.body.appendChild(backdrop);
}

function closeSavedListsPopup() {
  document.getElementById('saved-lists-backdrop')?.remove();
}	

////////// START	
function renderLikedDealsGallery() {
  const likedDeals = JSON.parse(localStorage.getItem('likedDeals') || '{}');
  const galleryEl = document.getElementById('likedDealsGallery');
  const sectionEl = document.getElementById('likedDealsSection');

  galleryEl.innerHTML = ''; // Clear previous content
  const likedKeys = Object.keys(likedDeals);

  if (likedKeys.length === 0) {
    sectionEl.style.display = 'none'; // Hide section if no liked deals
    return;
  }

  likedKeys.forEach(key => {
    const deal = likedDeals[key];
    if (deal && deal.name && deal.image && deal.original) {
      const card = document.createElement('div');
      card.className = 'deal liked';

      const percentOff = deal.percentOff || 0;
      const brandLogo = deal.brandLogo || '';
      const shortName = deal.name.length > 20 ? deal.name.substring(0, 20) + '...' : deal.name;

      card.innerHTML = `
        <div class="liked-deal-brand">
          <img src="${brandLogo}" alt="Brand Logo" class="liked-deal-brand-img">
        </div>
        <img src="${deal.image}" class="liked-deal-card-img" alt="${deal.name}">
        ${percentOff ? `<span class="liked-discount-badge">${percentOff}% OFF </span>` : ''}
        <div class="liked-deal-content">
          <div class="liked-deal-title">${shortName}</div>
          <div class="liked-deal-price">J$${deal.original}</div>
          <div class="liked-deal-discount">J$${deal.discount}</div>
        </div>
      `;

    
  card.addEventListener('click', () => {
  const likedDeals = JSON.parse(localStorage.getItem('likedDeals') || '{}');
  likedDealKeys = Object.keys(likedDeals);
 likedDealIndex = likedDealKeys.findIndex(k => k === getDealKey(deal));

  isLikedMode = true;
  document.getElementById('showLikedBtn')?.classList.add('active');
  document.getElementById('showRandomBtn')?.classList.remove('active');

  openPopup(deal);

  // Delay attaching swipe listeners until popup fully rendered
  setTimeout(() => {
    addPopupSwipeListeners();
  }, 100); // 100ms is usually enough
});


      galleryEl.appendChild(card);
    }
  });

  sectionEl.style.display = 'block';
}

	
 /////////// END

function startPopupCountdown(expireDate, el) {
  if (!el || !expireDate) return;

  const parsedDate = Date.parse(expireDate);

  // If date is invalid or already expired
  if (isNaN(parsedDate) || parsedDate < Date.now()) {
    el.textContent = "⏳ Coming soon";
    el.classList.add("countdown-upcoming");
    return;
  }

  // 🔁 Clear previous countdown interval if it exists
  if (popupCountdownInterval) {
    clearInterval(popupCountdownInterval);
    popupCountdownInterval = null;
  }

  function updateCountdown() {
    const now = new Date();
    const endTime = new Date(parsedDate);
    const diff = endTime - now;

    if (diff <= 0) {
      el.textContent = "❌ Deal expired";
      el.classList.add("countdown-ended");
      clearInterval(popupCountdownInterval);
      popupCountdownInterval = null;
      return;
    }

    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
    const minutes = Math.floor((diff / (1000 * 60)) % 60);
    const seconds = Math.floor((diff / 1000) % 60);

    let timeStr = `${days}d ${hours}h ${minutes}m ${seconds}s left`;
    el.textContent = `⏳ ${timeStr}`;
  }

  updateCountdown();
  popupCountdownInterval = setInterval(updateCountdown, 1000);
}
	
	
function openPopup({ image, name, original, discount, description, brandLogo, brandName }, skipHistory = false) {
  const originalPrice = parseFloat(original.replace(/,/g, '')) || 0;
  const discountPrice = parseFloat(discount.replace(/,/g, '')) || 0;
  const percentOff = originalPrice && discountPrice ? Math.round((1 - discountPrice / originalPrice) * 100) : 0;
  const savings = originalPrice - discountPrice;

  const cashbackPercent = 49;
  const cashbackAmount = Math.round(discountPrice * cashbackPercent / 100);
  const finalPrice = discountPrice - cashbackAmount;

  const cashbackEl = document.getElementById('popupCashback');
  cashbackEl.innerHTML = `CashBack: upto J$${cashbackAmount.toLocaleString()} (${cashbackPercent}%) <br> <span class="final-price">Final Price: downto J$${finalPrice.toLocaleString()} — With Deal Plus⁺ ¹²¹ </span>`;

  document.body.classList.add('noscroll');

  currentPopupDeal = { image, name, original, discount, description, brandLogo, brandName };

  document.getElementById('popupImg').src = image;
  document.getElementById('popupTitle').textContent = name;
  document.getElementById('popupPrice').textContent = `Original Price: JMD $${original}`;
  document.getElementById('popupDiscount').textContent = `Now: JMD $${discount}`;
  document.getElementById('popupDesc').innerHTML = formatDescription(description || '');
  document.getElementById('popupBadge').textContent = `${percentOff}% OFF`;
  document.getElementById('popupSavings').textContent = `SAVINGS $${savings.toLocaleString()}`;

  document.getElementById('brandLogo').src = brandLogo;
  document.getElementById('brandLogo').alt = brandName;
  document.getElementById('brandName').textContent = brandName;

  const popupTimerEl = document.getElementById('popupTimer');
  popupTimerEl.textContent = 'Loading...';
  popupTimerEl.classList.remove('countdown-ended', 'countdown-urgent');

  const brandInfo = allBrandsData.find(b => b.brand === brandName);
  // Wait for the popup to be fully populated

	  setTimeout(() => {
    const badgeContainer = document.querySelector('#popup .brand-logo-container');
    if (!badgeContainer) return console.warn('No badge container in popup');

    // Remove old badges (including any future types)
    badgeContainer.querySelectorAll('.badge-premium, .badge-pro, .badge-starter, .badge-exclusive')
      .forEach(el => el.remove());

    if (brandInfo) {
      // Normalize case to avoid mismatches like 'True' vs 'true'
      const isPro = brandInfo.Pro?.toLowerCase() === 'true';
      const isPremium = brandInfo.Premium?.toLowerCase() === 'true';
      const isStarter = brandInfo.Starter?.toLowerCase() === 'true';
      const isExclusive = brandInfo.Exclusive?.toLowerCase() === 'true';

      let badge;

      if (isExclusive) {
        badge = document.createElement('div');
        badge.className = 'badge-exclusive';
        badge.textContent = '🏆';
      } else if (isStarter) {
        badge = document.createElement('div');
        badge.className = 'badge-starter';
        badge.textContent = '🎁';
      } else if (isPro) {
        badge = document.createElement('div');
        badge.className = 'badge-pro';
        badge.textContent = '👑';
      } else if (isPremium) {
        badge = document.createElement('div');
        badge.className = 'badge-premium';
        badge.textContent = '💎';
      }

      if (badge) {
        badgeContainer.appendChild(badge);
        console.log('Badge added to popup:', badge.outerHTML);
      } else {
        console.log('No matching badge type found for brandInfo:', brandInfo);
      }
    }
  }, 100); // ✅ Properly closed


if (brandInfo?.expireDate) {
  startPopupCountdown(brandInfo.expireDate, popupTimerEl);
}

  const backArrow = document.getElementById('popupBack');
  backArrow.style.display = window.history.length > 1 ? 'block' : 'none';

  if (!skipHistory) {
    history.pushState({ popup: true, dealName: name }, '', '');
  }

  document.getElementById('popup').style.display = 'flex';
  setupLikeButton(currentPopupDeal);
  setupAddToCartButton(currentPopupDeal);
}
	
//////////    OUTSIDE 
	
function setupLikeButton(deal) {

const likeContainer = document.getElementById('likeButtonContainer');

// Hide like button in brand mode
if (typeof isBrandMode !== 'undefined' && isBrandMode) {
  likeContainer?.classList.add('hidden');
  return;
} else {
  likeContainer?.classList.remove('hidden');
}

	
  const likeBtn = document.getElementById('popupLikeBtn');
  if (!likeBtn || !deal || !deal.name) {
    console.warn('Like button or deal missing:', { likeBtn, deal });
    return;
  }

  const dealKey = getDealKey(deal);
  console.log('Setting up like button for:', deal.name, 'Key:', dealKey);

  const likedDeals = JSON.parse(localStorage.getItem('likedDeals') || '{}');
  const isLiked = !!likedDeals[dealKey];

  console.log('Is this deal already liked?', isLiked);
  likeBtn.classList.toggle('liked', isLiked);
  likeBtn.textContent = isLiked ? '❤️ Like' : '🤍 Like';

  likeBtn.onclick = () => {
    console.log('Like button clicked for:', deal.name);
    const updatedLikedDeals = JSON.parse(localStorage.getItem('likedDeals') || '{}');

    const isNowLiked = likeBtn.classList.toggle('liked');
    likeBtn.textContent = isNowLiked ? '❤️ Like' : '🤍 Like';
    console.log('Deal is now liked?', isNowLiked);

    const original = parseFloat(deal.original?.toString().replace(/,/g, '') || '0');
    const discount = parseFloat(deal.discount?.toString().replace(/,/g, '') || '0');
    const percentOff = original && discount
      ? Math.round(((original - discount) / original) * 100)
      : 0;

    if (isNowLiked) {
      updatedLikedDeals[dealKey] = {
        ...deal,
        percentOff,
        _id: dealKey
      };
      console.log('Added to liked deals:', updatedLikedDeals[dealKey]);
    } else {
      delete updatedLikedDeals[dealKey];
      console.log('Removed from liked deals:', dealKey);
    }

    localStorage.setItem('likedDeals', JSON.stringify(updatedLikedDeals));
    console.log('Updated localStorage:', updatedLikedDeals);

    renderLikedDealsGallery();
  };
}		
 	
 function setupAddToCartButton(deal) {
  const cartBtnContainer = document.getElementById('cartBtnContainer');
  const addToCartBtn = document.getElementById('popupAddToCartBtn');

  if (typeof isBrandMode === 'undefined' || !isBrandMode) {
    cartBtnContainer?.classList.add('hidden');
    return;
  } else {
    cartBtnContainer?.classList.remove('hidden');
  }

  if (!addToCartBtn || !deal || !deal.name) {
    console.warn('Cart button or deal missing:', { addToCartBtn, deal });
    return;
  }

  const brand = deal.brandName?.trim() || 'Unknown';
  const dealKey = getDealKey(deal);

  const checkIfInCart = () => {
    const cart = JSON.parse(localStorage.getItem('cartItems') || '{}');
    const brandCart = cart[brand] || [];
    return brandCart.some(item => item._id === dealKey);
  };

  updateCartBtnState(checkIfInCart());

  addToCartBtn.onclick = () => {
    const isInCart = checkIfInCart();
    updateCartBtnState(!isInCart); // Update UI instantly
    addToCart(deal); // Then handle logic + real cart update
  };

  function updateCartBtnState(isNowInCart) {
    addToCartBtn.classList.toggle('in-cart', isNowInCart);
    addToCartBtn.textContent = isNowInCart ? '❌ Del' : '🛒 Add';
  }
}

function closePopup() {
  document.getElementById('popup').style.display = 'none';
  currentPopupDeal = null;
  document.body.classList.remove('noscroll');

  // FULL RESET here:
  isBrandMode = false;
  isLikedMode = false;
  
  // Reset tab buttons inside the popup (if you have any active classes)
  const tabs = document.querySelectorAll('.tab-switcher .tab-btn');
  tabs.forEach(tab => tab.classList.remove('active'));

  // Optional: highlight random tab as the default
  const randomTab = document.getElementById('showRandomBtn');
  if (randomTab) randomTab.classList.add('active');
}

function resetTabsToNormal() {
  // Reset the active tab to the "random" deals tab
  highlightTab('showRandomTabBtn');  // Assumes 'showRandomTabBtn' is the button for the random tab
  isBrandMode = false;  // Reset brand mode
  isLikedMode = false;  // Reset liked mode

  // Optionally, reset any other state or UI changes that were specific to the popup
  document.body.classList.remove('noscroll');  // Allow scrolling again after popup close
  // Hide the popup
  document.getElementById('popup').style.display = 'none';

  // Optionally clear any other custom settings (e.g., reset any custom button styles or selected elements)
  // Example: reset the popup content (optional)
  document.getElementById('popupImg').src = '';
  document.getElementById('popupTitle').textContent = '';
  document.getElementById('popupPrice').textContent = '';
  document.getElementById('popupDiscount').textContent = '';
  document.getElementById('popupDesc').textContent = '';
  document.getElementById('popupBadge').textContent = '';
  document.getElementById('popupSavings').textContent = '';
  document.getElementById('popupTimer').textContent = '';
}

// You can handle the 'back' button if you're using history navigation
window.onpopstate = function(event) {
  if (event.state && event.state.popup) {
    resetTabsToNormal();
  }
};

function highlightTab(tabId) {
  // Reset the styles for all tabs
  const tabs = document.querySelectorAll('.tab-button');  // Assuming all tab buttons have class 'tab-button'
  tabs.forEach(tab => tab.classList.remove('active'));  // Remove active class

  // Add the active class to the selected tab
  const selectedTab = document.getElementById(tabId);
  if (selectedTab) {
    selectedTab.classList.add('active');  // Add active class
  }
}

// Add click event to close the popup by clicking outside
document.getElementById('popup').addEventListener('click', function (e) {
  if (e.target === this) {
    resetTabsToNormal();  // Reset tabs when closing the popup
  }
});
	

	
function showBrandDealsInPopup(brandName) {
 isBrandMode = true;  // Set this before calling openPopup
  isLikedMode = false;  // Disable liked mode (random deals)
  highlightTab('showBrandTabBtn');  // Highlight the "Brand" tab
	  
  // Filter all deals to get the selected brand's deals
  const brandDeals = allDealsFlat.filter(d => d.brandName === brandName);

  if (!brandDeals.length) {
    alert("No deals for " + brandName);
    return;
  }

  brandDealKeys = brandDeals.map(d => d.name);
  brandDealIndex = 0;

  // Check if the current deal is from this brand to maintain position
  const currentKey = getDealKey(currentPopupDeal);
  const startIndex = brandDeals.findIndex(d => getDealKey(d) === currentKey);
  brandDealIndex = startIndex !== -1 ? startIndex : 0;

  const deal = brandDeals[brandDealIndex];

  // Show only brand deals in the "Brand" tab
  openPopup(deal, true);  // Skip history push
}	


function goToNextBrandDeal() {
  if (!brandDealKeys.length) return;
  brandDealIndex = (brandDealIndex + 1) % brandDealKeys.length;
  const deal = allDealsFlat.find(d => d.name === brandDealKeys[brandDealIndex]);
  openPopup(deal, true);
}

function goToPrevBrandDeal() {
  if (!brandDealKeys.length) return;
  brandDealIndex = (brandDealIndex - 1 + brandDealKeys.length) % brandDealKeys.length;
  const deal = allDealsFlat.find(d => d.name === brandDealKeys[brandDealIndex]);
  openPopup(deal, true);
}


function highlightTab(buttonId) {
  document.querySelectorAll('.tab-switcher .tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  document.getElementById(buttonId).classList.add('active');
}
	
 function showRandomDealsInPopup() {
  isLikedMode = false;
  isBrandMode = false;	 

  const likedDeals = JSON.parse(localStorage.getItem('likedDeals') || '{}');
  const likedNames = new Set(Object.keys(likedDeals));

  const unlikedDeals = allDeals.filter(deal => !likedNames.has(deal.name));

  if (unlikedDeals.length === 0) {
    alert("You've liked all the deals!");
    return;
  }

  const randomIndex = Math.floor(Math.random() * unlikedDeals.length);
  const deal = unlikedDeals[randomIndex];
  openPopup(deal, true);
} 
	
function showLikedDealsInPopup() {
  const likedDeals = JSON.parse(localStorage.getItem('likedDeals') || '{}');
  likedDealKeys = Object.keys(likedDeals);

  if (likedDealKeys.length === 0) {
    alert("No liked deals yet.");
    return;
  }

  isBrandMode = false;
  isLikedMode = true;
  likedDealIndex = 0;
  const deal = likedDeals[likedDealKeys[likedDealIndex]];
  openPopup(deal, true);
}
	
function goToNextLikedDeal() {
  if (likedDealKeys.length === 0) return;
  likedDealIndex = (likedDealIndex + 1) % likedDealKeys.length;
  const likedDeals = JSON.parse(localStorage.getItem('likedDeals') || '{}');
  const deal = likedDeals[likedDealKeys[likedDealIndex]];
  openPopup(deal, true);
}
	
function goToPrevLikedDeal() {
  if (likedDealKeys.length === 0) return;
  likedDealIndex = (likedDealIndex - 1 + likedDealKeys.length) % likedDealKeys.length;
  const likedDeals = JSON.parse(localStorage.getItem('likedDeals') || '{}');
  const deal = likedDeals[likedDealKeys[likedDealIndex]];
  openPopup(deal, true);
}
document.getElementById('showRandomBtn').onclick = () => {
  document.getElementById('showRandomBtn').classList.add('active');
  document.getElementById('showLikedBtn').classList.remove('active');
  showRandomDealsInPopup();
};

document.getElementById('showLikedBtn').onclick = () => {
  document.getElementById('showLikedBtn').classList.add('active');
  document.getElementById('showRandomBtn').classList.remove('active');
  showLikedDealsInPopup();
};

function cleanUpLikedDeals() {
  // Retrieve liked deals from localStorage
  const likedDeals = JSON.parse(localStorage.getItem('likedDeals') || '{}');

  // Log the data for debugging purposes
 console.log("🧪 allDealsFlat.length before cleanup:", allDealsFlat.length);
console.log("🧪 allDealsFlat keys:", allDealsFlat.map(getDealKey));

  // Create a Set of valid keys from allDealsFlat
  const validKeys = new Set(allDealsFlat.map(deal => getDealKey(deal)));
  
  let updated = false;

  // Iterate over the liked deals to check for invalid ones
  Object.keys(likedDeals).forEach(key => {
    if (!validKeys.has(key)) {
      console.log('Removing invalid liked deal:', key);
      delete likedDeals[key];
      updated = true;
    }
  });

  // If any updates were made, save the new likedDeals back to localStorage
  if (updated) {
    localStorage.setItem('likedDeals', JSON.stringify(likedDeals));
    renderLikedDealsGallery(); // Optional: Refresh the UI after cleanup
  }
}


document.getElementById('showLikedBtn').onclick = () => {
  isLikedMode = true;
  isBrandMode = false;
  highlightTab('showLikedBtn');
  showLikedDealsInPopup();
};

document.getElementById('showRandomBtn').onclick = () => {
  isLikedMode = false;
  isBrandMode = false;
  highlightTab('showRandomBtn');
  showRandomDealInPopup();
};

document.getElementById('showBrandTabBtn').onclick = () => {
  const brand = currentPopupDeal?.brandName;
  if (!brand) return;
  isLikedMode = false;
  isBrandMode = true;
  highlightTab('showBrandTabBtn');
  showBrandDealsInPopup(brand);
};
	
function formatDescription(description) {
  if (!description) return '';

  // Replace bold markers (e.g., **bold**) with <strong> tags
  description = description.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

  // Replace newlines (\n) with <br> to preserve line breaks, without showing \n to the user
  description = description.replace(/\n/g, '<br>');

  // Optional: Replace multiple consecutive <br> tags with <p> tags for paragraphs
  description = description.replace(/(<br>){2,}/g, '</p><p>');

  return description;
}


const brandContainer = document.getElementById('brandContainer');
if (brandContainer) {
  brandContainer.addEventListener('click', () => {
    const brandName = document.getElementById('brandName')?.textContent?.trim();
    if (brandName) {
      showBrandDealsInPopup(brandName); // Open the brand tab with that brand
    }
  });
}	

function activateBrandTab() {
  const brandTabBtn = document.getElementById('brandTabBtn');
  if (brandTabBtn) {
    brandTabBtn.click(); // Simulate user clicking on the Brand tab
  }
}
	
// Add this small helper function near the top of your script
async function fetchWithTimeout(url, timeout = 7000) {
  return Promise.race([
    fetch(url).then(res => res.json()),
    new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), timeout))
  ]).catch(error => ({ error }));
}

// Then inside your main code:

function shuffleArray(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr; // <-- return the shuffled array
}

	
async function loadDeals() {
  const likedDeals = JSON.parse(localStorage.getItem('likedDeals') || '{}');
  const favoriteBrand = localStorage.getItem('selectedFavoriteBrand');
  const container = document.getElementById('deals-container');
  container.innerHTML = '';
  allBrandsData.length = 0;
  allDealsFlat.length = 0;
  let currentlyOpenGrid = null;

  // 🕓 Step 1: Restore takeover brand if override has expired
const overrideUntil = parseInt(sessionStorage.getItem('overrideTakeoverUntil'), 10);
const now = Date.now();

if (overrideUntil && now >= overrideUntil) {
  const originalTakeover = sessionStorage.getItem('originalTakeoverBrand');
  if (originalTakeover) {
    localStorage.setItem('selectedTakeoverBrand', originalTakeover);
  }

  // Cleanup
  sessionStorage.removeItem('overrideTakeoverUntil');
  sessionStorage.removeItem('originalTakeoverBrand');
}

// ✅ Step 2: Now get takeover brand AFTER restoration
const selectedTakeoverBrand = localStorage.getItem('selectedTakeoverBrand');
const isTakeover = selectedTakeoverBrand !== null;
let isOverrideActive = false;

if (selectedTakeoverBrand) {
  isOverrideActive = true;
  console.log(`Takeover mode is active for brand: ${selectedTakeoverBrand}`);
}

	
// ✅ Step 3: Continue with deal loading
   const allResponses = await Promise.all(
    sheetUrls.map(url => fetchWithTimeout(url))
  );

  for (let i = 0; i < allResponses.length; i++) {
    const rows = allResponses[i];

    // Skip all sheets if takeover is active, except the takeover sheet
    if (isOverrideActive && !rows.some(row => row.BrandName === selectedTakeoverBrand)) {
      console.log(`Skipping sheet ${i} due to active takeover mode.`);
      continue;
    }

    const hasActiveRow = rows.some(row => row.Active?.toLowerCase() === 'yes');
    if (!hasActiveRow) {
      console.log(`Sheet ${i} has no active rows. Skipping.`);
      continue;
    }

    if (rows.error) {
      console.warn(`Skipping sheet (timeout or error): ${sheetUrls[i]}`, rows.error);
      continue;
    }

// After your deal processing loop
/*const usedSheetUrls = [];

for (let i = 0; i < sheetUrls.length; i++) {
  const rows = allResponses[i];
  if (rows.error) continue;

  const shouldSkip = isOverrideActive && !rows.some(row => row.BrandName === selectedTakeoverBrand);
  if (shouldSkip) continue;

  const hasActiveRow = rows.some(row => row.Active?.toLowerCase() === 'yes');
  if (!hasActiveRow) continue;

  usedSheetUrls.push(sheetUrls[i]);
}

// ✅ Send used sheets to the service worker
if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
  navigator.serviceWorker.controller.postMessage({
    type: 'CLEANUP_SHEET_CACHE', // This matches what your SW is already set up for
    keepSheets: usedSheetUrls    // This must match what the SW expects
  });
}
*/

	  
    try {
      let currentBrand = '';
      let currentLogo = '';
      let currentPrimaryColor = '';
      let currentSecondaryColor = '';
      let brandSection = null;
      let grid = null;
      let brandDeals = [];
      let expireDate = '';
      let isFavorite = false;

      rows.forEach(row => {
        try {
          if (row.BrandName && row.BrandLogo) {
            currentBrand = row.BrandName;
            currentLogo = row.BrandLogo;
            currentPrimaryColor = row.PrimaryColor || '#163A5C';
            currentSecondaryColor = row.SecondaryColor || '#2066A7';
            isFavorite = currentBrand === favoriteBrand;
            
	    let isPaidBrand = row.Pro === 'true' || row.Premium === 'true' || row.Starter === 'true' || row.Exclusive === 'true';
		  
            brandSection = document.createElement('div');
            brandSection.className = 'brand-section';

            const brandDiv = document.createElement('div');
            brandDiv.className = 'brand';
            const timerId = `timer-${Math.random().toString(36).substring(2)}`;

            brandDiv.innerHTML = `
              <div class="brand-logo-container">
                <img src="${currentLogo}" alt="${currentBrand}" />
              </div>
              <div>
                <span class="brand-name">${currentBrand}</span><br>
                <span class="brand-timer" id="${timerId}">Click The Pin To Find Our Location </span>
              </div>
            `;

            // 📍 Add location badge
          const locationBadge = document.createElement('div');
          locationBadge.className = 'location-badge';
          locationBadge.textContent = `📍`;
          locationBadge.addEventListener('click', (event) => {
          event.stopPropagation(); // Prevents grid from toggling
          openBrandLocation(currentBrand);
       });

           const logoContainer = brandDiv.querySelector('.brand-logo-container');
           if (logoContainer) {
           logoContainer.appendChild(locationBadge);
         }
	  
          if (isPaidBrand) {
  const badge = document.createElement('div');

  if (row.Pro === 'true') {
    badge.className = 'badge-pro';
    badge.textContent = '👑';
    brandDiv.classList.add('pro-brand-highlight');
  } else if (row.Premium === 'true') {
    badge.className = 'badge-premium';
    badge.textContent = '💎';
    brandDiv.classList.add('premium-brand-highlight');
  } else if (row.Starter === 'true') {
    badge.className = 'badge-starter';
    badge.textContent = '🎁';
    brandDiv.classList.add('starter-brand-highlight');
  } else if (row.Exclusive === 'true') {
    badge.className = 'badge-exclusive';
    badge.textContent = '🏆';
    brandDiv.classList.add('exclusive-brand-highlight');
  }

  brandDiv.querySelector('.brand-logo-container').appendChild(badge);
}

            const expireDateStr = row.ExpiryDate || row.expireDate;
            const parsedDate = Date.parse(expireDateStr);

            if (isNaN(parsedDate) || parsedDate < Date.now()) {
              const el = document.getElementById(timerId);
              if (el) {
                el.textContent = '⏳ Coming soon';
                el.classList.add('countdown-upcoming');
              }
            } else {
              startBrandCountdown(expireDateStr, timerId);
            }

            brandSection.appendChild(brandDiv);

            grid = document.createElement('div');
            grid.className = 'deal-grid';
            grid.style.display = 'none';
            brandSection.appendChild(grid);

            brandDiv.style.cursor = 'pointer';
		  
           // Capture a reference to the local deals for this brand
const localDeals = brandDeals;

brandDiv.addEventListener('click', () => {
  const isOpen = grid.style.display === 'grid';

  if (currentlyOpenGrid && currentlyOpenGrid !== grid) {
    currentlyOpenGrid.style.display = 'none';
  }

  grid.style.display = isOpen ? 'none' : 'grid';

  if (!isOpen) {
    // 🧹 Clear grid before adding shuffled items
    grid.innerHTML = '';

      // 🎲 Shuffle the current brand's deals on open
     const shuffled = shuffleArray([...localDeals]);
     shuffled.forEach((d, index) => {
       d.element.style.animationDelay = `${index * 50}ms`;
       d.element.classList.add('deal-item');
       grid.appendChild(d.element);
     });

    // Optional scroll logic
    const headerHeight = 35;
    const likedDealsSection = document.getElementById('likedDealsSection');
    const likedVisible = likedDealsSection && likedDealsSection.offsetParent !== null;
    const extraOffset = likedVisible ? 5 : 0;
    const top = brandDiv.getBoundingClientRect().top + window.scrollY - headerHeight - extraOffset;
    window.scrollTo({ top, behavior: 'smooth' });
  }

  currentlyOpenGrid = grid.style.display === 'grid' ? grid : null;
});

            container.appendChild(brandSection);

            if (expireDateStr) {
              expireDate = new Date(expireDateStr);
              if (!isNaN(expireDate)) {
                startBrandCountdown(expireDate, timerId);
              }
            }

            allBrandsData.push({
              brand: currentBrand,
              logo: currentLogo,
              expireDate,
              section: brandSection,
              grid,
              deals: brandDeals,
              primaryColor: currentPrimaryColor,
              secondaryColor: currentSecondaryColor,
              isFavorite,
	      isPaidBrand: row.Pro === 'true' || row.Premium === 'true' || row.Starter === 'true' || row.Exclusive === 'true',
              isPro: row.Pro === 'true',
              Pro: row.Pro,
              Premium: row.Premium,
              Starter: row.Starter,
              Exclusive: row.Exclusive   
            });
          }

          if (row.ProductName && row.ImageURL && row.OriginalPrice && row.DiscountPrice) {
            const original = parseFloat(row.OriginalPrice.replace(/,/g, '')) || 0;
            const discount = parseFloat(row.DiscountPrice.replace(/,/g, '')) || 0;
            const percentOff = original && discount ? Math.round((1 - discount / original) * 100) : 0;
            const shortName = row.ProductName.length > 15 ? row.ProductName.slice(0, 15) + '...' : row.ProductName;

            const dealCard = document.createElement('div');
            dealCard.className = 'deal';
            dealCard.innerHTML = `
              <span class="discount-badge">${percentOff}% OFF</span>
              <img src="${row.ImageURL}" alt="${row.ProductName}">
              <div class="deal-content">
                <div class="deal-title">${shortName}</div>
                <div class="price">JMD $${row.OriginalPrice}</div>
                <div class="discount">JMD $${row.DiscountPrice}</div>
              </div>
            `;

            const dealData = {
              image: row.ImageURL,
              name: row.ProductName,
              original: row.OriginalPrice,
              discount: row.DiscountPrice,
              description: row.Description,
              brandLogo: currentLogo,
              brandName: currentBrand
            };

            const isLiked = !!likedDeals[dealData.name];

            dealCard.addEventListener('click', () => {
              if (!dealData) return;
              isLikedMode = false;
              document.getElementById('showRandomBtn')?.classList.add('active');
              document.getElementById('showLikedBtn')?.classList.remove('active');

              const brandData = allBrandsData.find(brand => brand.brand === dealData.brandName);

              if (brandData) {
                if (brandData.isFavorite) {
                  openPopup(dealData);
                  showBrandDealsInPopup(brandData.brand);
                  activateBrandTab();
                } else {
                  openPopup(dealData);
                }
              } else {
                openPopup(dealData);
              }
            });

            if (!isLiked) {
              allDealsFlat.push(dealData);
              brandDeals.push({
                element: dealCard,
                percentOff,
                expireDate: row.expireDate
              });
            } else {
              allDealsFlat.push(dealData);
            }
          }
        } catch (rowErr) {
          console.warn('Skipped bad deal row:', rowErr);
        }
      });
    } catch (sheetErr) {
      console.warn('Error processing a sheet:', sheetErr);
    }
  }

if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
  navigator.serviceWorker.controller.postMessage({
    type: 'CLEANUP_IMAGES',   // <-- match the worker code
    currentImageUrls: allDealsFlat.map(d => d.image)  // match worker param name
  });
}
	
// 1. Precompute bestDiscount and timeRemaining ONCE
	
allBrandsData.forEach(brandData => {

	// Shuffle deals on page load
shuffleArray(brandData.deals);
	
  // Append shuffled deals to the grid
  brandData.deals.forEach(d => brandData.grid.appendChild(d.element));

  // Compute best discount (still based on actual data)
  brandData.bestDiscount = Math.max(...brandData.deals.map(d => d.percentOff));

  // Time remaining to expiry
  brandData.timeRemaining = brandData.expireDate
    ? new Date(brandData.expireDate).getTime() - Date.now()
    : Infinity;
});

// Sort brands as usual
allBrandsData.sort((a, b) => {
  if (b.bestDiscount !== a.bestDiscount) {
    return b.bestDiscount - a.bestDiscount;
  }
  return a.timeRemaining - b.timeRemaining;
});

// 3. Clear container and continue
container.innerHTML = '';

// Create and append the "no deals" message (hidden by default)
const noDealsMessage = document.createElement('div');
noDealsMessage.id = 'noDealsMessage';
noDealsMessage.textContent = '🚫 No deals available right now. Please check back later!';
noDealsMessage.style.textAlign = 'center';
noDealsMessage.style.fontWeight = 'bold';
noDealsMessage.style.marginTop = '2rem';
noDealsMessage.style.display = 'none';
container.appendChild(noDealsMessage);

if (allDealsFlat.length === 0) {
  document.getElementById('noDealsMessage').style.display = 'block';
}
	
  let likedDealsSection = document.getElementById('likedDealsSection');
  if (!likedDealsSection) {
    likedDealsSection = document.createElement('div');
    likedDealsSection.id = 'likedDealsSection';
    likedDealsSection.style.display = 'none';
    likedDealsSection.style.marginBottom = '1rem';
    likedDealsSection.innerHTML = `<div id="likedDealsGallery" class="likedDealsGallery"></div>`;
    container.appendChild(likedDealsSection);
  }

  renderLikedDealsGallery();

const takeoverBrandData = isTakeover
  ? allBrandsData.find(b => b.brand === selectedTakeoverBrand)
  : null;

// 👉 Add the class right after it's defined
if (takeoverBrandData?.grid) {
  takeoverBrandData.grid.classList.add('takeover-active');
}
	
const favoriteBrandData = allBrandsData.find(brand => brand.isFavorite);

const brandToShow = takeoverBrandData || favoriteBrandData;

if (brandToShow) {
  const favBadge = document.createElement('div');
  favBadge.className = 'favorite-brand-badge';
  favBadge.textContent = isTakeover ? '💥 Exclusive Brand' : '⭐ Featured Brand';
  const primaryColor = brandToShow.primaryColor?.trim() || '#163A5C';
  favBadge.style.backgroundColor = primaryColor;
  brandToShow.section.querySelector('.brand-logo-container').appendChild(favBadge);

  if (brandToShow.secondaryColor) {
    const brandElement = brandToShow.section.querySelector('.brand');
    brandElement.classList.add('favorite-brand-highlight');
    const secondaryColor = brandToShow.secondaryColor.trim();
    brandElement.style.setProperty('--highlight-border-color', secondaryColor);

    const pulseColor = toSemiTransparent(secondaryColor, 0.6);
    let pulseActive = true;
    setInterval(() => {
      brandElement.style.boxShadow = pulseActive ? `0 0 10px ${secondaryColor}` : `0 0 20px ${pulseColor}`;
      pulseActive = !pulseActive;
    }, 1000);
  }

  // Auto-open the grid
  brandToShow.grid.style.display = 'grid';
  currentlyOpenGrid = brandToShow.grid;

  container.appendChild(brandToShow.section);

  if (isTakeover) {
  const overrideBtn = document.createElement('button');
  overrideBtn.textContent = 'Show All Other Brands';
  overrideBtn.id = 'overrideButton';
  overrideBtn.className = 'override-button';
  overrideBtn.style.margin = '1rem auto';
  overrideBtn.style.display = 'block';

  overrideBtn.addEventListener('click', () => {
    const originalTakeover = localStorage.getItem('selectedTakeoverBrand');

    if (originalTakeover) {
      sessionStorage.setItem('originalTakeoverBrand', originalTakeover);
      const oneHourFromNow = Date.now() + 60 * 1000;
      sessionStorage.setItem('overrideTakeoverUntil', oneHourFromNow.toString());
      localStorage.removeItem('selectedTakeoverBrand');
    }

    location.reload();
  });

  container.appendChild(overrideBtn);
  updateOfflineButtons();
}

}


// 2. Find and render promoted brands (rankedSlot1–5)
const promotedBrands = [];
for (let i = 1; i <= 5; i++) {
  const brandName = localStorage.getItem(`rankedSlot${i}`);
  const expiry = parseInt(localStorage.getItem(`rankedSlot${i}Expiry`), 10);

  if (brandName && !isNaN(expiry) && Date.now() < expiry) {
    const match = allBrandsData.find(b => b.brand === brandName && !b.isFavorite);
    if (match && !promotedBrands.includes(match)) {
      const badge = document.createElement('div');
      badge.className = 'top-ranked-badge';
      badge.textContent = `🌟${i}`;

      const logoContainer = match.section.querySelector('.brand-logo-container');
      if (logoContainer) logoContainer.appendChild(badge);
      match.section.querySelector('.brand')?.classList.add('top-ranked-highlight');

      promotedBrands.push(match);
    }
  }
}
	
  promotedBrands.forEach(b => container.appendChild(b.section));

// 3. Append remaining brands sorted by discount, skipping takeover, favorite, and promoted brands
const promotedSet = new Set(promotedBrands.map(b => b.brand));
allBrandsData.forEach(brandData => {
  // Skip favorite brands, promoted brands, and the takeover brand
  if (brandData.brand !== selectedTakeoverBrand && !brandData.isFavorite && !promotedSet.has(brandData.brand)) {
    // Add hottest discount badge only to the best discount brand
    if (brandData.bestDiscount === Math.max(...allBrandsData.map(b => b.bestDiscount))) {
      const badge = document.createElement('div');
      badge.className = 'top-deal-badge';
      badge.textContent = '🔥 Hottest Discount';
      brandData.section.querySelector('.brand-logo-container').appendChild(badge);
      brandData.section.querySelector('.brand').classList.add('top-brand-highlight');
    }

    // Append the brand section to the container
    container.appendChild(brandData.section);
  }
});
		
  setTimeout(() => {
    cleanUpLikedDeals();
  }, 3000);
}

	
function toSemiTransparent(color, alpha = 0.5) {
  color = color.trim();
  
  if (color.startsWith('#')) {
    let r, g, b;
    
    if (color.length === 7) { // #rrggbb
      r = parseInt(color.substr(1,2), 16);
      g = parseInt(color.substr(3,2), 16);
      b = parseInt(color.substr(5,2), 16);
    } else if (color.length === 4) { // #rgb
      r = parseInt(color[1] + color[1], 16);
      g = parseInt(color[2] + color[2], 16);
      b = parseInt(color[3] + color[3], 16);
    } else {
      return color;
    }
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
  }

  return color; // fallback for rgb() already
}

	
function startBrandCountdown(expireDate, elementId) {
  const parsedDate = Date.parse(expireDate);
  const el = document.getElementById(elementId);

  if (!el) return;

  // Show "Coming soon" for invalid or backdated dates
  if (isNaN(parsedDate) || parsedDate < Date.now()) {
    el.textContent = '⏳ Coming soon';
    el.classList.add('countdown-upcoming');
    return;
  }

  function update() {
    const timeLeft = parsedDate - Date.now();

    if (timeLeft <= 0) {
      el.textContent = '❌ Deal ended';
      el.classList.add('countdown-ended');
      clearInterval(timer);
    } else {
      const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
      const hrs = String(Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / 3600000)).padStart(2, '0');
      const mins = String(Math.floor((timeLeft % 3600000) / 60000)).padStart(2, '0');
      const secs = String(Math.floor((timeLeft % 60000) / 1000)).padStart(2, '0');

      let countdownStr = '';
      if (days > 0) {
        countdownStr += `${days}d `;
      }

      countdownStr += `${hrs}hr :${mins}min :${secs}sec`;

      el.innerHTML = `⏳ <span class="countdown-timer">Ends in: ${countdownStr}</span>`;

      if (timeLeft <= 3600000) {
        el.classList.add('countdown-urgent');
      } else {
        el.classList.remove('countdown-urgent');
      }
    }
  }

  update();
  const timer = setInterval(update, 1000);
}

  document.getElementById('popup').addEventListener('click', function (e) {
    if (e.target === this) {
      closePopup();
    }
  });

/*  document.getElementById('popupImg').addEventListener('click', () => {
    let next;
    do {
      const randomIndex = Math.floor(Math.random() * allDealsFlat.length);
      next = allDealsFlat[randomIndex];
    } while (next.name === currentPopupDeal?.name);

    openPopup(next); // pushState already handled in openPopup
  }); 

  document.getElementById('popupBack').addEventListener('click', () => {
    window.history.back();
  }); */

  window.onpopstate = function (event) {
    if (event.state?.popup && event.state.dealName) {
      const deal = allDealsFlat.find(d => d.name === event.state.dealName);
      if (deal) {
        openPopup(deal, true); // skip history push
      }
    } else {
      closePopup();
    }
  };
	
  loadDeals();

	
function injectLoadingModal() {
  if (document.getElementById('loading-modal')) return;

  const modal = document.createElement('div');
  modal.id = 'loading-modal';
  modal.style.display = 'none';
  modal.innerHTML = `
    <div id="loading-spinner"></div>
    <div id="loading-text">Loading...</div>
  `;

  document.body.appendChild(modal);
}

// Call it on load
injectLoadingModal(); // or use DOMContentLoaded if needed

	
function showSpinner(message = "Loading...") {
  const modal = document.getElementById('loading-modal');
  const text = document.getElementById('loading-text');
  if (modal && text) {
    text.textContent = message;
    modal.style.display = 'flex';
  }
}

function hideSpinner() {
  const modal = document.getElementById('loading-modal');
  if (modal) {
    modal.style.display = 'none';
  }
}

	function addPopupSwipeListeners() {
  const popup = document.getElementById('popup');
  let startY = 0;
  let endY = 0;

 popup.addEventListener('touchstart', (e) => {
  if (e.touches.length === 1) {
    startY = e.touches[0].clientY;
  }
}, { passive: true });

popup.addEventListener('touchend', (e) => {
  endY = e.changedTouches[0].clientY;
  handleSwipe();
}, { passive: true });

  function handleSwipe() {
  const deltaY = endY - startY;

  if (isSwiping || Math.abs(deltaY) <= 100) return;

  isSwiping = true;

  if (deltaY < 0) {
    // Swipe Up
    if (isLikedMode) {
      goToNextLikedDeal();
    } else if (isBrandMode) {
      goToNextBrandDeal();
    } else {
      let next;
      do {
        const randomIndex = Math.floor(Math.random() * allDealsFlat.length);
        next = allDealsFlat[randomIndex];
      } while (next.name === currentPopupDeal?.name);

      document.getElementById('showLikedBtn')?.classList.remove('active');
      document.getElementById('showRandomBtn')?.classList.add('active');
      isLikedMode = false;
      isBrandMode = false;

      openPopup(next);
    }
  } else {
    // Swipe Down
    if (isLikedMode) {
      goToPrevLikedDeal();
    } else if (isBrandMode) {
      goToPrevBrandDeal();
    } else {
      window.history.back();
    }
  }

  // Allow next swipe after 300ms
  setTimeout(() => {
    isSwiping = false;
  }, 300);
}



	}


// Call this after your popup is ready
addPopupSwipeListeners();
	
</script>
</div>
<script>
    // Letter animation
    const loadingText = "Loading...";
    const container = document.getElementById("loadingText");

    loadingText.split("").forEach((char, i) => {
      const span = document.createElement("span");
      span.textContent = char;
      span.style.animationDelay = `${i * 0.4}s`;
      container.appendChild(span);
    });

    // Fade out splash after 4 seconds
    setTimeout(() => {
      const splash = document.getElementById("splash-screen");
      splash.style.transition = "opacity 1s ease";
      splash.style.opacity = 0;
      setTimeout(() => {
        splash.style.display = "none";
        document.getElementById("main-app").style.display = "block";
      }, 1000); // wait for fade out
    }, 4500);
  </script>

<script>
  let deferredPrompt;

  const IOS_STORAGE_KEY = 'iosPwaLastSeen';
  const IOS_DAYS_LIMIT = 30;

  function isIos() {
    return /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
  }

  function isInStandaloneMode() {
    return ('standalone' in window.navigator) && window.navigator.standalone;
  }

  function daysSince(dateString) {
    const previous = new Date(dateString);
    const now = new Date();
    const diffTime = now - previous;
    return diffTime / (1000 * 60 * 60 * 24);
  }

  function showPopup() {
    if (!localStorage.getItem('a2hsShown')) {
      document.getElementById('a2hs-popup').style.display = 'block';
    }
  }

  // Android: Capture A2HS event
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;

    setTimeout(() => {
      document.getElementById('a2hs-message').innerHTML = `
       <strong>Install This App, It's Free <br>-- No App Store <br>-- No Play Store <br>-- No Downloads</strong><br><br>
        Add to your home screen for fast, instant access!
      `;
      document.getElementById('a2hs-install-btn').style.display = 'inline-block';
      showPopup();
    }, 10000);
  });

  // iOS: Show custom message if not in standalone and not seen in 30 days
  window.addEventListener('load', () => {
    if (isIos()) {
      if (isInStandaloneMode()) {
        // User opened the app in standalone — update timestamp
        localStorage.setItem(IOS_STORAGE_KEY, new Date().toISOString());
      } else {
        const lastSeen = localStorage.getItem(IOS_STORAGE_KEY);
        const shouldShowPrompt = !lastSeen || daysSince(lastSeen) >= IOS_DAYS_LIMIT;

        if (shouldShowPrompt) {
          setTimeout(() => {
            document.getElementById('a2hs-message').innerHTML = `
              <strong>Install This App, It's Free <br>-- No App Store <br>-- No Play Store <br>-- No Downloads</strong><br><br>
              Add to your home screen for fast, instant access!
              <br><br>
              Tap the <span style="font-weight: bold;">Share</span> icon
              <span style="font-size: 1.2rem;">📤</span> and then select <strong>"Add to Home Screen"</strong>.
            `;
            document.getElementById('a2hs-install-btn').style.display = 'none';
            showPopup();
          }, 10000);
        }
      }
    }
  });

  // Android install button
  document.getElementById('a2hs-install-btn').addEventListener('click', async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const result = await deferredPrompt.userChoice;
      console.log('User response:', result.outcome);
      document.getElementById('a2hs-popup').style.display = 'none';
      localStorage.setItem('a2hsShown', 'true');
      deferredPrompt = null;
    }
  });

  // Close button
  document.getElementById('a2hs-close').addEventListener('click', () => {
    document.getElementById('a2hs-popup').style.display = 'none';
    localStorage.setItem('a2hsShown', 'false'); // So it can show again next time
  });

  // Android: If installed
  window.addEventListener('appinstalled', () => {
    console.log('App was installed');
    document.getElementById('a2hs-popup').style.display = 'none';
    localStorage.setItem('a2hsShown', 'true');
  });
</script>
			 
<script>
const SHEET_URL = 'https://opensheet.elk.sh/169KgT37g1HPVkzH-NLmANR4wAByHtLy03y5bnjQA21o/appdata';

function openLeaderboard() {
  document.getElementById("leaderboardPopup").classList.add("show");
  document.body.style.overflow = "hidden";

renderTakeoverSponsor();
	
  const sponsorTabElement = document.querySelector('[onclick*="sponsorTab"]');
if (sponsorTabElement) showTab('sponsorTab', sponsorTabElement); // Default tab
  fetchSheetData();
}

function closeLeaderboard() {
  document.getElementById("leaderboardPopup").classList.remove("show");
  document.body.style.overflow = "";
}

function showTab(tabId, el) {
  // Hide all tab contents
  document.getElementById('sponsorTab').style.display = 'none';
  document.getElementById('leaderboardTab').style.display = 'none';
  document.getElementById('winnersTab').style.display = 'none';

  // Show selected tab
  document.getElementById(tabId).style.display = 'block';

  // Update active tab UI
  const allTabs = document.querySelectorAll('.leaderboard-tab');
  allTabs.forEach(tab => tab.classList.remove('active'));
  if (el) el.classList.add('active');
}

async function fetchSheetData() {
  try {
    const response = await fetch(SHEET_URL);
    const data = await response.json();

    // Leaderboard data: must have valid points
    const leaderboardData = data
      .filter(entry => entry["First Name"] && !isNaN(parseFloat(entry["Points"])))
      .map(entry => ({
        idCode: entry["ID CODE"] || "",
        name: `${entry["First Name"]} ${entry["Last Name"] || ""}`.trim(),
        points: parseFloat(entry["Points"]) || 0
      }))
      .sort((a, b) => b.points - a.points);

    renderLeaderboard(leaderboardData);

    // Winner data: must have prize
    const winnerData = data
      .filter(entry => entry["First Name"] && entry["Prize"])
      .map(entry => ({
        idCode: entry["ID CODE"] || "",
        name: entry["First Name"] || "",
        prize: entry["Prize"] || "—"
      }));

    renderWinners(winnerData);

  } catch (error) {
    document.getElementById("leaderboardContent").innerHTML = "Failed to load data.";
    document.getElementById("winnersContent").innerHTML = "Failed to load winners.";
    console.error("Error fetching data:", error);
  }
}

function renderLeaderboard(data) {
  const container = document.getElementById("leaderboardContent");
  container.innerHTML = "";

  data.forEach((entry, index) => {
    const div = document.createElement("div");
    div.className = "leaderboard-row";
    div.innerHTML = `
      <div class="leaderboard-left">
        <div class="leaderboard-idcode">${entry.idCode}</div>
        <div class="leaderboard-name">${index + 1}. ${entry.name}</div>
      </div>
      <div class="leaderboard-points">${entry.points}</div>
    `;
    container.appendChild(div);
  });
}

function renderWinners(data) {
  const container = document.getElementById("winnersContent");
  container.innerHTML = "";

  data.forEach((entry, index) => {
    const div = document.createElement("div");
    div.className = "leaderboard-row";
    div.innerHTML = `
      <div class="leaderboard-left">
        <div class="leaderboard-idcode">${entry.idCode}</div>
        <div class="leaderboard-name">${index + 1}. ${entry.name}</div>
      </div>
      <div class="leaderboard-points">💰 $${parseInt(entry.prize).toLocaleString()}</div>
    `;
    container.appendChild(div);
  });
}

function renderTakeoverSponsor() {
  const sponsorBox = document.getElementById('sponsorContent');
  if (!sponsorBox) return;

  const selectedBrandName = localStorage.getItem('selectedTakeoverBrand');
  if (!selectedBrandName || !Array.isArray(allBrandsData)) return;

  const brand = allBrandsData.find(b => b.brand === selectedBrandName);
  if (!brand) return;

  sponsorBox.innerHTML = '';

  const brandCard = document.createElement('div');
  brandCard.className = 'popup-brand-box';
  brandCard.innerHTML = `<img src="${brand.logo}" />`;

  const heading = document.createElement('div');
  heading.className = 'takeover-heading';
  heading.innerText = `Win a $5,000 Shopping Voucher`;

  const desc = document.createElement('div');
  desc.className = 'takeover-description';
  desc.innerHTML = `<p>To Spend At <strong>${brand.brand}</strong></p>
  <p style="margin-top: 10px;"><strong>🎉 What You Can Win:</strong> 🎁 $5k Shopping Voucher monthly raffle and 🏆 $100k Grand Prize at year-end for top referrer
  </p>

  <p style="text-align: left; font-weight: bold; margin-top: 10px;">📌 How It Works:</p>
  <ul style="text-align: left; padding-left: 20px; margin: 0;">
    <li>📲 Install the app and sign up</li>
    <li>🎟 Get your unique referral code</li>
    <li>👥 Share it with friends via WhatsApp</li>
    <li>🎁 Each signs up = 1 raffle entry</li>
    <li>🚀 The more referrals, higher chance</li>
  </ul>

  <small style="display: block; margin-top: 10px; color: #666;">
    Must be 18+ and a resident of Jamaica. Prizes will be loaded to your <strong>digital shopping card</strong>. Winners are selected monthly. Grand Prize awarded at year-end. Terms subject to change.
  </small>`;

  sponsorBox.appendChild(brandCard);
  sponsorBox.appendChild(heading);
  sponsorBox.appendChild(desc);
}

</script>


			 
<script>
function updateOfflineButtons() {
  const isOnline = navigator.onLine;

  const overrideBtn = document.getElementById("overrideButton");
  if (overrideBtn) {
    overrideBtn.classList.toggle("hidden-offline", !isOnline);
  }

  const buttonsToHide = ["lockButton", "profile", "marketing", "salesletter"];
  const buttonsToStyle = ["CartButton"];
  const offlineMessage = document.getElementById("offlineMessage");

  buttonsToHide.forEach(id => {
    const btn = document.getElementById(id);
    if (btn) {
      btn.hidden = !isOnline;
    }
  });

  buttonsToStyle.forEach(id => {
    const btn = document.getElementById(id);
    if (btn) {
      btn.style.marginLeft = isOnline ? "" : "60px";
    }
  });

  if (offlineMessage) {
    offlineMessage.style.display = isOnline ? "none" : "block";
  }
}
	
// Run on page load
updateOfflineButtons();

// Listen for connection changes
window.addEventListener("online", updateOfflineButtons);
window.addEventListener("offline", updateOfflineButtons);
</script>

			 
<script>
async function getDeviceId() {
  let deviceId = localStorage.getItem('deviceId');
  if (!deviceId) {
    deviceId = crypto.randomUUID();
    localStorage.setItem('deviceId', deviceId);
  }
  return deviceId;
}

function getInstallNote() {
  if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
    return 'standalone';
  }
  return 'browser';
}

async function reportAnonymousInstall() {
  if (localStorage.getItem('installReported')) {
    console.log('Anonymous install already reported.');
    return;
  }

  const deviceId = await getDeviceId();
  const userAgent = navigator.userAgent;
  const timestamp = Date.now();
  const note = getInstallNote();

  try {
    const res = await fetch('https://script.google.com/macros/s/AKfycbxl-2XeXXvcOE4VTHVp-7fFnzvpoj8qqI_O2ZfjgVAm0e1sC9NQxRYJTlCFM2LrXLH3/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        action: 'install',
        deviceId,
        userAgent,
        timestamp: timestamp.toString(),
        note
      }),
    });
    const text = await res.text();
    console.log('Anonymous install reported:', text);
    localStorage.setItem('installReported', 'true');
    localStorage.setItem('lastPingTimestamp', timestamp); // Set initial ping timestamp here
  } catch (e) {
    console.error('Error reporting anonymous install:', e);
  }
}

async function pingDevice() {
  const deviceId = await getDeviceId();
  const userAgent = navigator.userAgent;
  const timestamp = Date.now();
  const note = getInstallNote();

  // Attempt to retrieve profile
  const profile = JSON.parse(localStorage.getItem('profileLogin') || '{}');

  const bodyData = {
    action: 'install',  // same action to update lastSeen timestamp
    deviceId,
    userAgent,
    timestamp: timestamp.toString(),
    note,
    idcode: profile.idcode || '',
    firstName: profile.firstName || '',
    lastName: profile.lastName || '',
    phone: profile.phone || ''
  };

  try {
    const res = await fetch('https://script.google.com/macros/s/AKfycbxl-2XeXXvcOE4VTHVp-7fFnzvpoj8qqI_O2ZfjgVAm0e1sC9NQxRYJTlCFM2LrXLH3/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams(bodyData),
    });

    const text = await res.text();
    console.log('Ping sent:', text);
    localStorage.setItem('lastPingTimestamp', timestamp);

    if (text.toLowerCase().includes('new row created') && profile.idcode) {
      localStorage.removeItem(`installLinked_${profile.idcode}`);
      console.log(`Cleared installLinked_${profile.idcode} because new row created on ping`);
    }

  } catch (e) {
    console.error('Error sending ping:', e);
  }
}


async function pingDeviceThrottled() {
  if (!localStorage.getItem('installReported')) {
    // Don't ping if install not yet reported
    return;
  }

  const lastPing = localStorage.getItem('lastPingTimestamp');
  const now = Date.now();
  const ONE_DAYS_MS = 1 * 24 * 60 * 60 * 1000;

  if (!lastPing || now - lastPing > ONE_DAYS_MS) {
    await pingDevice();
  } else {
    console.log('Ping skipped — last ping less than 1 days ago');
  }
}

// On page load:
document.addEventListener('DOMContentLoaded', () => {
  reportAnonymousInstall().then(() => {
    pingDeviceThrottled();
  });
});


</script>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
 const sheetURL = 'https://opensheet.elk.sh/1_DyGLoYi5ndEkiwhPEzJhMc3vciIFNhN2g-H0gbVRds/sheet7';
  let storyMap = {};
  let sequenceRanges = [];
  let swiper;
  let isJumping = false;

  async function loadStories() {
  const res = await fetch(sheetURL);
  const data = await res.json();

  sequenceRanges = [];
  storyMap = {}; // reset

  let currentSequence = '';
  let currentStartIndex = 0;

  data.forEach((story, index) => {
    // Detect new sequence start
    if (parseInt(story['Slide #']) === 1 && story['Story Title']) {
      if (currentSequence) {
        sequenceRanges.push({ title: currentSequence, start: currentStartIndex, end: index - 1 });
      }
      currentSequence = story['Story Title'].trim();
      currentStartIndex = index;
    }

    // Map every slide title (e.g., headline) to its index for jumps
    if (parseInt(story['Slide #']) === 1 && story['Story Title']) {
  const normalizedTitle = story['Story Title'].trim().toLowerCase();
  if (!(normalizedTitle in storyMap)) {
    storyMap[normalizedTitle] = index;
  }
}

  });
   
  if (currentSequence) {
    sequenceRanges.push({ title: currentSequence, start: currentStartIndex, end: data.length - 1 });
  }

    // Build slidesData array
    window.slidesData = data
      .map((story, index) => {
        if (!story['Image URL']) return null;

        let sequenceName = '';
        for (let seq of sequenceRanges) {
          if (index >= seq.start && index <= seq.end) {
            sequenceName = seq.title;
            break;
          }
        }

        return {
          index,
          sequence: sequenceName,
          image: story['Image URL'],
          title: (parseInt(story['Slide #']) === 1 && story['Story Title']) ? story['Story Title'] : story['Title'],
          description: story['Description'],
          ctaText: story['CTA Text'],
          ctaLink: story['CTA Link'],
          ctaText2: story['CTA Text 2'],
          storyJump: story['Story Jump'],
          sponsored: story['Sponsored'],
          brandLogo: story['Brand Logo'],
        };
      })
      .filter(Boolean);

    showStoryList();
  }

  function groupSlidesBySequence(slides) {
    const sequences = {};
    slides.forEach(slide => {
      if (!sequences[slide.sequence]) sequences[slide.sequence] = [];
      sequences[slide.sequence].push(slide);
    });
    return sequences;
  }

  function renderSlides(slides) {
    const wrapper = document.getElementById('storyWrapper');
    wrapper.innerHTML = '';

    slides.forEach((story, i) => {
      const slide = document.createElement('div');
      slide.className = 'swiper-slide';
      slide.style.backgroundImage = `url(${story.image})`;

      slide.dataset.index = story.globalIndex ?? i;
     
      const overlay = document.createElement('div');
      overlay.className = 'slide-overlay';

      // Big headline for first slide in sequence (Slide # 1)
      if (parseInt(story.index) === slides[0].index) {
        slide.classList.add('headline-slide');
        const title = document.createElement('div');
        title.className = 'slide-title';
        title.textContent = story.title;
        overlay.appendChild(title);
      } else if (story.title) {
        const title = document.createElement('div');
        title.className = 'slide-title';
        title.textContent = story.title;
        overlay.appendChild(title);
      }

      if (story.description) {
        const desc = document.createElement('div');
        desc.className = 'slide-desc';
        desc.textContent = story.description;
        overlay.appendChild(desc);
      }

      const ctaContainer = document.createElement('div');
      ctaContainer.className = 'cta-container';

      if (story.ctaText && story.ctaLink) {
        const linkBtn = document.createElement('a');
        linkBtn.className = 'cta-button cta-link-button';
        linkBtn.href = story.ctaLink;
        linkBtn.target = '_blank';
        linkBtn.textContent = story.ctaText;
        linkBtn.addEventListener('click', e => e.stopPropagation());
        ctaContainer.appendChild(linkBtn);
      }

   if (story.ctaText2 && story.storyJump) {
  const jumpBtn = document.createElement('button');
  jumpBtn.className = 'cta-button cta-jump-button';
  jumpBtn.textContent = story.ctaText2;

  jumpBtn.addEventListener('click', e => {
  e.stopPropagation();

  if (isJumping) return; // avoid double-tap issues
  isJumping = true; // lock early

  const jumpTitle = story.storyJump.trim().toLowerCase();
  const jumpIndex = storyMap[jumpTitle];

  if (jumpIndex !== undefined) {
    const jumpSlide = window.slidesData[jumpIndex];
    const jumpSequence = jumpSlide.sequence;

    const sequences = groupSlidesBySequence(window.slidesData || []);
    const slidesInSequence = sequences[jumpSequence] || [];
    const localIndex = slidesInSequence.findIndex(slide => slide.index == jumpIndex);

    if (localIndex !== -1) {
      openStorySequence(jumpSequence, localIndex); // will handle isJumping reset
    } else {
      console.warn('Jump target found globally, but not within sequence:', jumpSequence);
      isJumping = false;
    }

  } else {
    console.warn('Jump target not found:', story.storyJump);
    console.log('Available titles:', Object.keys(storyMap));
    isJumping = false;
  }
});


 const closeBtn = document.createElement('button');
closeBtn.className = 'cta-button cta-close-button';
closeBtn.textContent = 'Close'; // Or 'Close'
closeBtn.addEventListener('click', e => {
  e.stopPropagation();
  closeStoryViewer();
});
  ctaContainer.appendChild(jumpBtn);
  ctaContainer.appendChild(closeBtn);
}
      if (ctaContainer.childElementCount > 0) {
        overlay.appendChild(ctaContainer);
      }

      if (story.sponsored && story.sponsored.toLowerCase() === 'true') {
        const label = document.createElement('div');
        label.className = 'sponsored-label';
        label.textContent = 'Sponsored';
        slide.appendChild(label);
      }

      if (story.brandLogo) {
        const logo = document.createElement('img');
        logo.className = 'brand-logo';
        logo.src = story.brandLogo;
        logo.alt = 'Logo';
        slide.appendChild(logo);
      }

      slide.appendChild(overlay);
      wrapper.appendChild(slide);
    });
  }

function closeStoryViewer() {
  if (isJumping) return; // Prevent closing during a jump transition

  const swiperContainer = document.querySelector('.swiper');
  const storyList = document.getElementById('storyListContainer');
  const viewAllBtn = document.getElementById('viewAllButton');

  if (swiperContainer) {
    swiperContainer.style.display = 'none'; // Hide swiper
  }

  if (swiper) {
    swiper.destroy(true, true);
    swiper = null;
  }

  if (storyList) {
    storyList.style.display = 'grid'; // Show story grid
  }

  if (viewAllBtn) {
    viewAllBtn.style.display = 'inline-block'; // Show 'View All' button
  }

  document.body.classList.remove('popup-open');
}


  function initSwiper() {
    if (swiper) swiper.destroy(true, true);

    swiper = new Swiper('.swiper', {
      direction: 'horizontal',
      slidesPerView: 1,
      allowTouchMove: false,
      watchSlidesProgress: true,
      observer: true,
      observeParents: true,
    });

    swiper.on('slideChangeTransitionEnd', () => {
      updateProgress(swiper.activeIndex);
    });

    // Tap zones for navigation
    document.getElementById('tapLeft').onclick = () => swiper.slidePrev();
    document.getElementById('tapRight').onclick = () => swiper.slideNext();
  }

  function updateProgress(index) {
  const progressBar = document.getElementById('progressBar');
  if (!swiper || !progressBar) return;

  const total = swiper.slides.length;

  progressBar.innerHTML = ''; // Clear previous segments

  for (let i = 0; i < total; i++) {
    const seg = document.createElement('div');
    seg.className = 'progress-segment';

    const fill = document.createElement('div');
    fill.className = 'progress-fill';

    if (i < index) {
      fill.style.width = '100%';
    } else if (i === index) {
      fill.style.width = '0%';
      fill.style.transition = 'width 5s linear'; // match to slide duration if autoplay
      requestAnimationFrame(() => {
        fill.style.width = '100%';
      });
    }

    seg.appendChild(fill);
    progressBar.appendChild(seg);
  }
}
  
function renderStoryTiles() {
  const container = document.getElementById('storyListContainer');
  container.innerHTML = '';

  const sequences = groupSlidesBySequence(window.slidesData || []);
  Object.keys(sequences).forEach(seqKey => {
    const firstSlide = sequences[seqKey][0];
    const tile = document.createElement('div');
    tile.className = 'story-tile';
    tile.onclick = () => {
      openStorySequence(seqKey);
    };
    tile.innerHTML = `
      <img src="${firstSlide.image || ''}" alt="Story preview">
      <h3>${firstSlide.title || 'Untitled'}</h3>
    `;
    container.appendChild(tile);
  });
}


 function openStorySequence(sequenceKey, startIndex = 0) {
  const sequences = groupSlidesBySequence(window.slidesData || []);
  const sequenceSlides = sequences[sequenceKey];
  if (!sequenceSlides) {
    isJumping = false;
    return;
  }

  const swiperContainer = document.querySelector('.swiper');
  if (swiperContainer) {
    swiperContainer.style.display = 'block';
  }

  renderSlides(sequenceSlides);


   setTimeout(() => {
  if (!swiper) {
    initSwiper();
  } else {
    swiper.update();  // <-- refresh swiper to sync with new slides
  }

  swiper.slideTo(startIndex);
  updateProgress(startIndex);

  setTimeout(() => {
    isJumping = false;
  }, 300);
}, 50);
 }  
  /* setTimeout(() => {
    if (!swiper) initSwiper();
    swiper.slideTo(startIndex);
    updateProgress(startIndex);

    // Only unlock after full transition + render
    setTimeout(() => {
      isJumping = false;
    }, 300); // may adjust this if your init is slow
  }, 50);
}*/

function showStoryList() {
  if (!window.slidesData) {
    loadStories().then(actuallyShowTiles);
  } else {
    actuallyShowTiles();
  }

  function actuallyShowTiles() {
    document.getElementById('storyListPopup').style.display = 'flex';
    renderStoryTiles();
  }
}

function closeStoryListPopup() {
  document.getElementById('storyListPopup').style.display = 'none';
}

// Listeners
document.getElementById('viewAllButton').addEventListener('click', showStoryList);
document.getElementById('closeStoryListPopupBtn').addEventListener('click', closeStoryListPopup);
	
</script>

			 
		 </div>	</div>	</div>	</div>	</div>			 			 
</body>
</html>
