<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allpree: Sign Up</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for social media icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4ff; /* Light background */
            color: #333;
            overflow-x: hidden; /* Keep hidden to prevent scrollbars from min-width on body */
            display: flex;
            flex-direction: column; /* Arrange header, main, footer vertically */
            min-height: 100vh; /* Ensure it takes full viewport height */
        }

        /* Custom CSS for header */
        .header-bg {
            background-color: #ffffff; /* White background for the header */
            border-bottom: 1px solid #e5e7eb; /* Light gray border at the bottom */
        }

        /* Custom CSS for footer */
        .footer-section {
            background-color: #2C3E50; /* Dark blue background */
            color: white;
            padding: 2rem;
            text-align: center;
            font-size: 0.9rem;
        }
        .footer-section a {
            color: #60a5fa; /* A light blue for links */
            text-decoration: none;
            transition: color 0.2s;
        }
        .footer-section a:hover {
            color: #93c5fd; /* Lighter blue on hover */
            text-decoration: underline;
        }
        .footer-section h3 {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: #ffffff;
        }
        .footer-section ul {
            list-style: none;
            padding: 0;
        }
        .footer-section ul li {
            margin-bottom: 0.5rem;
        }
        .footer-section ul li a {
            color: #d1d5db; /* Lighter gray for footer links */
            font-weight: 400;
        }
        .footer-section ul li a:hover {
            color: #ffffff;
        }

        /* Re-usable max-width for content containers */
        .max-w-7xl-custom {
            max-width: 80rem; /* Equivalent to Tailwind's max-w-7xl (1280px) */
        }

        /* Button primary style */
        .btn-primary {
            background-color: #007bff; /* Blue background */
            color: white;
            border-radius: 0.5rem; /* Rounded corners */
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .btn-primary:hover {
            background-color: #0056b3; /* Darker blue on hover */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* Main content wrapper */
        .container-wrapper {
            border-radius: 1.5rem; /* Rounded corners for the main container */
            padding: 0; /* Remove padding here, it's inside sections */
            margin: 2rem auto; /* Center horizontally and add vertical margin */
            max-width: 1200px; /* Max width for content */
            width: 95%; /* Responsive width */
            overflow: hidden; /* Ensure rounded corners clip content */
            flex-grow: 1; /* Allow main content to grow and push footer down */
        }

        /* Specific styles for signup form */
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            box-sizing: border-box;
        }
        .hidden {
            display: none;
        }
        .loading-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes pop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="antialiased text-gray-800" onload="init_signup()">
    <!-- Header -->
    <header class="header-bg py-4 sticky top-0 z-50">
        <div class="max-w-7xl-custom mx-auto px-6 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <!-- Allpree Logo -->
                <img src="https://www.allpree.com/img/allpree.com.logo.ja.png" alt="Allpree Logo" class="h-14 w-auto">
            </div>

            <!-- Desktop Navigation - Hidden on mobile -->
            <nav class="hidden md:block">
                <ul class="flex space-x-6 text-gray-700 font-medium">
                    <li><a href="https://www.allpree.com/getapp" class="btn-primary py-2 px-6 text-base shadow-md">Get The App</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container-wrapper bg-white shadow-xl">
        <main class="p-6 sm:p-8 lg:p-10">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-blue-700 mb-8 text-center">Join Allpree Today!</h1>

            <!-- Welcome Message Section (Hidden by default) -->
            <div id="welcomeMessage" class="hidden bg-green-50 p-6 rounded-lg shadow-md text-center">
                <h2 id="welcomeText" class="text-2xl font-bold text-green-700 mb-4"></h2>
                <!-- Content injected by handleSuccessfulSignup -->
            </div>

            <!-- Invite Code Section -->
            <section class="invite-section mb-10">
                <div class="bg-blue-50 p-6 rounded-lg shadow-md text-center">
                    <h2 class="text-2xl font-bold text-blue-700 mb-4">Enter Your Invite Code</h2>
                    <input type="text" id="inviteCodeInput" class="form-input text-center" placeholder="Enter Code Here" autocomplete="off">
                    <button id="validateBtn" class="btn-primary py-2 px-6 text-base shadow-md">Validate Code</button>
                    <p id="inviteError" class="text-red-500 mt-2 hidden">Invalid invite code. Please try again.</p>
                </div>
            </section>

            <!-- Signup Form Section (Hidden by default) -->
            <section id="signupFormSection" class="hidden">
                <form id="signupForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="hidden" id="field_ID" name="entry.1092645840">
                    <input type="hidden" id="field_Code" name="entry.2034350499">
                    <input type="hidden" name="entry.297851038" value="">
                    <input type="hidden" name="entry.663913627" value="Digital Free">
                    <input type="hidden" name="entry.218867361" value="Basic Free">

                    <div>
                        <label for="firstName" class="form-label">First Name</label>
                        <input type="text" id="firstName" name="entry.1502543154" class="form-input" required>
                    </div>
                    <div>
                        <label for="lastName" class="form-label">Last Name</label>
                        <input type="text" id="lastName" name="entry.166208811" class="form-input" required>
                    </div>
                    <div>
                        <label for="emailAddress" class="form-label">Email Address</label>
                        <input type="email" id="emailAddress" name="emailAddress" class="form-input" required>
                    </div>
                    <div>
                        <label for="whatsappNumber" class="form-label">WhatsApp Number (+1876)</label>
                        <input type="tel" id="whatsappNumber" name="entry.1897494140" class="form-input" placeholder="+1876" required>
                    </div>
                    <div>
                        <label for="gender" class="form-label">Gender</label>
                        <select id="gender" name="entry.208508536" class="form-select" required>
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="birthYearSelect" class="form-label">Birth Year</label>
                        <select id="birthYearSelect" name="entry.577240945" class="form-select" required>
                            <option value="">Select Year</option>
                        </select>
                    </div>
                    <div>
                        <label for="countrySelect" class="form-label">Country</label>
                        <select id="countrySelect" name="entry.1890405601" class="form-select" required>
                            <option value="">Select Country</option>
                        </select>
                    </div>
                    <div>
                        <label for="parishSelect" class="form-label">Parish</label>
                        <select id="parishSelect" name="entry.341957417" class="form-select" required>
                            <option value="">Select Parish</option>
                        </select>
                    </div>
                    <div class="md:col-span-2 text-center mt-4">
                        <button type="button" id="submitSignupBtn" class="btn-primary py-3 px-8 text-lg shadow-lg">Sign Up Now!</button>
                    </div>
                </form>
            </section>

            <!-- Contact Saving Section -->
            <section class="mt-10 text-center">
                <h2 class="text-2xl font-bold text-blue-600 mb-4">Save Our Contact</h2>
                <div id="action" class="mb-4">
                    <!-- Dynamic content for saving contact -->
                </div>
                <div id="qr" class="flex justify-center">
                    <!-- QR code will be loaded here -->
                </div>
            </section>
        </main>
    </div>

    <!-- Loading Modal (Hidden by default) -->
    <div id="loading-modal" class="loading-modal hidden">
        <div class="spinner"></div>
    </div>

    <!-- Hidden iframe for Google Forms submission -->
    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;" onload="if(window.submitted) handleSuccessfulSignup();"></iframe>

    <!-- Footer -->
    <footer class="footer-section mt-auto">
        <div class="max-w-7xl-custom mx-auto px-6 py-8 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-8 text-left">
            <!-- About Allpree Column -->
            <div class="col-span-1">
                <h3 class="text-white mb-4">About Allpree</h3>
                <p class="text-gray-300 text-sm leading-relaxed">
                    Allpree shows you the best local deals. From groceries to fashion and many more. We help you save every day. We search high and low to bring you unbeatable local prices on the products you love, so you can spend less and enjoy more
                </p>
                <div class="flex space-x-4 mt-6">
                    <a href="https://www.facebook.com/allpreedotcom" target="_blank" class="text-gray-300 hover:text-white transition-colors duration-200">
                        <i class="fab fa-facebook-f fa-lg"></i>
                    </a>
                    <a href="https://www.instagram.com/allpreedotcom" target="_blank" class="text-gray-300 hover:text-white transition-colors duration-200">
                        <i class="fab fa-instagram fa-lg"></i>
                    </a>
                    <a href="https://www.youtube.com/@allpreedotcom" target="_blank" class="text-gray-300 hover:text-white transition-colors duration-200">
                        <i class="fab fa-youtube fa-lg"></i>
                    </a>
                    <a href="https://www.tiktok.com/@allpreedotcom" target="_blank" class="text-gray-300 hover:text-white transition-colors duration-200">
                        <i class="fab fa-tiktok fa-lg"></i>
                    </a>
                    <a href="https://twitter.com/allpreedotcom" target="_blank" class="text-gray-300 hover:text-white transition-colors duration-200">
                        <i class="fab fa-twitter fa-lg"></i>
                    </a>
                </div>
            </div>

            <!-- My Account Column -->
            <div class="col-span-1">
                <h3 class="text-white mb-4">CASHBACK CLUB</h3>
                <ul>
                    <li><a href="https://www.allpree.com/for-giftcard" class="text-gray-300 hover:text-white transition-colors duration-200">CashBack Club: Gift Card</a></li>
                    <li><a href="https://www.allpree.com/all-stores" class="text-gray-300 hover:text-white transition-colors duration-200">CashBack Club: All Stores</a></li>
                    <li><a href="https://www.allpree.com/install" class="text-gray-300 hover:text-white transition-colors duration-200">CashBack Club: Install App</a></li>
                    <li><a href="https://www.allpree.com/join" class="text-gray-300 hover:text-white transition-colors duration-200">CashBack Club: Sign Up</a></li>
                </ul>
            </div>

            <!-- Let Us Help Column -->
            <div class="col-span-1">
                <h3 class="text-white mb-4">LET US HELP</h3>
                <ul>
                   <li><a href="https://www.allpree.com/for-retailers" class="text-gray-300 hover:text-white transition-colors duration-200">For Giftme Retailers</a></li>
                   <li><a href="https://www.allpree.com/getapp" class="text-gray-300 hover:text-white transition-colors duration-200">Get The App</a></li>
                    <li><a href="#" class="text-gray-300 hover:text-white transition-colors duration-200">Help Center</a></li>
                    <li><a href="#" class="text-gray-300 hover:text-white transition-colors duration-200">Contact Customer Care</a></li>
                    <li><a href="#" class="text-gray-300 hover:text-white transition-colors duration-200">Frequently Asked Questions</a></li>
                </ul>
            </div>

            <!-- Company Information Column -->
            <div class="col-span-1">
                <h3 class="text-white mb-4">COMPANY</h3>
                <ul>
                  <li><a href="https://www.allpree.com/about-us" class="text-gray-300 hover:text-white transition-colors duration-200">About Us</a></li>
                   <li><a href="https://www.allpree.com/who-we-are" class="text-gray-300 hover:text-white transition-colors duration-200">Who We Are</a></li>
                  <li><a href="https://www.allpree.com/what-we-do" class="text-gray-300 hover:text-white transition-colors duration-200">What We Do</a></li>
                   <li><a href="https://www.allpree.com/getapp" class="text-gray-300 hover:text-white transition-colors duration-200">Get The App</a></li>
                </ul>
            </div>
        </div>
        <div class="max-w-7xl-custom mx-auto px-6 pt-4 border-t border-gray-700 text-center text-gray-400 text-xs">
            <p class="mb-2"><strong>Your Privacy is Guaranteed.</strong> We will never give, lease, or sell your personal information. Period!</p>
            <p class="mb-2">&copy; Copyright 2024 - <span id="current-year"></span>&nbsp;Allpree Local Deals operates under the management of Allpree Group Holding Ltd. All Rights Reserved.</p>
            <p>By using our services, you agree to our <a href="/legal" class="text-blue-400 hover:underline">Terms & Conditions</a> and <a href="/legal" class="text-blue-400 hover:underline">Privacy Policy</a>.</p>
        </div>
    </footer>

    <script>
        // Set the current year dynamically
        document.getElementById('current-year').textContent = new Date().getFullYear();

        function init_signup() {
            const inviteBtn = document.getElementById('validateBtn');
            const inviteInput = document.getElementById('inviteCodeInput');
            const errorText = document.getElementById('inviteError');
            const formSection = document.getElementById('signupFormSection');
            const welcomeDiv = document.getElementById("welcomeMessage");
            const welcomeText = document.getElementById("welcomeText");
            const loader = document.getElementById("loading-modal");
            const hiddenIframe = document.getElementById("hidden_iframe");

            let iframeInitialized = false;
            window.submitted = false;

            const savedUser = localStorage.getItem("signedUpUser");
            if (savedUser) {
                document.querySelector('.invite-section').classList.add('hidden');
                formSection.classList.add('hidden');
                welcomeText.textContent = `Welcome back, ${savedUser}!`;
                welcomeDiv.classList.remove('hidden');
                return;
            }

            inviteBtn.onclick = async () => {
                const code = inviteInput.value.trim().toUpperCase();
                if (!code) return;

                loader.style.display = "flex";

                try {
                    const res = await fetch("https://opensheet.elk.sh/169KgT37g1HPVkzH-NLmANR4wAByHtLy03y5bnjQA21o/appdata");
                    const data = await res.json();
                    
                    const match = data.find(row => row["ID CODE"]?.toUpperCase() === code);

                    if (match) {
                        document.getElementById('field_ID').value = `ID ${code}`;
                        document.getElementById('field_Code').value = code;
                        formSection.classList.remove('hidden');
                        document.querySelector('.invite-section').classList.add('hidden');
                        errorText.style.display = "none";
                    } else {
                        errorText.style.display = "block";
                    }
                } catch (e) {
                    console.error("Error checking code:", e);
                    errorText.style.display = "block";
                } finally {
                    loader.style.display = "none";
                }
            };

            const birthYearSelect = document.getElementById("birthYearSelect");
            const currentYear = new Date().getFullYear();
            for (let y = currentYear - 50; y <= currentYear - 10; y++) {
                const option = document.createElement("option");
                option.value = y;
                option.textContent = y;
                birthYearSelect.appendChild(option);
            }

            const countries = ["Jamaica"];
            const countrySelect = document.getElementById("countrySelect");
            countries.forEach(c => {
                const option = document.createElement("option");
                option.value = c;
                option.textContent = c;
                countrySelect.appendChild(option);
            });

            const parishes = [
                "Kingston", "St. Andrew", "St. Thomas", "Portland", "St. Mary", "St. Ann", "Trelawny",
                "St. James", "Hanover", "Westmoreland", "St. Elizabeth", "Manchester", "Clarendon", "St. Catherine"
            ];
            const parishSelect = document.getElementById("parishSelect");
            parishes.forEach(p => {
                const option = document.createElement("option");
                option.value = p;
                option.textContent = p;
                parishSelect.appendChild(option);
            });

            const phoneInput = document.getElementById("whatsappNumber");
            phoneInput.addEventListener("input", () => {
                const expectedPrefix = "+1876";
                const actualPrefix = phoneInput.value.slice(0, expectedPrefix.length);
                const rest = phoneInput.value.slice(expectedPrefix.length);

                let fixedPrefix = "";
                for (let i = 0; i < expectedPrefix.length; i++) {
                    fixedPrefix += actualPrefix[i] !== expectedPrefix[i] ? expectedPrefix[i] : actualPrefix[i];
                }

                if (fixedPrefix !== actualPrefix) {
                    phoneInput.value = fixedPrefix + rest;
                }
            });

            document.getElementById("submitSignupBtn").addEventListener("click", submitSignupForm);


            hiddenIframe.onload = () => {
                if (!iframeInitialized) {
                    iframeInitialized = true;
                    return;
                }
                if (window.submitted) {
                    handleSuccessfulSignup();
                }
            };

            document.addEventListener('click', function (event) {
                if (event.target.closest('#seeHowItWorks')) {
                    const realButton = document.querySelector('.menu-button[data-view="salesletter"]:not(#seeHowItWorks)');
                    if (realButton) {
                        realButton.click();
                    } else {
                        console.error('Target action button not found.');
                    }
                }
            });
        }

        async function submitSignupForm() {
            document.getElementById("loading-modal").style.display = "flex";

            const requiredFields = [
                { name: 'entry.1502543154', label: 'First Name' },
                { name: 'entry.166208811', label: 'Last Name' },
                { name: 'emailAddress', label: 'Email' },
                { id: 'whatsappNumber', label: 'WhatsApp Number' },
                { name: 'entry.208508536', label: 'Gender' },
                { id: 'birthYearSelect', label: 'Birth Year' },
                { id: 'countrySelect', label: 'Country' },
                { id: 'parishSelect', label: 'Parish' }
            ];

            let missingFields = [];
            const allFields = document.querySelectorAll('input, select');
            allFields.forEach(field => {
                field.style.border = '';
                field.style.backgroundColor = '';
            });

            requiredFields.forEach(field => {
                let value;
                let element;
                if (field.id) {
                    element = document.getElementById(field.id);
                    value = element?.value.trim();
                } else if (field.name) {
                    element = document.querySelector(`[name="${field.name}"]`);
                    value = element?.value.trim();
                }
                if (!value) {
                    missingFields.push(field.label);
                    if (element) {
                        element.style.border = '2px solid red';
                        element.style.backgroundColor = '#f8d7da';
                    }
                }
            });

            if (missingFields.length > 0) {
                // Using a custom modal/message box instead of alert()
                const message = `Please complete the following fields:\n\n- ${missingFields.join('\n- ')}`;
                // For demonstration, a simple alert is used, but in a real app, this would be a custom modal.
                // alert(message);
                console.warn(message); // Log to console as a fallback
                document.getElementById("loading-modal").style.display = "none";
                return;
            }

            const formData = new FormData();
            formData.append('entry.1092645840', document.getElementById('field_ID').value);
            formData.append('entry.2034350499', document.getElementById('field_Code').value);
            formData.append('entry.297851038', '');
            formData.append('entry.663913627', 'Digital Free');
            formData.append('entry.218867361', 'Basic Free');
            formData.append('entry.1502543154', document.querySelector('[name="entry.1502543154"]').value);
            formData.append('entry.166208811', document.querySelector('[name="entry.166208811"]').value);
            formData.append('emailAddress', document.querySelector('[name="emailAddress"]').value);
            formData.append('entry.1897494140', document.getElementById('whatsappNumber').value);
            formData.append('entry.208508536', document.querySelector('[name="entry.208508536"]').value);
            formData.append('entry.577240945', document.getElementById('birthYearSelect').value);
            formData.append('entry.1890405601', document.getElementById('countrySelect').value);
            formData.append('entry.341957417', document.getElementById('parishSelect').value);

            try {
                const response = await fetch('https://docs.google.com/forms/u/0/d/e/1FAIpQLSfw0Sts9wFjaExeOLWxUGAhdrEbfMEE2n6kh430bFqb0xKO2w/formResponse', {
                    method: 'POST',
                    mode: 'no-cors',
                    body: formData
                });

                window.submitted = true;
                // The iframe onload will handle the successful signup
            } catch (error) {
                console.error("Fetch form submission failed:", error);
                // Using a custom modal/message box instead of alert()
                // alert("There was a problem submitting the form. Please try again.");
                console.error("There was a problem submitting the form. Please try again."); // Log to console as a fallback
                document.getElementById("loading-modal").style.display = "none";
            }
        }

        function handleSuccessfulSignup() {
            if (!window.submitted) return;
            window.submitted = false;

            const submitBtn = document.querySelector('button[type="submit"]');
            if (submitBtn) submitBtn.disabled = false;

            document.getElementById("loading-modal").style.display = "none";
            const firstName = document.querySelector('[name="entry.1502543154"]').value || "there";
            localStorage.setItem("signedUpUser", firstName);

            document.querySelector('.invite-section').classList.add('hidden');
            document.getElementById('signupFormSection').classList.add('hidden');
            const welcomeDiv = document.getElementById("welcomeMessage");
            welcomeDiv.classList.remove('hidden');

            welcomeDiv.innerHTML = `
                <div style="text-align:left; padding: 20px;">
                    <h3 style="
                        font-size: 1.2rem;
                        font-weight: bold;
                        background: linear-gradient(90deg, #ff6ec4, #7873f5, #4ade80);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                        text-align: center;
                        margin-top: 30px;
                        animation: pop 0.6s ease-in-out;
                    ">${firstName} 🎉 Congratulations On Signing Up! 🎉</h3>
                    <center> <h2><strong>BE SMART.<br> SHOP CLEVER.<br> GET PAID.</strong></h2>
                    <h3>It’s Time To Make Money While Shopping In Jamaica!</h3><br> </center>

                    <p><strong>${firstName}</strong>, I know you are a savvy shopper<br><br>
                    
                    Tired of going shopping and walking away with just your receipts and <strong>no real discounts</strong> from big or small retailers?<br><br>

                    What if you could stop worrying about discounts and start <strong>earning cash back</strong> instead? 💸 With our system, you can get back <strong>up to 49%</strong> of what you spend, sent straight to your <strong>bank account</strong>. All it takes is <strong>121 days</strong> to settle. No stress, no strings.<br><br>

                    Sounds too good to miss, right?<br>
                    </p>

                    <p>
                    It all starts with our <strong>➕ Deal Plus⁺ Program</strong>, giving you exclusive access to over <strong>300+ merchants</strong> across Jamaica.<br><br>

                    But here’s the real magic: <strong>You don’t need to wait for any special deals.</strong> Deal Plus⁺ works on <strong>every purchase</strong>, from <strong>any merchant</strong>, automatically turning your everyday spending into real money back.<br><br>

                    So far, our members have saved <strong id='savedAmount'>loading...</strong>, that’s real cash returned from a total spend of <strong id='spentAmount'>loading...</strong>! <strong>${firstName}</strong>, imagine what you could be saving just by shopping like you already do.<br><br>

                    And yes, we work quietly behind the scenes to turn your everyday shopping into smart shopping that <strong>pays you back</strong>. Join the movement and make every dollar count.
                    </p>
                    <h4><center>Plus Unlock Lifetime Income</center></h4>
                    <p>By <strong>inviting</strong> your <strong>friends</strong>, <strong>family</strong>, or even your <strong>enemy</strong>, You can start earning <strong>recurring commissions for life</strong>, on every thing they purchase, for as long as they are using the ➕ Deal Plus⁺ Program.</p>

                    <p>No gimmicks, just real money sent <strong>straight to your bank account</strong> with the right opportunity to earn a little extra.</p><br>

                    <center>
                    <button id="seeHowItWorks" class="btn-primary py-3 px-8 text-lg shadow-lg">
                    👉 See How It Works
                    </button>
                    </center>

                </div>
            `;
            fetchStatsAndUpdateUI(); // Run stats fetch separately AFTER success
        }

        async function fetchStatsAndUpdateUI() {
            try {
                const response = await fetch("https://opensheet.elk.sh/169KgT37g1HPVkzH-NLmANR4wAByHtLy03y5bnjQA21o/appdata");
                const data = await response.json();

                let totalSaved = 0;
                let totalSpent = 0;

                data.forEach(row => {
                    const saved = parseFloat((row["Saved"] || "0").replace(/[^0-9.-]+/g, ""));
                    const spent = parseFloat((row["Spent"] || "0").replace(/[^0-9.-]+/g, ""));
                    totalSaved += isNaN(saved) ? 0 : saved;
                    totalSpent += isNaN(spent) ? 0 : spent;
                });

                const savedEl = document.getElementById("savedAmount");
                const spentEl = document.getElementById("spentAmount");

                if (savedEl) savedEl.textContent = totalSaved.toLocaleString("en-JM", { style: "currency", currency: "JMD" });
                if (spentEl) spentEl.textContent = totalSpent.toLocaleString("en-JM", { style: "currency", currency: "JMD" });

            } catch (error) {
                console.error("Error fetching stats:", error);
            }
        }

        const contactDetails = {
            fullName: "Allpree.com",
            organization: "Allpree.com",
            email: "allpreedotcom@gmail.com",
            website: "https://www.allpree.com",
            address: "Shop #4 Dunbar Mall;Sav-La-Mar;Westmoreland;00000;Jamaica",
            numbers: [
                { type: "whatsapp main", number: "+18762042132" },
                { type: "whatsapp bot", number: "+18762042107" },
                { type: "whatsapp billing", number: "+18764604563" }
            ],
            socialHandles: {
                twitter: "@allpreedotcom",
                facebook: "https://facebook.com/allpreedotcom",
                instagram: "https://instagram.com/allpreedotcom"
            }
        };

        function buildVCardString() {
            let vcard = `BEGIN:VCARD
VERSION:3.0
FN:${contactDetails.fullName}
ORG:${contactDetails.organization}
EMAIL:${contactDetails.email}
URL:${contactDetails.website}
ADR:;;${contactDetails.address}`;

            contactDetails.numbers.forEach(n => {
                vcard += `\nTEL;TYPE=${n.type}:${n.number}`;
            });

            const socials = contactDetails.socialHandles;
            if (socials.twitter) vcard += `\nX-SOCIALPROFILE;TYPE=twitter:${socials.twitter}`;
            if (socials.facebook) vcard += `\nX-SOCIALPROFILE;TYPE=facebook:${socials.facebook}`;
            if (socials.linkedin) vcard += `\nX-SOCIALPROFILE;TYPE=linkedin:${socials.linkedin}`;
            if (socials.instagram) vcard += `\nX-SOCIALPROFILE;TYPE=instagram:${socials.instagram}`;

            vcard += `\nEND:VCARD`;
            return vcard;
        }

        const vCard = buildVCardString();

        function generateVCF() {
            const blob = new Blob([vCard], { type: "text/vcard" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "contact.vcf";
            a.click();
            URL.revokeObjectURL(url);
        }

        const isAndroid = /android/i.test(navigator.userAgent);
        const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
        const actionDiv = document.getElementById("action");
        const qrDiv = document.getElementById("qr");

        if (actionDiv && qrDiv) { // Ensure elements exist before trying to manipulate
            if (isAndroid) {
                const contactIntentURL =
                    "intent://createContact#Intent;" +
                    "scheme=content;" +
                    "action=android.intent.action.INSERT;" +
                    "type=vnd.android.cursor.dir/contact;" +
                    `S.name=${encodeURIComponent(contactDetails.fullName)};` +
                    `S.phone=${contactDetails.numbers[0].number};` +
                    `S.email=${contactDetails.email};` +
                    `S.organization=${encodeURIComponent(contactDetails.organization)};` +
                    `S.postal=${encodeURIComponent(contactDetails.address)};` +
                    "end;";

                const encodedVCardData = encodeURIComponent(vCard);
                const qrUrl = `https://quickchart.io/qr?text=${encodedVCardData}`;

                function tryIntentFallback() {
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = contactIntentURL;
                    document.body.appendChild(iframe);

                    actionDiv.innerHTML = `
                        <p>Scan the QR or use the button to download and import</p><br>
                        <img id="fallbackQR" src="${qrUrl}" alt="QR Code" width="170" height="170" style="border:1px solid #ccc; padding:10px; opacity:0; transition:opacity 0.6s ease;">
                        <br><br> <button onclick="generateVCF()" class="btn-primary py-2 px-4 text-base shadow-md">D/L & Imp</button>
                    `;

                    setTimeout(() => {
                        document.getElementById("fallbackQR").style.opacity = 1;
                    }, 500);
                }

                actionDiv.innerHTML = `
                    <button onclick="tryIntentFallback()" class="btn-primary py-2 px-4 text-base shadow-md">Click & Save</button>
                `;

                qrDiv.innerHTML = `<img src="${qrUrl}" alt="Preload QR" style="display:none;">`;
            } else if (isIOS) {
                actionDiv.innerHTML = `<button onclick="generateVCF()" class="btn-primary py-2 px-4 text-base shadow-md">Click To Save</button>`;
            } else {
                actionDiv.innerHTML = `<p class="text-gray-600">Use a mobile device to add contact</p>`;
            }
        }
    </script>
</body>
</html>
