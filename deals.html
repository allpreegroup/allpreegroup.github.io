<!DOCTYPE html>
<html lang="en">
 
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <link rel="stylesheet" href="https://www.allpree.com/css/main.css">
 <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> 
 <link href="//site-assets.fontawesome.com/releases/v6.1.1/css/all.css" rel="stylesheet"> 
<link href="//fonts.googleapis.com/css?family=Space+Mono|Work+Sans:700" rel="stylesheet">
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">	

  
     <title>See Today's Deals</title>
	
         <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      margin-top: 20px;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    
    }

	.hidden {
  display: none;
}	 

.noscroll {
  overflow: hidden;
  height: 100vh;
}

.favorite-brand-badge {
    
    color: #fff;
     font-weight: bold;
  padding: 2px 10px;
  border-radius: 20px;
  position: absolute;
  top: -10px;
  right: -225px;
  font-size: 12px;
  box-shadow: 0 0 8px rgba(0,0,0,0.2);
}	
 .brand-logo-container {
  position: absolute; /* Needed for badge positioning */
 
}
		 
.favorite-brand-highlight {
  --highlight-border-color: gold; /* Default fallback */
  border: 3px solid var(--highlight-border-color);
  border-radius: 12px;
  padding-left: 50px;
  padding-right: 50px;
}



		 
.top-deal-badge {
  background-color: gold;
  color: #000;
  font-weight: bold;
  padding: 2px 10px;
  border-radius: 20px;
  position: absolute;
  top: -10px;
  right: -225px;
  font-size: 12px;
  box-shadow: 0 0 8px rgba(0,0,0,0.2);
}
.brand-logo-container {
  position: absolute; /* Needed for badge positioning */
 
}
	     
	     
.top-brand-highlight {
	
  border: 3px solid gold;	
  border-radius: 12px;
  animation: glowPulse 2s ease-in-out infinite;
  box-shadow: 0 0 10px gold;
  
  padding-left: 50px;
  padding-right: 50px;
}

@keyframes glowPulse {
  0% {
    box-shadow: 0 0 10px gold;
  }
  50% {
    box-shadow: 0 0 20px orange;
  }
  100% {
    box-shadow: 0 0 10px gold;
  }
}

     .countdown-timer {
  font-weight: bold;
  color: #007bff;
}

.countdown-urgent .countdown-timer {
  color: #ff4136;
  animation: blink 1s step-start 0s infinite;
}

.countdown-ended {
  color: gray;
}

@keyframes blink {
  50% {
    opacity: 0;
  }
}

	
    .countdown {
      text-align: center;
      font-size: 18px;
      margin-bottom: 20px;
    }
		 
    .brand-section {
      margin-bottom: 30px;
		    
    }

.countdown-upcoming {
  color: orange;
  font-style: italic;
}
		 
    .brand {
  display: flex;
  align-items: center;
  gap: 12px;
	    
  margin-left: -15px;
  margin-right: -15px;
  width: calc(100% + 30px); /* wider than container */    
  
  background-color: #fff;
  padding: 1px 1px;
  border-radius: 10px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  margin-bottom: 1px;
  min-height: 7px;
}

.brand-logo-container {
 
height: 60px;
  width: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.brand-logo-container img {
  max-height: 100%;
  max-width: 100%;
  object-fit: contain;
  border-radius: 8px;
}
    .brand img {
      width: 100px;
      height: 100px;
      margin-left: 8px;
      border-radius: 1px;
      object-fit: contain;
    }
    .brand-name {
      font-size: 18px;
      font-weight: bold;
      margin-left: 67px;
    }
    .brand-timer {
  font-size: 14px;
  margin-left: 67px;
    }

    .deal {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      flex: 0 0 auto;
      margin-left: -20px;
      margin-right: -20px;
      width: 100%;
      scroll-snap-align: start;
      position: relative;
      cursor: pointer;
    }
    .deal-grid {
      display: grid;
      grid-auto-flow: column;
      grid-template-rows: repeat(2, 1fr); /* 2 rows */
      grid-auto-columns: 54.2%;  
       
       margin-left: -5px;
       margin-right: -5px;
	    
      gap: 15px;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      padding: 10px 20px;  /*Slightly more padding for breathing room */
      scrollbar-width: none; /* Firefox */
    }
    .deal-grid::-webkit-scrollbar {
      display: none; /* Chrome, Safari */
	    
    }
    .deal img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
    }
    .deal-content {
      padding: 10px;
      
    }
    .deal-title {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .price {
      color: #999;
      text-decoration: line-through;
      font-size: 14px;
    }
    .discount {
      color: #e60000;
      font-weight: bold;
      font-size: 16px;
    }
    .discount-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: red;
      color: white;
      font-weight: bold;
      font-size: 12px;
      padding: 4px 6px;
      border-radius: 4px;
    }

     /* Popup Styles */
.popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: linear-gradient(
    to bottom,
    rgba(0, 0, 0, 1) 0%,
    rgba(0, 0, 0, 1) 10%,
    rgba(0, 0, 0, 1) 20%,
    rgba(0, 0, 0, 1) 30%,
    rgba(0, 0, 0, 1) 40%,
    rgba(0, 0, 0, 1) 50%,
    rgba(0, 0, 0, 1) 60%,
    rgba(0, 0, 0, 1) 70%,
    rgba(0, 0, 0, 1) 80%,
    rgba(0, 0, 0, 1) 90%,
    rgba(0, 0, 0, 1) 100%
  );
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  flex-direction: column;
  gap: 20px;
}

.popup-content {
  background: white;
  justify-content: center;
  border-radius: 10px;
  max-width: 500px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;	
}


.tab-switcher {
  display: flex;
  width: 50%;
  justify-content: center;
  background: black;
  margin-top: -50px; /* or try -10px if you want to pull it up */	
  padding: 5px 0;
}

.tab-btn {
  flex: 1;
  background: transparent;
  border: none;
  font-size: 16px;
  font-weight: bold;
  color: rgba(255, 255, 255, 0.5);
  padding: 5px;
  position: relative;
  cursor: pointer;
}

.tab-btn.active {
  color: #fff;
}

.tab-btn.active::after {
  content: "";
  position: absolute;
  bottom: -2px;
  left: 50%;
  transform: translateX(-50%);
  width: 30px;
  height: 3px;
  background: #fff;
  border-radius: 2px;
}

		 
.image-wrapper {
  width: 100%;
  height: 200px; /* Fixed container height */
  background: #f9f9f9;
  border-top-left-radius: 10px;
  border-top-right-radius: 10px;
  overflow: hidden; /* Important: clip the image if needed */
  display: flex;
  align-items: center;
  justify-content: center;
}

.image-wrapper img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain; /* Show full image inside without cutting */
  display: block;
}

.popup-body {
  padding: 20px;
}

.popup-title {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 10px;
}

.popup-price {
  font-size: 14px;
  text-decoration: line-through;
  color: #888;
}

.popup-discount {
  font-size: 18px;
  color: #e60000;
  font-weight: bold;
}
		
.popup-cashback {
  font-weight: bold;
  color: #28a745;
  font-size: 13px;
}	
		
.final-price {
  margin-top: -10px;  
  margin-bottom: 10px;
  color: #e60000; /* Green shade for positive pricing */
  font-weight: bold;
  font-size: 12px;
}
		
.popup-discount-badge {
  position: absolute;
  top: 15px;
  right: 15px;
  background: red;
  color: white;
  font-weight: bold;
  font-size: 9px;
  padding: 5px 8px;
  border-radius: 4px;
  z-index: 10;
}
		 /* Style for the Like Button */
.like-btn {
  font-size: 2rem;
  background: none;
  border: none;
  cursor: pointer;
  transition: transform 0.2s ease;
  position: absolute; /* Position it inside the container */
  bottom: -123px; /* Pushes the button down */
  right: 15px; /* Adjust to your desired position (can be changed to center, right, etc.) */
  color: black; /* Initial color */
  z-index: 10; /* Ensures it's above other content */
}

.like-btn.liked {
  color: red;
  transform: scale(1.2); /* Enlarges the button when liked */
}

.popup-savings {
  position: absolute; /* Position it absolutely */
  top: 15px; /* Adjust position as needed */
  left: 15px; /* Align to the right side */
  background: #28a745; /* Green color for savings */
  color: white;
  font-weight: bold;
  font-size: 12px;
  padding: 5px 8px;
  border-radius: 4px;
  z-index: 10; /* Ensure it stays above other elements */
}


.popup-description {
  font-size: 9px;
  padding-top: 10px;
}

.popup-close {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 28px;
  color: #333;
  cursor: pointer;
  font-weight: bold;
}

.popup-brand-box {
 margin: -10px 20px 20px 20px; /* Top, horizontal, bottom */
  padding: 15px;
  border-top: 1px solid #eee;
  background-color: #fdfdfd;
  border-radius: 8px;
  display: flex;
  flex-direction: column; /* Stack brand name and timer vertically */
  align-items: flex-start; /* Align to the left */
  gap: 8px; /* Space between brand name and timer */
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.popup-brand-box .brand-logo-container {
  height: 50px;
  width: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.popup-brand-box .brand-logo-container img {
  max-height: 100%;
  max-width: 100%;
  object-fit: contain;
  border-radius: 6px;
}

.popup-brand-box .brand-name {
  font-size: 16px;
  font-weight: bold;
}

.popup-brand-box .brand-timer {
  font-size: 14px;
  color: #555;
}


.popup-back-arrow {
  position: absolute;
  left: 15px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  font-size: 22px;
  color: #888;
  cursor: pointer;
  display: none;
  z-index: 11;
  padding: 6px 10px;
  border-radius: 4px;
}

.popup-back-arrow:hover {
  color: black;
}
		 

/* Liked Deals Gallery (Horizontal Scroll) */
#likedDealsSection {
  border: 0px ;
  padding-top: 0;
  padding-right: 1rem;
  padding-bottom: 1rem;
  padding-left: 1rem;
  
  box-shadow: 0 0 0px;
  margin-bottom: 40px;
  animation: fadeInUp 0.4s ease-in-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(15px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}


/* Deal Grid Style for Liked Deals */
#likedDealsGallery {
display: grid;
  grid-auto-flow: column;
  grid-template-rows: repeat(1, 1fr); /* Two rows if needed */
  grid-auto-columns: 54.2%;
  gap: 15px;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  padding: 10px 20px;
  margin-left: -5px;
  margin-right: -5px;
  margin-top: -25px; /* Pulls the gallery up */
  scrollbar-width: none; /* Firefox */
}

#likedDealsGallery::-webkit-scrollbar {
  display: none; /* Chrome & Safari */
}

/* Style for the container around the brand logo (liked-deal-brand) */
.liked-deal-brand {
height: 40px;
  width: 40px;
  display: flex;
	border: 3px solid #163a5c; /* Glowing border */
  align-items: center;
  justify-content: center;
	border-radius: 50%;
	overflow: hidden;
	object-position: top;
	position: relative;
	margin-top: 10px;
        margin-left: 10px;
}

/* Styling for the image inside the brand logo container */
.liked-deal-brand-img {
  max-height: 100%;
  max-width: 100%;
  object-fit: contain;
	
  border-radius: 8px;
  align-items: center;
  padding: 3px;
  justify-content: center;
}

		 
/* Card style for each liked deal */
.liked-deal-card {
  background: white;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  flex: 0 0 auto;
  width: 100%;
  scroll-snap-align: start;
  position: relative;
  cursor: pointer;
  transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.liked-deal-card:hover {
  transform: scale(1.05);
  box-shadow: 0 0 15px rgba(255, 111, 97, 0.7);
}
		 
/* Optional glow if liked */
.liked-deal-card.liked {
   border: 2px solid #ff6f61;
  box-shadow: 0 0 15px rgba(255, 111, 97, 0.7);
}

/* Image Styling */
.liked-deal-card-img {
  width: 65%;
  height: 65%;
  margin-top: -20px;
  object-fit: contain; /* shows entire image without cropping */
  border-top-left-radius: 10px;
  border-top-right-radius: 10px;
  background-color: white; /* background: #f9f9f9; *//* optional: adds background behind image if needed */
  padding: 30px; /* optional: gives image breathing room */
}

/* Card Content */
.liked-deal-content {
 padding-left: 12px;
height: 20%;
}
		 
.liked-deal-title {
  font-size: 9px;
  font-weight: bold;
  margin-top: -25px;
  margin-bottom: 5px;
}

.liked-deal-price {
  color: #999;
  text-decoration: line-through;
  font-size: 14px;
}


.liked-deal-discount {
 color: #e60000;
  font-weight: bold;
  font-size: 16px;
}

/* Discount badge */
.liked-discount-badge {
  position: absolute;
  top: 16.6px;
  right: 10px;
  background: red;
  color: white;
  font-weight: bold;
  font-size: 10px;
  padding: 4px 6px;
  border-radius: 4px;
}

#cartBtnContainer.hidden {
  display: none !important;
}

#popupAddToCartBtn {
  font-size: 2rem;
  background: none;
  border: none;
  cursor: pointer;
  transition: transform 0.2s ease;
  position: absolute;
  bottom: -123px;
  right: 15px;
  color: black;
  z-index: 10;
}

#popupAddToCartBtn.in-cart {
  color: green;
  transform: scale(1.2);
}
	 
.cart-icon {
  position: absolute;
  top: 10px;
  right: 20px;
  font-size: 24px;
  cursor: pointer;
}

.cart-count {
  position: absolute;
  top: -8px;
  right: -8px;
  background-color: red;
  color: white;
  border-radius: 50%;
  font-size: 12px;
  padding: 2px 6px;
}
#cart-icon-container {
  position: fixed;
  top: 10px;
  right: 10px;
  z-index: 1000;
}

#cart-icon {
  font-size: 24px;
  background: white;
  border-radius: 50%;
  padding: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  cursor: pointer;
}
#cartBtn {
  display: flex;
  align-items: center;
  gap: 4px; /* space between icon and count */
  font-size: 12px;
}
		 
.cart-icon2 {
  font-size: 20px;
  padding: 0px;
  cursor: pointer;
}
.cart-count2 {
  font-weight: bold;
  background-color: red;
  color: white;
  padding: 2px 6px;
  border-radius: 50%;
  font-size: 12px;
}
		 
  </style>
  
<link rel="manifest" href="https://www.allpree.com/manifest.json">
<script>
    if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("https://www.allpree.com/service-worker.js")
            .then(() => console.log("Service Worker Registered"))
            .catch((error) => console.log("Service Worker Registration Failed", error));
    }
</script>	

	<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J2Z2P5DQPN"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-J2Z2P5DQPN');
</script>

</head>
<body>
<!-- start webpushr tracking code --> 
<script>(function(w,d, s, id) {if(typeof(w.webpushr)!=='undefined') return;w.webpushr=w.webpushr||function(){(w.webpushr.q=w.webpushr.q||[]).push(arguments)};var js, fjs = d.getElementsByTagName(s)[0];js = d.createElement(s); js.id = id;js.async=1;js.src = "https://cdn.webpushr.com/app.min.js";
fjs.parentNode.appendChild(js);}(window,document, 'script', 'webpushr-jssdk'));
webpushr('setup',{'key':'BE2GVRF5mLk7Fp1kzgXE_A5QDGK54HwqN1wEgxczP_fzfugkPREKHebr_Bfzd13eEyrn2rpv_IxZ-H9A4rygXPA' });</script>
<!-- end webpushr tracking code -->

<!-- <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "d4d4a08e-e7f1-49b4-9d7b-0c4c57222df1",
      safari_web_id: "web.onesignal.auto.2d1085e1-a560-4918-b950-42f254dd8495",
      notifyButton: {
        enable: true,
      },
    });
  });
</script> -->

<!-- Fullscreen Overlay -->
 <div id="fullscreenOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:#fff; z-index:9999; overflow:auto;">
   <button onclick="smartBack()" style="
     position:absolute;
     top:15px;
     right:15px;
     z-index:10000;
     background:#000;
     color:#fff;
     border:none;
     padding:10px 15px;
     font-size:16px;
     border-radius:8px;
   ">✕ Close</button>
 
   <div id="menuContent" style="padding:20px;"></div>
 </div>
 
 <script>
 function loadMenu() {
   fetch('https://www.allpree.com/menu/')
     .then(response => response.text())
     .then(html => {
       document.getElementById('menuContent').innerHTML = html;
       document.getElementById('fullscreenOverlay').style.display = 'block';
     })
     .catch(err => {
       alert("Failed to load menu.");
       console.error(err);
     });
 }
 
 function smartBack(fallbackUrl = '/balance') {
   const previous = document.referrer;
 
   if (previous && previous !== window.location.href) {
     window.location.href = previous;
   } else {
     window.location.href = fallbackUrl;
   }
 }
 
 </script>


<nav id="mainNav" class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
              <a href="#" onclick="loadMenu(); return false;">   <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                  <span class="sr-only">Toggle navigation</span> Menu <i class="fa-solid fa-bars"></i>
                </button> 

             </a>
               

           <!--  <a class="navbar-brand page-scroll" href="https://twitter.com/allpreedotcom"><i class="fa-brands fa-twitter"></i></a>
             <a class="navbar-brand page-scroll" href="https://instagram.com/allpreedotcom"><i class="fa-brands fa-instagram"></i></a>
             <a class="navbar-brand page-scroll" href="https://facebook.com/allpreedotcom"><i class="fa-brands fa-facebook"></i></a> -->
             
             <!--    <a class="navbar-brand page-scroll" onclick="history.back()"><i class="fa-solid fa-backward"></i></a>  
             <a class="navbar-brand page-scroll" href="https://www.allpree.com/" >CashBack</a> -->

             
             <a class="navbar-brand page-scroll" href="https://www.allpree.com/deals"><strong><i class="fa-solid fa-badge-percent fa-lg"></i></strong> Brand Deals</a>
             <a class="navbar-brand page-scroll" href="https://www.allpree.com/generategiftcard" ><strong><i class="fa-solid fa-credit-card"></i></strong> Card </a>
              
	     <!--      <a class="navbar-brand page-scroll" href="https://www.allpree.com/balance" >Balance</a>
             <a class="navbar-brand page-scroll" href="https://www.allpree.com/vouchers"><strong>Bufa-solid fa-housey eVoucher</strong></a>
              <a class="navbar-brand page-scroll" href="https://www.allpree.com/invite" >Earn</a>
              <a class="navbar-brand page-scroll" href="https://www.allpree.com/balance"><strong><i class="fa-solid fa-house"></i> HOME</strong></a>
               
            <!--   <a class="navbar-brand page-scroll" href="https://www.allpree.com/join" >Msg HR</a> -->

              
             
            <!--   <a class="navbar-brand page-scroll" href="https://www.snapchat.com/add/allpreedotcom"><i class="fa-brands fa-snapchat"></i>&nbsp;</a>
             
              <a class="navbar-brand page-scroll" href="https://tiktok.com/@joinwatsapp"><i class="fa-brands fa-tiktok"></i>&nbsp;</a>
             
              <a class="navbar-brand page-scroll">&nbsp;<strong>EVERY Day Is Black Friday!</strong></a>  
      <a class="navbar-brand page-scroll">&nbsp;<strong>Allpree Plus <i class="fa-solid fa-location-plus"></i></strong></a>
             <a class="navbar-brand page-scroll" href=""><strong><i class="fa-brands fa-whatsapp"></i> eCom <i class="fa-brands fa-btc"></i></strong> - Semi Done For You </a> 
             	  <a class="navbar-brand page-scroll" href=""><i class="fa-solid fa-sack-dollar"></i>&nbsp;Investors</a>
              <a class="navbar-brand page-scroll" href=""><i class="fa-solid fa-sack-dollar"></i>&nbsp;Resellers</a>
             <a class="navbar-brand page-scroll" href=""><i class="fa-solid fa-sack-dollar"></i>&nbsp;Referrals</a> 
               -->
              
             
             
            </div>

            <!-- Collect the nav links, forms, and other content for toggling &nbsp; -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
              <!--  <ul class="nav navbar-nav navbar-right">
                <li>
                   <a class="page-scroll" href="https://www.allpree.com/referral-program" >Refer & Earn</a>
                    </li>
                    <li>
                   <a class="page-scroll" href="https://www.allpree.com/list/">All Stores</a>
                    </li>
                    <li>
                  <a class="page-scroll" href="https://www.allpree.com/balance/"><strong>Check Balance</strong></a> 
                    </li> 
                </ul> -->
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>

	<div class="container">
             <div class="row land">
                 <div class="home">     
 			<div class="center">
                 <div class="col-md-6 home-txt1"> <br>
			 
		<button onclick="openSavedListsPopup()" style="margin: 10px auto; display: block; background: #28a745; color: white; padding: 10px 16px; border-radius: 6px; border: none;">📝 View Saved Shopping Lists</button>
 <br>
  <div id="deals-container">Loading deals...</div>

 <!-- Popup Overlay -->
<div class="popup-overlay" id="popup">

<div class="tab-switcher">
  <button id="showLikedBtn" class="tab-btn">Likes</button>
  <button id="showRandomBtn" class="tab-btn active">Deals</button>
  <button id="showBrandTabBtn" class="tab-btn">Shop</button>
 <button id="cartBtn" class="tab-btn">
  <span class="cart-icon2">📝</span>
  <span id="cartCount" class="cart-count2">0</span>
</button>
</div>

	
  <div class="popup-content" id="popupContent">
    <span class="popup-close" onclick="closePopup()">×</span>
    <div style="position: relative;">
      <span class="popup-discount-badge" id="popupBadge"></span>
	    
      <button id="popupBack" class="popup-back-arrow"></button> 
     <div class="image-wrapper">
      <img id="popupImg" src="" alt="Product">
    </div>
	   <div id="cartBtnContainer" class="hidden">
	    <button id="popupAddToCartBtn" class="cart-btn">📝 Add</button>
	    </div>
	   <div id="likeButtonContainer">
  <button class="like-btn" id="popupLikeBtn">🤍 Like</button>
</div>

    </div>
    <div class="popup-body">
      <div class="popup-title" id="popupTitle"></div>
      <div class="popup-price" id="popupPrice"></div>
      <div class="popup-discount" id="popupDiscount"></div>
      <div class="popup-savings" id="popupSavings"></div> <!-- Savings element below the discount -->
      <div id="popupCashback" class="popup-cashback"></div>
      <div class="popup-description" id="popupDesc"></div>
     
    </div>	  
  </div> 

 <!-- Brand Box Wrapper -->
<div class="popup-brand-box" id="brandContainer">
  <div class="brand-logo-container">
    <img id="brandLogo" src="" alt="Brand Logo" class="brand-logo">
  </div>

	<div class="brand-text-container">
    <div id="brandName" class="brand-name"></div>
    <span id="popupTimer" class="brand-timer"></span>
  </div>
  
</div>
	
</div> 


<div id="cartPopup" style="display: none; position: fixed; top: 60px; right: 10px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; background: white; border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.3); z-index: 10000; padding: 16px;"></div>
			 
<script>
	let sheetUrls = [];

async function loadSheetUrls() {
  try {
    // Fetch the sheeturls.json
    const response = await fetch('https://www.allpree.com/sheeturls.json'); // Make sure this is the correct URL to your JSON file
    const data = await response.json();

    // Now we have the array of URLs
    sheetUrls = data.sheeturls; // This will assign the URLs to the sheetUrls variable
    console.log(sheetUrls); // You can log the URLs to confirm
    loadDeals(); // Call the loadDeals function after loading the sheet URLs
  } catch (err) {
    console.error('Failed to load sheet URLs:', err);
  }
}

loadSheetUrls(); // Call this function to initialize and load the URLs
	
const allBrandsData = [];       // Holds all data from each brand's sheet
const allDealsFlat = [];        // Flattened list of all deals across brands
let currentPopupDeal = null;    // Currently open deal in the popup
let likedDealIndex = 0;         // Index of current liked deal being viewed
let likedDealKeys = [];         // Array of liked deal keys
let isLikedMode = false;        // Tracks whether we’re in liked mode or random mode
let allDealsFromSheets = [];
let isBrandMode = false;
let brandDealIndex = 0;
let brandDealKeys =[];	
let isSwiping = false;
let isNavigating = false; // Flag to prevent multiple redirects happening at the same time
let lastKnownLocation = null;
let userLocation = null;

	
function getDealKey(deal) {
  return `${(deal.brandName || '').trim().toLowerCase()}-${(deal.name || '').trim().toLowerCase()}`
    .replace(/\s+/g, '')      // remove spaces
    .replace(/[^a-z0-9\-]/g, ''); // strip weird characters
}

const refreshButton = document.createElement('div');
refreshButton.id = 'refresh-button';
refreshButton.style = `
  position: fixed;
  bottom: 5px;
  right: 25px;
  z-index: 1000;
  font-size: 15px;
  background: white;
  border-radius: 50%;
  padding: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  cursor: pointer;
  text-align: center;
`;
refreshButton.innerHTML = `🔄`;
document.body.appendChild(refreshButton);

refreshButton.addEventListener('click', function() {
  location.reload();
});



///////  ///////// START

document.addEventListener('DOMContentLoaded', () => {
  initFavoriteBrandIcon();
  updateFavoriteBrandCount(getTotalFavoriteBrands());
});

function initFavoriteBrandIcon() {
  if (!document.getElementById('favorite-brand-icon-container')) {
    const favoriteBrandIconContainer = document.createElement('div');
    favoriteBrandIconContainer.id = 'favorite-brand-icon-container';
    favoriteBrandIconContainer.innerHTML = `
      <div id="favorite-brand-icon" style="
        position: fixed;
        top: 68px;
        left: 25px;
        z-index: 1000;
        font-size: 15px;
        background: white;
        border-radius: 50%;
        padding: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        cursor: pointer;
      ">
        ❤️
      </div>
    `;
    document.body.appendChild(favoriteBrandIconContainer);
    document.getElementById('favorite-brand-icon').onclick = openFavoriteBrandPopup;
    updateFavoriteBrandCount(getTotalFavoriteBrands());
  }
}

function updateFavoriteBrandCount(count) {
  const countEl = document.getElementById('favorite-brand-count');
  if (countEl) {
    countEl.textContent = count;
    countEl.style.display = count > 0 ? 'inline-block' : 'none';
  }
}

function getTotalFavoriteBrands() {
  const favoriteBrands = JSON.parse(localStorage.getItem('favoriteBrands') || '[]');
  return favoriteBrands.length;
}

function addToFavorites(brand) {
  const favoriteBrands = JSON.parse(localStorage.getItem('favoriteBrands') || '[]');
  const alreadyInFavorites = favoriteBrands.includes(brand);

  if (alreadyInFavorites) {
    const index = favoriteBrands.indexOf(brand);
    favoriteBrands.splice(index, 1);
    console.log('Removed from favorites:', brand);
  } else {
    favoriteBrands.push(brand);
    console.log('Added to favorites:', brand);
  }

  localStorage.setItem('favoriteBrands', JSON.stringify(favoriteBrands));
  updateFavoriteBrandCount(getTotalFavoriteBrands());
  showFavoriteBrandIcon();

  return !alreadyInFavorites; // return new state: true if added, false if removed
}

function showFavoriteBrandIcon() {
  const favoriteBrands = JSON.parse(localStorage.getItem('favoriteBrands') || '[]');
  if (favoriteBrands.length > 0) {
    document.getElementById('favorite-brand-icon').style.display = 'block';
  } else {
    document.getElementById('favorite-brand-icon').style.display = 'none';
  }
}

function openFavoriteBrandPopup() {
  // Prevent duplicate backdrop
  if (document.getElementById('favorite-brand-backdrop')) return;

  // Create backdrop
  const backdrop = document.createElement('div');
  backdrop.id = 'favorite-brand-backdrop';
  backdrop.style = `
    position: fixed;
    top: 0;
    left: 0;
    bottom: 68px;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  `;
  backdrop.addEventListener('click', (e) => {
    if (e.target === backdrop) closeFavoriteBrandPopup();
  });

  // Create popup
  let popup = document.getElementById('favorite-brand-popup');
  if (!popup) {
    popup = document.createElement('div');
    popup.id = 'favorite-brand-popup';
    popup.style = `
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  padding: 10px;
  width: 90%;
  max-width: 500px;
  height: 70%;
  max-height: 100vh;
   overflow-y: scroll; /* Allow scroll */
  scrollbar-width: none; /* Firefox hide */
  -ms-overflow-style: none; /* IE/Edge hide */
  box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
  z-index: 9999;
`;
  }

  // Add swipeable brand content dynamically from allBrandsData
  const brands = allBrandsData.map(brand => ({ name: brand.brand, logo: brand.logo }));  // Extract brand names and logos
  popup.innerHTML = '';

  if (brands.length === 0) {
    popup.innerHTML = `<div style="text-align:center;">No favorite brands available.</div>`;
  } else {
    const brandCarousel = document.createElement('div');
    brandCarousel.style = 'display: flex; flex-direction: column; gap: 10px; overflow-y: scroll; max-height: 70vh; padding: 10px;';

    // Retrieve selected brand from localStorage
    const selectedBrand = localStorage.getItem('selectedFavoriteBrand');

    // Add each brand as a card
    brands.forEach(brand => {
      const brandCard = document.createElement('div');
      brandCard.style = `
        width: 100%;
        display: flex;
        align-items: center;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
        background-color: #f8f8f8;
        transition: all 0.3s;
      `;

      const brandLogo = document.createElement('img');
      brandLogo.src = brand.logo;  // Set the logo image source
      brandLogo.style = 'width: 40px; height: 40px; margin-right: 15px; border-radius: 50%;';
      
      const brandName = document.createElement('strong');
      brandName.innerText = brand.name;

      brandCard.appendChild(brandLogo);
      brandCard.appendChild(brandName);

      // Check if this brand was previously selected
      if (brand.name === selectedBrand) {
        brandCard.style.border = '2px solid #ff4d4d';
        brandCard.style.backgroundColor = '#ffe6e6';
      }

      // Click event to select brand
      brandCard.onclick = () => {
        selectFavoriteBrand(brand.name, brandCard);
      };

      // Hover effect
      brandCard.onmouseover = () => {
        brandCard.style.transform = 'scale(1.05)';
        brandCard.style.backgroundColor = '#f0f0f0';
      };

      brandCard.onmouseout = () => {
        brandCard.style.transform = 'scale(1)';
        brandCard.style.backgroundColor = '#f8f8f8';
      };

      // Add brand card to carousel
      brandCarousel.appendChild(brandCard);
    });

    popup.appendChild(brandCarousel);
  }

  backdrop.appendChild(popup);
  document.body.appendChild(backdrop);
}

// Select a brand and highlight it visually
function selectFavoriteBrand(brand, brandCard) {
  console.log(`Selected favorite brand: ${brand}`);

  // Reset previous selections
  const allBrandCards = document.querySelectorAll('#favorite-brand-popup div');
  allBrandCards.forEach(card => {
    card.style.border = '1px solid #ddd';
    card.style.backgroundColor = '#f8f8f8';
  });

  // Highlight selected brand
  brandCard.style.border = '2px solid #ff4d4d';
  brandCard.style.backgroundColor = '#ffe6e6';

  // Save selected brand to localStorage
  localStorage.setItem('selectedFavoriteBrand', brand);
  closeFavoriteBrandPopup();
}

function closeFavoriteBrandPopup() {
  const backdrop = document.getElementById('favorite-brand-backdrop');
  if (backdrop) backdrop.remove();
  document.body.style.overflow = ''; // Re-enable page scroll
}

///////  ///////// END	


	
/////// ////////// START

document.addEventListener('DOMContentLoaded', () => {
  initCartIcon();
  updateCartCount(getTotalCartItems());
});

function initCartIcon() {
  if (!document.getElementById('cart-icon-container')) {
    const cartIconContainer = document.createElement('div');
    cartIconContainer.id = 'cart-icon-container';
    cartIconContainer.innerHTML = `
      <div id="cart-icon" style="
        position: fixed;
        top: 68px;
        right: 25px;
        z-index: 1000;
        font-size: 15px;
        background: white;
        border-radius: 50%;
        padding: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        cursor: pointer;
      ">
        📝
        <span id="cart-count" style="
          position: absolute;
          top: 0;
          right: 0;
          transform: translate(50%, -50%);
          background: red;
          color: white;
          border-radius: 50%;
          padding: 2px 6px;
          font-size: 12px;
          display: none;
        ">0</span>
      </div>
    `;
    document.body.appendChild(cartIconContainer);
    document.getElementById('cart-icon').onclick = openCartPopup;
    updateCartCount(getTotalCartItems()); 
  
}
}

document.getElementById('cartBtn').addEventListener('click', (e) => {
  e.stopPropagation(); // Prevents closing the current popup
  openCartPopup();
});
	
function updateCartCount(count) {
  const countEl = document.getElementById('cart-count');
  const tabCountEl = document.getElementById('cartCount');
  if (countEl) {
    countEl.textContent = count;
    countEl.style.display = count > 0 ? 'inline-block' : 'none';
  }
  if (tabCountEl) {
    tabCountEl.textContent = count;
  }
}

function getTotalCartItems() {
  const cart = JSON.parse(localStorage.getItem('cartItems') || '{}');
  return Object.values(cart).reduce((sum, items) => sum + items.length, 0);
}

function addToCart(deal) {
  const dealKey = getDealKey(deal);
  const brand = deal.brandName?.trim() || 'Unknown';
  const cart = JSON.parse(localStorage.getItem('cartItems') || '{}');
  let brandItems = cart[brand] || [];

  const itemIndex = brandItems.findIndex(item => item._id === dealKey);
  const inCart = itemIndex !== -1;

  if (inCart) {
    // Remove item
    brandItems.splice(itemIndex, 1);
    console.log('Removed from cart:', deal.name);
  } else {
    // Add item
    const price = parseFloat(deal.discount?.toString().replace(/,/g, '') || '0');
    brandItems.push({
      _id: dealKey,
      brand: deal.brandName,
      brandimg: deal.brandLogo,
      name: deal.name,
      img: deal.img || deal.image || '',
      price
    });
    console.log('Added to cart:', deal.name);
  }

  cart[brand] = brandItems;
  localStorage.setItem('cartItems', JSON.stringify(cart));
  updateCartCount(getTotalCartItems());
  showCartIcon();

  return !inCart; // return new state: true if added, false if removed
}

function clearBrandCart(brand) {
  const cart = JSON.parse(localStorage.getItem('cartItems') || '{}');
  delete cart[brand];
  localStorage.setItem('cartItems', JSON.stringify(cart));
  updateCartCount(getTotalCartItems());

  const popup = document.getElementById('cart-popup');
  if (!popup) return;

  // Remove the brand section directly
  const brandSections = popup.querySelectorAll('strong');
  brandSections.forEach(strong => {
    if (strong.textContent.trim() === brand) {
      const section = strong.closest('div[style*="border-bottom"]');
      if (section) section.remove();
    }
  });

  // If nothing left in cart, show empty message
  const remainingCart = JSON.parse(localStorage.getItem('cartItems') || '{}');
  const hasItems = Object.values(remainingCart).some(arr => arr.length > 0);
  if (!hasItems) {
    popup.innerHTML = `<div style="text-align:center;">📝 Your shopping list is empty.</div>`;
  }
}

	function saveLocation(coords) {
  localStorage.setItem('userLocation', coords);
}

	function getSavedLocation() {
  return localStorage.getItem('userLocation');
}

async function loadBrandLocations() {
  try {
    const res = await fetch('brandLocations.json');
    if (!res.ok) throw new Error('Failed to fetch locations');
    brandLocations = await res.json();
  } catch (err) {
    console.error('Failed to load brand locations:', err);
  }
}
	

async function showCartWithLocations() {
  await loadBrandLocations();  // Wait for the locations to load
  openCartPopup();             // Then show the cart popup
}

// Function to calculate the distance between two locations (in meters)
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3; // Earth radius in meters
  const φ1 = lat1 * Math.PI / 180;
  const φ2 = lat2 * Math.PI / 180;
  const Δφ = (lat2 - lat1) * Math.PI / 180;
  const Δλ = (lon2 - lon1) * Math.PI / 180;

  const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
            Math.cos(φ1) * Math.cos(φ2) *
            Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

  return R * c; // Distance in meters
}

// Check if user has moved more than 500 meters from saved location
function hasMovedSignificantly(savedLocation, currentLocation) {
  if (!savedLocation) return true; // If no saved location, treat it as moved
  const [savedLat, savedLon] = savedLocation.split(',').map(Number);
  const [currentLat, currentLon] = currentLocation.split(',').map(Number);
  const distance = getDistance(savedLat, savedLon, currentLat, currentLon);
  return distance > 500; // 500 meters
}

function handleLocationClick(coordinates) {
  if (!coordinates) {
    alert("Sorry, this location is not available yet.");
    return;
  }
  closeLocationPopup(); // auto-close the popup first
  navigateToLocation(coordinates);
}

	
async function openBrandLocation(brand) {
  if (isNavigating) return;
  isNavigating = true;

 const dest = brandLocations[brand];

// If no destination OR blank string OR empty object
if (!dest || (typeof dest === 'string' && dest.trim() === '') || (typeof dest === 'object' && Object.keys(dest).length === 0)) {
  alert("No location set for this brand yet.");
  isNavigating = false;
  return;
}


  if (typeof dest === 'object') {
    // Brand has multiple locations
    showLocationPopup(dest);
    isNavigating = false;
  } else {
    // Brand has only one location
    const savedLocation = getSavedLocation();
    if (!savedLocation || hasMovedSignificantly(savedLocation, savedLocation)) {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const currentCoords = `${pos.coords.latitude},${pos.coords.longitude}`;
            if (hasMovedSignificantly(savedLocation, currentCoords)) {
              userLocation = currentCoords;
              saveLocation(currentCoords);
              alert("Close to redirect to google maps for directions.");
            }
            navigateToLocation(dest, currentCoords);
            isNavigating = false;
          },
          (err) => {
            alert("Could not retrieve your location.");
            navigateToLocation(dest);
            isNavigating = false;
          }
        );
      } else {
        alert("Geolocation is not supported by your browser.");
        navigateToLocation(dest);
        isNavigating = false;
      }
    } else {
      navigateToLocation(dest, savedLocation);
      isNavigating = false;
    }
  }
}

function showLocationPopup(brandLocations) {
  // Check if already open
  if (document.getElementById('location-popup')) return;

  // Create the backdrop element
  const backdrop = document.createElement('div');
  backdrop.id = 'location-popup-backdrop';
  backdrop.style = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
   background: linear-gradient(
    to bottom,
    rgba(0, 0, 0, 1) 0%,
    rgba(0, 0, 0, 1) 10%,
    rgba(0, 0, 0, 1) 20%,
    rgba(0, 0, 0, 1) 30%,
    rgba(0, 0, 0, 1) 40%,
    rgba(0, 0, 0, 1) 50%,
    rgba(0, 0, 0, 1) 60%,
    rgba(0, 0, 0, 1) 70%,
    rgba(0, 0, 0, 1) 80%,
    rgba(0, 0, 0, 1) 90%,
    rgba(0, 0, 0, 1) 100%
  );
    z-index: 10000;
  `;

  // Create the popup element
  const popup = document.createElement('div');
  popup.id = 'location-popup';
  popup.style = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 10px;
    z-index: 10001;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    max-width: 400px;
    width: 90%;
    text-align: center;
    overflow-y: scroll;
    scrollbar-width: none; /* Firefox hide */
    -ms-overflow-style: none; /* IE/Edge hide */
    height: 80%;
  `;

  let optionsHtml = '<h3>Select a Location</h3>';

  const origin = getSavedLocation();

  // Check if there's a saved location and if it’s been moved significantly
  if (origin) {
    const currentCoords = `${origin.latitude},${origin.longitude}`;
    if (hasMovedSignificantly(origin, currentCoords)) {
      // If moved, save the new location and alert
      saveLocation(currentCoords); 
      alert("Close to redirect to google maps for directions.");
    }
  }

  // If the brand has multiple locations, ask for the user's geolocation
  if (Object.keys(brandLocations).length > 1 && !origin) {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const currentCoords = `${pos.coords.latitude},${pos.coords.longitude}`;
          saveLocation(currentCoords); // Save the new location
           alert("Location detected. You will now see all location.");
          showLocationButtons(brandLocations, currentCoords); // Show the buttons with the updated location
        },
        (err) => {
          alert("Could not retrieve your location.");
          showLocationButtons(brandLocations); // Show buttons without geolocation
        }
      );
    } else {
      alert("Geolocation is not supported by your browser.");
      showLocationButtons(brandLocations); // Show buttons without geolocation
    }
  } else {
    // Show location buttons directly if single location or already have saved location
    showLocationButtons(brandLocations, origin);
  }

  function showLocationButtons(brandLocations, origin) {
    // Build location buttons for each brand
    for (const [name, coords] of Object.entries(brandLocations)) {
      optionsHtml += `
        <button onclick="handleNavigate('${coords}', '${origin}')" style="margin: 8px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px;">${name}</button><br>
      `;
    }

    // Cancel button
  /*  optionsHtml += `
      <button onclick="closeLocationPopup()" style="margin-top: 10px; padding: 10px 20px; background: red; color: white; border: none; border-radius: 5px;">Cancel</button>
    `; */

    popup.innerHTML = optionsHtml;
    document.body.appendChild(backdrop); // Add the backdrop to the body
    document.body.appendChild(popup); // Add the popup to the body

    // Add click event listener to the backdrop to close the popup when clicking outside
    backdrop.addEventListener('click', closeLocationPopup);

    // Prevent closing when clicking inside the popup
    popup.addEventListener('click', (event) => {
      event.stopPropagation(); // Stop event from propagating to the backdrop
    });

	  
    popup.innerHTML = optionsHtml;
    document.body.appendChild(popup);
  }
}

// New helper function for safe navigation
function handleNavigate(coords, origin) {
  if (!coords || coords.trim() === '') {
    alert("No location set for this location yet.");
    return;
  }
  closeLocationPopup();
  navigateToLocation(coords, origin);
}

function closeLocationPopup() {
  const popup = document.getElementById('location-popup');
  const backdrop = document.getElementById('location-popup-backdrop');
  if (popup) popup.remove();
  if (backdrop) backdrop.remove();
}

function closeLocationSection() {
  const popup = document.getElementById('cart-popup');
  const locationSection = popup.querySelector('.location-section');
  if (locationSection) {
    locationSection.remove();
  }
}

function navigateToLocation(dest, originCoords = null) {
  const url = originCoords
    ? `https://www.google.com/maps/dir/?api=1&origin=${originCoords}&destination=${dest}`
    : `https://www.google.com/maps/dir/?api=1&destination=${dest}`;

  window.location.href = url;
}
	
	
function openCartPopup() {
  // Prevent duplicate backdrop
  if (document.getElementById('cart-backdrop')) return;

	// Load brand locations first
  showCartWithLocations();
	
 // Create backdrop
const backdrop = document.createElement('div');
backdrop.id = 'cart-backdrop';
backdrop.style = `
  position: fixed;
  top: 0;
  left: 0;
  bottom: 0;
  width: 100%;
  height: 100%;
 background: linear-gradient(
    to bottom,
    rgba(0, 0, 0, 1) 0%,
    rgba(0, 0, 0, 1) 10%,
    rgba(0, 0, 0, 1) 20%,
    rgba(0, 0, 0, 1) 30%,
    rgba(0, 0, 0, 1) 40%,
    rgba(0, 0, 0, 1) 50%,
    rgba(0, 0, 0, 1) 60%,
    rgba(0, 0, 0, 1) 70%,
    rgba(0, 0, 0, 1) 80%,
    rgba(0, 0, 0, 1) 90%,
    rgba(0, 0, 0, 1) 100%
  );
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
`;
backdrop.addEventListener('click', (e) => {
  if (e.target === backdrop) closeCartPopup();
});

// Create or get popup
let popup = document.getElementById('cart-popup');
if (!popup) {
  popup = document.createElement('div');
  popup.id = 'cart-popup';
  popup.style = `
   background: #fff;
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 10px;
    width: 90%;
    max-width: 500px;
    margin-top: -90px;
    height: 80%;
    max-height: 100vh;
   overflow-y: scroll; /* Allow scroll */
  scrollbar-width: none; /* Firefox hide */
  -ms-overflow-style: none; /* IE/Edge hide */
  box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
  z-index: 9999;
`;
}

// Add popup to backdrop and backdrop to body
backdrop.appendChild(popup);
document.body.appendChild(backdrop);

  // Clear and rebuild cart content
  const cart = JSON.parse(localStorage.getItem('cartItems') || '{}');
  const brandKeys = Object.keys(cart);
  popup.innerHTML = '';

  if (brandKeys.length === 0) {
    popup.innerHTML = `<div style="text-align:center;">📝 Your shopping is empty.</div>`;
  } else {
    brandKeys.forEach(brand => {
      const items = cart[brand];
      if (!items || items.length === 0) return;

      const brandLogo = items[0].brandimg || '';
      const brandSection = document.createElement('div');
      brandSection.style = 'border-bottom: 1px solid #eee; margin-bottom: 12px; padding-bottom: 10px;';
      brandSection.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <img src="${brandLogo}" alt="${brand}" style="width: 30px; height: 30px; object-fit: contain;">
            <strong>${brand}</strong>
          </div>
        </div>
      `;

      items.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.style = 'display: flex; gap: 10px; align-items: center; margin-bottom: 6px;';
        itemDiv.innerHTML = `
          <img src="${item.img}" alt="${item.name}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px;">
          <div style="flex: 1;">
            <div style="font-size: 14px;">${item.name}</div>
            <div style="font-weight: bold; color: green;">JMD ${item.price}</div>
          </div>
        `;
        brandSection.appendChild(itemDiv);
      });

    // Calculate totals
const subtotal = items.reduce((sum, item) => sum + (item.price || 0), 0);
const tax = subtotal * 0.15;
const grandTotal = subtotal + tax;

// Format numbers as currency
const formatCurrency = (amount) => `JMD ${amount.toLocaleString('en-JM', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

// Totals section
const totalsDiv = document.createElement('div');
totalsDiv.style = 'margin-top: 10px; margin-bottom: 10px; font-size: 14px;';
totalsDiv.innerHTML = `
  <div style="display: flex; justify-content: space-between;"><span>Subtotal:</span><strong>${formatCurrency(subtotal)}</strong></div>
  <div style="display: flex; justify-content: space-between;"><span>15% Tax:</span><strong>${formatCurrency(tax)}</strong></div>
  <div style="display: flex; justify-content: space-between; font-weight: bold;"><span>Total:</span><strong style="color: green;">${formatCurrency(grandTotal)}</strong></div>
`;
brandSection.appendChild(totalsDiv);

// Buttons row
const actionRow = document.createElement('div');
actionRow.style = 'display: flex; justify-content: space-between; margin-top: 8px;';
actionRow.innerHTML = `
  <button onclick="clearBrandCart('${brand}')" style="background: red; color: white; border: none; padding: 5px 10px; border-radius: 4px;">Clear</button>
  <button onclick="saveShoppingList('${brand}')" style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 4px;">Save Shopping List</button>
  <button onclick="openBrandLocation('${brand}')" style="background: #555; color: white; border: none; padding: 5px 10px; border-radius: 4px;">Location</button>
`;

brandSection.appendChild(actionRow);

      popup.appendChild(brandSection);
    });
  }

  // Add popup to backdrop and show
  backdrop.appendChild(popup);
  document.body.appendChild(backdrop);
  document.body.style.overflow = 'hidden'; // disable page scroll
}

function closeCartPopup() {
  const backdrop = document.getElementById('cart-backdrop');
  if (backdrop) backdrop.remove();
  document.body.style.overflow = ''; // re-enable scroll
}

	
 ////////// END


	
function deleteSavedList(brand, index) {
  const savedLists = JSON.parse(localStorage.getItem('savedLists') || '{}');
  if (savedLists[brand]) {
    savedLists[brand].splice(index, 1);
    if (savedLists[brand].length === 0) delete savedLists[brand];
    localStorage.setItem('savedLists', JSON.stringify(savedLists));
    openSavedListsPopup(); // Refresh the popup
  }
}

function formatCurrency(value) {
  return value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
	
function saveShoppingList(brand) {
  const cart = JSON.parse(localStorage.getItem('cartItems') || '{}');
  const savedLists = JSON.parse(localStorage.getItem('savedLists') || '{}');
  const timestamp = new Date().toISOString();

  if (cart[brand]) {
    if (!savedLists[brand]) savedLists[brand] = [];
    savedLists[brand].push({
      date: timestamp,
      items: cart[brand]
    });
    localStorage.setItem('savedLists', JSON.stringify(savedLists));
    alert(`Shopping list for ${brand} saved!`);
  }
}
	
function openSavedListsPopup() {
  // Backdrop
  const backdrop = document.createElement('div');
  backdrop.id = 'saved-lists-backdrop';
  backdrop.style = `
    position: fixed;
    top: 0;
    left: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.4);
    z-index: 10000;
  `;
  backdrop.onclick = (e) => {
    if (e.target === backdrop) closeSavedListsPopup();
  };

  // Popup
  const popup = document.createElement('div');
  popup.id = 'saved-lists-popup';
  popup.style = `
    background: #fff;
    padding: 16px;
    border-radius: 10px;
    max-width: 500px;
    width: 90%;
    max-height: 70vh;
    overflow-y: auto;
    box-shadow: 0 0 20px rgba(0,0,0,0.2);
  `;

  const savedLists = JSON.parse(localStorage.getItem('savedLists') || '{}');
  const brandKeys = Object.keys(savedLists);
  popup.innerHTML = `<h3 style="margin-bottom: 16px;">📝 Saved Shopping Lists</h3>`;

  if (brandKeys.length === 0) {
    popup.innerHTML += `<div style="text-align: center;">📝 No saved shopping lists yet.</div>`;
  } else {
    brandKeys.forEach(brand => {
      savedLists[brand].forEach((list, index) => {
        const date = new Date(list.date).toLocaleString();
        const section = document.createElement('div');
        section.style = 'border: 1px solid #ccc; border-radius: 8px; padding: 10px; margin-bottom: 12px;';
        section.innerHTML = `
          <strong>${brand}</strong><br>
          <small>Saved: ${date}</small>
          <ul style="margin-top: 8px; padding-left: 16px;">
            ${list.items.map(item => `<li>${item.name} – JMD ${formatCurrency(item.price)}</li>`).join('')}
          </ul>
          <button onclick="deleteSavedList('${brand}', ${index})" style="margin-top: 6px; background: red; color: white; border: none; padding: 4px 8px; border-radius: 4px;">Delete</button>
        `;
        popup.appendChild(section);
      });
    });
  }

  backdrop.appendChild(popup);
  document.body.appendChild(backdrop);
}

function closeSavedListsPopup() {
  document.getElementById('saved-lists-backdrop')?.remove();
}	

////////// START	
function renderLikedDealsGallery() {
  const likedDeals = JSON.parse(localStorage.getItem('likedDeals') || '{}');
  const galleryEl = document.getElementById('likedDealsGallery');
  const sectionEl = document.getElementById('likedDealsSection');

  galleryEl.innerHTML = ''; // Clear previous content
  const likedKeys = Object.keys(likedDeals);

  if (likedKeys.length === 0) {
    sectionEl.style.display = 'none'; // Hide section if no liked deals
    return;
  }

  likedKeys.forEach(key => {
    const deal = likedDeals[key];
    if (deal && deal.name && deal.image && deal.original) {
      const card = document.createElement('div');
      card.className = 'deal liked';

      const percentOff = deal.percentOff || 0;
      const brandLogo = deal.brandLogo || '';
      const shortName = deal.name.length > 20 ? deal.name.substring(0, 20) + '...' : deal.name;

      card.innerHTML = `
        <div class="liked-deal-brand">
          <img src="${brandLogo}" alt="Brand Logo" class="liked-deal-brand-img">
        </div>
        <img src="${deal.image}" class="liked-deal-card-img" alt="${deal.name}">
        ${percentOff ? `<span class="liked-discount-badge">${percentOff}% OFF </span>` : ''}
        <div class="liked-deal-content">
          <div class="liked-deal-title">${shortName}</div>
          <div class="liked-deal-price">J$${deal.original}</div>
          <div class="liked-deal-discount">J$${deal.discount}</div>
        </div>
      `;

    
  card.addEventListener('click', () => {
  const likedDeals = JSON.parse(localStorage.getItem('likedDeals') || '{}');
  likedDealKeys = Object.keys(likedDeals);
 likedDealIndex = likedDealKeys.findIndex(k => k === getDealKey(deal));

  isLikedMode = true;
  document.getElementById('showLikedBtn')?.classList.add('active');
  document.getElementById('showRandomBtn')?.classList.remove('active');

  openPopup(deal);

  // Delay attaching swipe listeners until popup fully rendered
  setTimeout(() => {
    addPopupSwipeListeners();
  }, 100); // 100ms is usually enough
});


      galleryEl.appendChild(card);
    }
  });

  sectionEl.style.display = 'block';
}

	
 /////////// END

	

	
 function startPopupCountdown(expireDate, el) {
  if (!el || !expireDate) return;

  const parsedDate = Date.parse(expireDate);

  // If date is invalid or already expired
  if (isNaN(parsedDate) || parsedDate < Date.now()) {
    el.textContent = "⏳ Coming soon";
    el.classList.add("countdown-upcoming");
    return;
  }

  function updateCountdown() {
    const now = new Date();
    const endTime = new Date(parsedDate);
    const diff = endTime - now;

    if (diff <= 0) {
      el.textContent = "❌ Deal expired";
      el.classList.add("countdown-ended");
      clearInterval(timerInterval);
      return;
    }

    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
    const minutes = Math.floor((diff / (1000 * 60)) % 60);
    const seconds = Math.floor((diff / 1000) % 60);

    let timeStr = `${days}d ${hours}h ${minutes}m ${seconds}s left`;

    el.textContent = `⏳ ${timeStr}`;
  }

  updateCountdown();
  const timerInterval = setInterval(updateCountdown, 1000);
}

	
function openPopup({ image, name, original, discount, description, brandLogo, brandName }, skipHistory = false) {
  const originalPrice = parseFloat(original.replace(/,/g, '')) || 0;
  const discountPrice = parseFloat(discount.replace(/,/g, '')) || 0;
  const percentOff = originalPrice && discountPrice ? Math.round((1 - discountPrice / originalPrice) * 100) : 0;
  const savings = originalPrice - discountPrice;

  const cashbackPercent = 49;
  const cashbackAmount = Math.round(discountPrice * cashbackPercent / 100);
  const finalPrice = discountPrice - cashbackAmount;

  const cashbackEl = document.getElementById('popupCashback');
  cashbackEl.innerHTML = `CashBack: J$${cashbackAmount.toLocaleString()} (${cashbackPercent}%) <br> <span class="final-price">Final Price: J$${finalPrice.toLocaleString()} — With Allpree Gift Card ¹²¹ </span>`;

  document.body.classList.add('noscroll');

  currentPopupDeal = { image, name, original, discount, description, brandLogo, brandName };

  document.getElementById('popupImg').src = image;
  document.getElementById('popupTitle').textContent = name;
  document.getElementById('popupPrice').textContent = `Original Price: JMD $${original}`;
  document.getElementById('popupDiscount').textContent = `Now: JMD $${discount}`;
  document.getElementById('popupDesc').innerHTML = formatDescription(description || '');
  document.getElementById('popupBadge').textContent = `${percentOff}% OFF`;
  document.getElementById('popupSavings').textContent = `SAVINGS $${savings.toLocaleString()}`;

  document.getElementById('brandLogo').src = brandLogo;
  document.getElementById('brandLogo').alt = brandName;
  document.getElementById('brandName').textContent = brandName;

  const popupTimerEl = document.getElementById('popupTimer');
  popupTimerEl.textContent = 'Loading...';
  popupTimerEl.classList.remove('countdown-ended', 'countdown-urgent');

  const brandInfo = allBrandsData.find(b => b.brand === brandName);
  if (brandInfo?.expireDate) {
    startPopupCountdown(brandInfo.expireDate, popupTimerEl);
  }

  const backArrow = document.getElementById('popupBack');
  backArrow.style.display = window.history.length > 1 ? 'block' : 'none';

  if (!skipHistory) {
    history.pushState({ popup: true, dealName: name }, '', '');
  }

  document.getElementById('popup').style.display = 'flex';
  setupLikeButton(currentPopupDeal);
  setupAddToCartButton(currentPopupDeal);
}
	
//////////    OUTSIDE 
	
function setupLikeButton(deal) {

const likeContainer = document.getElementById('likeButtonContainer');

// Hide like button in brand mode
if (typeof isBrandMode !== 'undefined' && isBrandMode) {
  likeContainer?.classList.add('hidden');
  return;
} else {
  likeContainer?.classList.remove('hidden');
}

	
  const likeBtn = document.getElementById('popupLikeBtn');
  if (!likeBtn || !deal || !deal.name) {
    console.warn('Like button or deal missing:', { likeBtn, deal });
    return;
  }

  const dealKey = getDealKey(deal);
  console.log('Setting up like button for:', deal.name, 'Key:', dealKey);

  const likedDeals = JSON.parse(localStorage.getItem('likedDeals') || '{}');
  const isLiked = !!likedDeals[dealKey];

  console.log('Is this deal already liked?', isLiked);
  likeBtn.classList.toggle('liked', isLiked);
  likeBtn.textContent = isLiked ? '❤️ Like' : '🤍 Like';

  likeBtn.onclick = () => {
    console.log('Like button clicked for:', deal.name);
    const updatedLikedDeals = JSON.parse(localStorage.getItem('likedDeals') || '{}');

    const isNowLiked = likeBtn.classList.toggle('liked');
    likeBtn.textContent = isNowLiked ? '❤️ Like' : '🤍 Like';
    console.log('Deal is now liked?', isNowLiked);

    const original = parseFloat(deal.original?.toString().replace(/,/g, '') || '0');
    const discount = parseFloat(deal.discount?.toString().replace(/,/g, '') || '0');
    const percentOff = original && discount
      ? Math.round(((original - discount) / original) * 100)
      : 0;

    if (isNowLiked) {
      updatedLikedDeals[dealKey] = {
        ...deal,
        percentOff,
        _id: dealKey
      };
      console.log('Added to liked deals:', updatedLikedDeals[dealKey]);
    } else {
      delete updatedLikedDeals[dealKey];
      console.log('Removed from liked deals:', dealKey);
    }

    localStorage.setItem('likedDeals', JSON.stringify(updatedLikedDeals));
    console.log('Updated localStorage:', updatedLikedDeals);

    renderLikedDealsGallery();
  };
}		
 	
 function setupAddToCartButton(deal) {
  const cartBtnContainer = document.getElementById('cartBtnContainer');
  const addToCartBtn = document.getElementById('popupAddToCartBtn');

  if (typeof isBrandMode === 'undefined' || !isBrandMode) {
    cartBtnContainer?.classList.add('hidden');
    return;
  } else {
    cartBtnContainer?.classList.remove('hidden');
  }

  if (!addToCartBtn || !deal || !deal.name) {
    console.warn('Cart button or deal missing:', { addToCartBtn, deal });
    return;
  }

  const brand = deal.brandName?.trim() || 'Unknown';
  const dealKey = getDealKey(deal);

  const checkIfInCart = () => {
    const cart = JSON.parse(localStorage.getItem('cartItems') || '{}');
    const brandCart = cart[brand] || [];
    return brandCart.some(item => item._id === dealKey);
  };

  updateCartBtnState(checkIfInCart());

  addToCartBtn.onclick = () => {
    const isInCart = checkIfInCart();
    updateCartBtnState(!isInCart); // Update UI instantly
    addToCart(deal); // Then handle logic + real cart update
  };

  function updateCartBtnState(isNowInCart) {
    addToCartBtn.classList.toggle('in-cart', isNowInCart);
    addToCartBtn.textContent = isNowInCart ? '❌ Del' : '📝 Add';
  }
}

function closePopup() {
  document.getElementById('popup').style.display = 'none';
  currentPopupDeal = null;
  document.body.classList.remove('noscroll');

  // FULL RESET here:
  isBrandMode = false;
  isLikedMode = false;
  
  // Reset tab buttons inside the popup (if you have any active classes)
  const tabs = document.querySelectorAll('.tab-switcher .tab-btn');
  tabs.forEach(tab => tab.classList.remove('active'));

  // Optional: highlight random tab as the default
  const randomTab = document.getElementById('showRandomBtn');
  if (randomTab) randomTab.classList.add('active');
}

function resetTabsToNormal() {
  // Reset the active tab to the "random" deals tab
  highlightTab('showRandomTabBtn');  // Assumes 'showRandomTabBtn' is the button for the random tab
  isBrandMode = false;  // Reset brand mode
  isLikedMode = false;  // Reset liked mode

  // Optionally, reset any other state or UI changes that were specific to the popup
  document.body.classList.remove('noscroll');  // Allow scrolling again after popup close
  // Hide the popup
  document.getElementById('popup').style.display = 'none';

  // Optionally clear any other custom settings (e.g., reset any custom button styles or selected elements)
  // Example: reset the popup content (optional)
  document.getElementById('popupImg').src = '';
  document.getElementById('popupTitle').textContent = '';
  document.getElementById('popupPrice').textContent = '';
  document.getElementById('popupDiscount').textContent = '';
  document.getElementById('popupDesc').textContent = '';
  document.getElementById('popupBadge').textContent = '';
  document.getElementById('popupSavings').textContent = '';
  document.getElementById('popupTimer').textContent = '';
}

// You can handle the 'back' button if you're using history navigation
window.onpopstate = function(event) {
  if (event.state && event.state.popup) {
    resetTabsToNormal();
  }
};

function highlightTab(tabId) {
  // Reset the styles for all tabs
  const tabs = document.querySelectorAll('.tab-button');  // Assuming all tab buttons have class 'tab-button'
  tabs.forEach(tab => tab.classList.remove('active'));  // Remove active class

  // Add the active class to the selected tab
  const selectedTab = document.getElementById(tabId);
  if (selectedTab) {
    selectedTab.classList.add('active');  // Add active class
  }
}

// Add click event to close the popup by clicking outside
document.getElementById('popup').addEventListener('click', function (e) {
  if (e.target === this) {
    resetTabsToNormal();  // Reset tabs when closing the popup
  }
});
	

	
function showBrandDealsInPopup(brandName) {
 isBrandMode = true;  // Set this before calling openPopup
  isLikedMode = false;  // Disable liked mode (random deals)
  highlightTab('showBrandTabBtn');  // Highlight the "Brand" tab
	  
  // Filter all deals to get the selected brand's deals
  const brandDeals = allDealsFlat.filter(d => d.brandName === brandName);

  if (!brandDeals.length) {
    alert("No deals for " + brandName);
    return;
  }

  brandDealKeys = brandDeals.map(d => d.name);
  brandDealIndex = 0;

  // Check if the current deal is from this brand to maintain position
  const currentKey = getDealKey(currentPopupDeal);
  const startIndex = brandDeals.findIndex(d => getDealKey(d) === currentKey);
  brandDealIndex = startIndex !== -1 ? startIndex : 0;

  const deal = brandDeals[brandDealIndex];

  // Show only brand deals in the "Brand" tab
  openPopup(deal, true);  // Skip history push
}	


function goToNextBrandDeal() {
  if (!brandDealKeys.length) return;
  brandDealIndex = (brandDealIndex + 1) % brandDealKeys.length;
  const deal = allDealsFlat.find(d => d.name === brandDealKeys[brandDealIndex]);
  openPopup(deal, true);
}

function goToPrevBrandDeal() {
  if (!brandDealKeys.length) return;
  brandDealIndex = (brandDealIndex - 1 + brandDealKeys.length) % brandDealKeys.length;
  const deal = allDealsFlat.find(d => d.name === brandDealKeys[brandDealIndex]);
  openPopup(deal, true);
}


function highlightTab(buttonId) {
  document.querySelectorAll('.tab-switcher .tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  document.getElementById(buttonId).classList.add('active');
}
	
 function showRandomDealsInPopup() {
  isLikedMode = false;
  isBrandMode = false;	 

  const likedDeals = JSON.parse(localStorage.getItem('likedDeals') || '{}');
  const likedNames = new Set(Object.keys(likedDeals));

  const unlikedDeals = allDeals.filter(deal => !likedNames.has(deal.name));

  if (unlikedDeals.length === 0) {
    alert("You've liked all the deals!");
    return;
  }

  const randomIndex = Math.floor(Math.random() * unlikedDeals.length);
  const deal = unlikedDeals[randomIndex];
  openPopup(deal, true);
} 
	
function showLikedDealsInPopup() {
  const likedDeals = JSON.parse(localStorage.getItem('likedDeals') || '{}');
  likedDealKeys = Object.keys(likedDeals);

  if (likedDealKeys.length === 0) {
    alert("No liked deals yet.");
    return;
  }

  isBrandMode = false;
  isLikedMode = true;
  likedDealIndex = 0;
  const deal = likedDeals[likedDealKeys[likedDealIndex]];
  openPopup(deal, true);
}
	
function goToNextLikedDeal() {
  if (likedDealKeys.length === 0) return;
  likedDealIndex = (likedDealIndex + 1) % likedDealKeys.length;
  const likedDeals = JSON.parse(localStorage.getItem('likedDeals') || '{}');
  const deal = likedDeals[likedDealKeys[likedDealIndex]];
  openPopup(deal, true);
}
	
function goToPrevLikedDeal() {
  if (likedDealKeys.length === 0) return;
  likedDealIndex = (likedDealIndex - 1 + likedDealKeys.length) % likedDealKeys.length;
  const likedDeals = JSON.parse(localStorage.getItem('likedDeals') || '{}');
  const deal = likedDeals[likedDealKeys[likedDealIndex]];
  openPopup(deal, true);
}
document.getElementById('showRandomBtn').onclick = () => {
  document.getElementById('showRandomBtn').classList.add('active');
  document.getElementById('showLikedBtn').classList.remove('active');
  showRandomDealsInPopup();
};

document.getElementById('showLikedBtn').onclick = () => {
  document.getElementById('showLikedBtn').classList.add('active');
  document.getElementById('showRandomBtn').classList.remove('active');
  showLikedDealsInPopup();
};

function cleanUpLikedDeals() {
  // Retrieve liked deals from localStorage
  const likedDeals = JSON.parse(localStorage.getItem('likedDeals') || '{}');

  // Log the data for debugging purposes
 console.log("🧪 allDealsFlat.length before cleanup:", allDealsFlat.length);
console.log("🧪 allDealsFlat keys:", allDealsFlat.map(getDealKey));

  // Create a Set of valid keys from allDealsFlat
  const validKeys = new Set(allDealsFlat.map(deal => getDealKey(deal)));
  
  let updated = false;

  // Iterate over the liked deals to check for invalid ones
  Object.keys(likedDeals).forEach(key => {
    if (!validKeys.has(key)) {
      console.log('Removing invalid liked deal:', key);
      delete likedDeals[key];
      updated = true;
    }
  });

  // If any updates were made, save the new likedDeals back to localStorage
  if (updated) {
    localStorage.setItem('likedDeals', JSON.stringify(likedDeals));
    renderLikedDealsGallery(); // Optional: Refresh the UI after cleanup
  }
}


document.getElementById('showLikedBtn').onclick = () => {
  isLikedMode = true;
  isBrandMode = false;
  highlightTab('showLikedBtn');
  showLikedDealsInPopup();
};

document.getElementById('showRandomBtn').onclick = () => {
  isLikedMode = false;
  isBrandMode = false;
  highlightTab('showRandomBtn');
  showRandomDealInPopup();
};

document.getElementById('showBrandTabBtn').onclick = () => {
  const brand = currentPopupDeal?.brandName;
  if (!brand) return;
  isLikedMode = false;
  isBrandMode = true;
  highlightTab('showBrandTabBtn');
  showBrandDealsInPopup(brand);
};
	
function formatDescription(description) {
  if (!description) return '';

  // Replace bold markers (e.g., **bold**) with <strong> tags
  description = description.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

  // Replace newlines (\n) with <br> to preserve line breaks, without showing \n to the user
  description = description.replace(/\n/g, '<br>');

  // Optional: Replace multiple consecutive <br> tags with <p> tags for paragraphs
  description = description.replace(/(<br>){2,}/g, '</p><p>');

  return description;
}

	
async function loadDeals() {
  const likedDeals = JSON.parse(localStorage.getItem('likedDeals') || '{}');
  const favoriteBrand = localStorage.getItem('selectedFavoriteBrand');  // Get the favorite brand from localStorage
  const container = document.getElementById('deals-container');
  container.innerHTML = '';
  allBrandsData.length = 0;
  allDealsFlat.length = 0;
  let currentlyOpenGrid = null;

  const allResponses = await Promise.all(
    sheetUrls.map(url => fetch(url).then(res => res.json()).catch(err => ({ error: err })))
  );

  for (let i = 0; i < allResponses.length; i++) {
    const rows = allResponses[i];
    if (rows.error) {
      console.warn(`Skipping sheet due to error: ${sheetUrls[i]}`, rows.error);
      continue;
    }

    try {
      let currentBrand = '';
      let currentLogo = '';
      let currentPrimaryColor = '';
      let currentSecondaryColor = '';
      let brandSection = null;
      let grid = null;
      let brandDeals = [];
      let expireDate = '';
      let isFavorite = false;

      rows.forEach(row => {
        try {
          if (row.BrandName && row.BrandLogo) {
            currentBrand = row.BrandName;
            currentLogo = row.BrandLogo;
	    currentPrimaryColor = row.PrimaryColor || '#163A5C'; // fallback
            currentSecondaryColor = row.SecondaryColor || '#2066A7'; // fallback

            // Check if the brand is marked as the favorite
            isFavorite = currentBrand === favoriteBrand;

            brandSection = document.createElement('div');
            brandSection.className = 'brand-section';

            const brandDiv = document.createElement('div');
            brandDiv.className = 'brand';
            const timerId = `timer-${Math.random().toString(36).substring(2)}`;

            brandDiv.innerHTML = `
              <div class="brand-logo-container">
                <img src="${currentLogo}" alt="${currentBrand}" />
              </div>
              <div>
                <span class="brand-name">${currentBrand}</span><br>
                <span class="brand-timer" id="${timerId}">Visit us now - limited-time promotion!</span>
              </div>
            `;

            const expireDateStr = row.ExpiryDate || row.expireDate;
            const parsedDate = Date.parse(expireDateStr);

            if (isNaN(parsedDate) || parsedDate < Date.now()) {
              const el = document.getElementById(timerId);
              if (el) {
                el.textContent = '⏳ Coming soon';
                el.classList.add('countdown-upcoming');
              }
            } else {
              startBrandCountdown(expireDateStr, timerId);
            }

            brandSection.appendChild(brandDiv);

            grid = document.createElement('div');
            grid.className = 'deal-grid';
            grid.style.display = 'none';

            brandSection.appendChild(grid);
            brandDiv.style.cursor = 'pointer';

            brandDiv.addEventListener('click', () => {
              const isOpen = grid.style.display === 'grid';
              if (currentlyOpenGrid && currentlyOpenGrid !== grid) {
                currentlyOpenGrid.style.display = 'none';
              }

              grid.style.display = isOpen ? 'none' : 'grid';

              if (!isOpen) {
                const headerHeight = 70;
                const likedDealsSection = document.getElementById('likedDealsSection');
                const likedVisible = likedDealsSection && likedDealsSection.offsetParent !== null;
                const extraOffset = likedVisible ? 5 : 0;
                const top = brandDiv.getBoundingClientRect().top + window.scrollY - headerHeight - extraOffset;
                window.scrollTo({ top, behavior: 'smooth' });
              }

             currentlyOpenGrid = grid.style.display === 'grid' ? grid : null;
            });

            container.appendChild(brandSection);

            if (expireDateStr) {
              expireDate = new Date(expireDateStr);
              if (!isNaN(expireDate)) {
                startBrandCountdown(expireDate, timerId);
              }
            }

            // Add the brand to the data list
            allBrandsData.push({
              brand: currentBrand,
              logo: currentLogo,
              expireDate,
              section: brandSection,
              grid,
              deals: brandDeals,
              primaryColor: currentPrimaryColor,
              secondaryColor: currentSecondaryColor,
              isFavorite
            });
          }

          // Now we process deals for each brand
          if (row.ProductName && row.ImageURL && row.OriginalPrice && row.DiscountPrice) {
            const original = parseFloat(row.OriginalPrice.replace(/,/g, '')) || 0;
            const discount = parseFloat(row.DiscountPrice.replace(/,/g, '')) || 0;
            const percentOff = original && discount ? Math.round((1 - discount / original) * 100) : 0;

            const shortName = row.ProductName.length > 15 ? row.ProductName.slice(0, 15) + '...' : row.ProductName;

            const dealCard = document.createElement('div');
            dealCard.className = 'deal';
            dealCard.innerHTML = `
              <span class="discount-badge">${percentOff}% OFF</span>
              <img src="${row.ImageURL}" alt="${row.ProductName}">
              <div class="deal-content">
                <div class="deal-title">${shortName}</div>
                <div class="price">JMD $${row.OriginalPrice}</div>
                <div class="discount">JMD $${row.DiscountPrice}</div>
              </div>
            `;

            const dealData = {
              image: row.ImageURL,
              name: row.ProductName,
              original: row.OriginalPrice,
              discount: row.DiscountPrice,
              description: row.Description,
              brandLogo: currentLogo,
              brandName: currentBrand
            };

            const isLiked = !!likedDeals[dealData.name];

            dealCard.addEventListener('click', () => {
              isLikedMode = false;
              document.getElementById('showRandomBtn')?.classList.add('active');
              document.getElementById('showLikedBtn')?.classList.remove('active');
              openPopup(dealData);
            });

            if (!isLiked) {
              allDealsFlat.push(dealData);
              brandDeals.push({
                element: dealCard,
                percentOff,
                expireDate: row.expireDate
              });
            } else {
              allDealsFlat.push(dealData);
            }
          }
        } catch (rowErr) {
          console.warn(`Skipped row due to missing or invalid fields:`, rowErr);
        }
      });
    } catch (sheetErr) {
      console.warn(`Error processing sheet at ${sheetUrls[i]}`, sheetErr);
    }
  }

  allBrandsData.forEach(brandData => {
    // Sort deals by discount percent
    brandData.deals.sort((a, b) => b.percentOff - a.percentOff);
    brandData.deals.forEach(d => brandData.grid.appendChild(d.element));
  });

  allBrandsData.forEach(brandData => {
    brandData.bestDiscount = Math.max(...brandData.deals.map(d => d.percentOff));
    brandData.timeRemaining = brandData.expireDate ? new Date(brandData.expireDate) - new Date() : Infinity;
  });

  // Sort brands: first by best discount, then by time remaining
  allBrandsData.sort((a, b) => {
    if (b.bestDiscount !== a.bestDiscount) {
      return b.bestDiscount - a.bestDiscount;
    }
    return a.timeRemaining - b.timeRemaining;
  });

  container.innerHTML = '';

  // Create liked deals section
  let likedDealsSection = document.getElementById('likedDealsSection');
  if (!likedDealsSection) {
    likedDealsSection = document.createElement('div');
    likedDealsSection.id = 'likedDealsSection';
    likedDealsSection.style.display = 'none';
    likedDealsSection.style.marginBottom = '1rem';
    likedDealsSection.innerHTML = `<div id="likedDealsGallery" class="likedDealsGallery"></div>`;
    container.appendChild(likedDealsSection);
  }

  renderLikedDealsGallery();

  // Handle favorite brand first
const favoriteBrandData = allBrandsData.find(brand => brand.isFavorite);
if (favoriteBrandData) {
  // Apply favorite brand specific styles
  const favBadge = document.createElement('div');
  favBadge.className = 'favorite-brand-badge';
  favBadge.textContent = '⭐ Your Favorite Brand';

  // Apply the brand's color if available
  const primaryColor = favoriteBrandData.primaryColor?.trim() || '#163A5C';

  // Apply dynamic colors
  favBadge.style.backgroundColor = primaryColor;  // Background = Primary Color
 
  // Append the badge to the logo container
  favoriteBrandData.section.querySelector('.brand-logo-container').appendChild(favBadge);

  // Apply the favorite color
 if (favoriteBrandData.secondaryColor) {
  const brandElement = favoriteBrandData.section.querySelector('.brand');
  brandElement.classList.add('favorite-brand-highlight');

  const secondaryColor = favoriteBrandData.secondaryColor.trim();

  // Set the border color
  brandElement.style.setProperty('--highlight-border-color', secondaryColor);
  
  // Calculate the pulse color (50% lighter version of secondaryColor)
  const pulseColor = toSemiTransparent(secondaryColor, 0.6);

  // Start animating the glow effect with JavaScript
  let pulseActive = true;
  setInterval(() => {
    if (pulseActive) {
      brandElement.style.boxShadow = `0 0 10px ${secondaryColor}`;  // Apply regular secondary color glow
    } else {
      brandElement.style.boxShadow = `0 0 20px ${pulseColor}`;  // Apply 50% lighter pulse color glow
    }
    pulseActive = !pulseActive; // Toggle pulse
  }, 1000); // Toggle every second
}

    // Auto-open the favorite brand grid
    favoriteBrandData.grid.style.display = 'grid';
    currentlyOpenGrid = favoriteBrandData.grid;

    // Move the favorite brand to the top
    container.appendChild(favoriteBrandData.section);
  }

  // Process remaining brands (excluding the favorite)
  allBrandsData.forEach(brandData => {
    if (!brandData.isFavorite) {
      if (brandData.bestDiscount === Math.max(...allBrandsData.map(b => b.bestDiscount))) {
        // Apply gold border and glow for the Hottest Discount
        const badge = document.createElement('div');
        badge.className = 'top-deal-badge';
        badge.textContent = '🔥 Hottest Discount';
        brandData.section.querySelector('.brand-logo-container').appendChild(badge);
        brandData.section.querySelector('.brand').classList.add('top-brand-highlight');
      }
      container.appendChild(brandData.section);
    }
  });

  setTimeout(() => {
    cleanUpLikedDeals();
  }, 3000);
}

function toSemiTransparent(color, alpha = 0.5) {
  color = color.trim();
  
  if (color.startsWith('#')) {
    let r, g, b;
    
    if (color.length === 7) { // #rrggbb
      r = parseInt(color.substr(1,2), 16);
      g = parseInt(color.substr(3,2), 16);
      b = parseInt(color.substr(5,2), 16);
    } else if (color.length === 4) { // #rgb
      r = parseInt(color[1] + color[1], 16);
      g = parseInt(color[2] + color[2], 16);
      b = parseInt(color[3] + color[3], 16);
    } else {
      return color;
    }
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
  }

  return color; // fallback for rgb() already
}

	
function startBrandCountdown(expireDate, elementId) {
  const parsedDate = Date.parse(expireDate);
  const el = document.getElementById(elementId);

  if (!el) return;

  // Show "Coming soon" for invalid or backdated dates
  if (isNaN(parsedDate) || parsedDate < Date.now()) {
    el.textContent = '⏳ Coming soon';
    el.classList.add('countdown-upcoming');
    return;
  }

  function update() {
    const timeLeft = parsedDate - Date.now();

    if (timeLeft <= 0) {
      el.textContent = '❌ Deal ended';
      el.classList.add('countdown-ended');
      clearInterval(timer);
    } else {
      const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
      const hrs = String(Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / 3600000)).padStart(2, '0');
      const mins = String(Math.floor((timeLeft % 3600000) / 60000)).padStart(2, '0');
      const secs = String(Math.floor((timeLeft % 60000) / 1000)).padStart(2, '0');

      let countdownStr = '';
      if (days > 0) {
        countdownStr += `${days}d `;
      }

      countdownStr += `${hrs}hr :${mins}min :${secs}sec`;

      el.innerHTML = `⏳ <span class="countdown-timer">Ends in: ${countdownStr}</span>`;

      if (timeLeft <= 3600000) {
        el.classList.add('countdown-urgent');
      } else {
        el.classList.remove('countdown-urgent');
      }
    }
  }

  update();
  const timer = setInterval(update, 1000);
}

  document.getElementById('popup').addEventListener('click', function (e) {
    if (e.target === this) {
      closePopup();
    }
  });

/*  document.getElementById('popupImg').addEventListener('click', () => {
    let next;
    do {
      const randomIndex = Math.floor(Math.random() * allDealsFlat.length);
      next = allDealsFlat[randomIndex];
    } while (next.name === currentPopupDeal?.name);

    openPopup(next); // pushState already handled in openPopup
  }); 

  document.getElementById('popupBack').addEventListener('click', () => {
    window.history.back();
  }); */

  window.onpopstate = function (event) {
    if (event.state?.popup && event.state.dealName) {
      const deal = allDealsFlat.find(d => d.name === event.state.dealName);
      if (deal) {
        openPopup(deal, true); // skip history push
      }
    } else {
      closePopup();
    }
  };
	
  loadDeals();
		
	function addPopupSwipeListeners() {
  const popup = document.getElementById('popup');
  let startY = 0;
  let endY = 0;

  popup.addEventListener('touchstart', (e) => {
    if (e.touches.length === 1) {
      startY = e.touches[0].clientY;
    }
  });

  popup.addEventListener('touchend', (e) => {
    endY = e.changedTouches[0].clientY;
    handleSwipe();
  });

  function handleSwipe() {
  const deltaY = endY - startY;

  if (isSwiping || Math.abs(deltaY) <= 50) return;

  isSwiping = true;

  if (deltaY < 0) {
    // Swipe Up
    if (isLikedMode) {
      goToNextLikedDeal();
    } else if (isBrandMode) {
      goToNextBrandDeal();
    } else {
      let next;
      do {
        const randomIndex = Math.floor(Math.random() * allDealsFlat.length);
        next = allDealsFlat[randomIndex];
      } while (next.name === currentPopupDeal?.name);

      document.getElementById('showLikedBtn')?.classList.remove('active');
      document.getElementById('showRandomBtn')?.classList.add('active');
      isLikedMode = false;
      isBrandMode = false;

      openPopup(next);
    }
  } else {
    // Swipe Down
    if (isLikedMode) {
      goToPrevLikedDeal();
    } else if (isBrandMode) {
      goToPrevBrandDeal();
    } else {
      window.history.back();
    }
  }

  // Allow next swipe after 300ms
  setTimeout(() => {
    isSwiping = false;
  }, 300);
}



	}


// Call this after your popup is ready
addPopupSwipeListeners();
	
</script>


		 </div>	</div>	</div>	</div>	</div>			 			 
</body>
</html>
